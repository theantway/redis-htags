<html>
<head>
<title>src/scripting.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/401.html'>src</a>/scripting.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L975'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L68' title='Defined at 68.'>redisProtocolToLuaType</a>
<li><a href='#L91' title='Defined at 91.'>redisProtocolToLuaType_Int</a>
<li><a href='#L100' title='Defined at 100.'>redisProtocolToLuaType_Bulk</a>
<li><a href='#L114' title='Defined at 114.'>redisProtocolToLuaType_Status</a>
<li><a href='#L124' title='Defined at 124.'>redisProtocolToLuaType_Error</a>
<li><a href='#L134' title='Defined at 134.'>redisProtocolToLuaType_MultiBulk</a>
<li><a href='#L154' title='Defined at 154.'>luaPushError</a>
<li><a href='#L167' title='Defined at 167.'>luaSortArray</a>
<li><a href='#L192' title='Defined at 192.'>luaRedisGenericCommand</a>
<li><a href='#L337' title='Defined at 337.'>luaRedisCallCommand</a>
<li><a href='#L341' title='Defined at 341.'>luaRedisPCallCommand</a>
<li><a href='#L347' title='Defined at 347.'>luaRedisSha1hexCommand</a>
<li><a href='#L371' title='Defined at 371.'>luaRedisReturnSingleFieldTable</a>
<li><a href='#L384' title='Defined at 384.'>luaRedisErrorReplyCommand</a>
<li><a href='#L388' title='Defined at 388.'>luaRedisStatusReplyCommand</a>
<li><a href='#L392' title='Defined at 392.'>luaLogCommand</a>
<li><a href='#L427' title='Defined at 427.'>luaMaskCountHook</a>
<li><a href='#L452' title='Defined at 452.'>luaLoadLib</a>
<li><a href='#L462' title='Defined at 462.'>luaLoadLibraries</a>
<li><a href='#L480' title='Defined at 480.'>luaRemoveUnsupportedFunctions</a>
<li><a href='#L490' title='Defined at 490.'>scriptingEnableGlobalsProtection</a>
<li><a href='#L526' title='Defined at 526.'>scriptingInit</a>
<li><a href='#L631' title='Defined at 631.'>scriptingRelease</a>
<li><a href='#L636' title='Defined at 636.'>scriptingReset</a>
<li><a href='#L647' title='Defined at 647.'>sha1hex</a>
<li><a href='#L664' title='Defined at 664.'>luaReplyToRedisReply</a>
<li><a href='#L730' title='Defined at 730.'>luaSetGlobalArray</a>
<li><a href='#L750' title='Defined at 750.'>luaCreateFunction</a>
<li><a href='#L786' title='Defined at 786.'>evalGenericCommand</a>
<li><a href='#L916' title='Defined at 916.'>evalCommand</a>
<li><a href='#L920' title='Defined at 920.'>evalShaCommand</a>
<li><a href='#L938' title='Defined at 938.'>redis_math_random</a>
<li><a href='#L966' title='Defined at 966.'>redis_math_randomseed</a>
<li><a href='#L975' title='Defined at 975.'>scriptCommand</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/*</font></i>
<a name='L2'><i><font color='green'> * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</font></i>
<a name='L3'><i><font color='green'> * All rights reserved.</font></i>
<a name='L4'><i><font color='green'> *</font></i>
<a name='L5'><i><font color='green'> * Redistribution and use in source and binary forms, with or without</font></i>
<a name='L6'><i><font color='green'> * modification, are permitted provided that the following conditions are met:</font></i>
<a name='L7'><i><font color='green'> *</font></i>
<a name='L8'><i><font color='green'> *   * Redistributions of source code must retain the above copyright notice,</font></i>
<a name='L9'><i><font color='green'> *     this list of conditions and the following disclaimer.</font></i>
<a name='L10'><i><font color='green'> *   * Redistributions in binary form must reproduce the above copyright</font></i>
<a name='L11'><i><font color='green'> *     notice, this list of conditions and the following disclaimer in the</font></i>
<a name='L12'><i><font color='green'> *     documentation and/or other materials provided with the distribution.</font></i>
<a name='L13'><i><font color='green'> *   * Neither the name of Redis nor the names of its contributors may be used</font></i>
<a name='L14'><i><font color='green'> *     to endorse or promote products derived from this software without</font></i>
<a name='L15'><i><font color='green'> *     specific prior written permission.</font></i>
<a name='L16'><i><font color='green'> *</font></i>
<a name='L17'><i><font color='green'> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</font></i>
<a name='L18'><i><font color='green'> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</font></i>
<a name='L19'><i><font color='green'> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</font></i>
<a name='L20'><i><font color='green'> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</font></i>
<a name='L21'><i><font color='green'> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</font></i>
<a name='L22'><i><font color='green'> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</font></i>
<a name='L23'><i><font color='green'> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</font></i>
<a name='L24'><i><font color='green'> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</font></i>
<a name='L25'><i><font color='green'> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</font></i>
<a name='L26'><i><font color='green'> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</font></i>
<a name='L27'><i><font color='green'> * POSSIBILITY OF SUCH DAMAGE.</font></i>
<a name='L28'><i><font color='green'> */</font></i>
<a name='L29'>
<a name='L30'><font color='darkred'>#include</font> "<a href='32.html'>redis.h</a>"
<a name='L31'><font color='darkred'>#include</font> "<a href='30.html'>sha1.h</a>"
<a name='L32'><font color='darkred'>#include</font> "<a href='83.html'>rand.h</a>"
<a name='L33'>
<a name='L34'><font color='darkred'>#include</font> &lt;<a href='266.html'>lua.h</a>&gt;
<a name='L35'><font color='darkred'>#include</font> &lt;<a href='265.html'>lauxlib.h</a>&gt;
<a name='L36'><font color='darkred'>#include</font> &lt;<a href='267.html'>lualib.h</a>&gt;
<a name='L37'><font color='darkred'>#include</font> &lt;ctype.h&gt;
<a name='L38'><font color='darkred'>#include</font> &lt;math.h&gt;
<a name='L39'>
<a name='L40'><b>char</b> *<a href='../S/75.html#L91' title='Defined at 91 in src/scripting.c.'>redisProtocolToLuaType_Int</a>(lua_State *lua, <b>char</b> *reply);
<a name='L41'><b>char</b> *<a href='../S/75.html#L100' title='Defined at 100 in src/scripting.c.'>redisProtocolToLuaType_Bulk</a>(lua_State *lua, <b>char</b> *reply);
<a name='L42'><b>char</b> *<a href='../S/75.html#L114' title='Defined at 114 in src/scripting.c.'>redisProtocolToLuaType_Status</a>(lua_State *lua, <b>char</b> *reply);
<a name='L43'><b>char</b> *<a href='../S/75.html#L124' title='Defined at 124 in src/scripting.c.'>redisProtocolToLuaType_Error</a>(lua_State *lua, <b>char</b> *reply);
<a name='L44'><b>char</b> *<a href='../S/75.html#L134' title='Defined at 134 in src/scripting.c.'>redisProtocolToLuaType_MultiBulk</a>(lua_State *lua, <b>char</b> *reply);
<a name='L45'><b>int</b> <a href='../S/75.html#L938' title='Defined at 938 in src/scripting.c.'>redis_math_random</a> (lua_State *L);
<a name='L46'><b>int</b> <a href='../S/75.html#L966' title='Defined at 966 in src/scripting.c.'>redis_math_randomseed</a> (lua_State *L);
<a name='L47'><b>void</b> <a href='../S/75.html#L647' title='Defined at 647 in src/scripting.c.'>sha1hex</a>(<b>char</b> *digest, <b>char</b> *script, size_t len);
<a name='L48'>
<a name='L49'><i><font color='green'>/* Take a Redis reply in the Redis protocol format and convert it into a</font></i>
<a name='L50'><i><font color='green'> * Lua type. Thanks to this function, and the introduction of not connected</font></i>
<a name='L51'><i><font color='green'> * clients, it is trvial to implement the redis() lua function.</font></i>
<a name='L52'><i><font color='green'> *</font></i>
<a name='L53'><i><font color='green'> * Basically we take the arguments, execute the Redis command in the context</font></i>
<a name='L54'><i><font color='green'> * of a non connected client, then take the generated reply and convert it</font></i>
<a name='L55'><i><font color='green'> * into a suitable Lua type. With this trick the scripting feature does not</font></i>
<a name='L56'><i><font color='green'> * need the introduction of a full Redis internals API. Basically the script</font></i>
<a name='L57'><i><font color='green'> * is like a normal client that bypasses all the slow I/O paths.</font></i>
<a name='L58'><i><font color='green'> *</font></i>
<a name='L59'><i><font color='green'> * Note: in this function we do not do any sanity check as the reply is</font></i>
<a name='L60'><i><font color='green'> * generated by Redis directly. This allows us to go faster.</font></i>
<a name='L61'><i><font color='green'> * The reply string can be altered during the parsing as it is discared</font></i>
<a name='L62'><i><font color='green'> * after the conversion is completed.</font></i>
<a name='L63'><i><font color='green'> *</font></i>
<a name='L64'><i><font color='green'> * Errors are returned as a table with a single 'err' field set to the</font></i>
<a name='L65'><i><font color='green'> * error string.</font></i>
<a name='L66'><i><font color='green'> */</font></i>
<a name='L67'>
<a name='L68'><b>char</b> *<a href='../R/3480.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType</a>(lua_State *lua, <b>char</b>* reply) <font color='red'>{</font>
<a name='L69'>    <b>char</b> *p = reply;
<a name='L70'>
<a name='L71'>    <b>switch</b>(*p) <font color='red'>{</font>
<a name='L72'>    <b>case</b> ':':
<a name='L73'>        p = <a href='../S/75.html#L91' title='Defined at 91 in src/scripting.c.'>redisProtocolToLuaType_Int</a>(lua,reply);
<a name='L74'>        <b>break</b>;
<a name='L75'>    <b>case</b> '$':
<a name='L76'>        p = <a href='../S/75.html#L100' title='Defined at 100 in src/scripting.c.'>redisProtocolToLuaType_Bulk</a>(lua,reply);
<a name='L77'>        <b>break</b>;
<a name='L78'>    <b>case</b> '+':
<a name='L79'>        p = <a href='../S/75.html#L114' title='Defined at 114 in src/scripting.c.'>redisProtocolToLuaType_Status</a>(lua,reply);
<a name='L80'>        <b>break</b>;
<a name='L81'>    <b>case</b> '-':
<a name='L82'>        p = <a href='../S/75.html#L124' title='Defined at 124 in src/scripting.c.'>redisProtocolToLuaType_Error</a>(lua,reply);
<a name='L83'>        <b>break</b>;
<a name='L84'>    <b>case</b> '*':
<a name='L85'>        p = <a href='../S/75.html#L134' title='Defined at 134 in src/scripting.c.'>redisProtocolToLuaType_MultiBulk</a>(lua,reply);
<a name='L86'>        <b>break</b>;
<a name='L87'>    <font color='red'>}</font>
<a name='L88'>    <b>return</b> p;
<a name='L89'><font color='red'>}</font>
<a name='L90'>
<a name='L91'><b>char</b> *<a href='../R/3483.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType_Int</a>(lua_State *lua, <b>char</b> *reply) <font color='red'>{</font>
<a name='L92'>    <b>char</b> *p = strchr(reply+1,'\r');
<a name='L93'>    <b>long</b> <b>long</b> value;
<a name='L94'>
<a name='L95'>    <a href='../S/74.html#L244' title='Defined at 244 in src/util.c.'>string2ll</a>(reply+1,p-reply-1,&amp;value);
<a name='L96'>    <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,(<a href='../S/266.html#L99' title='Defined at 99 in deps/lua/src/lua.h.'>lua_Number</a>)value);
<a name='L97'>    <b>return</b> p+2;
<a name='L98'><font color='red'>}</font>
<a name='L99'>
<a name='L100'><b>char</b> *<a href='../R/3481.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType_Bulk</a>(lua_State *lua, <b>char</b> *reply) <font color='red'>{</font>
<a name='L101'>    <b>char</b> *p = strchr(reply+1,'\r');
<a name='L102'>    <b>long</b> <b>long</b> <a href='../S/120.html#L682' title='Defined at 682 in deps/hiredis/hiredis.c.'>bulklen</a>;
<a name='L103'>
<a name='L104'>    <a href='../S/74.html#L244' title='Defined at 244 in src/util.c.'>string2ll</a>(reply+1,p-reply-1,&amp;<a href='../S/120.html#L682' title='Defined at 682 in deps/hiredis/hiredis.c.'>bulklen</a>);
<a name='L105'>    <b>if</b> (<a href='../S/120.html#L682' title='Defined at 682 in deps/hiredis/hiredis.c.'>bulklen</a> == -1) <font color='red'>{</font>
<a name='L106'>        <a href='../S/272.html#L503' title='Defined at 503 in deps/lua/src/lapi.c.'>lua_pushboolean</a>(lua,0);
<a name='L107'>        <b>return</b> p+2;
<a name='L108'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L109'>        <a href='../S/272.html#L445' title='Defined at 445 in deps/lua/src/lapi.c.'>lua_pushlstring</a>(lua,p+2,<a href='../S/120.html#L682' title='Defined at 682 in deps/hiredis/hiredis.c.'>bulklen</a>);
<a name='L110'>        <b>return</b> p+2+<a href='../S/120.html#L682' title='Defined at 682 in deps/hiredis/hiredis.c.'>bulklen</a>+2;
<a name='L111'>    <font color='red'>}</font>
<a name='L112'><font color='red'>}</font>
<a name='L113'>
<a name='L114'><b>char</b> *<a href='../R/3485.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType_Status</a>(lua_State *lua, <b>char</b> *reply) <font color='red'>{</font>
<a name='L115'>    <b>char</b> *p = strchr(reply+1,'\r');
<a name='L116'>
<a name='L117'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L118'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"ok");
<a name='L119'>    <a href='../S/272.html#L445' title='Defined at 445 in deps/lua/src/lapi.c.'>lua_pushlstring</a>(lua,reply+1,p-reply-1);
<a name='L120'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L121'>    <b>return</b> p+2;
<a name='L122'><font color='red'>}</font>
<a name='L123'>
<a name='L124'><b>char</b> *<a href='../R/3482.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType_Error</a>(lua_State *lua, <b>char</b> *reply) <font color='red'>{</font>
<a name='L125'>    <b>char</b> *p = strchr(reply+1,'\r');
<a name='L126'>
<a name='L127'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L128'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"err");
<a name='L129'>    <a href='../S/272.html#L445' title='Defined at 445 in deps/lua/src/lapi.c.'>lua_pushlstring</a>(lua,reply+1,p-reply-1);
<a name='L130'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L131'>    <b>return</b> p+2;
<a name='L132'><font color='red'>}</font>
<a name='L133'>
<a name='L134'><b>char</b> *<a href='../R/3484.html' title='Multiple refered from 2 places.'>redisProtocolToLuaType_MultiBulk</a>(lua_State *lua, <b>char</b> *reply) <font color='red'>{</font>
<a name='L135'>    <b>char</b> *p = strchr(reply+1,'\r');
<a name='L136'>    <b>long</b> <b>long</b> mbulklen;
<a name='L137'>    <b>int</b> j = 0;
<a name='L138'>
<a name='L139'>    <a href='../S/74.html#L244' title='Defined at 244 in src/util.c.'>string2ll</a>(reply+1,p-reply-1,&amp;mbulklen);
<a name='L140'>    p += 2;
<a name='L141'>    <b>if</b> (mbulklen == -1) <font color='red'>{</font>
<a name='L142'>        <a href='../S/272.html#L503' title='Defined at 503 in deps/lua/src/lapi.c.'>lua_pushboolean</a>(lua,0);
<a name='L143'>        <b>return</b> p;
<a name='L144'>    <font color='red'>}</font>
<a name='L145'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L146'>    <b>for</b> (j = 0; j &lt; mbulklen; j++) <font color='red'>{</font>
<a name='L147'>        <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,j+1);
<a name='L148'>        p = <a href='../S/75.html#L68' title='Defined at 68 in src/scripting.c.'>redisProtocolToLuaType</a>(lua,p);
<a name='L149'>        <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L150'>    <font color='red'>}</font>
<a name='L151'>    <b>return</b> p;
<a name='L152'><font color='red'>}</font>
<a name='L153'>
<a name='L154'><b>void</b> <a href='../R/2697.html' title='Multiple refered from 14 places.'>luaPushError</a>(lua_State *lua, <b>char</b> *error) <font color='red'>{</font>
<a name='L155'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L156'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"err");
<a name='L157'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, <a href='../D/2172.html' title='Multiple defined in 3 places.'>error</a>);
<a name='L158'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L159'><font color='red'>}</font>
<a name='L160'>
<a name='L161'><i><font color='green'>/* Sort the array currently in the stack. We do this to make the output</font></i>
<a name='L162'><i><font color='green'> * of commands like KEYS or SMEMBERS something deterministic when called</font></i>
<a name='L163'><i><font color='green'> * from Lua (to play well with AOf/replication).</font></i>
<a name='L164'><i><font color='green'> *</font></i>
<a name='L165'><i><font color='green'> * The array is sorted using table.sort itself, and assuming all the</font></i>
<a name='L166'><i><font color='green'> * list elements are strings. */</font></i>
<a name='L167'><b>void</b> <a href='../S/75.html#L314' title='Refered from 314 in src/scripting.c.'>luaSortArray</a>(lua_State *lua) <font color='red'>{</font>
<a name='L168'>    <i><font color='green'>/* Initial Stack: array */</font></i>
<a name='L169'>    <a href='../S/266.html#L277' title='Defined at 277 in deps/lua/src/lua.h.'>lua_getglobal</a>(lua,"table");
<a name='L170'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"sort");
<a name='L171'>    <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);       <i><font color='green'>/* Stack: array, table, table.sort */</font></i>
<a name='L172'>    <a href='../S/272.html#L228' title='Defined at 228 in deps/lua/src/lapi.c.'>lua_pushvalue</a>(lua,-3);      <i><font color='green'>/* Stack: array, table, table.sort, array */</font></i>
<a name='L173'>    <b>if</b> (<a href='../S/272.html#L805' title='Defined at 805 in deps/lua/src/lapi.c.'>lua_pcall</a>(lua,1,0,0)) <font color='red'>{</font>
<a name='L174'>        <i><font color='green'>/* Stack: array, table, error */</font></i>
<a name='L175'>
<a name='L176'>        <i><font color='green'>/* We are not interested in the error, we assume that the problem is</font></i>
<a name='L177'><i><font color='green'>         * that there are 'false' elements inside the array, so we try</font></i>
<a name='L178'><i><font color='green'>         * again with a slower function but able to handle this case, that</font></i>
<a name='L179'><i><font color='green'>         * is: table.sort(table, __redis__compare_helper) */</font></i>
<a name='L180'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);             <i><font color='green'>/* Stack: array, table */</font></i>
<a name='L181'>        <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"sort"); <i><font color='green'>/* Stack: array, table, sort */</font></i>
<a name='L182'>        <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);       <i><font color='green'>/* Stack: array, table, table.sort */</font></i>
<a name='L183'>        <a href='../S/272.html#L228' title='Defined at 228 in deps/lua/src/lapi.c.'>lua_pushvalue</a>(lua,-3);      <i><font color='green'>/* Stack: array, table, table.sort, array */</font></i>
<a name='L184'>        <a href='../S/266.html#L277' title='Defined at 277 in deps/lua/src/lua.h.'>lua_getglobal</a>(lua,"__redis__compare_helper");
<a name='L185'>        <i><font color='green'>/* Stack: array, table, table.sort, array, __redis__compare_helper */</font></i>
<a name='L186'>        <a href='../S/272.html#L776' title='Defined at 776 in deps/lua/src/lapi.c.'>lua_call</a>(lua,2,0);
<a name='L187'>    <font color='red'>}</font>
<a name='L188'>    <i><font color='green'>/* Stack: array (sorted), table */</font></i>
<a name='L189'>    <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);             <i><font color='green'>/* Stack: array (sorted) */</font></i>
<a name='L190'><font color='red'>}</font>
<a name='L191'>
<a name='L192'><b>int</b> <a href='../R/2700.html' title='Multiple refered from 2 places.'>luaRedisGenericCommand</a>(lua_State *lua, <b>int</b> raise_error) <font color='red'>{</font>
<a name='L193'>    <b>int</b> j, argc = <a href='../S/272.html#L159' title='Defined at 159 in deps/lua/src/lapi.c.'>lua_gettop</a>(lua);
<a name='L194'>    <b>struct</b> <a href='../D/3782.html' title='Multiple defined in 2 places.'>redisCommand</a> *cmd;
<a name='L195'>    <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> **argv;
<a name='L196'>    <a href='../D/3781.html' title='Multiple defined in 2 places.'>redisClient</a> *c = server.lua_client;
<a name='L197'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> reply;
<a name='L198'>
<a name='L199'>    <i><font color='green'>/* Require at least one argument */</font></i>
<a name='L200'>    <b>if</b> (argc == 0) <font color='red'>{</font>
<a name='L201'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua,
<a name='L202'>            "Please specify at least one argument for redis.call()");
<a name='L203'>        <b>return</b> 1;
<a name='L204'>    <font color='red'>}</font>
<a name='L205'>
<a name='L206'>    <i><font color='green'>/* Build the arguments vector */</font></i>
<a name='L207'>    argv = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(<a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a>*)*argc);
<a name='L208'>    <b>for</b> (j = 0; j &lt; argc; j++) <font color='red'>{</font>
<a name='L209'>        <b>if</b> (!<a href='../S/272.html#L267' title='Defined at 267 in deps/lua/src/lapi.c.'>lua_isstring</a>(lua,j+1)) <b>break</b>;
<a name='L210'>        argv[j] = <a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>((<b>char</b>*)<a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,j+1),
<a name='L211'>                                     <a href='../S/266.html#L262' title='Defined at 262 in deps/lua/src/lua.h.'>lua_strlen</a>(lua,j+1));
<a name='L212'>    <font color='red'>}</font>
<a name='L213'>    
<a name='L214'>    <i><font color='green'>/* Check if one of the arguments passed by the Lua script</font></i>
<a name='L215'><i><font color='green'>     * is not a string or an integer (lua_isstring() return true for</font></i>
<a name='L216'><i><font color='green'>     * integers as well). */</font></i>
<a name='L217'>    <b>if</b> (j != argc) <font color='red'>{</font>
<a name='L218'>        j--;
<a name='L219'>        <b>while</b> (j &gt;= 0) <font color='red'>{</font>
<a name='L220'>            <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(argv[j]);
<a name='L221'>            j--;
<a name='L222'>        <font color='red'>}</font>
<a name='L223'>        <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(argv);
<a name='L224'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua,
<a name='L225'>            "Lua redis() command arguments must be strings or integers");
<a name='L226'>        <b>return</b> 1;
<a name='L227'>    <font color='red'>}</font>
<a name='L228'>
<a name='L229'>    <i><font color='green'>/* Setup our fake client for command execution */</font></i>
<a name='L230'>    c-&gt;argv = argv;
<a name='L231'>    c-&gt;argc = argc;
<a name='L232'>
<a name='L233'>    <i><font color='green'>/* Command lookup */</font></i>
<a name='L234'>    cmd = <a href='../S/35.html#L1448' title='Defined at 1448 in src/redis.c.'>lookupCommand</a>(argv[0]-&gt;ptr);
<a name='L235'>    <b>if</b> (!cmd || ((cmd-&gt;arity &gt; 0 &amp;&amp; cmd-&gt;arity != argc) ||
<a name='L236'>                   (argc &lt; -cmd-&gt;arity)))
<a name='L237'>    <font color='red'>{</font>
<a name='L238'>        <b>if</b> (cmd)
<a name='L239'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua,
<a name='L240'>                "Wrong number of args calling Redis command From Lua script");
<a name='L241'>        <b>else</b>
<a name='L242'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua,"Unknown Redis command called from Lua script");
<a name='L243'>        <b>goto</b> cleanup;
<a name='L244'>    <font color='red'>}</font>
<a name='L245'>
<a name='L246'>    <i><font color='green'>/* There are commands that are not allowed inside scripts. */</font></i>
<a name='L247'>    <b>if</b> (cmd-&gt;flags &amp; <a href='../S/32.html#L113' title='Defined at 113 in src/redis.h.'>REDIS_CMD_NOSCRIPT</a>) <font color='red'>{</font>
<a name='L248'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "This Redis command is not allowed from scripts");
<a name='L249'>        <b>goto</b> cleanup;
<a name='L250'>    <font color='red'>}</font>
<a name='L251'>
<a name='L252'>    <i><font color='green'>/* Write commands are forbidden against read-only slaves, or if a</font></i>
<a name='L253'><i><font color='green'>     * command marked as non-deterministic was already called in the context</font></i>
<a name='L254'><i><font color='green'>     * of this script. */</font></i>
<a name='L255'>    <b>if</b> (cmd-&gt;flags &amp; <a href='../S/32.html#L107' title='Defined at 107 in src/redis.h.'>REDIS_CMD_WRITE</a>) <font color='red'>{</font>
<a name='L256'>        <b>if</b> (server.lua_random_dirty) <font color='red'>{</font>
<a name='L257'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua,
<a name='L258'>                "Write commands not allowed after non deterministic commands");
<a name='L259'>            <b>goto</b> cleanup;
<a name='L260'>        <font color='red'>}</font> <b>else</b> <b>if</b> (server.masterhost &amp;&amp; server.repl_slave_ro &amp;&amp;
<a name='L261'>                   !(server.lua_caller-&gt;flags &amp; <a href='../S/32.html#L173' title='Defined at 173 in src/redis.h.'>REDIS_MASTER</a>))
<a name='L262'>        <font color='red'>{</font>
<a name='L263'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, shared.roslaveerr-&gt;ptr);
<a name='L264'>            <b>goto</b> cleanup;
<a name='L265'>        <font color='red'>}</font> <b>else</b> <b>if</b> (server.stop_writes_on_bgsave_err &amp;&amp;
<a name='L266'>                   server.saveparamslen &gt; 0 &amp;&amp;
<a name='L267'>                   server.lastbgsave_status == <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>)
<a name='L268'>        <font color='red'>{</font>
<a name='L269'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, shared.bgsaveerr-&gt;ptr);
<a name='L270'>            <b>goto</b> cleanup;
<a name='L271'>        <font color='red'>}</font>
<a name='L272'>    <font color='red'>}</font>
<a name='L273'>
<a name='L274'>    <i><font color='green'>/* If we reached the memory limit configured via maxmemory, commands that</font></i>
<a name='L275'><i><font color='green'>     * could enlarge the memory usage are not allowed, but only if this is the</font></i>
<a name='L276'><i><font color='green'>     * first write in the context of this script, otherwise we can't stop</font></i>
<a name='L277'><i><font color='green'>     * in the middle. */</font></i>
<a name='L278'>    <b>if</b> (server.maxmemory &amp;&amp; server.lua_write_dirty == 0 &amp;&amp;
<a name='L279'>        (cmd-&gt;flags &amp; <a href='../S/32.html#L109' title='Defined at 109 in src/redis.h.'>REDIS_CMD_DENYOOM</a>))
<a name='L280'>    <font color='red'>{</font>
<a name='L281'>        <b>if</b> (<a href='../S/35.html#L2228' title='Defined at 2228 in src/redis.c.'>freeMemoryIfNeeded</a>() == <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>) <font color='red'>{</font>
<a name='L282'>            <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, shared.oomerr-&gt;ptr);
<a name='L283'>            <b>goto</b> cleanup;
<a name='L284'>        <font color='red'>}</font>
<a name='L285'>    <font color='red'>}</font>
<a name='L286'>
<a name='L287'>    <b>if</b> (cmd-&gt;flags &amp; <a href='../S/32.html#L114' title='Defined at 114 in src/redis.h.'>REDIS_CMD_RANDOM</a>) server.lua_random_dirty = 1;
<a name='L288'>    <b>if</b> (cmd-&gt;flags &amp; <a href='../S/32.html#L107' title='Defined at 107 in src/redis.h.'>REDIS_CMD_WRITE</a>) server.lua_write_dirty = 1;
<a name='L289'>
<a name='L290'>    <i><font color='green'>/* Run the command */</font></i>
<a name='L291'>    c-&gt;cmd = cmd;
<a name='L292'>    <a href='../S/35.html#L1487' title='Defined at 1487 in src/redis.c.'>call</a>(c,<a href='../S/32.html#L282' title='Defined at 282 in src/redis.h.'>REDIS_CALL_SLOWLOG</a> | <a href='../S/32.html#L283' title='Defined at 283 in src/redis.h.'>REDIS_CALL_STATS</a>);
<a name='L293'>
<a name='L294'>    <i><font color='green'>/* Convert the result of the Redis command into a suitable Lua type.</font></i>
<a name='L295'><i><font color='green'>     * The first thing we need is to create a single string from the client</font></i>
<a name='L296'><i><font color='green'>     * output buffers. */</font></i>
<a name='L297'>    reply = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L298'>    <b>if</b> (c-&gt;bufpos) <font color='red'>{</font>
<a name='L299'>        reply = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(reply,c-&gt;buf,c-&gt;bufpos);
<a name='L300'>        c-&gt;bufpos = 0;
<a name='L301'>    <font color='red'>}</font>
<a name='L302'>    <b>while</b>(<a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(c-&gt;reply)) <font color='red'>{</font>
<a name='L303'>        <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *o = <a href='../S/58.html#L62' title='Defined at 62 in src/adlist.h.'>listNodeValue</a>(<a href='../S/58.html#L58' title='Defined at 58 in src/adlist.h.'>listFirst</a>(c-&gt;reply));
<a name='L304'>
<a name='L305'>        reply = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(reply,o-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(o-&gt;ptr));
<a name='L306'>        <a href='../S/54.html#L159' title='Defined at 159 in src/adlist.c.'>listDelNode</a>(c-&gt;reply,<a href='../S/58.html#L58' title='Defined at 58 in src/adlist.h.'>listFirst</a>(c-&gt;reply));
<a name='L307'>    <font color='red'>}</font>
<a name='L308'>    <b>if</b> (raise_error &amp;&amp; reply[0] != '-') raise_error = 0;
<a name='L309'>    <a href='../S/75.html#L68' title='Defined at 68 in src/scripting.c.'>redisProtocolToLuaType</a>(lua,reply);
<a name='L310'>    <i><font color='green'>/* Sort the output array if needed, assuming it is a non-null multi bulk</font></i>
<a name='L311'><i><font color='green'>     * reply as expected. */</font></i>
<a name='L312'>    <b>if</b> ((cmd-&gt;flags &amp; <a href='../S/32.html#L115' title='Defined at 115 in src/redis.h.'>REDIS_CMD_SORT_FOR_SCRIPT</a>) &amp;&amp;
<a name='L313'>        (reply[0] == '*' &amp;&amp; reply[1] != '-')) <font color='red'>{</font>
<a name='L314'>            <a href='../S/75.html#L167' title='Defined at 167 in src/scripting.c.'>luaSortArray</a>(lua);
<a name='L315'>    <font color='red'>}</font>
<a name='L316'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(reply);
<a name='L317'>    c-&gt;reply_bytes = 0;
<a name='L318'>
<a name='L319'>cleanup:
<a name='L320'>    <i><font color='green'>/* Clean up. Command code may have changed argv/argc so we use the</font></i>
<a name='L321'><i><font color='green'>     * argv/argc of the client instead of the local variables. */</font></i>
<a name='L322'>    <b>for</b> (j = 0; j &lt; c-&gt;argc; j++)
<a name='L323'>        <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(c-&gt;argv[j]);
<a name='L324'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(c-&gt;argv);
<a name='L325'>
<a name='L326'>    <b>if</b> (raise_error) <font color='red'>{</font>
<a name='L327'>        <i><font color='green'>/* If we are here we should have an error in the stack, in the</font></i>
<a name='L328'><i><font color='green'>         * form of a table with an "err" field. Extract the string to</font></i>
<a name='L329'><i><font color='green'>         * return the plain error. */</font></i>
<a name='L330'>        <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"err");
<a name='L331'>        <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);
<a name='L332'>        <b>return</b> <a href='../S/272.html#L964' title='Defined at 964 in deps/lua/src/lapi.c.'>lua_error</a>(lua);
<a name='L333'>    <font color='red'>}</font>
<a name='L334'>    <b>return</b> 1;
<a name='L335'><font color='red'>}</font>
<a name='L336'>
<a name='L337'><b>int</b> <a href='../S/75.html#L542' title='Refered from 542 in src/scripting.c.'>luaRedisCallCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L338'>    <b>return</b> <a href='../S/75.html#L192' title='Defined at 192 in src/scripting.c.'>luaRedisGenericCommand</a>(lua,1);
<a name='L339'><font color='red'>}</font>
<a name='L340'>
<a name='L341'><b>int</b> <a href='../S/75.html#L547' title='Refered from 547 in src/scripting.c.'>luaRedisPCallCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L342'>    <b>return</b> <a href='../S/75.html#L192' title='Defined at 192 in src/scripting.c.'>luaRedisGenericCommand</a>(lua,0);
<a name='L343'><font color='red'>}</font>
<a name='L344'>
<a name='L345'><i><font color='green'>/* This adds redis.sha1hex(string) to Lua scripts using the same hashing</font></i>
<a name='L346'><i><font color='green'> * function used for sha1ing lua scripts. */</font></i>
<a name='L347'><b>int</b> <a href='../S/75.html#L573' title='Refered from 573 in src/scripting.c.'>luaRedisSha1hexCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L348'>    <b>int</b> argc = <a href='../S/272.html#L159' title='Defined at 159 in deps/lua/src/lapi.c.'>lua_gettop</a>(lua);
<a name='L349'>    <b>char</b> digest[41];
<a name='L350'>    size_t len;
<a name='L351'>    <b>char</b> *s;
<a name='L352'>
<a name='L353'>    <b>if</b> (argc != 1) <font color='red'>{</font>
<a name='L354'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "wrong number of arguments");
<a name='L355'>        <b>return</b> 1;
<a name='L356'>    <font color='red'>}</font>
<a name='L357'>
<a name='L358'>    s = (<b>char</b>*)<a href='../S/272.html#L343' title='Defined at 343 in deps/lua/src/lapi.c.'>lua_tolstring</a>(lua,1,&amp;len);
<a name='L359'>    <a href='../S/75.html#L647' title='Defined at 647 in src/scripting.c.'>sha1hex</a>(digest,s,len);
<a name='L360'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,digest);
<a name='L361'>    <b>return</b> 1;
<a name='L362'><font color='red'>}</font>
<a name='L363'>
<a name='L364'><i><font color='green'>/* Returns a table with a single field 'field' set to the string value</font></i>
<a name='L365'><i><font color='green'> * passed as argument. This helper function is handy when returning</font></i>
<a name='L366'><i><font color='green'> * a Redis Protocol error or status reply from Lua:</font></i>
<a name='L367'><i><font color='green'> *</font></i>
<a name='L368'><i><font color='green'> * return redis.error_reply("ERR Some Error")</font></i>
<a name='L369'><i><font color='green'> * return redis.status_reply("ERR Some Error")</font></i>
<a name='L370'><i><font color='green'> */</font></i>
<a name='L371'><b>int</b> <a href='../R/2702.html' title='Multiple refered from 2 places.'>luaRedisReturnSingleFieldTable</a>(lua_State *lua, <b>char</b> *field) <font color='red'>{</font>
<a name='L372'>    <b>if</b> (<a href='../S/272.html#L159' title='Defined at 159 in deps/lua/src/lapi.c.'>lua_gettop</a>(lua) != 1 || <a href='../S/272.html#L242' title='Defined at 242 in deps/lua/src/lapi.c.'>lua_type</a>(lua,-1) != <a href='../S/266.html#L78' title='Defined at 78 in deps/lua/src/lua.h.'>LUA_TSTRING</a>) <font color='red'>{</font>
<a name='L373'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "wrong number or type of arguments");
<a name='L374'>        <b>return</b> 1;
<a name='L375'>    <font color='red'>}</font>
<a name='L376'>
<a name='L377'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L378'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, <a href='../S/304.html#L407' title='Defined at 407 in deps/lua/src/lparser.c.'>field</a>);
<a name='L379'>    <a href='../S/272.html#L228' title='Defined at 228 in deps/lua/src/lapi.c.'>lua_pushvalue</a>(lua, -3);
<a name='L380'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua, -3);
<a name='L381'>    <b>return</b> 1;
<a name='L382'><font color='red'>}</font>
<a name='L383'>
<a name='L384'><b>int</b> <a href='../S/75.html#L578' title='Refered from 578 in src/scripting.c.'>luaRedisErrorReplyCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L385'>    <b>return</b> <a href='../S/75.html#L371' title='Defined at 371 in src/scripting.c.'>luaRedisReturnSingleFieldTable</a>(lua,"err");
<a name='L386'><font color='red'>}</font>
<a name='L387'>
<a name='L388'><b>int</b> <a href='../S/75.html#L581' title='Refered from 581 in src/scripting.c.'>luaRedisStatusReplyCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L389'>    <b>return</b> <a href='../S/75.html#L371' title='Defined at 371 in src/scripting.c.'>luaRedisReturnSingleFieldTable</a>(lua,"ok");
<a name='L390'><font color='red'>}</font>
<a name='L391'>
<a name='L392'><b>int</b> <a href='../S/75.html#L552' title='Refered from 552 in src/scripting.c.'>luaLogCommand</a>(lua_State *lua) <font color='red'>{</font>
<a name='L393'>    <b>int</b> j, argc = <a href='../S/272.html#L159' title='Defined at 159 in deps/lua/src/lapi.c.'>lua_gettop</a>(lua);
<a name='L394'>    <b>int</b> level;
<a name='L395'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> log;
<a name='L396'>
<a name='L397'>    <b>if</b> (argc &lt; 2) <font color='red'>{</font>
<a name='L398'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "redis.log() requires two arguments or more.");
<a name='L399'>        <b>return</b> 1;
<a name='L400'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!<a href='../S/272.html#L260' title='Defined at 260 in deps/lua/src/lapi.c.'>lua_isnumber</a>(lua,-argc)) <font color='red'>{</font>
<a name='L401'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "First argument must be a number (log level).");
<a name='L402'>        <b>return</b> 1;
<a name='L403'>    <font color='red'>}</font>
<a name='L404'>    level = <a href='../S/272.html#L313' title='Defined at 313 in deps/lua/src/lapi.c.'>lua_tonumber</a>(lua,-argc);
<a name='L405'>    <b>if</b> (level &lt; <a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a> || level &gt; <a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>) <font color='red'>{</font>
<a name='L406'>        <a href='../S/75.html#L154' title='Defined at 154 in src/scripting.c.'>luaPushError</a>(lua, "Invalid debug level.");
<a name='L407'>        <b>return</b> 1;
<a name='L408'>    <font color='red'>}</font>
<a name='L409'>
<a name='L410'>    <i><font color='green'>/* Glue together all the arguments */</font></i>
<a name='L411'>    log = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L412'>    <b>for</b> (j = 1; j &lt; argc; j++) <font color='red'>{</font>
<a name='L413'>        size_t len;
<a name='L414'>        <b>char</b> *s;
<a name='L415'>
<a name='L416'>        s = (<b>char</b>*)<a href='../S/272.html#L343' title='Defined at 343 in deps/lua/src/lapi.c.'>lua_tolstring</a>(lua,(-argc)+j,&amp;len);
<a name='L417'>        <b>if</b> (s) <font color='red'>{</font>
<a name='L418'>            <b>if</b> (j != 1) log = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(log," ",1);
<a name='L419'>            log = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(log,s,len);
<a name='L420'>        <font color='red'>}</font>
<a name='L421'>    <font color='red'>}</font>
<a name='L422'>    <a href='../S/35.html#L260' title='Defined at 260 in src/redis.c.'>redisLogRaw</a>(level,log);
<a name='L423'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(log);
<a name='L424'>    <b>return</b> 0;
<a name='L425'><font color='red'>}</font>
<a name='L426'>
<a name='L427'><b>void</b> <a href='../R/2687.html' title='Multiple refered from 3 places.'>luaMaskCountHook</a>(lua_State *lua, lua_Debug *ar) <font color='red'>{</font>
<a name='L428'>    <b>long</b> <b>long</b> elapsed;
<a name='L429'>    <a href='../D/847.html' title='Multiple defined in 3 places.'>REDIS_NOTUSED</a>(ar);
<a name='L430'>    <a href='../D/847.html' title='Multiple defined in 3 places.'>REDIS_NOTUSED</a>(lua);
<a name='L431'>
<a name='L432'>    elapsed = (<a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>()/1000) - server.lua_time_start;
<a name='L433'>    <b>if</b> (elapsed &gt;= server.lua_time_limit &amp;&amp; server.lua_timedout == 0) <font color='red'>{</font>
<a name='L434'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Lua slow script detected: still in execution after %lld milliseconds. You can try killing the script using the SCRIPT KILL command.",elapsed);
<a name='L435'>        server.lua_timedout = 1;
<a name='L436'>        <i><font color='green'>/* Once the script timeouts we reenter the event loop to permit others</font></i>
<a name='L437'><i><font color='green'>         * to call SCRIPT KILL or SHUTDOWN NOSAVE if needed. For this reason</font></i>
<a name='L438'><i><font color='green'>         * we need to mask the client executing the script from the event loop.</font></i>
<a name='L439'><i><font color='green'>         * If we don't do that the client may disconnect and could no longer be</font></i>
<a name='L440'><i><font color='green'>         * here when the EVAL command will return. */</font></i>
<a name='L441'>         <a href='../S/36.html#L121' title='Defined at 121 in src/ae.c.'>aeDeleteFileEvent</a>(server.el, server.lua_caller-&gt;fd, <a href='../S/38.html#L40' title='Defined at 40 in src/ae.h.'>AE_READABLE</a>);
<a name='L442'>    <font color='red'>}</font>
<a name='L443'>    <b>if</b> (server.lua_timedout)
<a name='L444'>        <a href='../S/36.html#L318' title='Defined at 318 in src/ae.c.'>aeProcessEvents</a>(server.el, <a href='../S/38.html#L43' title='Defined at 43 in src/ae.h.'>AE_FILE_EVENTS</a>|<a href='../S/38.html#L46' title='Defined at 46 in src/ae.h.'>AE_DONT_WAIT</a>);
<a name='L445'>    <b>if</b> (server.lua_kill) <font color='red'>{</font>
<a name='L446'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Lua script killed by user with SCRIPT KILL.");
<a name='L447'>        <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"Script killed by user with SCRIPT KILL...");
<a name='L448'>        <a href='../S/272.html#L964' title='Defined at 964 in deps/lua/src/lapi.c.'>lua_error</a>(lua);
<a name='L449'>    <font color='red'>}</font>
<a name='L450'><font color='red'>}</font>
<a name='L451'>
<a name='L452'><b>void</b> <a href='../R/2672.html' title='Multiple refered from 10 places.'>luaLoadLib</a>(lua_State *lua, <b>const</b> <b>char</b> *libname, lua_CFunction luafunc) <font color='red'>{</font>
<a name='L453'>  <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua, luafunc);
<a name='L454'>  <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, libname);
<a name='L455'>  <a href='../S/272.html#L776' title='Defined at 776 in deps/lua/src/lapi.c.'>lua_call</a>(lua, 1, 0);
<a name='L456'><font color='red'>}</font>
<a name='L457'>
<a name='L458'><a href='../S/317.html#L169' title='Defined at 169 in deps/lua/src/luaconf.h.'>LUALIB_API</a> <b>int</b> (<a href='../S/285.html#L1265' title='Defined at 1265 in deps/lua/src/lua_cjson.c.'>luaopen_cjson</a>) (<a href='../D/3087.html' title='Multiple defined in 2 places.'>lua_State</a> *L);
<a name='L459'><a href='../S/317.html#L169' title='Defined at 169 in deps/lua/src/luaconf.h.'>LUALIB_API</a> <b>int</b> (<a href='../S/302.html#L326' title='Defined at 326 in deps/lua/src/lua_struct.c.'>luaopen_struct</a>) (<a href='../D/3087.html' title='Multiple defined in 2 places.'>lua_State</a> *L);
<a name='L460'><a href='../S/317.html#L169' title='Defined at 169 in deps/lua/src/luaconf.h.'>LUALIB_API</a> <b>int</b> (<a href='../S/280.html#L696' title='Defined at 696 in deps/lua/src/lua_cmsgpack.c.'>luaopen_cmsgpack</a>) (<a href='../D/3087.html' title='Multiple defined in 2 places.'>lua_State</a> *L);
<a name='L461'>
<a name='L462'><b>void</b> <a href='../S/75.html#L529' title='Refered from 529 in src/scripting.c.'>luaLoadLibraries</a>(lua_State *lua) <font color='red'>{</font>
<a name='L463'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, "", <a href='../S/277.html#L648' title='Defined at 648 in deps/lua/src/lbaselib.c.'>luaopen_base</a>);
<a name='L464'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L21' title='Defined at 21 in deps/lua/src/lualib.h.'>LUA_TABLIBNAME</a>, <a href='../S/295.html#L283' title='Defined at 283 in deps/lua/src/ltablib.c.'>luaopen_table</a>);
<a name='L465'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L30' title='Defined at 30 in deps/lua/src/lualib.h.'>LUA_STRLIBNAME</a>, <a href='../S/270.html#L860' title='Defined at 860 in deps/lua/src/lstrlib.c.'>luaopen_string</a>);
<a name='L466'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L33' title='Defined at 33 in deps/lua/src/lualib.h.'>LUA_MATHLIBNAME</a>, <a href='../S/276.html#L251' title='Defined at 251 in deps/lua/src/lmathlib.c.'>luaopen_math</a>);
<a name='L467'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L36' title='Defined at 36 in deps/lua/src/lualib.h.'>LUA_DBLIBNAME</a>, <a href='../S/269.html#L393' title='Defined at 393 in deps/lua/src/ldblib.c.'>luaopen_debug</a>); 
<a name='L468'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, "cjson", <a href='../S/285.html#L1265' title='Defined at 1265 in deps/lua/src/lua_cjson.c.'>luaopen_cjson</a>);
<a name='L469'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, "struct", <a href='../S/302.html#L326' title='Defined at 326 in deps/lua/src/lua_struct.c.'>luaopen_struct</a>);
<a name='L470'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, "cmsgpack", <a href='../S/280.html#L696' title='Defined at 696 in deps/lua/src/lua_cmsgpack.c.'>luaopen_cmsgpack</a>);
<a name='L471'>
<a name='L472'><font color='darkred'>#if</font> 0 <i><font color='green'>/* Stuff that we don't load currently, for sandboxing concerns. */</font></i>
<a name='L473'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L39' title='Defined at 39 in deps/lua/src/lualib.h.'>LUA_LOADLIBNAME</a>, <a href='../S/279.html#L627' title='Defined at 627 in deps/lua/src/loadlib.c.'>luaopen_package</a>);
<a name='L474'>    <a href='../S/75.html#L452' title='Defined at 452 in src/scripting.c.'>luaLoadLib</a>(lua, <a href='../S/267.html#L27' title='Defined at 27 in deps/lua/src/lualib.h.'>LUA_OSLIBNAME</a>, <a href='../S/294.html#L239' title='Defined at 239 in deps/lua/src/loslib.c.'>luaopen_os</a>);
<a name='L475'><font color='darkred'>#endif</font>
<a name='L476'><font color='red'>}</font>
<a name='L477'>
<a name='L478'><i><font color='green'>/* Remove a functions that we don't want to expose to the Redis scripting</font></i>
<a name='L479'><i><font color='green'> * environment. */</font></i>
<a name='L480'><b>void</b> <a href='../S/75.html#L530' title='Refered from 530 in src/scripting.c.'>luaRemoveUnsupportedFunctions</a>(lua_State *lua) <font color='red'>{</font>
<a name='L481'>    <a href='../S/272.html#L421' title='Defined at 421 in deps/lua/src/lapi.c.'>lua_pushnil</a>(lua);
<a name='L482'>    <a href='../S/266.html#L276' title='Defined at 276 in deps/lua/src/lua.h.'>lua_setglobal</a>(lua,"loadfile");
<a name='L483'><font color='red'>}</font>
<a name='L484'>
<a name='L485'><i><font color='green'>/* This function installs metamethods in the global table _G that prevent</font></i>
<a name='L486'><i><font color='green'> * the creation of globals accidentally.</font></i>
<a name='L487'><i><font color='green'> *</font></i>
<a name='L488'><i><font color='green'> * It should be the last to be called in the scripting engine initialization</font></i>
<a name='L489'><i><font color='green'> * sequence, because it may interact with creation of globals. */</font></i>
<a name='L490'><b>void</b> <a href='../S/75.html#L624' title='Refered from 624 in src/scripting.c.'>scriptingEnableGlobalsProtection</a>(lua_State *lua) <font color='red'>{</font>
<a name='L491'>    <b>char</b> *s[32];
<a name='L492'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> code = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L493'>    <b>int</b> j = 0;
<a name='L494'>
<a name='L495'>    <i><font color='green'>/* strict.lua from: http://metalua.luaforge.net/src/lib/strict.lua.html.</font></i>
<a name='L496'><i><font color='green'>     * Modified to be adapted to Redis. */</font></i>
<a name='L497'>    s[j++]="local mt = {}\n";
<a name='L498'>    s[j++]="setmetatable(_G, mt)\n";
<a name='L499'>    s[j++]="mt.__newindex = function (t, n, v)\n";
<a name='L500'>    s[j++]="  if debug.getinfo(2) then\n";
<a name='L501'>    s[j++]="    local w = debug.getinfo(2, \"S\").what\n";
<a name='L502'>    s[j++]="    if w ~= \"main\" and w ~= \"C\" then\n";
<a name='L503'>    s[j++]="      error(\"Script attempted to create global variable '\"..tostring(n)..\"'\", 2)\n";
<a name='L504'>    s[j++]="    end\n";
<a name='L505'>    s[j++]="  end\n";
<a name='L506'>    s[j++]="  rawset(t, n, v)\n";
<a name='L507'>    s[j++]="end\n";
<a name='L508'>    s[j++]="mt.__index = function (t, n)\n";
<a name='L509'>    s[j++]="  if debug.getinfo(2) and debug.getinfo(2, \"S\").what ~= \"C\" then\n";
<a name='L510'>    s[j++]="    error(\"Script attempted to access unexisting global variable '\"..tostring(n)..\"'\", 2)\n";
<a name='L511'>    s[j++]="  end\n";
<a name='L512'>    s[j++]="  return rawget(t, n)\n";
<a name='L513'>    s[j++]="end\n";
<a name='L514'>    s[j++]=NULL;
<a name='L515'>
<a name='L516'>    <b>for</b> (j = 0; s[j] != NULL; j++) code = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(code,s[j],strlen(s[j]));
<a name='L517'>    <a href='../S/260.html#L609' title='Defined at 609 in deps/lua/src/lauxlib.c.'>luaL_loadbuffer</a>(lua,code,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(code),"@enable_strict_lua");
<a name='L518'>    <a href='../S/272.html#L805' title='Defined at 805 in deps/lua/src/lapi.c.'>lua_pcall</a>(lua,0,0,0);
<a name='L519'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(code);
<a name='L520'><font color='red'>}</font>
<a name='L521'>
<a name='L522'><i><font color='green'>/* Initialize the scripting environment.</font></i>
<a name='L523'><i><font color='green'> * It is possible to call this function to reset the scripting environment</font></i>
<a name='L524'><i><font color='green'> * assuming that we call scriptingRelease() before.</font></i>
<a name='L525'><i><font color='green'> * See scriptingReset() for more information. */</font></i>
<a name='L526'><b>void</b> <a href='../R/3612.html' title='Multiple refered from 3 places.'>scriptingInit</a>(<b>void</b>) <font color='red'>{</font>
<a name='L527'>    <a href='../D/3087.html' title='Multiple defined in 2 places.'>lua_State</a> *lua = <a href='../S/266.html#L287' title='Defined at 287 in deps/lua/src/lua.h.'>lua_open</a>();
<a name='L528'>
<a name='L529'>    <a href='../S/75.html#L462' title='Defined at 462 in src/scripting.c.'>luaLoadLibraries</a>(lua);
<a name='L530'>    <a href='../S/75.html#L480' title='Defined at 480 in src/scripting.c.'>luaRemoveUnsupportedFunctions</a>(lua);
<a name='L531'>
<a name='L532'>    <i><font color='green'>/* Initialize a dictionary we use to map SHAs to scripts.</font></i>
<a name='L533'><i><font color='green'>     * This is useful for replication, as we need to replicate EVALSHA</font></i>
<a name='L534'><i><font color='green'>     * as EVAL, so we need to remember the associated script. */</font></i>
<a name='L535'>    server.lua_scripts = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;shaScriptObjectDictType,NULL);
<a name='L536'>
<a name='L537'>    <i><font color='green'>/* Register the redis commands table and fields */</font></i>
<a name='L538'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L539'>
<a name='L540'>    <i><font color='green'>/* redis.call */</font></i>
<a name='L541'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"call");
<a name='L542'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua,<a href='../S/75.html#L337' title='Defined at 337 in src/scripting.c.'>luaRedisCallCommand</a>);
<a name='L543'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L544'>
<a name='L545'>    <i><font color='green'>/* redis.pcall */</font></i>
<a name='L546'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"pcall");
<a name='L547'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua,<a href='../S/75.html#L341' title='Defined at 341 in src/scripting.c.'>luaRedisPCallCommand</a>);
<a name='L548'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L549'>
<a name='L550'>    <i><font color='green'>/* redis.log and log levels. */</font></i>
<a name='L551'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"log");
<a name='L552'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua,<a href='../S/75.html#L392' title='Defined at 392 in src/scripting.c.'>luaLogCommand</a>);
<a name='L553'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L554'>
<a name='L555'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"LOG_DEBUG");
<a name='L556'>    <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>);
<a name='L557'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L558'>
<a name='L559'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"LOG_VERBOSE");
<a name='L560'>    <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,<a href='../S/32.html#L230' title='Defined at 230 in src/redis.h.'>REDIS_VERBOSE</a>);
<a name='L561'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L562'>
<a name='L563'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"LOG_NOTICE");
<a name='L564'>    <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>);
<a name='L565'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L566'>
<a name='L567'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"LOG_WARNING");
<a name='L568'>    <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>);
<a name='L569'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L570'>
<a name='L571'>    <i><font color='green'>/* redis.sha1hex */</font></i>
<a name='L572'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, "sha1hex");
<a name='L573'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua, <a href='../S/75.html#L347' title='Defined at 347 in src/scripting.c.'>luaRedisSha1hexCommand</a>);
<a name='L574'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua, -3);
<a name='L575'>
<a name='L576'>    <i><font color='green'>/* redis.error_reply and redis.status_reply */</font></i>
<a name='L577'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, "error_reply");
<a name='L578'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua, <a href='../S/75.html#L384' title='Defined at 384 in src/scripting.c.'>luaRedisErrorReplyCommand</a>);
<a name='L579'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua, -3);
<a name='L580'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua, "status_reply");
<a name='L581'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua, <a href='../S/75.html#L388' title='Defined at 388 in src/scripting.c.'>luaRedisStatusReplyCommand</a>);
<a name='L582'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua, -3);
<a name='L583'>
<a name='L584'>    <i><font color='green'>/* Finally set the table as 'redis' global var. */</font></i>
<a name='L585'>    <a href='../S/266.html#L276' title='Defined at 276 in deps/lua/src/lua.h.'>lua_setglobal</a>(lua,"redis");
<a name='L586'>
<a name='L587'>    <i><font color='green'>/* Replace math.random and math.randomseed with our implementations. */</font></i>
<a name='L588'>    <a href='../S/266.html#L277' title='Defined at 277 in deps/lua/src/lua.h.'>lua_getglobal</a>(lua,"math");
<a name='L589'>
<a name='L590'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"random");
<a name='L591'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua,<a href='../S/75.html#L938' title='Defined at 938 in src/scripting.c.'>redis_math_random</a>);
<a name='L592'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L593'>
<a name='L594'>    <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"randomseed");
<a name='L595'>    <a href='../S/266.html#L260' title='Defined at 260 in deps/lua/src/lua.h.'>lua_pushcfunction</a>(lua,<a href='../S/75.html#L966' title='Defined at 966 in src/scripting.c.'>redis_math_randomseed</a>);
<a name='L596'>    <a href='../S/272.html#L645' title='Defined at 645 in deps/lua/src/lapi.c.'>lua_settable</a>(lua,-3);
<a name='L597'>
<a name='L598'>    <a href='../S/266.html#L276' title='Defined at 276 in deps/lua/src/lua.h.'>lua_setglobal</a>(lua,"math");
<a name='L599'>
<a name='L600'>    <i><font color='green'>/* Add a helper funciton that we use to sort the multi bulk output of non</font></i>
<a name='L601'><i><font color='green'>     * deterministic commands, when containing 'false' elements. */</font></i>
<a name='L602'>    <font color='red'>{</font>
<a name='L603'>        <b>char</b> *compare_func =    "function __redis__compare_helper(a,b)\n"
<a name='L604'>                                "  if a == false then a = '' end\n"
<a name='L605'>                                "  if b == false then b = '' end\n"
<a name='L606'>                                "  return a&lt;b\n"
<a name='L607'>                                "end\n";
<a name='L608'>        <a href='../S/260.html#L609' title='Defined at 609 in deps/lua/src/lauxlib.c.'>luaL_loadbuffer</a>(lua,compare_func,strlen(compare_func),"@cmp_func_def");
<a name='L609'>        <a href='../S/272.html#L805' title='Defined at 805 in deps/lua/src/lapi.c.'>lua_pcall</a>(lua,0,0,0);
<a name='L610'>    <font color='red'>}</font>
<a name='L611'>
<a name='L612'>    <i><font color='green'>/* Create the (non connected) client that we use to execute Redis commands</font></i>
<a name='L613'><i><font color='green'>     * inside the Lua interpreter.</font></i>
<a name='L614'><i><font color='green'>     * Note: there is no need to create it again when this function is called</font></i>
<a name='L615'><i><font color='green'>     * by scriptingReset(). */</font></i>
<a name='L616'>    <b>if</b> (server.lua_client == NULL) <font color='red'>{</font>
<a name='L617'>        server.lua_client = <a href='../D/1966.html' title='Multiple defined in 2 places.'>createClient</a>(-1);
<a name='L618'>        server.lua_client-&gt;flags |= <a href='../S/32.html#L181' title='Defined at 181 in src/redis.h.'>REDIS_LUA_CLIENT</a>;
<a name='L619'>    <font color='red'>}</font>
<a name='L620'>
<a name='L621'>    <i><font color='green'>/* Lua beginners ofter don't use "local", this is likely to introduce</font></i>
<a name='L622'><i><font color='green'>     * subtle bugs in their code. To prevent problems we protect accesses</font></i>
<a name='L623'><i><font color='green'>     * to global variables. */</font></i>
<a name='L624'>    <a href='../S/75.html#L490' title='Defined at 490 in src/scripting.c.'>scriptingEnableGlobalsProtection</a>(lua);
<a name='L625'>
<a name='L626'>    server.lua = lua;
<a name='L627'><font color='red'>}</font>
<a name='L628'>
<a name='L629'><i><font color='green'>/* Release resources related to Lua scripting.</font></i>
<a name='L630'><i><font color='green'> * This function is used in order to reset the scripting environment. */</font></i>
<a name='L631'><b>void</b> <a href='../S/75.html#L637' title='Refered from 637 in src/scripting.c.'>scriptingRelease</a>(<b>void</b>) <font color='red'>{</font>
<a name='L632'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(server.lua_scripts);
<a name='L633'>    <a href='../S/275.html#L199' title='Defined at 199 in deps/lua/src/lstate.c.'>lua_close</a>(server.lua);
<a name='L634'><font color='red'>}</font>
<a name='L635'>
<a name='L636'><b>void</b> <a href='../S/75.html#L977' title='Refered from 977 in src/scripting.c.'>scriptingReset</a>(<b>void</b>) <font color='red'>{</font>
<a name='L637'>    <a href='../S/75.html#L631' title='Defined at 631 in src/scripting.c.'>scriptingRelease</a>();
<a name='L638'>    <a href='../S/75.html#L526' title='Defined at 526 in src/scripting.c.'>scriptingInit</a>();
<a name='L639'><font color='red'>}</font>
<a name='L640'>
<a name='L641'><i><font color='green'>/* Perform the SHA1 of the input string. We use this both for hasing script</font></i>
<a name='L642'><i><font color='green'> * bodies in order to obtain the Lua function name, and in the implementation</font></i>
<a name='L643'><i><font color='green'> * of redis.sha1().</font></i>
<a name='L644'><i><font color='green'> *</font></i>
<a name='L645'><i><font color='green'> * 'digest' should point to a 41 bytes buffer: 40 for SHA1 converted into an</font></i>
<a name='L646'><i><font color='green'> * hexadecimal number, plus 1 byte for null term. */</font></i>
<a name='L647'><b>void</b> <a href='../R/3786.html' title='Multiple refered from 4 places.'>sha1hex</a>(<b>char</b> *digest, <b>char</b> *script, size_t len) <font color='red'>{</font>
<a name='L648'>    <a href='../S/30.html#L12' title='Defined at 12 in src/sha1.h.'>SHA1_CTX</a> ctx;
<a name='L649'>    <b>unsigned</b> <b>char</b> <a href='../D/2394.html' title='Multiple defined in 2 places.'>hash</a>[20];
<a name='L650'>    <b>char</b> *cset = "0123456789abcdef";
<a name='L651'>    <b>int</b> j;
<a name='L652'>
<a name='L653'>    <a href='../S/80.html#L119' title='Defined at 119 in src/sha1.c.'>SHA1Init</a>(&amp;ctx);
<a name='L654'>    <a href='../S/80.html#L133' title='Defined at 133 in src/sha1.c.'>SHA1Update</a>(&amp;ctx,(<b>unsigned</b> <b>char</b>*)script,len);
<a name='L655'>    <a href='../S/80.html#L158' title='Defined at 158 in src/sha1.c.'>SHA1Final</a>(<a href='../D/2394.html' title='Multiple defined in 2 places.'>hash</a>,&amp;ctx);
<a name='L656'>
<a name='L657'>    <b>for</b> (j = 0; j &lt; 20; j++) <font color='red'>{</font>
<a name='L658'>        digest[j*2] = cset[((<a href='../D/2394.html' title='Multiple defined in 2 places.'>hash</a>[j]&amp;0xF0)&gt;&gt;4)];
<a name='L659'>        digest[j*2+1] = cset[(<a href='../D/2394.html' title='Multiple defined in 2 places.'>hash</a>[j]&amp;0xF)];
<a name='L660'>    <font color='red'>}</font>
<a name='L661'>    digest[40] = '\0';
<a name='L662'><font color='red'>}</font>
<a name='L663'>
<a name='L664'><b>void</b> <a href='../R/2706.html' title='Multiple refered from 2 places.'>luaReplyToRedisReply</a>(redisClient *c, lua_State *lua) <font color='red'>{</font>
<a name='L665'>    <b>int</b> t = <a href='../S/272.html#L242' title='Defined at 242 in deps/lua/src/lapi.c.'>lua_type</a>(lua,-1);
<a name='L666'>
<a name='L667'>    <b>switch</b>(t) <font color='red'>{</font>
<a name='L668'>    <b>case</b> <a href='../S/266.html#L78' title='Defined at 78 in deps/lua/src/lua.h.'>LUA_TSTRING</a>:
<a name='L669'>        <a href='../S/86.html#L482' title='Defined at 482 in src/networking.c.'>addReplyBulkCBuffer</a>(c,(<b>char</b>*)<a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1),<a href='../S/266.html#L262' title='Defined at 262 in deps/lua/src/lua.h.'>lua_strlen</a>(lua,-1));
<a name='L670'>        <b>break</b>;
<a name='L671'>    <b>case</b> <a href='../S/266.html#L75' title='Defined at 75 in deps/lua/src/lua.h.'>LUA_TBOOLEAN</a>:
<a name='L672'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,<a href='../S/272.html#L337' title='Defined at 337 in deps/lua/src/lapi.c.'>lua_toboolean</a>(lua,-1) ? shared.cone : shared.nullbulk);
<a name='L673'>        <b>break</b>;
<a name='L674'>    <b>case</b> <a href='../S/266.html#L77' title='Defined at 77 in deps/lua/src/lua.h.'>LUA_TNUMBER</a>:
<a name='L675'>        <a href='../S/86.html#L439' title='Defined at 439 in src/networking.c.'>addReplyLongLong</a>(c,(<b>long</b> <b>long</b>)<a href='../S/272.html#L313' title='Defined at 313 in deps/lua/src/lapi.c.'>lua_tonumber</a>(lua,-1));
<a name='L676'>        <b>break</b>;
<a name='L677'>    <b>case</b> <a href='../S/266.html#L79' title='Defined at 79 in deps/lua/src/lua.h.'>LUA_TTABLE</a>:
<a name='L678'>        <i><font color='green'>/* We need to check if it is an array, an error, or a status reply.</font></i>
<a name='L679'><i><font color='green'>         * Error are returned as a single element table with 'err' field.</font></i>
<a name='L680'><i><font color='green'>         * Status replies are returned as single elment table with 'ok' field */</font></i>
<a name='L681'>        <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"err");
<a name='L682'>        <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);
<a name='L683'>        t = <a href='../S/272.html#L242' title='Defined at 242 in deps/lua/src/lapi.c.'>lua_type</a>(lua,-1);
<a name='L684'>        <b>if</b> (t == <a href='../S/266.html#L78' title='Defined at 78 in deps/lua/src/lua.h.'>LUA_TSTRING</a>) <font color='red'>{</font>
<a name='L685'>            <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> err = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(<a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1));
<a name='L686'>            <a href='../S/63.html#L607' title='Defined at 607 in src/sds.c.'>sdsmapchars</a>(err,"\r\n","  ",2);
<a name='L687'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(<a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>(),"-%s\r\n",err));
<a name='L688'>            <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(err);
<a name='L689'>            <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,2);
<a name='L690'>            <b>return</b>;
<a name='L691'>        <font color='red'>}</font>
<a name='L692'>
<a name='L693'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L694'>        <a href='../S/272.html#L454' title='Defined at 454 in deps/lua/src/lapi.c.'>lua_pushstring</a>(lua,"ok");
<a name='L695'>        <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);
<a name='L696'>        t = <a href='../S/272.html#L242' title='Defined at 242 in deps/lua/src/lapi.c.'>lua_type</a>(lua,-1);
<a name='L697'>        <b>if</b> (t == <a href='../S/266.html#L78' title='Defined at 78 in deps/lua/src/lua.h.'>LUA_TSTRING</a>) <font color='red'>{</font>
<a name='L698'>            <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> <a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a> = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(<a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1));
<a name='L699'>            <a href='../S/63.html#L607' title='Defined at 607 in src/sds.c.'>sdsmapchars</a>(<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>,"\r\n","  ",2);
<a name='L700'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(<a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>(),"+%s\r\n",<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>));
<a name='L701'>            <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>);
<a name='L702'>            <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L703'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L704'>            <b>void</b> *replylen = <a href='../S/86.html#L371' title='Defined at 371 in src/networking.c.'>addDeferredMultiBulkLength</a>(c);
<a name='L705'>            <b>int</b> j = 1, mbulklen = 0;
<a name='L706'>
<a name='L707'>            <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1); <i><font color='green'>/* Discard the 'ok' field value we popped */</font></i>
<a name='L708'>            <b>while</b>(1) <font color='red'>{</font>
<a name='L709'>                <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(lua,j++);
<a name='L710'>                <a href='../S/272.html#L534' title='Defined at 534 in deps/lua/src/lapi.c.'>lua_gettable</a>(lua,-2);
<a name='L711'>                t = <a href='../S/272.html#L242' title='Defined at 242 in deps/lua/src/lapi.c.'>lua_type</a>(lua,-1);
<a name='L712'>                <b>if</b> (t == <a href='../S/266.html#L74' title='Defined at 74 in deps/lua/src/lua.h.'>LUA_TNIL</a>) <font color='red'>{</font>
<a name='L713'>                    <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L714'>                    <b>break</b>;
<a name='L715'>                <font color='red'>}</font>
<a name='L716'>                <a href='../S/75.html#L664' title='Defined at 664 in src/scripting.c.'>luaReplyToRedisReply</a>(c, lua);
<a name='L717'>                mbulklen++;
<a name='L718'>            <font color='red'>}</font>
<a name='L719'>            <a href='../S/86.html#L381' title='Defined at 381 in src/networking.c.'>setDeferredMultiBulkLength</a>(c,replylen,mbulklen);
<a name='L720'>        <font color='red'>}</font>
<a name='L721'>        <b>break</b>;
<a name='L722'>    <b>default</b>:
<a name='L723'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.nullbulk);
<a name='L724'>    <font color='red'>}</font>
<a name='L725'>    <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L726'><font color='red'>}</font>
<a name='L727'>
<a name='L728'><i><font color='green'>/* Set an array of Redis String Objects as a Lua array (table) stored into a</font></i>
<a name='L729'><i><font color='green'> * global variable. */</font></i>
<a name='L730'><b>void</b> <a href='../R/2713.html' title='Multiple refered from 2 places.'>luaSetGlobalArray</a>(lua_State *lua, <b>char</b> *var, robj **elev, <b>int</b> elec) <font color='red'>{</font>
<a name='L731'>    <b>int</b> j;
<a name='L732'>
<a name='L733'>    <a href='../S/266.html#L256' title='Defined at 256 in deps/lua/src/lua.h.'>lua_newtable</a>(lua);
<a name='L734'>    <b>for</b> (j = 0; j &lt; elec; j++) <font color='red'>{</font>
<a name='L735'>        <a href='../S/272.html#L445' title='Defined at 445 in deps/lua/src/lapi.c.'>lua_pushlstring</a>(lua,(<b>char</b>*)elev[j]-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(elev[j]-&gt;ptr));
<a name='L736'>        <a href='../S/272.html#L684' title='Defined at 684 in deps/lua/src/lapi.c.'>lua_rawseti</a>(lua,-2,j+1);
<a name='L737'>    <font color='red'>}</font>
<a name='L738'>    <a href='../S/266.html#L276' title='Defined at 276 in deps/lua/src/lua.h.'>lua_setglobal</a>(lua,var);
<a name='L739'><font color='red'>}</font>
<a name='L740'>
<a name='L741'><i><font color='green'>/* Define a lua function with the specified function name and body.</font></i>
<a name='L742'><i><font color='green'> * The function name musts be a 2 characters long string, since all the</font></i>
<a name='L743'><i><font color='green'> * functions we defined in the Lua context are in the form:</font></i>
<a name='L744'><i><font color='green'> *</font></i>
<a name='L745'><i><font color='green'> *   f_&lt;hex sha1 sum&gt;</font></i>
<a name='L746'><i><font color='green'> *</font></i>
<a name='L747'><i><font color='green'> * On success REDIS_OK is returned, and nothing is left on the Lua stack.</font></i>
<a name='L748'><i><font color='green'> * On error REDIS_ERR is returned and an appropriate error is set in the</font></i>
<a name='L749'><i><font color='green'> * client context. */</font></i>
<a name='L750'><b>int</b> <a href='../R/2541.html' title='Multiple refered from 2 places.'>luaCreateFunction</a>(redisClient *c, lua_State *lua, <b>char</b> *funcname, robj *body) <font color='red'>{</font>
<a name='L751'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> funcdef = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L752'>
<a name='L753'>    funcdef = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(funcdef,"function ");
<a name='L754'>    funcdef = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(funcdef,<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>,42);
<a name='L755'>    funcdef = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(funcdef,"() ",3);
<a name='L756'>    funcdef = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(funcdef,<a href='../S/304.html#L576' title='Defined at 576 in deps/lua/src/lparser.c.'>body</a>-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(<a href='../S/304.html#L576' title='Defined at 576 in deps/lua/src/lparser.c.'>body</a>-&gt;ptr));
<a name='L757'>    funcdef = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(funcdef," end",4);
<a name='L758'>
<a name='L759'>    <b>if</b> (<a href='../S/260.html#L609' title='Defined at 609 in deps/lua/src/lauxlib.c.'>luaL_loadbuffer</a>(lua,funcdef,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(funcdef),"@user_script")) <font color='red'>{</font>
<a name='L760'>        <a href='../S/86.html#L334' title='Defined at 334 in src/networking.c.'>addReplyErrorFormat</a>(c,"Error compiling script (new function): %s\n",
<a name='L761'>            <a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1));
<a name='L762'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L763'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(funcdef);
<a name='L764'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L765'>    <font color='red'>}</font>
<a name='L766'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(funcdef);
<a name='L767'>    <b>if</b> (<a href='../S/272.html#L805' title='Defined at 805 in deps/lua/src/lapi.c.'>lua_pcall</a>(lua,0,0,0)) <font color='red'>{</font>
<a name='L768'>        <a href='../S/86.html#L334' title='Defined at 334 in src/networking.c.'>addReplyErrorFormat</a>(c,"Error running script (new function): %s\n",
<a name='L769'>            <a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1));
<a name='L770'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L771'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L772'>    <font color='red'>}</font>
<a name='L773'>
<a name='L774'>    <i><font color='green'>/* We also save a SHA1 -&gt; Original script map in a dictionary</font></i>
<a name='L775'><i><font color='green'>     * so that we can replicate / write in the AOF all the</font></i>
<a name='L776'><i><font color='green'>     * EVALSHA commands as EVAL using the original script. */</font></i>
<a name='L777'>    <font color='red'>{</font>
<a name='L778'>        <b>int</b> retval = <a href='../D/2061.html' title='Multiple defined in 2 places.'>dictAdd</a>(server.lua_scripts,
<a name='L779'>                             <a href='../D/4014.html' title='Multiple defined in 2 places.'>sdsnewlen</a>(<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>+2,40),<a href='../S/304.html#L576' title='Defined at 576 in deps/lua/src/lparser.c.'>body</a>);
<a name='L780'>        <a href='../S/32.html#L298' title='Defined at 298 in src/redis.h.'>redisAssertWithInfo</a>(c,NULL,retval == <a href='../D/124.html' title='Multiple defined in 2 places.'>DICT_OK</a>);
<a name='L781'>        <a href='../S/71.html#L214' title='Defined at 214 in src/object.c.'>incrRefCount</a>(<a href='../S/304.html#L576' title='Defined at 576 in deps/lua/src/lparser.c.'>body</a>);
<a name='L782'>    <font color='red'>}</font>
<a name='L783'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L784'><font color='red'>}</font>
<a name='L785'>
<a name='L786'><b>void</b> <a href='../R/1900.html' title='Multiple refered from 2 places.'>evalGenericCommand</a>(redisClient *c, <b>int</b> evalsha) <font color='red'>{</font>
<a name='L787'>    <a href='../D/3087.html' title='Multiple defined in 2 places.'>lua_State</a> *lua = server.lua;
<a name='L788'>    <b>char</b> <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[43];
<a name='L789'>    <b>long</b> <b>long</b> numkeys;
<a name='L790'>    <b>int</b> delhook = 0;
<a name='L791'>
<a name='L792'>    <i><font color='green'>/* We want the same PRNG sequence at every call so that our PRNG is</font></i>
<a name='L793'><i><font color='green'>     * not affected by external state. */</font></i>
<a name='L794'>    <a href='../S/22.html#L76' title='Defined at 76 in src/rand.c.'>redisSrand48</a>(0);
<a name='L795'>
<a name='L796'>    <i><font color='green'>/* We set this flag to zero to remember that so far no random command</font></i>
<a name='L797'><i><font color='green'>     * was called. This way we can allow the user to call commands like</font></i>
<a name='L798'><i><font color='green'>     * SRANDMEMBER or RANDOMKEY from Lua scripts as far as no write command</font></i>
<a name='L799'><i><font color='green'>     * is called (otherwise the replication and AOF would end with non</font></i>
<a name='L800'><i><font color='green'>     * deterministic sequences).</font></i>
<a name='L801'><i><font color='green'>     *</font></i>
<a name='L802'><i><font color='green'>     * Thanks to this flag we'll raise an error every time a write command</font></i>
<a name='L803'><i><font color='green'>     * is called after a random command was used. */</font></i>
<a name='L804'>    server.lua_random_dirty = 0;
<a name='L805'>    server.lua_write_dirty = 0;
<a name='L806'>
<a name='L807'>    <i><font color='green'>/* Get the number of arguments that are keys */</font></i>
<a name='L808'>    <b>if</b> (<a href='../S/71.html#L484' title='Defined at 484 in src/object.c.'>getLongLongFromObjectOrReply</a>(c,c-&gt;argv[2],&amp;numkeys,NULL) != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>)
<a name='L809'>        <b>return</b>;
<a name='L810'>    <b>if</b> (numkeys &gt; (c-&gt;argc - 3)) <font color='red'>{</font>
<a name='L811'>        <a href='../S/86.html#L330' title='Defined at 330 in src/networking.c.'>addReplyError</a>(c,"Number of keys can't be greater than number of args");
<a name='L812'>        <b>return</b>;
<a name='L813'>    <font color='red'>}</font>
<a name='L814'>
<a name='L815'>    <i><font color='green'>/* We obtain the script SHA1, then check if this function is already</font></i>
<a name='L816'><i><font color='green'>     * defined into the Lua state */</font></i>
<a name='L817'>    <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[0] = 'f';
<a name='L818'>    <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[1] = '_';
<a name='L819'>    <b>if</b> (!evalsha) <font color='red'>{</font>
<a name='L820'>        <i><font color='green'>/* Hash the code if this is an EVAL call */</font></i>
<a name='L821'>        <a href='../S/75.html#L647' title='Defined at 647 in src/scripting.c.'>sha1hex</a>(<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>+2,c-&gt;argv[1]-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(c-&gt;argv[1]-&gt;ptr));
<a name='L822'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L823'>        <i><font color='green'>/* We already have the SHA if it is a EVALSHA */</font></i>
<a name='L824'>        <b>int</b> j;
<a name='L825'>        <b>char</b> *sha = c-&gt;argv[1]-&gt;ptr;
<a name='L826'>
<a name='L827'>        <b>for</b> (j = 0; j &lt; 40; j++)
<a name='L828'>            <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[j+2] = tolower(sha[j]);
<a name='L829'>        <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[42] = '\0';
<a name='L830'>    <font color='red'>}</font>
<a name='L831'>
<a name='L832'>    <i><font color='green'>/* Try to lookup the Lua function */</font></i>
<a name='L833'>    <a href='../S/266.html#L277' title='Defined at 277 in deps/lua/src/lua.h.'>lua_getglobal</a>(lua, <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>);
<a name='L834'>    <b>if</b> (<a href='../S/266.html#L267' title='Defined at 267 in deps/lua/src/lua.h.'>lua_isnil</a>(lua,1)) <font color='red'>{</font>
<a name='L835'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1); <i><font color='green'>/* remove the nil from the stack */</font></i>
<a name='L836'>        <i><font color='green'>/* Function not defined... let's define it if we have the</font></i>
<a name='L837'><i><font color='green'>         * body of the funciton. If this is an EVALSHA call we can just</font></i>
<a name='L838'><i><font color='green'>         * return an error. */</font></i>
<a name='L839'>        <b>if</b> (evalsha) <font color='red'>{</font>
<a name='L840'>            <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c, shared.noscripterr);
<a name='L841'>            <b>return</b>;
<a name='L842'>        <font color='red'>}</font>
<a name='L843'>        <b>if</b> (<a href='../S/75.html#L750' title='Defined at 750 in src/scripting.c.'>luaCreateFunction</a>(c,lua,<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>,c-&gt;argv[1]) == <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>) <b>return</b>;
<a name='L844'>        <i><font color='green'>/* Now the following is guaranteed to return non nil */</font></i>
<a name='L845'>        <a href='../S/266.html#L277' title='Defined at 277 in deps/lua/src/lua.h.'>lua_getglobal</a>(lua, <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>);
<a name='L846'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(!<a href='../S/266.html#L267' title='Defined at 267 in deps/lua/src/lua.h.'>lua_isnil</a>(lua,1));
<a name='L847'>    <font color='red'>}</font>
<a name='L848'>
<a name='L849'>    <i><font color='green'>/* Populate the argv and keys table accordingly to the arguments that</font></i>
<a name='L850'><i><font color='green'>     * EVAL received. */</font></i>
<a name='L851'>    <a href='../S/75.html#L730' title='Defined at 730 in src/scripting.c.'>luaSetGlobalArray</a>(lua,"KEYS",c-&gt;argv+3,numkeys);
<a name='L852'>    <a href='../S/75.html#L730' title='Defined at 730 in src/scripting.c.'>luaSetGlobalArray</a>(lua,"ARGV",c-&gt;argv+3+numkeys,c-&gt;argc-3-numkeys);
<a name='L853'>
<a name='L854'>    <i><font color='green'>/* Select the right DB in the context of the Lua client */</font></i>
<a name='L855'>    <a href='../S/31.html#L181' title='Defined at 181 in src/db.c.'>selectDb</a>(server.lua_client,c-&gt;db-&gt;id);
<a name='L856'>    
<a name='L857'>    <i><font color='green'>/* Set an hook in order to be able to stop the script execution if it</font></i>
<a name='L858'><i><font color='green'>     * is running for too much time.</font></i>
<a name='L859'><i><font color='green'>     * We set the hook only if the time limit is enabled as the hook will</font></i>
<a name='L860'><i><font color='green'>     * make the Lua script execution slower. */</font></i>
<a name='L861'>    server.lua_caller = c;
<a name='L862'>    server.lua_time_start = <a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>()/1000;
<a name='L863'>    server.lua_kill = 0;
<a name='L864'>    <b>if</b> (server.lua_time_limit &gt; 0 &amp;&amp; server.masterhost == NULL) <font color='red'>{</font>
<a name='L865'>        <a href='../S/299.html#L56' title='Defined at 56 in deps/lua/src/ldebug.c.'>lua_sethook</a>(lua,<a href='../S/75.html#L427' title='Defined at 427 in src/scripting.c.'>luaMaskCountHook</a>,<a href='../S/266.html#L324' title='Defined at 324 in deps/lua/src/lua.h.'>LUA_MASKCOUNT</a>,100000);
<a name='L866'>        delhook = 1;
<a name='L867'>    <font color='red'>}</font>
<a name='L868'>
<a name='L869'>    <i><font color='green'>/* At this point whatever this script was never seen before or if it was</font></i>
<a name='L870'><i><font color='green'>     * already defined, we can call it. We have zero arguments and expect</font></i>
<a name='L871'><i><font color='green'>     * a single return value. */</font></i>
<a name='L872'>    <b>if</b> (<a href='../S/272.html#L805' title='Defined at 805 in deps/lua/src/lapi.c.'>lua_pcall</a>(lua,0,1,0)) <font color='red'>{</font>
<a name='L873'>        <b>if</b> (delhook) <a href='../S/299.html#L56' title='Defined at 56 in deps/lua/src/ldebug.c.'>lua_sethook</a>(lua,<a href='../S/75.html#L427' title='Defined at 427 in src/scripting.c.'>luaMaskCountHook</a>,0,0); <i><font color='green'>/* Disable hook */</font></i>
<a name='L874'>        <b>if</b> (server.lua_timedout) <font color='red'>{</font>
<a name='L875'>            server.lua_timedout = 0;
<a name='L876'>            <i><font color='green'>/* Restore the readable handler that was unregistered when the</font></i>
<a name='L877'><i><font color='green'>             * script timeout was detected. */</font></i>
<a name='L878'>            <a href='../S/36.html#L104' title='Defined at 104 in src/ae.c.'>aeCreateFileEvent</a>(server.el,c-&gt;fd,<a href='../S/38.html#L40' title='Defined at 40 in src/ae.h.'>AE_READABLE</a>,
<a name='L879'>                              <a href='../S/86.html#L1013' title='Defined at 1013 in src/networking.c.'>readQueryFromClient</a>,c);
<a name='L880'>        <font color='red'>}</font>
<a name='L881'>        server.lua_caller = NULL;
<a name='L882'>        <a href='../S/31.html#L181' title='Defined at 181 in src/db.c.'>selectDb</a>(c,server.lua_client-&gt;db-&gt;id); <i><font color='green'>/* set DB ID from Lua client */</font></i>
<a name='L883'>        <a href='../S/86.html#L334' title='Defined at 334 in src/networking.c.'>addReplyErrorFormat</a>(c,"Error running script (call to %s): %s\n",
<a name='L884'>            <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>, <a href='../S/266.html#L279' title='Defined at 279 in deps/lua/src/lua.h.'>lua_tostring</a>(lua,-1));
<a name='L885'>        <a href='../S/266.html#L254' title='Defined at 254 in deps/lua/src/lua.h.'>lua_pop</a>(lua,1);
<a name='L886'>        <a href='../S/272.html#L899' title='Defined at 899 in deps/lua/src/lapi.c.'>lua_gc</a>(lua,<a href='../S/266.html#L223' title='Defined at 223 in deps/lua/src/lua.h.'>LUA_GCCOLLECT</a>,0);
<a name='L887'>        <b>return</b>;
<a name='L888'>    <font color='red'>}</font>
<a name='L889'>    <b>if</b> (delhook) <a href='../S/299.html#L56' title='Defined at 56 in deps/lua/src/ldebug.c.'>lua_sethook</a>(lua,<a href='../S/75.html#L427' title='Defined at 427 in src/scripting.c.'>luaMaskCountHook</a>,0,0); <i><font color='green'>/* Disable hook */</font></i>
<a name='L890'>    server.lua_timedout = 0;
<a name='L891'>    server.lua_caller = NULL;
<a name='L892'>    <a href='../S/31.html#L181' title='Defined at 181 in src/db.c.'>selectDb</a>(c,server.lua_client-&gt;db-&gt;id); <i><font color='green'>/* set DB ID from Lua client */</font></i>
<a name='L893'>    <a href='../S/75.html#L664' title='Defined at 664 in src/scripting.c.'>luaReplyToRedisReply</a>(c,lua);
<a name='L894'>    <a href='../S/272.html#L899' title='Defined at 899 in deps/lua/src/lapi.c.'>lua_gc</a>(lua,<a href='../S/266.html#L226' title='Defined at 226 in deps/lua/src/lua.h.'>LUA_GCSTEP</a>,1);
<a name='L895'>
<a name='L896'>    <i><font color='green'>/* If we have slaves attached we want to replicate this command as</font></i>
<a name='L897'><i><font color='green'>     * EVAL instead of EVALSHA. We do this also in the AOF as currently there</font></i>
<a name='L898'><i><font color='green'>     * is no easy way to propagate a command in a different way in the AOF</font></i>
<a name='L899'><i><font color='green'>     * and in the replication link.</font></i>
<a name='L900'><i><font color='green'>     *</font></i>
<a name='L901'><i><font color='green'>     * IMPROVEMENT POSSIBLE:</font></i>
<a name='L902'><i><font color='green'>     * 1) Replicate this command as EVALSHA in the AOF.</font></i>
<a name='L903'><i><font color='green'>     * 2) Remember what slave already received a given script, and replicate</font></i>
<a name='L904'><i><font color='green'>     *    the EVALSHA against this slaves when possible.</font></i>
<a name='L905'><i><font color='green'>     */</font></i>
<a name='L906'>    <b>if</b> (evalsha) <font color='red'>{</font>
<a name='L907'>        <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *script = <a href='../S/29.html#L501' title='Defined at 501 in src/dict.c.'>dictFetchValue</a>(server.lua_scripts,c-&gt;argv[1]-&gt;ptr);
<a name='L908'>
<a name='L909'>        <a href='../S/32.html#L298' title='Defined at 298 in src/redis.h.'>redisAssertWithInfo</a>(c,NULL,script != NULL);
<a name='L910'>        <a href='../S/86.html#L1228' title='Defined at 1228 in src/networking.c.'>rewriteClientCommandArgument</a>(c,0,
<a name='L911'>            <a href='../S/71.html#L249' title='Defined at 249 in src/object.c.'>resetRefCount</a>(<a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>("EVAL",4)));
<a name='L912'>        <a href='../S/86.html#L1228' title='Defined at 1228 in src/networking.c.'>rewriteClientCommandArgument</a>(c,1,script);
<a name='L913'>    <font color='red'>}</font>
<a name='L914'><font color='red'>}</font>
<a name='L915'>
<a name='L916'><b>void</b> <a href='../R/1899.html' title='Multiple refered from 2 places.'>evalCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L917'>    <a href='../S/75.html#L786' title='Defined at 786 in src/scripting.c.'>evalGenericCommand</a>(c,0);
<a name='L918'><font color='red'>}</font>
<a name='L919'>
<a name='L920'><b>void</b> <a href='../R/1902.html' title='Multiple refered from 2 places.'>evalShaCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L921'>    <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(c-&gt;argv[1]-&gt;ptr) != 40) <font color='red'>{</font>
<a name='L922'>        <i><font color='green'>/* We know that a match is not possible if the provided SHA is</font></i>
<a name='L923'><i><font color='green'>         * not the right length. So we return an error ASAP, this way</font></i>
<a name='L924'><i><font color='green'>         * evalGenericCommand() can be implemented without string length</font></i>
<a name='L925'><i><font color='green'>         * sanity check */</font></i>
<a name='L926'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c, shared.noscripterr);
<a name='L927'>        <b>return</b>;
<a name='L928'>    <font color='red'>}</font>
<a name='L929'>    <a href='../S/75.html#L786' title='Defined at 786 in src/scripting.c.'>evalGenericCommand</a>(c,1);
<a name='L930'><font color='red'>}</font>
<a name='L931'>
<a name='L932'><i><font color='green'>/* We replace math.random() with our implementation that is not affected</font></i>
<a name='L933'><i><font color='green'> * by specific libc random() implementations and will output the same sequence</font></i>
<a name='L934'><i><font color='green'> * (for the same seed) in every arch. */</font></i>
<a name='L935'>
<a name='L936'><i><font color='green'>/* The following implementation is the one shipped with Lua itself but with</font></i>
<a name='L937'><i><font color='green'> * rand() replaced by redisLrand48(). */</font></i>
<a name='L938'><b>int</b> <a href='../R/3503.html' title='Multiple refered from 2 places.'>redis_math_random</a> (lua_State *L) <font color='red'>{</font>
<a name='L939'>  <i><font color='green'>/* the `%' avoids the (rare) case of r==1, and is needed also because on</font></i>
<a name='L940'><i><font color='green'>     some systems (SunOS!) `rand()' may return a value larger than RAND_MAX */</font></i>
<a name='L941'>  <a href='../S/266.html#L99' title='Defined at 99 in deps/lua/src/lua.h.'>lua_Number</a> r = (<a href='../S/266.html#L99' title='Defined at 99 in deps/lua/src/lua.h.'>lua_Number</a>)(<a href='../S/22.html#L71' title='Defined at 71 in src/rand.c.'>redisLrand48</a>()%<a href='../S/83.html#L36' title='Defined at 36 in src/rand.h.'>REDIS_LRAND48_MAX</a>) /
<a name='L942'>                                (<a href='../S/266.html#L99' title='Defined at 99 in deps/lua/src/lua.h.'>lua_Number</a>)<a href='../S/83.html#L36' title='Defined at 36 in src/rand.h.'>REDIS_LRAND48_MAX</a>;
<a name='L943'>  <b>switch</b> (<a href='../S/272.html#L159' title='Defined at 159 in deps/lua/src/lapi.c.'>lua_gettop</a>(L)) <font color='red'>{</font>  <i><font color='green'>/* check number of arguments */</font></i>
<a name='L944'>    <b>case</b> 0: <font color='red'>{</font>  <i><font color='green'>/* no arguments */</font></i>
<a name='L945'>      <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(L, r);  <i><font color='green'>/* Number between 0 and 1 */</font></i>
<a name='L946'>      <b>break</b>;
<a name='L947'>    <font color='red'>}</font>
<a name='L948'>    <b>case</b> 1: <font color='red'>{</font>  <i><font color='green'>/* only upper limit */</font></i>
<a name='L949'>      <b>int</b> u = <a href='../S/265.html#L104' title='Defined at 104 in deps/lua/src/lauxlib.h.'>luaL_checkint</a>(L, 1);
<a name='L950'>      <a href='../S/265.html#L100' title='Defined at 100 in deps/lua/src/lauxlib.h.'>luaL_argcheck</a>(L, 1&lt;=u, 1, "interval is empty");
<a name='L951'>      <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(L, floor(r*u)+1);  <i><font color='green'>/* int between 1 and `u' */</font></i>
<a name='L952'>      <b>break</b>;
<a name='L953'>    <font color='red'>}</font>
<a name='L954'>    <b>case</b> 2: <font color='red'>{</font>  <i><font color='green'>/* lower and upper limits */</font></i>
<a name='L955'>      <b>int</b> l = <a href='../S/265.html#L104' title='Defined at 104 in deps/lua/src/lauxlib.h.'>luaL_checkint</a>(L, 1);
<a name='L956'>      <b>int</b> u = <a href='../S/265.html#L104' title='Defined at 104 in deps/lua/src/lauxlib.h.'>luaL_checkint</a>(L, 2);
<a name='L957'>      <a href='../S/265.html#L100' title='Defined at 100 in deps/lua/src/lauxlib.h.'>luaL_argcheck</a>(L, l&lt;=u, 2, "interval is empty");
<a name='L958'>      <a href='../S/272.html#L429' title='Defined at 429 in deps/lua/src/lapi.c.'>lua_pushnumber</a>(L, floor(r*(u-l+1))+l);  <i><font color='green'>/* int between `l' and `u' */</font></i>
<a name='L959'>      <b>break</b>;
<a name='L960'>    <font color='red'>}</font>
<a name='L961'>    <b>default</b>: <b>return</b> <a href='../S/260.html#L86' title='Defined at 86 in deps/lua/src/lauxlib.c.'>luaL_error</a>(L, "wrong number of arguments");
<a name='L962'>  <font color='red'>}</font>
<a name='L963'>  <b>return</b> 1;
<a name='L964'><font color='red'>}</font>
<a name='L965'>
<a name='L966'><b>int</b> <a href='../R/3504.html' title='Multiple refered from 2 places.'>redis_math_randomseed</a> (lua_State *L) <font color='red'>{</font>
<a name='L967'>  <a href='../S/22.html#L76' title='Defined at 76 in src/rand.c.'>redisSrand48</a>(<a href='../S/265.html#L104' title='Defined at 104 in deps/lua/src/lauxlib.h.'>luaL_checkint</a>(L, 1));
<a name='L968'>  <b>return</b> 0;
<a name='L969'><font color='red'>}</font>
<a name='L970'>
<a name='L971'><i><font color='green'>/* ---------------------------------------------------------------------------</font></i>
<a name='L972'><i><font color='green'> * SCRIPT command for script environment introspection and control</font></i>
<a name='L973'><i><font color='green'> * ------------------------------------------------------------------------- */</font></i>
<a name='L974'>
<a name='L975'><b>void</b> <a href='../R/3610.html' title='Multiple refered from 3 places.'>scriptCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L976'>    <b>if</b> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,"flush")) <font color='red'>{</font>
<a name='L977'>        <a href='../S/75.html#L636' title='Defined at 636 in src/scripting.c.'>scriptingReset</a>();
<a name='L978'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>);
<a name='L979'>        server.dirty++; <i><font color='green'>/* Replicating this command is a good idea. */</font></i>
<a name='L980'>    <font color='red'>}</font> <b>else</b> <b>if</b> (c-&gt;argc &gt;= 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,"exists")) <font color='red'>{</font>
<a name='L981'>        <b>int</b> j;
<a name='L982'>
<a name='L983'>        <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c, c-&gt;argc-2);
<a name='L984'>        <b>for</b> (j = 2; j &lt; c-&gt;argc; j++) <font color='red'>{</font>
<a name='L985'>            <b>if</b> (<a href='../D/2076.html' title='Multiple defined in 2 places.'>dictFind</a>(server.lua_scripts,c-&gt;argv[j]-&gt;ptr))
<a name='L986'>                <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.cone);
<a name='L987'>            <b>else</b>
<a name='L988'>                <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.czero);
<a name='L989'>        <font color='red'>}</font>
<a name='L990'>    <font color='red'>}</font> <b>else</b> <b>if</b> (c-&gt;argc == 3 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,"load")) <font color='red'>{</font>
<a name='L991'>        <b>char</b> <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[43];
<a name='L992'>        <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> sha;
<a name='L993'>
<a name='L994'>        <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[0] = 'f';
<a name='L995'>        <a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>[1] = '_';
<a name='L996'>        <a href='../S/75.html#L647' title='Defined at 647 in src/scripting.c.'>sha1hex</a>(<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>+2,c-&gt;argv[2]-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(c-&gt;argv[2]-&gt;ptr));
<a name='L997'>        sha = <a href='../D/4014.html' title='Multiple defined in 2 places.'>sdsnewlen</a>(<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>+2,40);
<a name='L998'>        <b>if</b> (<a href='../D/2076.html' title='Multiple defined in 2 places.'>dictFind</a>(server.lua_scripts,sha) == NULL) <font color='red'>{</font>
<a name='L999'>            <b>if</b> (<a href='../S/75.html#L750' title='Defined at 750 in src/scripting.c.'>luaCreateFunction</a>(c,server.lua,<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>,c-&gt;argv[2])
<a name='L1000'>                    == <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>) <font color='red'>{</font>
<a name='L1001'>                <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sha);
<a name='L1002'>                <b>return</b>;
<a name='L1003'>            <font color='red'>}</font>
<a name='L1004'>        <font color='red'>}</font>
<a name='L1005'>        <a href='../S/86.html#L482' title='Defined at 482 in src/networking.c.'>addReplyBulkCBuffer</a>(c,<a href='../S/304.html#L1198' title='Defined at 1198 in deps/lua/src/lparser.c.'>funcname</a>+2,40);
<a name='L1006'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sha);
<a name='L1007'>    <font color='red'>}</font> <b>else</b> <b>if</b> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,"kill")) <font color='red'>{</font>
<a name='L1008'>        <b>if</b> (server.lua_caller == NULL) <font color='red'>{</font>
<a name='L1009'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>("-NOTBUSY No scripts in execution right now.\r\n"));
<a name='L1010'>        <font color='red'>}</font> <b>else</b> <b>if</b> (server.lua_write_dirty) <font color='red'>{</font>
<a name='L1011'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>("-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in an hard way using the SHUTDOWN NOSAVE command.\r\n"));
<a name='L1012'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1013'>            server.lua_kill = 1;
<a name='L1014'>            <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>);
<a name='L1015'>        <font color='red'>}</font>
<a name='L1016'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1017'>        <a href='../S/86.html#L330' title='Defined at 330 in src/networking.c.'>addReplyError</a>(c, "Unknown SCRIPT subcommand or wrong # of args.");
<a name='L1018'>    <font color='red'>}</font>
<a name='L1019'><font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L975'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
