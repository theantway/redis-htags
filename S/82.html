<html>
<head>
<title>src/sentinel.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/401.html'>src</a>/sentinel.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L229'>[^]</a><a href='#L3050'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L229' title='Defined at 229.'>redisAeReadEvent</a>
<li><a href='#L236' title='Defined at 236.'>redisAeWriteEvent</a>
<li><a href='#L243' title='Defined at 243.'>redisAeAddRead</a>
<li><a href='#L252' title='Defined at 252.'>redisAeDelRead</a>
<li><a href='#L261' title='Defined at 261.'>redisAeAddWrite</a>
<li><a href='#L270' title='Defined at 270.'>redisAeDelWrite</a>
<li><a href='#L279' title='Defined at 279.'>redisAeCleanup</a>
<li><a href='#L286' title='Defined at 286.'>redisAeAttach</a>
<li><a href='#L337' title='Defined at 337.'>dictInstancesValDestructor</a>
<li><a href='#L384' title='Defined at 384.'>initSentinelConfig</a>
<li><a href='#L389' title='Defined at 389.'>initSentinel</a>
<li><a href='#L419' title='Defined at 419.'>createSentinelAddr</a>
<li><a href='#L438' title='Defined at 438.'>releaseSentinelAddr</a>
<li><a href='#L469' title='Defined at 469.'>sentinelEvent</a>
<li><a href='#L529' title='Defined at 529.'>sentinelReleaseScriptJob</a>
<li><a href='#L538' title='Defined at 538.'>sentinelScheduleScriptExecution</a>
<li><a href='#L586' title='Defined at 586.'>sentinelGetScriptListNodeByPid</a>
<li><a href='#L602' title='Defined at 602.'>sentinelRunPendingScripts</a>
<li><a href='#L655' title='Defined at 655.'>sentinelScriptRetryDelay</a>
<li><a href='#L666' title='Defined at 666.'>sentinelCollectTerminatedScripts</a>
<li><a href='#L713' title='Defined at 713.'>sentinelKillTimedoutScripts</a>
<li><a href='#L733' title='Defined at 733.'>sentinelPendingScriptsCommand</a>
<li><a href='#L787' title='Defined at 787.'>sentinelCallClientReconfScript</a>
<li><a href='#L821' title='Defined at 821.'>createSentinelRedisInstance</a>
<li><a href='#L910' title='Defined at 910.'>releaseSentinelRedisInstance</a>
<li><a href='#L937' title='Defined at 937.'>sentinelRedisInstanceLookupSlave</a>
<li><a href='#L951' title='Defined at 951.'>sentinelRedisInstanceTypeStr</a>
<li><a href='#L979' title='Defined at 979.'>removeMatchingSentinelsFromMaster</a>
<li><a href='#L1005' title='Defined at 1005.'>getSentinelRedisInstanceByAddrAndRunID</a>
<li><a href='#L1029' title='Defined at 1029.'>sentinelGetMasterByName</a>
<li><a href='#L1039' title='Defined at 1039.'>sentinelAddFlagsToDictOfRedisInstances</a>
<li><a href='#L1053' title='Defined at 1053.'>sentinelDelFlagsToDictOfRedisInstances</a>
<li><a href='#L1073' title='Defined at 1073.'>sentinelResetMaster</a>
<li><a href='#L1102' title='Defined at 1102.'>sentinelResetMastersByPattern</a>
<li><a href='#L1134' title='Defined at 1134.'>sentinelResetMasterAndChangeAddress</a>
<li><a href='#L1149' title='Defined at 1149.'>sentinelHandleConfiguration</a>
<li><a href='#L1225' title='Defined at 1225.'>sentinelKillLink</a>
<li><a href='#L1242' title='Defined at 1242.'>sentinelDisconnectInstanceFromContext</a>
<li><a href='#L1258' title='Defined at 1258.'>sentinelLinkEstablishedCallback</a>
<li><a href='#L1270' title='Defined at 1270.'>sentinelDisconnectCallback</a>
<li><a href='#L1280' title='Defined at 1280.'>sentinelSendAuthIfNeeded</a>
<li><a href='#L1292' title='Defined at 1292.'>sentinelReconnectInstance</a>
<li><a href='#L1353' title='Defined at 1353.'>sentinelRefreshInstanceInfo</a>
<li><a href='#L1569' title='Defined at 1569.'>sentinelInfoReplyCallback</a>
<li><a href='#L1584' title='Defined at 1584.'>sentinelDiscardReplyCallback</a>
<li><a href='#L1590' title='Defined at 1590.'>sentinelPingReplyCallback</a>
<li><a href='#L1625' title='Defined at 1625.'>sentinelPublishReplyCallback</a>
<li><a href='#L1641' title='Defined at 1641.'>sentinelReceiveHelloMessages</a>
<li><a href='#L1716' title='Defined at 1716.'>sentinelPingInstance</a>
<li><a href='#L1783' title='Defined at 1783.'>sentinelFailoverStateStr</a>
<li><a href='#L1799' title='Defined at 1799.'>addReplySentinelRedisInstance</a>
<li><a href='#L1944' title='Defined at 1944.'>addReplyDictOfRedisInstances</a>
<li><a href='#L1961' title='Defined at 1961.'>sentinelGetMasterByNameOrReplyError</a>
<li><a href='#L1974' title='Defined at 1974.'>sentinelCommand</a>
<li><a href='#L2078' title='Defined at 2078.'>sentinelInfoCommand</a>
<li><a href='#L2140' title='Defined at 2140.'>sentinelCheckSubjectivelyDown</a>
<li><a href='#L2186' title='Defined at 2186.'>sentinelCheckObjectivelyDown</a>
<li><a href='#L2223' title='Defined at 2223.'>sentinelReceiveIsMasterDownReply</a>
<li><a href='#L2253' title='Defined at 2253.'>sentinelAskMasterStateToOtherSentinels</a>
<li><a href='#L2309' title='Defined at 2309.'>compareRunID</a>
<li><a href='#L2314' title='Defined at 2314.'>sentinelGetSubjectiveLeader</a>
<li><a href='#L2358' title='Defined at 2358.'>sentinelObjectiveLeaderIncr</a>
<li><a href='#L2374' title='Defined at 2374.'>sentinelGetObjectiveLeader</a>
<li><a href='#L2441' title='Defined at 2441.'>sentinelStartFailover</a>
<li><a href='#L2473' title='Defined at 2473.'>sentinelStartFailoverIfNeeded</a>
<li><a href='#L2548' title='Defined at 2548.'>compareSlavesForPromotion</a>
<li><a href='#L2568' title='Defined at 2568.'>sentinelSelectSlave</a>
<li><a href='#L2610' title='Defined at 2610.'>sentinelFailoverWaitStart</a>
<li><a href='#L2636' title='Defined at 2636.'>sentinelFailoverSelectSlave</a>
<li><a href='#L2653' title='Defined at 2653.'>sentinelFailoverSendSlaveOfNoOne</a>
<li><a href='#L2674' title='Defined at 2674.'>sentinelFailoverWaitPromotion</a>
<li><a href='#L2688' title='Defined at 2688.'>sentinelFailoverDetectEnd</a>
<li><a href='#L2763' title='Defined at 2763.'>sentinelFailoverReconfNextSlave</a>
<li><a href='#L2829' title='Defined at 2829.'>sentinelFailoverSwitchToPromotedSlave</a>
<li><a href='#L2840' title='Defined at 2840.'>sentinelFailoverStateMachine</a>
<li><a href='#L2877' title='Defined at 2877.'>sentinelAbortFailover</a>
<li><a href='#L2931' title='Defined at 2931.'>sentinelAbortFailoverIfNeeded</a>
<li><a href='#L2950' title='Defined at 2950.'>sentinelHandleRedisInstance</a>
<li><a href='#L2995' title='Defined at 2995.'>sentinelHandleDictOfRedisInstances</a>
<li><a href='#L3038' title='Defined at 3038.'>sentinelCheckTiltCondition</a>
<li><a href='#L3050' title='Defined at 3050.'>sentinelTimer</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/* Redis Sentinel implementation</font></i>
<a name='L2'><i><font color='green'> *</font></i>
<a name='L3'><i><font color='green'> * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</font></i>
<a name='L4'><i><font color='green'> * All rights reserved.</font></i>
<a name='L5'><i><font color='green'> *</font></i>
<a name='L6'><i><font color='green'> * Redistribution and use in source and binary forms, with or without</font></i>
<a name='L7'><i><font color='green'> * modification, are permitted provided that the following conditions are met:</font></i>
<a name='L8'><i><font color='green'> *</font></i>
<a name='L9'><i><font color='green'> *   * Redistributions of source code must retain the above copyright notice,</font></i>
<a name='L10'><i><font color='green'> *     this list of conditions and the following disclaimer.</font></i>
<a name='L11'><i><font color='green'> *   * Redistributions in binary form must reproduce the above copyright</font></i>
<a name='L12'><i><font color='green'> *     notice, this list of conditions and the following disclaimer in the</font></i>
<a name='L13'><i><font color='green'> *     documentation and/or other materials provided with the distribution.</font></i>
<a name='L14'><i><font color='green'> *   * Neither the name of Redis nor the names of its contributors may be used</font></i>
<a name='L15'><i><font color='green'> *     to endorse or promote products derived from this software without</font></i>
<a name='L16'><i><font color='green'> *     specific prior written permission.</font></i>
<a name='L17'><i><font color='green'> *</font></i>
<a name='L18'><i><font color='green'> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</font></i>
<a name='L19'><i><font color='green'> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</font></i>
<a name='L20'><i><font color='green'> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</font></i>
<a name='L21'><i><font color='green'> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</font></i>
<a name='L22'><i><font color='green'> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</font></i>
<a name='L23'><i><font color='green'> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</font></i>
<a name='L24'><i><font color='green'> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</font></i>
<a name='L25'><i><font color='green'> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</font></i>
<a name='L26'><i><font color='green'> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</font></i>
<a name='L27'><i><font color='green'> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</font></i>
<a name='L28'><i><font color='green'> * POSSIBILITY OF SUCH DAMAGE.</font></i>
<a name='L29'><i><font color='green'> */</font></i>
<a name='L30'>
<a name='L31'><font color='darkred'>#include</font> "<a href='32.html'>redis.h</a>"
<a name='L32'><font color='darkred'>#include</font> "<a href='121.html'>hiredis.h</a>"
<a name='L33'><font color='darkred'>#include</font> "<a href='124.html'>async.h</a>"
<a name='L34'>
<a name='L35'><font color='darkred'>#include</font> &lt;ctype.h&gt;
<a name='L36'><font color='darkred'>#include</font> &lt;arpa/inet.h&gt;
<a name='L37'><font color='darkred'>#include</font> &lt;sys/socket.h&gt;
<a name='L38'><font color='darkred'>#include</font> &lt;sys/wait.h&gt;
<a name='L39'>
<a name='L40'><b>extern</b> <b>char</b> **environ;
<a name='L41'>
<a name='L42'><font color='darkred'>#define</font> <a href='../S/82.html#L385' title='Refered from 385 in src/sentinel.c.'>REDIS_SENTINEL_PORT</a> 26379
<a name='L43'>
<a name='L44'><i><font color='green'>/* ======================== Sentinel global state =========================== */</font></i>
<a name='L45'>
<a name='L46'><b>typedef</b> <b>long</b> <b>long</b> <a href='../R/3055.html' title='Multiple refered from 37 places.'>mstime_t</a>; <i><font color='green'>/* millisecond time type. */</font></i>
<a name='L47'>
<a name='L48'><i><font color='green'>/* Address object, used to describe an ip:port pair. */</font></i>
<a name='L49'><b>typedef</b> <b>struct</b> <a href='../R/3665.html' title='Multiple refered from 6 places.'>sentinelAddr</a> <font color='red'>{</font>
<a name='L50'>    <b>char</b> *ip;
<a name='L51'>    <b>int</b> port;
<a name='L52'><font color='red'>}</font> <a href='../R/3665.html' title='Multiple refered from 6 places.'>sentinelAddr</a>;
<a name='L53'>
<a name='L54'><i><font color='green'>/* A Sentinel Redis Instance object is monitoring. */</font></i>
<a name='L55'><font color='darkred'>#define</font> <a href='../R/899.html' title='Multiple refered from 28 places.'>SRI_MASTER</a>  (1&lt;&lt;0)
<a name='L56'><font color='darkred'>#define</font> <a href='../R/908.html' title='Multiple refered from 18 places.'>SRI_SLAVE</a>   (1&lt;&lt;1)
<a name='L57'><font color='darkred'>#define</font> <a href='../R/907.html' title='Multiple refered from 9 places.'>SRI_SENTINEL</a> (1&lt;&lt;2)
<a name='L58'><font color='darkred'>#define</font> <a href='../R/895.html' title='Multiple refered from 15 places.'>SRI_DISCONNECTED</a> (1&lt;&lt;3)
<a name='L59'><font color='darkred'>#define</font> <a href='../R/909.html' title='Multiple refered from 18 places.'>SRI_S_DOWN</a> (1&lt;&lt;4)   <i><font color='green'>/* Subjectively down (no quorum). */</font></i>
<a name='L60'><font color='darkred'>#define</font> <a href='../R/901.html' title='Multiple refered from 12 places.'>SRI_O_DOWN</a> (1&lt;&lt;5)   <i><font color='green'>/* Objectively down (quorum reached). */</font></i>
<a name='L61'><font color='darkred'>#define</font> <a href='../R/900.html' title='Multiple refered from 7 places.'>SRI_MASTER_DOWN</a> (1&lt;&lt;6) <i><font color='green'>/* A Sentinel with this flag set thinks that</font></i>
<a name='L62'><i><font color='green'>                                   its master is down. */</font></i>
<a name='L63'><i><font color='green'>/* SRI_CAN_FAILOVER when set in an SRI_MASTER instance means that we are</font></i>
<a name='L64'><i><font color='green'> * allowed to perform the failover for this master.</font></i>
<a name='L65'><i><font color='green'> * When set in a SRI_SENTINEL instance means that sentinel is allowed to</font></i>
<a name='L66'><i><font color='green'> * perform the failover on its master. */</font></i>
<a name='L67'><font color='darkred'>#define</font> <a href='../R/894.html' title='Multiple refered from 10 places.'>SRI_CAN_FAILOVER</a> (1&lt;&lt;7)
<a name='L68'><font color='darkred'>#define</font> <a href='../R/896.html' title='Multiple refered from 21 places.'>SRI_FAILOVER_IN_PROGRESS</a> (1&lt;&lt;8) <i><font color='green'>/* Failover is in progress for</font></i>
<a name='L69'><i><font color='green'>                                           this master. */</font></i>
<a name='L70'><font color='darkred'>#define</font> <a href='../R/898.html' title='Multiple refered from 10 places.'>SRI_I_AM_THE_LEADER</a> (1&lt;&lt;9)     <i><font color='green'>/* We are the leader for this master. */</font></i>
<a name='L71'><font color='darkred'>#define</font> <a href='../R/902.html' title='Multiple refered from 10 places.'>SRI_PROMOTED</a> (1&lt;&lt;10)            <i><font color='green'>/* Slave selected for promotion. */</font></i>
<a name='L72'><font color='darkred'>#define</font> <a href='../R/905.html' title='Multiple refered from 15 places.'>SRI_RECONF_SENT</a> (1&lt;&lt;11)     <i><font color='green'>/* SLAVEOF &lt;newmaster&gt; sent. */</font></i>
<a name='L73'><font color='darkred'>#define</font> <a href='../R/904.html' title='Multiple refered from 9 places.'>SRI_RECONF_INPROG</a> (1&lt;&lt;12)   <i><font color='green'>/* Slave synchronization in progress. */</font></i>
<a name='L74'><font color='darkred'>#define</font> <a href='../R/903.html' title='Multiple refered from 7 places.'>SRI_RECONF_DONE</a> (1&lt;&lt;13)     <i><font color='green'>/* Slave synchronized with new master. */</font></i>
<a name='L75'><font color='darkred'>#define</font> <a href='../R/897.html' title='Multiple refered from 3 places.'>SRI_FORCE_FAILOVER</a> (1&lt;&lt;14)  <i><font color='green'>/* Force failover with master up. */</font></i>
<a name='L76'><font color='darkred'>#define</font> <a href='../R/906.html' title='Multiple refered from 3 places.'>SRI_SCRIPT_KILL_SENT</a> (1&lt;&lt;15) <i><font color='green'>/* SCRIPT KILL already sent on -BUSY */</font></i>
<a name='L77'>
<a name='L78'><font color='darkred'>#define</font> <a href='../R/841.html' title='Multiple refered from 2 places.'>SENTINEL_INFO_PERIOD</a> 10000
<a name='L79'><font color='darkred'>#define</font> <a href='../R/850.html' title='Multiple refered from 2 places.'>SENTINEL_PING_PERIOD</a> 1000
<a name='L80'><font color='darkred'>#define</font> <a href='../S/82.html#L2279' title='Refered from 2279 in src/sentinel.c.'>SENTINEL_ASK_PERIOD</a> 1000
<a name='L81'><font color='darkred'>#define</font> <a href='../R/852.html' title='Multiple refered from 2 places.'>SENTINEL_PUBLISH_PERIOD</a> 5000
<a name='L82'><font color='darkred'>#define</font> <a href='../S/82.html#L876' title='Refered from 876 in src/sentinel.c.'>SENTINEL_DOWN_AFTER_PERIOD</a> 30000
<a name='L83'><font color='darkred'>#define</font> <a href='../R/840.html' title='Multiple refered from 2 places.'>SENTINEL_HELLO_CHANNEL</a> "__sentinel__:hello"
<a name='L84'><font color='darkred'>#define</font> <a href='../S/82.html#L3042' title='Refered from 3042 in src/sentinel.c.'>SENTINEL_TILT_TRIGGER</a> 2000
<a name='L85'><font color='darkred'>#define</font> <a href='../S/82.html#L2971' title='Refered from 2971 in src/sentinel.c.'>SENTINEL_TILT_PERIOD</a> (<a href='../S/82.html#L79' title='Defined at 79 in src/sentinel.c.'>SENTINEL_PING_PERIOD</a>*30)
<a name='L86'><font color='darkred'>#define</font> <a href='../S/82.html#L879' title='Refered from 879 in src/sentinel.c.'>SENTINEL_DEFAULT_SLAVE_PRIORITY</a> 100
<a name='L87'><font color='darkred'>#define</font> <a href='../S/82.html#L2677' title='Refered from 2677 in src/sentinel.c.'>SENTINEL_PROMOTION_RETRY_PERIOD</a> 30000
<a name='L88'><font color='darkred'>#define</font> <a href='../S/82.html#L2792' title='Refered from 2792 in src/sentinel.c.'>SENTINEL_SLAVE_RECONF_RETRY_PERIOD</a> 10000
<a name='L89'><font color='darkred'>#define</font> <a href='../S/82.html#L886' title='Refered from 886 in src/sentinel.c.'>SENTINEL_DEFAULT_PARALLEL_SYNCS</a> 1
<a name='L90'><font color='darkred'>#define</font> <a href='../R/847.html' title='Multiple refered from 2 places.'>SENTINEL_MIN_LINK_RECONNECT_PERIOD</a> 15000
<a name='L91'><font color='darkred'>#define</font> <a href='../S/82.html#L896' title='Refered from 896 in src/sentinel.c.'>SENTINEL_DEFAULT_FAILOVER_TIMEOUT</a> (60*15*1000)
<a name='L92'><font color='darkred'>#define</font> <a href='../S/82.html#L1731' title='Refered from 1731 in src/sentinel.c.'>SENTINEL_MAX_PENDING_COMMANDS</a> 100
<a name='L93'><font color='darkred'>#define</font> <a href='../S/82.html#L2938' title='Refered from 2938 in src/sentinel.c.'>SENTINEL_EXTENDED_SDOWN_MULTIPLIER</a> 10
<a name='L94'>
<a name='L95'><i><font color='green'>/* How many milliseconds is an information valid? This applies for instance</font></i>
<a name='L96'><i><font color='green'> * to the reply to SENTINEL IS-MASTER-DOWN-BY-ADDR replies. */</font></i>
<a name='L97'><font color='darkred'>#define</font> <a href='../R/842.html' title='Multiple refered from 3 places.'>SENTINEL_INFO_VALIDITY_TIME</a> 5000
<a name='L98'><font color='darkred'>#define</font> <a href='../S/82.html#L2454' title='Refered from 2454 in src/sentinel.c.'>SENTINEL_FAILOVER_FIXED_DELAY</a> 5000
<a name='L99'><font color='darkred'>#define</font> <a href='../S/82.html#L2455' title='Refered from 2455 in src/sentinel.c.'>SENTINEL_FAILOVER_MAX_RANDOM_DELAY</a> 10000
<a name='L100'>
<a name='L101'><i><font color='green'>/* Failover machine different states. */</font></i>
<a name='L102'><font color='darkred'>#define</font> <a href='../R/832.html' title='Multiple refered from 4 places.'>SENTINEL_FAILOVER_STATE_NONE</a> 0  <i><font color='green'>/* No failover in progress. */</font></i>
<a name='L103'><font color='darkred'>#define</font> <a href='../R/838.html' title='Multiple refered from 7 places.'>SENTINEL_FAILOVER_STATE_WAIT_START</a> 1  <i><font color='green'>/* Wait for failover_start_time*/</font></i> 
<a name='L104'><font color='darkred'>#define</font> <a href='../R/834.html' title='Multiple refered from 4 places.'>SENTINEL_FAILOVER_STATE_SELECT_SLAVE</a> 2 <i><font color='green'>/* Select slave to promote */</font></i>
<a name='L105'><font color='darkred'>#define</font> <a href='../R/835.html' title='Multiple refered from 3 places.'>SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</a> 3 <i><font color='green'>/* Slave -&gt; Master */</font></i>
<a name='L106'><font color='darkred'>#define</font> <a href='../R/837.html' title='Multiple refered from 4 places.'>SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</a> 4 <i><font color='green'>/* Wait slave to change role */</font></i>
<a name='L107'><font color='darkred'>#define</font> <a href='../R/833.html' title='Multiple refered from 5 places.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a> 5 <i><font color='green'>/* SLAVEOF newmaster */</font></i>
<a name='L108'><font color='darkred'>#define</font> SENTINEL_FAILOVER_STATE_WAIT_NEXT_SLAVE 6 <i><font color='green'>/* wait replication */</font></i>
<a name='L109'><font color='darkred'>#define</font> <a href='../S/82.html#L1791' title='Refered from 1791 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_ALERT_CLIENTS</a> 7 <i><font color='green'>/* Run user script. */</font></i>
<a name='L110'><font color='darkred'>#define</font> SENTINEL_FAILOVER_STATE_WAIT_ALERT_SCRIPT 8 <i><font color='green'>/* Wait script exec. */</font></i>
<a name='L111'><font color='darkred'>#define</font> <a href='../R/831.html' title='Multiple refered from 3 places.'>SENTINEL_FAILOVER_STATE_DETECT_END</a> 9 <i><font color='green'>/* Check for failover end. */</font></i>
<a name='L112'><font color='darkred'>#define</font> <a href='../R/836.html' title='Multiple refered from 3 places.'>SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</a> 10 <i><font color='green'>/* Monitor promoted slave. */</font></i>
<a name='L113'>
<a name='L114'><font color='darkred'>#define</font> <a href='../R/845.html' title='Multiple refered from 3 places.'>SENTINEL_MASTER_LINK_STATUS_UP</a> 0
<a name='L115'><font color='darkred'>#define</font> <a href='../R/844.html' title='Multiple refered from 2 places.'>SENTINEL_MASTER_LINK_STATUS_DOWN</a> 1
<a name='L116'>
<a name='L117'><i><font color='green'>/* Generic flags that can be used with different functions. */</font></i>
<a name='L118'><font color='darkred'>#define</font> <a href='../S/82.html#L1139' title='Refered from 1139 in src/sentinel.c.'>SENTINEL_NO_FLAGS</a> 0
<a name='L119'><font color='darkred'>#define</font> <a href='../R/839.html' title='Multiple refered from 2 places.'>SENTINEL_GENERATE_EVENT</a> 1
<a name='L120'><font color='darkred'>#define</font> <a href='../R/843.html' title='Multiple refered from 4 places.'>SENTINEL_LEADER</a> 2
<a name='L121'><font color='darkred'>#define</font> <a href='../R/849.html' title='Multiple refered from 3 places.'>SENTINEL_OBSERVER</a> 4
<a name='L122'>
<a name='L123'><i><font color='green'>/* Script execution flags and limits. */</font></i>
<a name='L124'><font color='darkred'>#define</font> <a href='../S/82.html#L555' title='Refered from 555 in src/sentinel.c.'>SENTINEL_SCRIPT_NONE</a> 0
<a name='L125'><font color='darkred'>#define</font> <a href='../R/860.html' title='Multiple refered from 9 places.'>SENTINEL_SCRIPT_RUNNING</a> 1
<a name='L126'><font color='darkred'>#define</font> <a href='../R/854.html' title='Multiple refered from 2 places.'>SENTINEL_SCRIPT_MAX_QUEUE</a> 256
<a name='L127'><font color='darkred'>#define</font> <a href='../S/82.html#L610' title='Refered from 610 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RUNNING</a> 16
<a name='L128'><font color='darkred'>#define</font> <a href='../S/82.html#L723' title='Refered from 723 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RUNTIME</a> 60000 <i><font color='green'>/* 60 seconds max exec time. */</font></i>
<a name='L129'><font color='darkred'>#define</font> <a href='../S/82.html#L691' title='Refered from 691 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RETRY</a> 10
<a name='L130'><font color='darkred'>#define</font> <a href='../S/82.html#L656' title='Refered from 656 in src/sentinel.c.'>SENTINEL_SCRIPT_RETRY_DELAY</a> 30000 <i><font color='green'>/* 30 seconds between retries. */</font></i>
<a name='L131'>
<a name='L132'><b>typedef</b> <b>struct</b> <a href='../R/3708.html' title='Multiple refered from 59 places.'>sentinelRedisInstance</a> <font color='red'>{</font>
<a name='L133'>    <b>int</b> flags;      <i><font color='green'>/* See SRI_... defines */</font></i>
<a name='L134'>    <b>char</b> *name;     <i><font color='green'>/* Master name from the point of view of this sentinel. */</font></i>
<a name='L135'>    <b>char</b> *runid;    <i><font color='green'>/* run ID of this instance. */</font></i>
<a name='L136'>    <a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *addr; <i><font color='green'>/* Master host. */</font></i>
<a name='L137'>    <a href='../D/3768.html' title='Multiple defined in 2 places.'>redisAsyncContext</a> *cc; <i><font color='green'>/* Hiredis context for commands. */</font></i>
<a name='L138'>    <a href='../D/3768.html' title='Multiple defined in 2 places.'>redisAsyncContext</a> *pc; <i><font color='green'>/* Hiredis context for Pub / Sub. */</font></i>
<a name='L139'>    <b>int</b> pending_commands;   <i><font color='green'>/* Number of commands sent waiting for a reply. */</font></i>
<a name='L140'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> cc_conn_time; <i><font color='green'>/* cc connection time. */</font></i>
<a name='L141'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> pc_conn_time; <i><font color='green'>/* pc connection time. */</font></i>
<a name='L142'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> pc_last_activity; <i><font color='green'>/* Last time we received any message. */</font></i>
<a name='L143'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> last_avail_time; <i><font color='green'>/* Last time the instance replied to ping with</font></i>
<a name='L144'><i><font color='green'>                                 a reply we consider valid. */</font></i>
<a name='L145'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> last_pong_time;  <i><font color='green'>/* Last time the instance replied to ping,</font></i>
<a name='L146'><i><font color='green'>                                 whatever the reply was. That's used to check</font></i>
<a name='L147'><i><font color='green'>                                 if the link is idle and must be reconnected. */</font></i>
<a name='L148'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> last_pub_time;   <i><font color='green'>/* Last time we sent hello via Pub/Sub. */</font></i>
<a name='L149'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> last_hello_time; <i><font color='green'>/* Only used if SRI_SENTINEL is set. Last time</font></i>
<a name='L150'><i><font color='green'>                                 we received an hello from this Sentinel</font></i>
<a name='L151'><i><font color='green'>                                 via Pub/Sub. */</font></i>
<a name='L152'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> last_master_down_reply_time; <i><font color='green'>/* Time of last reply to</font></i>
<a name='L153'><i><font color='green'>                                             SENTINEL is-master-down command. */</font></i>
<a name='L154'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> s_down_since_time; <i><font color='green'>/* Subjectively down since time. */</font></i>
<a name='L155'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> o_down_since_time; <i><font color='green'>/* Objectively down since time. */</font></i>
<a name='L156'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> down_after_period; <i><font color='green'>/* Consider it down after that period. */</font></i>
<a name='L157'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> info_refresh;  <i><font color='green'>/* Time at which we received INFO output from it. */</font></i>
<a name='L158'>
<a name='L159'>    <i><font color='green'>/* Master specific. */</font></i>
<a name='L160'>    <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *sentinels;    <i><font color='green'>/* Other sentinels monitoring the same master. */</font></i>
<a name='L161'>    <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *slaves;       <i><font color='green'>/* Slaves for this master instance. */</font></i>
<a name='L162'>    <b>int</b> quorum;         <i><font color='green'>/* Number of sentinels that need to agree on failure. */</font></i>
<a name='L163'>    <b>int</b> parallel_syncs; <i><font color='green'>/* How many slaves to reconfigure at same time. */</font></i>
<a name='L164'>    <b>char</b> *auth_pass;    <i><font color='green'>/* Password to use for AUTH against master &amp; slaves. */</font></i>
<a name='L165'>
<a name='L166'>    <i><font color='green'>/* Slave specific. */</font></i>
<a name='L167'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> master_link_down_time; <i><font color='green'>/* Slave replication link down time. */</font></i>
<a name='L168'>    <b>int</b> slave_priority; <i><font color='green'>/* Slave priority according to its INFO output. */</font></i>
<a name='L169'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> slave_reconf_sent_time; <i><font color='green'>/* Time at which we sent SLAVE OF &lt;new&gt; */</font></i>
<a name='L170'>    <b>struct</b> <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *master; <i><font color='green'>/* Master instance if SRI_SLAVE is set. */</font></i>
<a name='L171'>    <b>char</b> *slave_master_host;    <i><font color='green'>/* Master host as reported by INFO */</font></i>
<a name='L172'>    <b>int</b> slave_master_port;      <i><font color='green'>/* Master port as reported by INFO */</font></i>
<a name='L173'>    <b>int</b> slave_master_link_status; <i><font color='green'>/* Master link status as reported by INFO */</font></i>
<a name='L174'>    <i><font color='green'>/* Failover */</font></i>
<a name='L175'>    <b>char</b> *leader;       <i><font color='green'>/* If this is a master instance, this is the runid of</font></i>
<a name='L176'><i><font color='green'>                           the Sentinel that should perform the failover. If</font></i>
<a name='L177'><i><font color='green'>                           this is a Sentinel, this is the runid of the Sentinel</font></i>
<a name='L178'><i><font color='green'>                           that this other Sentinel is voting as leader.</font></i>
<a name='L179'><i><font color='green'>                           This field is valid only if SRI_MASTER_DOWN is</font></i>
<a name='L180'><i><font color='green'>                           set on the Sentinel instance. */</font></i>
<a name='L181'>    <b>int</b> failover_state; <i><font color='green'>/* See SENTINEL_FAILOVER_STATE_* defines. */</font></i>
<a name='L182'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> failover_state_change_time;
<a name='L183'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> failover_start_time;   <i><font color='green'>/* When to start to failover if leader. */</font></i>
<a name='L184'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> failover_timeout;      <i><font color='green'>/* Max time to refresh failover state. */</font></i>
<a name='L185'>    <b>struct</b> <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *promoted_slave; <i><font color='green'>/* Promoted slave instance. */</font></i>
<a name='L186'>    <i><font color='green'>/* Scripts executed to notify admin or reconfigure clients: when they</font></i>
<a name='L187'><i><font color='green'>     * are set to NULL no script is executed. */</font></i>
<a name='L188'>    <b>char</b> *notification_script;
<a name='L189'>    <b>char</b> *client_reconfig_script;
<a name='L190'><font color='red'>}</font> <a href='../R/3708.html' title='Multiple refered from 59 places.'>sentinelRedisInstance</a>;
<a name='L191'>
<a name='L192'><i><font color='green'>/* Main state. */</font></i>
<a name='L193'><b>struct</b> sentinelState <font color='red'>{</font>
<a name='L194'>    <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *masters;      <i><font color='green'>/* Dictionary of master sentinelRedisInstances.</font></i>
<a name='L195'><i><font color='green'>                           Key is the instance name, value is the</font></i>
<a name='L196'><i><font color='green'>                           sentinelRedisInstance structure pointer. */</font></i>
<a name='L197'>    <b>int</b> tilt;           <i><font color='green'>/* Are we in TILT mode? */</font></i>
<a name='L198'>    <b>int</b> running_scripts;    <i><font color='green'>/* Number of scripts in execution right now. */</font></i>
<a name='L199'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> tilt_start_time;   <i><font color='green'>/* When TITL started. */</font></i>
<a name='L200'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> previous_time;     <i><font color='green'>/* Time last time we ran the time handler. */</font></i>
<a name='L201'>    <a href='../D/2690.html' title='Multiple defined in 2 places.'>list</a> *scripts_queue;    <i><font color='green'>/* Queue of user scripts to execute. */</font></i>
<a name='L202'><font color='red'>}</font> <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>;
<a name='L203'>
<a name='L204'><i><font color='green'>/* A script execution job. */</font></i>
<a name='L205'><b>typedef</b> <b>struct</b> <a href='../R/3718.html' title='Multiple refered from 6 places.'>sentinelScriptJob</a> <font color='red'>{</font>
<a name='L206'>    <b>int</b> flags;              <i><font color='green'>/* Script job flags: SENTINEL_SCRIPT_* */</font></i>
<a name='L207'>    <b>int</b> retry_num;          <i><font color='green'>/* Number of times we tried to execute it. */</font></i>
<a name='L208'>    <b>char</b> **argv;            <i><font color='green'>/* Arguments to call the script. */</font></i>
<a name='L209'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> start_time;    <i><font color='green'>/* Script execution time if the script is running,</font></i>
<a name='L210'><i><font color='green'>                               otherwise 0 if we are allowed to retry the</font></i>
<a name='L211'><i><font color='green'>                               execution at any time. If the script is not</font></i>
<a name='L212'><i><font color='green'>                               running and it's not 0, it means: do not run</font></i>
<a name='L213'><i><font color='green'>                               before the specified time. */</font></i>
<a name='L214'>    pid_t pid;              <i><font color='green'>/* Script execution pid. */</font></i>
<a name='L215'><font color='red'>}</font> <a href='../R/3718.html' title='Multiple refered from 6 places.'>sentinelScriptJob</a>;
<a name='L216'>
<a name='L217'><i><font color='green'>/* ======================= hiredis ae.c adapters =============================</font></i>
<a name='L218'><i><font color='green'> * Note: this implementation is taken from hiredis/adapters/ae.h, however</font></i>
<a name='L219'><i><font color='green'> * we have our modified copy for Sentinel in order to use our allocator</font></i>
<a name='L220'><i><font color='green'> * and to have full control over how the adapter works. */</font></i>
<a name='L221'>
<a name='L222'><b>typedef</b> <b>struct</b> <a href='../R/3397.html' title='Multiple refered from 18 places.'>redisAeEvents</a> <font color='red'>{</font>
<a name='L223'>    <a href='../D/3768.html' title='Multiple defined in 2 places.'>redisAsyncContext</a> *context;
<a name='L224'>    <a href='../D/1510.html' title='Multiple defined in 2 places.'>aeEventLoop</a> *loop;
<a name='L225'>    <b>int</b> fd;
<a name='L226'>    <b>int</b> reading, writing;
<a name='L227'><font color='red'>}</font> <a href='../R/3397.html' title='Multiple refered from 18 places.'>redisAeEvents</a>;
<a name='L228'>
<a name='L229'><b>static</b> <b>void</b> <a href='../R/3398.html' title='Multiple refered from 2 places.'>redisAeReadEvent</a>(aeEventLoop *el, <b>int</b> fd, <b>void</b> *privdata, <b>int</b> mask) <font color='red'>{</font>
<a name='L230'>    ((<b>void</b>)el); ((<b>void</b>)fd); ((<b>void</b>)mask);
<a name='L231'>
<a name='L232'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L233'>    <a href='../S/104.html#L464' title='Defined at 464 in deps/hiredis/async.c.'>redisAsyncHandleRead</a>(e-&gt;context);
<a name='L234'><font color='red'>}</font>
<a name='L235'>
<a name='L236'><b>static</b> <b>void</b> <a href='../R/3399.html' title='Multiple refered from 2 places.'>redisAeWriteEvent</a>(aeEventLoop *el, <b>int</b> fd, <b>void</b> *privdata, <b>int</b> mask) <font color='red'>{</font>
<a name='L237'>    ((<b>void</b>)el); ((<b>void</b>)fd); ((<b>void</b>)mask);
<a name='L238'>
<a name='L239'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L240'>    <a href='../S/104.html#L485' title='Defined at 485 in deps/hiredis/async.c.'>redisAsyncHandleWrite</a>(e-&gt;context);
<a name='L241'><font color='red'>}</font>
<a name='L242'>
<a name='L243'><b>static</b> <b>void</b> <a href='../R/3391.html' title='Multiple refered from 2 places.'>redisAeAddRead</a>(<b>void</b> *privdata) <font color='red'>{</font>
<a name='L244'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L245'>    <a href='../D/1510.html' title='Multiple defined in 2 places.'>aeEventLoop</a> *loop = e-&gt;loop;
<a name='L246'>    <b>if</b> (!e-&gt;reading) <font color='red'>{</font>
<a name='L247'>        e-&gt;reading = 1;
<a name='L248'>        <a href='../S/36.html#L104' title='Defined at 104 in src/ae.c.'>aeCreateFileEvent</a>(loop,e-&gt;fd,<a href='../S/38.html#L40' title='Defined at 40 in src/ae.h.'>AE_READABLE</a>,<a href='../D/3757.html' title='Multiple defined in 2 places.'>redisAeReadEvent</a>,e);
<a name='L249'>    <font color='red'>}</font>
<a name='L250'><font color='red'>}</font>
<a name='L251'>
<a name='L252'><b>static</b> <b>void</b> <a href='../R/3395.html' title='Multiple refered from 4 places.'>redisAeDelRead</a>(<b>void</b> *privdata) <font color='red'>{</font>
<a name='L253'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L254'>    <a href='../D/1510.html' title='Multiple defined in 2 places.'>aeEventLoop</a> *loop = e-&gt;loop;
<a name='L255'>    <b>if</b> (e-&gt;reading) <font color='red'>{</font>
<a name='L256'>        e-&gt;reading = 0;
<a name='L257'>        <a href='../S/36.html#L121' title='Defined at 121 in src/ae.c.'>aeDeleteFileEvent</a>(loop,e-&gt;fd,<a href='../S/38.html#L40' title='Defined at 40 in src/ae.h.'>AE_READABLE</a>);
<a name='L258'>    <font color='red'>}</font>
<a name='L259'><font color='red'>}</font>
<a name='L260'>
<a name='L261'><b>static</b> <b>void</b> <a href='../R/3392.html' title='Multiple refered from 2 places.'>redisAeAddWrite</a>(<b>void</b> *privdata) <font color='red'>{</font>
<a name='L262'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L263'>    <a href='../D/1510.html' title='Multiple defined in 2 places.'>aeEventLoop</a> *loop = e-&gt;loop;
<a name='L264'>    <b>if</b> (!e-&gt;writing) <font color='red'>{</font>
<a name='L265'>        e-&gt;writing = 1;
<a name='L266'>        <a href='../S/36.html#L104' title='Defined at 104 in src/ae.c.'>aeCreateFileEvent</a>(loop,e-&gt;fd,<a href='../S/38.html#L41' title='Defined at 41 in src/ae.h.'>AE_WRITABLE</a>,<a href='../D/3758.html' title='Multiple defined in 2 places.'>redisAeWriteEvent</a>,e);
<a name='L267'>    <font color='red'>}</font>
<a name='L268'><font color='red'>}</font>
<a name='L269'>
<a name='L270'><b>static</b> <b>void</b> <a href='../R/3396.html' title='Multiple refered from 4 places.'>redisAeDelWrite</a>(<b>void</b> *privdata) <font color='red'>{</font>
<a name='L271'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L272'>    <a href='../D/1510.html' title='Multiple defined in 2 places.'>aeEventLoop</a> *loop = e-&gt;loop;
<a name='L273'>    <b>if</b> (e-&gt;writing) <font color='red'>{</font>
<a name='L274'>        e-&gt;writing = 0;
<a name='L275'>        <a href='../S/36.html#L121' title='Defined at 121 in src/ae.c.'>aeDeleteFileEvent</a>(loop,e-&gt;fd,<a href='../S/38.html#L41' title='Defined at 41 in src/ae.h.'>AE_WRITABLE</a>);
<a name='L276'>    <font color='red'>}</font>
<a name='L277'><font color='red'>}</font>
<a name='L278'>
<a name='L279'><b>static</b> <b>void</b> <a href='../R/3394.html' title='Multiple refered from 2 places.'>redisAeCleanup</a>(<b>void</b> *privdata) <font color='red'>{</font>
<a name='L280'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)privdata;
<a name='L281'>    <a href='../D/3754.html' title='Multiple defined in 2 places.'>redisAeDelRead</a>(privdata);
<a name='L282'>    <a href='../D/3755.html' title='Multiple defined in 2 places.'>redisAeDelWrite</a>(privdata);
<a name='L283'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(e);
<a name='L284'><font color='red'>}</font>
<a name='L285'>
<a name='L286'><b>static</b> <b>int</b> <a href='../R/3393.html' title='Multiple refered from 3 places.'>redisAeAttach</a>(aeEventLoop *loop, redisAsyncContext *ac) <font color='red'>{</font>
<a name='L287'>    <a href='../D/3791.html' title='Multiple defined in 2 places.'>redisContext</a> *c = &amp;(ac-&gt;c);
<a name='L288'>    <a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a> *e;
<a name='L289'>
<a name='L290'>    <i><font color='green'>/* Nothing should be attached when something is already attached */</font></i>
<a name='L291'>    <b>if</b> (ac-&gt;ev.data != NULL)
<a name='L292'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L293'>
<a name='L294'>    <i><font color='green'>/* Create container for context and r/w events */</font></i>
<a name='L295'>    e = (<a href='../D/3756.html' title='Multiple defined in 4 places.'>redisAeEvents</a>*)<a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*e));
<a name='L296'>    e-&gt;context = ac;
<a name='L297'>    e-&gt;loop = loop;
<a name='L298'>    e-&gt;fd = c-&gt;fd;
<a name='L299'>    e-&gt;reading = e-&gt;writing = 0;
<a name='L300'>
<a name='L301'>    <i><font color='green'>/* Register functions to start/stop listening for events */</font></i>
<a name='L302'>    ac-&gt;ev.addRead = <a href='../D/3750.html' title='Multiple defined in 2 places.'>redisAeAddRead</a>;
<a name='L303'>    ac-&gt;ev.delRead = <a href='../D/3754.html' title='Multiple defined in 2 places.'>redisAeDelRead</a>;
<a name='L304'>    ac-&gt;ev.addWrite = <a href='../D/3751.html' title='Multiple defined in 2 places.'>redisAeAddWrite</a>;
<a name='L305'>    ac-&gt;ev.delWrite = <a href='../D/3755.html' title='Multiple defined in 2 places.'>redisAeDelWrite</a>;
<a name='L306'>    ac-&gt;ev.cleanup = <a href='../D/3753.html' title='Multiple defined in 2 places.'>redisAeCleanup</a>;
<a name='L307'>    ac-&gt;ev.data = e;
<a name='L308'>
<a name='L309'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L310'><font color='red'>}</font>
<a name='L311'>
<a name='L312'><i><font color='green'>/* ============================= Prototypes ================================= */</font></i>
<a name='L313'>
<a name='L314'><b>void</b> <a href='../S/82.html#L1258' title='Defined at 1258 in src/sentinel.c.'>sentinelLinkEstablishedCallback</a>(<b>const</b> redisAsyncContext *c, <b>int</b> status);
<a name='L315'><b>void</b> <a href='../S/82.html#L1270' title='Defined at 1270 in src/sentinel.c.'>sentinelDisconnectCallback</a>(<b>const</b> redisAsyncContext *c, <b>int</b> status);
<a name='L316'><b>void</b> <a href='../S/82.html#L1641' title='Defined at 1641 in src/sentinel.c.'>sentinelReceiveHelloMessages</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata);
<a name='L317'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(<b>char</b> *name);
<a name='L318'><b>char</b> *<a href='../S/82.html#L2314' title='Defined at 2314 in src/sentinel.c.'>sentinelGetSubjectiveLeader</a>(sentinelRedisInstance *master);
<a name='L319'><b>char</b> *<a href='../S/82.html#L2374' title='Defined at 2374 in src/sentinel.c.'>sentinelGetObjectiveLeader</a>(sentinelRedisInstance *master);
<a name='L320'><b>int</b> <a href='../S/96.html#L38' title='Defined at 38 in src/config.c.'>yesnotoi</a>(<b>char</b> *s);
<a name='L321'><b>void</b> <a href='../S/82.html#L1242' title='Defined at 1242 in src/sentinel.c.'>sentinelDisconnectInstanceFromContext</a>(<b>const</b> redisAsyncContext *c);
<a name='L322'><b>void</b> <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(sentinelRedisInstance *ri, redisAsyncContext *c);
<a name='L323'><b>const</b> <b>char</b> *<a href='../S/82.html#L951' title='Defined at 951 in src/sentinel.c.'>sentinelRedisInstanceTypeStr</a>(sentinelRedisInstance *ri);
<a name='L324'><b>void</b> <a href='../S/82.html#L2877' title='Defined at 2877 in src/sentinel.c.'>sentinelAbortFailover</a>(sentinelRedisInstance *ri);
<a name='L325'><b>void</b> <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<b>int</b> level, <b>char</b> *type, sentinelRedisInstance *ri, <b>const</b> <b>char</b> *fmt, ...);
<a name='L326'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../S/82.html#L2568' title='Defined at 2568 in src/sentinel.c.'>sentinelSelectSlave</a>(sentinelRedisInstance *master);
<a name='L327'><b>void</b> <a href='../S/82.html#L538' title='Defined at 538 in src/sentinel.c.'>sentinelScheduleScriptExecution</a>(<b>char</b> *path, ...);
<a name='L328'><b>void</b> <a href='../S/82.html#L2441' title='Defined at 2441 in src/sentinel.c.'>sentinelStartFailover</a>(sentinelRedisInstance *master, <b>int</b> state);
<a name='L329'><b>void</b> <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata);
<a name='L330'>
<a name='L331'><i><font color='green'>/* ========================= Dictionary types =============================== */</font></i>
<a name='L332'>
<a name='L333'><b>unsigned</b> <b>int</b> <a href='../S/35.html#L431' title='Defined at 431 in src/redis.c.'>dictSdsHash</a>(<b>const</b> <b>void</b> *key);
<a name='L334'><b>int</b> <a href='../S/35.html#L382' title='Defined at 382 in src/redis.c.'>dictSdsKeyCompare</a>(<b>void</b> *privdata, <b>const</b> <b>void</b> *key1, <b>const</b> <b>void</b> *key2);
<a name='L335'><b>void</b> <a href='../S/82.html#L910' title='Defined at 910 in src/sentinel.c.'>releaseSentinelRedisInstance</a>(sentinelRedisInstance *ri);
<a name='L336'>
<a name='L337'><b>void</b> <a href='../S/82.html#L351' title='Refered from 351 in src/sentinel.c.'>dictInstancesValDestructor</a> (<b>void</b> *privdata, <b>void</b> *obj) <font color='red'>{</font>
<a name='L338'>    <a href='../S/82.html#L910' title='Defined at 910 in src/sentinel.c.'>releaseSentinelRedisInstance</a>(obj);
<a name='L339'><font color='red'>}</font>
<a name='L340'>
<a name='L341'><i><font color='green'>/* Instance name (sds) -&gt; instance (sentinelRedisInstance pointer)</font></i>
<a name='L342'><i><font color='green'> *</font></i>
<a name='L343'><i><font color='green'> * also used for: sentinelRedisInstance-&gt;sentinels dictionary that maps</font></i>
<a name='L344'><i><font color='green'> * sentinels ip:port to last seen time in Pub/Sub hello message. */</font></i>
<a name='L345'><a href='../D/2127.html' title='Multiple defined in 4 places.'>dictType</a> instancesDictType = <font color='red'>{</font>
<a name='L346'>    <a href='../S/35.html#L431' title='Defined at 431 in src/redis.c.'>dictSdsHash</a>,               <i><font color='green'>/* hash function */</font></i>
<a name='L347'>    NULL,                      <i><font color='green'>/* key dup */</font></i>
<a name='L348'>    NULL,                      <i><font color='green'>/* val dup */</font></i>
<a name='L349'>    <a href='../S/35.html#L382' title='Defined at 382 in src/redis.c.'>dictSdsKeyCompare</a>,         <i><font color='green'>/* key compare */</font></i>
<a name='L350'>    NULL,                      <i><font color='green'>/* key destructor */</font></i>
<a name='L351'>    <a href='../S/82.html#L337' title='Defined at 337 in src/sentinel.c.'>dictInstancesValDestructor</a> <i><font color='green'>/* val destructor */</font></i>
<a name='L352'><font color='red'>}</font>;
<a name='L353'>
<a name='L354'><i><font color='green'>/* Instance runid (sds) -&gt; votes (long casted to void*)</font></i>
<a name='L355'><i><font color='green'> *</font></i>
<a name='L356'><i><font color='green'> * This is useful into sentinelGetObjectiveLeader() function in order to</font></i>
<a name='L357'><i><font color='green'> * count the votes and understand who is the leader. */</font></i>
<a name='L358'><a href='../D/2127.html' title='Multiple defined in 4 places.'>dictType</a> leaderVotesDictType = <font color='red'>{</font>
<a name='L359'>    <a href='../S/35.html#L431' title='Defined at 431 in src/redis.c.'>dictSdsHash</a>,               <i><font color='green'>/* hash function */</font></i>
<a name='L360'>    NULL,                      <i><font color='green'>/* key dup */</font></i>
<a name='L361'>    NULL,                      <i><font color='green'>/* val dup */</font></i>
<a name='L362'>    <a href='../S/35.html#L382' title='Defined at 382 in src/redis.c.'>dictSdsKeyCompare</a>,         <i><font color='green'>/* key compare */</font></i>
<a name='L363'>    NULL,                      <i><font color='green'>/* key destructor */</font></i>
<a name='L364'>    NULL                       <i><font color='green'>/* val destructor */</font></i>
<a name='L365'><font color='red'>}</font>;
<a name='L366'>
<a name='L367'><i><font color='green'>/* =========================== Initialization =============================== */</font></i>
<a name='L368'>
<a name='L369'><b>void</b> <a href='../S/82.html#L1974' title='Defined at 1974 in src/sentinel.c.'>sentinelCommand</a>(redisClient *c);
<a name='L370'><b>void</b> <a href='../S/82.html#L2078' title='Defined at 2078 in src/sentinel.c.'>sentinelInfoCommand</a>(redisClient *c);
<a name='L371'>
<a name='L372'><b>struct</b> <a href='../D/3782.html' title='Multiple defined in 2 places.'>redisCommand</a> sentinelcmds[] = <font color='red'>{</font>
<a name='L373'>    <font color='red'>{</font>"ping",<a href='../S/35.html#L1795' title='Defined at 1795 in src/redis.c.'>pingCommand</a>,1,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L374'>    <font color='red'>{</font>"sentinel",<a href='../S/82.html#L1974' title='Defined at 1974 in src/sentinel.c.'>sentinelCommand</a>,-2,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L375'>    <font color='red'>{</font>"subscribe",<a href='../S/46.html#L255' title='Defined at 255 in src/pubsub.c.'>subscribeCommand</a>,-2,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L376'>    <font color='red'>{</font>"unsubscribe",<a href='../S/46.html#L262' title='Defined at 262 in src/pubsub.c.'>unsubscribeCommand</a>,-1,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L377'>    <font color='red'>{</font>"psubscribe",<a href='../S/46.html#L274' title='Defined at 274 in src/pubsub.c.'>psubscribeCommand</a>,-2,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L378'>    <font color='red'>{</font>"punsubscribe",<a href='../S/46.html#L281' title='Defined at 281 in src/pubsub.c.'>punsubscribeCommand</a>,-1,"",0,NULL,0,0,0,0,0<font color='red'>}</font>,
<a name='L379'>    <font color='red'>{</font>"info",<a href='../S/82.html#L2078' title='Defined at 2078 in src/sentinel.c.'>sentinelInfoCommand</a>,-1,"",0,NULL,0,0,0,0,0<font color='red'>}</font>
<a name='L380'><font color='red'>}</font>;
<a name='L381'>
<a name='L382'><i><font color='green'>/* This function overwrites a few normal Redis config default with Sentinel</font></i>
<a name='L383'><i><font color='green'> * specific defaults. */</font></i>
<a name='L384'><b>void</b> <a href='../R/2205.html' title='Multiple refered from 2 places.'>initSentinelConfig</a>(<b>void</b>) <font color='red'>{</font>
<a name='L385'>    server.port = <a href='../S/82.html#L42' title='Defined at 42 in src/sentinel.c.'>REDIS_SENTINEL_PORT</a>;
<a name='L386'><font color='red'>}</font>
<a name='L387'>
<a name='L388'><i><font color='green'>/* Perform the Sentinel mode initialization. */</font></i>
<a name='L389'><b>void</b> <a href='../R/2204.html' title='Multiple refered from 2 places.'>initSentinel</a>(<b>void</b>) <font color='red'>{</font>
<a name='L390'>    <b>int</b> j;
<a name='L391'>
<a name='L392'>    <i><font color='green'>/* Remove usual Redis commands from the command table, then just add</font></i>
<a name='L393'><i><font color='green'>     * the SENTINEL command. */</font></i>
<a name='L394'>    <a href='../S/29.html#L673' title='Defined at 673 in src/dict.c.'>dictEmpty</a>(server.commands);
<a name='L395'>    <b>for</b> (j = 0; j &lt; <b>sizeof</b>(sentinelcmds)/<b>sizeof</b>(sentinelcmds[0]); j++) <font color='red'>{</font>
<a name='L396'>        <b>int</b> retval;
<a name='L397'>        <b>struct</b> <a href='../D/3782.html' title='Multiple defined in 2 places.'>redisCommand</a> *cmd = sentinelcmds+j;
<a name='L398'>
<a name='L399'>        retval = <a href='../D/2061.html' title='Multiple defined in 2 places.'>dictAdd</a>(server.commands, <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(cmd-&gt;name), cmd);
<a name='L400'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(retval == <a href='../D/124.html' title='Multiple defined in 2 places.'>DICT_OK</a>);
<a name='L401'>    <font color='red'>}</font>
<a name='L402'>
<a name='L403'>    <i><font color='green'>/* Initialize various data structures. */</font></i>
<a name='L404'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;instancesDictType,NULL);
<a name='L405'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt = 0;
<a name='L406'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt_start_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L407'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.previous_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L408'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.running_scripts = 0;
<a name='L409'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue = <a href='../S/54.html#L41' title='Defined at 41 in src/adlist.c.'>listCreate</a>();
<a name='L410'><font color='red'>}</font>
<a name='L411'>
<a name='L412'><i><font color='green'>/* ============================== sentinelAddr ============================== */</font></i>
<a name='L413'>
<a name='L414'><i><font color='green'>/* Create a sentinelAddr object and return it on success.</font></i>
<a name='L415'><i><font color='green'> * On error NULL is returned and errno is set to:</font></i>
<a name='L416'><i><font color='green'> *  ENOENT: Can't resolve the hostname.</font></i>
<a name='L417'><i><font color='green'> *  EINVAL: Invalid port number.</font></i>
<a name='L418'><i><font color='green'> */</font></i>
<a name='L419'><a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *<a href='../R/1705.html' title='Multiple refered from 2 places.'>createSentinelAddr</a>(<b>char</b> *hostname, <b>int</b> port) <font color='red'>{</font>
<a name='L420'>    <b>char</b> buf[32];
<a name='L421'>    <a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *sa;
<a name='L422'>
<a name='L423'>    <b>if</b> (port &lt;= 0 || port &gt; 65535) <font color='red'>{</font>
<a name='L424'>        errno = EINVAL;
<a name='L425'>        <b>return</b> NULL;
<a name='L426'>    <font color='red'>}</font>
<a name='L427'>    <b>if</b> (<a href='../S/50.html#L109' title='Defined at 109 in src/anet.c.'>anetResolve</a>(NULL,hostname,buf) == <a href='../S/84.html#L35' title='Defined at 35 in src/anet.h.'>ANET_ERR</a>) <font color='red'>{</font>
<a name='L428'>        errno = ENOENT;
<a name='L429'>        <b>return</b> NULL;
<a name='L430'>    <font color='red'>}</font>
<a name='L431'>    sa = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*sa));
<a name='L432'>    sa-&gt;ip = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(buf);
<a name='L433'>    sa-&gt;port = port;
<a name='L434'>    <b>return</b> sa;
<a name='L435'><font color='red'>}</font>
<a name='L436'>
<a name='L437'><i><font color='green'>/* Free a Sentinel address. Can't fail. */</font></i>
<a name='L438'><b>void</b> <a href='../R/3515.html' title='Multiple refered from 2 places.'>releaseSentinelAddr</a>(sentinelAddr *sa) <font color='red'>{</font>
<a name='L439'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sa-&gt;ip);
<a name='L440'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(sa);
<a name='L441'><font color='red'>}</font>
<a name='L442'>
<a name='L443'><i><font color='green'>/* =========================== Events notification ========================== */</font></i>
<a name='L444'>
<a name='L445'><i><font color='green'>/* Send an event to log, pub/sub, user notification script.</font></i>
<a name='L446'><i><font color='green'> * </font></i>
<a name='L447'><i><font color='green'> * 'level' is the log level for logging. Only REDIS_WARNING events will trigger</font></i>
<a name='L448'><i><font color='green'> * the execution of the user notification script.</font></i>
<a name='L449'><i><font color='green'> *</font></i>
<a name='L450'><i><font color='green'> * 'type' is the message type, also used as a pub/sub channel name.</font></i>
<a name='L451'><i><font color='green'> *</font></i>
<a name='L452'><i><font color='green'> * 'ri', is the redis instance target of this event if applicable, and is</font></i>
<a name='L453'><i><font color='green'> * used to obtain the path of the notification script to execute.</font></i>
<a name='L454'><i><font color='green'> *</font></i>
<a name='L455'><i><font color='green'> * The remaining arguments are printf-alike.</font></i>
<a name='L456'><i><font color='green'> * If the format specifier starts with the two characters "%@" then ri is</font></i>
<a name='L457'><i><font color='green'> * not NULL, and the message is prefixed with an instance identifier in the</font></i>
<a name='L458'><i><font color='green'> * following format:</font></i>
<a name='L459'><i><font color='green'> *</font></i>
<a name='L460'><i><font color='green'> *  &lt;instance type&gt; &lt;instance name&gt; &lt;ip&gt; &lt;port&gt;</font></i>
<a name='L461'><i><font color='green'> *</font></i>
<a name='L462'><i><font color='green'> *  If the instance type is not master, than the additional string is</font></i>
<a name='L463'><i><font color='green'> *  added to specify the originating master:</font></i>
<a name='L464'><i><font color='green'> *</font></i>
<a name='L465'><i><font color='green'> *  @ &lt;master name&gt; &lt;master ip&gt; &lt;master port&gt;</font></i>
<a name='L466'><i><font color='green'> *</font></i>
<a name='L467'><i><font color='green'> *  Any other specifier after "%@" is processed by printf itself.</font></i>
<a name='L468'><i><font color='green'> */</font></i>
<a name='L469'><b>void</b> <a href='../R/3677.html' title='Multiple refered from 48 places.'>sentinelEvent</a>(<b>int</b> level, <b>char</b> *type, sentinelRedisInstance *ri,
<a name='L470'>                   <b>const</b> <b>char</b> *fmt, ...) <font color='red'>{</font>
<a name='L471'>    va_list ap;
<a name='L472'>    <b>char</b> msg[<a href='../S/32.html#L81' title='Defined at 81 in src/redis.h.'>REDIS_MAX_LOGMSG_LEN</a>];
<a name='L473'>    <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *channel, *payload;
<a name='L474'>
<a name='L475'>    <i><font color='green'>/* Handle %@ */</font></i>
<a name='L476'>    <b>if</b> (fmt[0] == '%' &amp;&amp; fmt[1] == '@') <font color='red'>{</font>
<a name='L477'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *master = (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) ?
<a name='L478'>                                         NULL : ri-&gt;master;
<a name='L479'>
<a name='L480'>        <b>if</b> (master) <font color='red'>{</font>
<a name='L481'>            snprintf(msg, <b>sizeof</b>(msg), "%s %s %s %d @ %s %s %d",
<a name='L482'>                <a href='../S/82.html#L951' title='Defined at 951 in src/sentinel.c.'>sentinelRedisInstanceTypeStr</a>(ri),
<a name='L483'>                ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,
<a name='L484'>                master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port);
<a name='L485'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L486'>            snprintf(msg, <b>sizeof</b>(msg), "%s %s %s %d",
<a name='L487'>                <a href='../S/82.html#L951' title='Defined at 951 in src/sentinel.c.'>sentinelRedisInstanceTypeStr</a>(ri),
<a name='L488'>                ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port);
<a name='L489'>        <font color='red'>}</font>
<a name='L490'>        fmt += 2;
<a name='L491'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L492'>        msg[0] = '\0';
<a name='L493'>    <font color='red'>}</font>
<a name='L494'>
<a name='L495'>    <i><font color='green'>/* Use vsprintf for the rest of the formatting if any. */</font></i>
<a name='L496'>    <b>if</b> (fmt[0] != '\0') <font color='red'>{</font>
<a name='L497'>        va_start(ap, fmt);
<a name='L498'>        vsnprintf(msg+strlen(msg), <b>sizeof</b>(msg)-strlen(msg), fmt, ap);
<a name='L499'>        va_end(ap);
<a name='L500'>    <font color='red'>}</font>
<a name='L501'>
<a name='L502'>    <i><font color='green'>/* Log the message if the log level allows it to be logged. */</font></i>
<a name='L503'>    <b>if</b> (level &gt;= server.verbosity)
<a name='L504'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(level,"%s %s",type,msg);
<a name='L505'>
<a name='L506'>    <i><font color='green'>/* Publish the message via Pub/Sub if it's not a debugging one. */</font></i>
<a name='L507'>    <b>if</b> (level != <a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>) <font color='red'>{</font>
<a name='L508'>        channel = <a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>(type,strlen(type));
<a name='L509'>        payload = <a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>(msg,strlen(msg));
<a name='L510'>        <a href='../S/46.html#L203' title='Defined at 203 in src/pubsub.c.'>pubsubPublishMessage</a>(channel,payload);
<a name='L511'>        <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(channel);
<a name='L512'>        <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(payload);
<a name='L513'>    <font color='red'>}</font>
<a name='L514'>
<a name='L515'>    <i><font color='green'>/* Call the notification script if applicable. */</font></i>
<a name='L516'>    <b>if</b> (level == <a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a> &amp;&amp; ri != NULL) <font color='red'>{</font>
<a name='L517'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *master = (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) ?
<a name='L518'>                                         ri : ri-&gt;master;
<a name='L519'>        <b>if</b> (master-&gt;notification_script) <font color='red'>{</font>
<a name='L520'>            <a href='../S/82.html#L538' title='Defined at 538 in src/sentinel.c.'>sentinelScheduleScriptExecution</a>(master-&gt;notification_script,
<a name='L521'>                type,msg,NULL);
<a name='L522'>        <font color='red'>}</font>
<a name='L523'>    <font color='red'>}</font>
<a name='L524'><font color='red'>}</font>
<a name='L525'>
<a name='L526'><i><font color='green'>/* ============================ script execution ============================ */</font></i>
<a name='L527'>
<a name='L528'><i><font color='green'>/* Release a script job structure and all the associated data. */</font></i>
<a name='L529'><b>void</b> <a href='../R/3712.html' title='Multiple refered from 2 places.'>sentinelReleaseScriptJob</a>(sentinelScriptJob *sj) <font color='red'>{</font>
<a name='L530'>    <b>int</b> j = 0;
<a name='L531'>
<a name='L532'>    <b>while</b>(sj-&gt;argv[j]) <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sj-&gt;argv[j++]);
<a name='L533'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(sj-&gt;argv);
<a name='L534'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(sj);
<a name='L535'><font color='red'>}</font>
<a name='L536'>
<a name='L537'><font color='darkred'>#define</font> <a href='../R/853.html' title='Multiple refered from 2 places.'>SENTINEL_SCRIPT_MAX_ARGS</a> 16
<a name='L538'><b>void</b> <a href='../R/3717.html' title='Multiple refered from 3 places.'>sentinelScheduleScriptExecution</a>(<b>char</b> *path, ...) <font color='red'>{</font>
<a name='L539'>    va_list ap;
<a name='L540'>    <b>char</b> *argv[<a href='../S/82.html#L537' title='Defined at 537 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_ARGS</a>+1];
<a name='L541'>    <b>int</b> argc = 1;
<a name='L542'>    <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj;
<a name='L543'>
<a name='L544'>    va_start(ap, path);
<a name='L545'>    <b>while</b>(argc &lt; <a href='../S/82.html#L537' title='Defined at 537 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_ARGS</a>) <font color='red'>{</font>
<a name='L546'>        argv[argc] = va_arg(ap,<b>char</b>*);
<a name='L547'>        <b>if</b> (!argv[argc]) <b>break</b>;
<a name='L548'>        argv[argc] = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(argv[argc]); <i><font color='green'>/* Copy the string. */</font></i>
<a name='L549'>        argc++;
<a name='L550'>    <font color='red'>}</font>
<a name='L551'>    va_end(ap);
<a name='L552'>    argv[0] = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(path);
<a name='L553'>    
<a name='L554'>    sj = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*sj));
<a name='L555'>    sj-&gt;flags = <a href='../S/82.html#L124' title='Defined at 124 in src/sentinel.c.'>SENTINEL_SCRIPT_NONE</a>;
<a name='L556'>    sj-&gt;retry_num = 0;
<a name='L557'>    sj-&gt;argv = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(<b>char</b>*)*(argc+1));
<a name='L558'>    sj-&gt;start_time = 0;
<a name='L559'>    sj-&gt;pid = 0;
<a name='L560'>    memcpy(sj-&gt;argv,argv,<b>sizeof</b>(<b>char</b>*)*(argc+1));
<a name='L561'>
<a name='L562'>    <a href='../S/54.html#L106' title='Defined at 106 in src/adlist.c.'>listAddNodeTail</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,sj);
<a name='L563'>
<a name='L564'>    <i><font color='green'>/* Remove the oldest non running script if we already hit the limit. */</font></i>
<a name='L565'>    <b>if</b> (<a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue) &gt; <a href='../S/82.html#L126' title='Defined at 126 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_QUEUE</a>) <font color='red'>{</font>
<a name='L566'>        <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L567'>        <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L568'>
<a name='L569'>        <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,&amp;li);
<a name='L570'>        <b>while</b> ((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li)) != NULL) <font color='red'>{</font>
<a name='L571'>            sj = ln-&gt;value;
<a name='L572'>
<a name='L573'>            <b>if</b> (sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>) <b>continue</b>;
<a name='L574'>            <i><font color='green'>/* The first node is the oldest as we add on tail. */</font></i>
<a name='L575'>            <a href='../S/54.html#L159' title='Defined at 159 in src/adlist.c.'>listDelNode</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,ln);
<a name='L576'>            <a href='../S/82.html#L529' title='Defined at 529 in src/sentinel.c.'>sentinelReleaseScriptJob</a>(sj);
<a name='L577'>            <b>break</b>;
<a name='L578'>        <font color='red'>}</font>
<a name='L579'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(<a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue) &lt;=
<a name='L580'>                    <a href='../S/82.html#L126' title='Defined at 126 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_QUEUE</a>);
<a name='L581'>    <font color='red'>}</font>
<a name='L582'><font color='red'>}</font>
<a name='L583'>
<a name='L584'><i><font color='green'>/* Lookup a script in the scripts queue via pid, and returns the list node</font></i>
<a name='L585'><i><font color='green'> * (so that we can easily remove it from the queue if needed). */</font></i>
<a name='L586'><a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *<a href='../S/82.html#L680' title='Refered from 680 in src/sentinel.c.'>sentinelGetScriptListNodeByPid</a>(pid_t pid) <font color='red'>{</font>
<a name='L587'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L588'>    <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L589'>
<a name='L590'>    <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,&amp;li);
<a name='L591'>    <b>while</b> ((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li)) != NULL) <font color='red'>{</font>
<a name='L592'>        <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj = ln-&gt;value;
<a name='L593'>
<a name='L594'>        <b>if</b> ((sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>) &amp;&amp; sj-&gt;pid == pid)
<a name='L595'>            <b>return</b> ln;
<a name='L596'>    <font color='red'>}</font>
<a name='L597'>    <b>return</b> NULL;
<a name='L598'><font color='red'>}</font>
<a name='L599'>
<a name='L600'><i><font color='green'>/* Run pending scripts if we are not already at max number of running</font></i>
<a name='L601'><i><font color='green'> * scripts. */</font></i>
<a name='L602'><b>void</b> <a href='../S/82.html#L3053' title='Refered from 3053 in src/sentinel.c.'>sentinelRunPendingScripts</a>(<b>void</b>) <font color='red'>{</font>
<a name='L603'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L604'>    <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L605'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> now = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L606'>
<a name='L607'>    <i><font color='green'>/* Find jobs that are not running and run them, from the top to the</font></i>
<a name='L608'><i><font color='green'>     * tail of the queue, so we run older jobs first. */</font></i>
<a name='L609'>    <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,&amp;li);
<a name='L610'>    <b>while</b> (<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.running_scripts &lt; <a href='../S/82.html#L127' title='Defined at 127 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RUNNING</a> &amp;&amp;
<a name='L611'>           (ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li)) != NULL)
<a name='L612'>    <font color='red'>{</font>
<a name='L613'>        <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj = ln-&gt;value;
<a name='L614'>        pid_t pid;
<a name='L615'>
<a name='L616'>        <i><font color='green'>/* Skip if already running. */</font></i>
<a name='L617'>        <b>if</b> (sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>) <b>continue</b>;
<a name='L618'>
<a name='L619'>        <i><font color='green'>/* Skip if it's a retry, but not enough time has elapsed. */</font></i>
<a name='L620'>        <b>if</b> (sj-&gt;start_time &amp;&amp; sj-&gt;start_time &gt; now) <b>continue</b>;
<a name='L621'>
<a name='L622'>        sj-&gt;flags |= <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>;
<a name='L623'>        sj-&gt;start_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L624'>        sj-&gt;retry_num++;
<a name='L625'>        pid = fork();
<a name='L626'>
<a name='L627'>        <b>if</b> (pid == -1) <font color='red'>{</font>
<a name='L628'>            <i><font color='green'>/* Parent (fork error).</font></i>
<a name='L629'><i><font color='green'>             * We report fork errors as signal 99, in order to unify the</font></i>
<a name='L630'><i><font color='green'>             * reporting with other kind of errors. */</font></i>
<a name='L631'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-script-error",NULL,
<a name='L632'>                          "%s %d %d", sj-&gt;argv[0], 99, 0);
<a name='L633'>            sj-&gt;flags &amp;= ~<a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>;
<a name='L634'>            sj-&gt;pid = 0;
<a name='L635'>        <font color='red'>}</font> <b>else</b> <b>if</b> (pid == 0) <font color='red'>{</font>
<a name='L636'>            <i><font color='green'>/* Child */</font></i>
<a name='L637'>            execve(sj-&gt;argv[0],sj-&gt;argv,environ);
<a name='L638'>            <i><font color='green'>/* If we are here an error occurred. */</font></i>
<a name='L639'>            _exit(2); <i><font color='green'>/* Don't retry execution. */</font></i>
<a name='L640'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L641'>            <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.running_scripts++;
<a name='L642'>            sj-&gt;pid = pid;
<a name='L643'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>,"+script-child",NULL,"%ld",(<b>long</b>)pid);
<a name='L644'>        <font color='red'>}</font>
<a name='L645'>    <font color='red'>}</font>
<a name='L646'><font color='red'>}</font>
<a name='L647'>
<a name='L648'><i><font color='green'>/* How much to delay the execution of a script that we need to retry after</font></i>
<a name='L649'><i><font color='green'> * an error?</font></i>
<a name='L650'><i><font color='green'> *</font></i>
<a name='L651'><i><font color='green'> * We double the retry delay for every further retry we do. So for instance</font></i>
<a name='L652'><i><font color='green'> * if RETRY_DELAY is set to 30 seconds and the max number of retries is 10</font></i>
<a name='L653'><i><font color='green'> * starting from the second attempt to execute the script the delays are:</font></i>
<a name='L654'><i><font color='green'> * 30 sec, 60 sec, 2 min, 4 min, 8 min, 16 min, 32 min, 64 min, 128 min. */</font></i>
<a name='L655'><a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> <a href='../S/82.html#L696' title='Refered from 696 in src/sentinel.c.'>sentinelScriptRetryDelay</a>(<b>int</b> retry_num) <font color='red'>{</font>
<a name='L656'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> delay = <a href='../S/82.html#L130' title='Defined at 130 in src/sentinel.c.'>SENTINEL_SCRIPT_RETRY_DELAY</a>;
<a name='L657'>
<a name='L658'>    <b>while</b> (retry_num-- &gt; 1) delay *= 2;
<a name='L659'>    <b>return</b> delay;
<a name='L660'><font color='red'>}</font>
<a name='L661'>
<a name='L662'><i><font color='green'>/* Check for scripts that terminated, and remove them from the queue if the</font></i>
<a name='L663'><i><font color='green'> * script terminated successfully. If instead the script was terminated by</font></i>
<a name='L664'><i><font color='green'> * a signal, or returned exit code "1", it is scheduled to run again if</font></i>
<a name='L665'><i><font color='green'> * the max number of retries did not already elapsed. */</font></i>
<a name='L666'><b>void</b> <a href='../S/82.html#L3054' title='Refered from 3054 in src/sentinel.c.'>sentinelCollectTerminatedScripts</a>(<b>void</b>) <font color='red'>{</font>
<a name='L667'>    <b>int</b> statloc;
<a name='L668'>    pid_t pid;
<a name='L669'>
<a name='L670'>    <b>while</b> ((pid = wait3(&amp;statloc,WNOHANG,NULL)) &gt; 0) <font color='red'>{</font>
<a name='L671'>        <b>int</b> exitcode = WEXITSTATUS(statloc);
<a name='L672'>        <b>int</b> bysignal = 0;
<a name='L673'>        <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L674'>        <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj;
<a name='L675'>
<a name='L676'>        <b>if</b> (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);
<a name='L677'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>,"-script-child",NULL,"%ld %d %d",
<a name='L678'>            (<b>long</b>)pid, exitcode, bysignal);
<a name='L679'>        
<a name='L680'>        ln = <a href='../S/82.html#L586' title='Defined at 586 in src/sentinel.c.'>sentinelGetScriptListNodeByPid</a>(pid);
<a name='L681'>        <b>if</b> (ln == NULL) <font color='red'>{</font>
<a name='L682'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"wait3() returned a pid (%ld) we can't find in our scripts execution queue!", (<b>long</b>)pid);
<a name='L683'>            <b>continue</b>;
<a name='L684'>        <font color='red'>}</font>
<a name='L685'>        sj = ln-&gt;value;
<a name='L686'>
<a name='L687'>        <i><font color='green'>/* If the script was terminated by a signal or returns an</font></i>
<a name='L688'><i><font color='green'>         * exit code of "1" (that means: please retry), we reschedule it</font></i>
<a name='L689'><i><font color='green'>         * if the max number of retries is not already reached. */</font></i>
<a name='L690'>        <b>if</b> ((bysignal || exitcode == 1) &amp;&amp;
<a name='L691'>            sj-&gt;retry_num != <a href='../S/82.html#L129' title='Defined at 129 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RETRY</a>)
<a name='L692'>        <font color='red'>{</font>
<a name='L693'>            sj-&gt;flags &amp;= ~<a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>;
<a name='L694'>            sj-&gt;pid = 0;
<a name='L695'>            sj-&gt;start_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() +
<a name='L696'>                             <a href='../S/82.html#L655' title='Defined at 655 in src/sentinel.c.'>sentinelScriptRetryDelay</a>(sj-&gt;retry_num);
<a name='L697'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L698'>            <i><font color='green'>/* Otherwise let's remove the script, but log the event if the</font></i>
<a name='L699'><i><font color='green'>             * execution did not terminated in the best of the ways. */</font></i>
<a name='L700'>            <b>if</b> (bysignal || exitcode != 0) <font color='red'>{</font>
<a name='L701'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-script-error",NULL,
<a name='L702'>                              "%s %d %d", sj-&gt;argv[0], bysignal, exitcode);
<a name='L703'>            <font color='red'>}</font>
<a name='L704'>            <a href='../S/54.html#L159' title='Defined at 159 in src/adlist.c.'>listDelNode</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,ln);
<a name='L705'>            <a href='../S/82.html#L529' title='Defined at 529 in src/sentinel.c.'>sentinelReleaseScriptJob</a>(sj);
<a name='L706'>            <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.running_scripts--;
<a name='L707'>        <font color='red'>}</font>
<a name='L708'>    <font color='red'>}</font>
<a name='L709'><font color='red'>}</font>
<a name='L710'>
<a name='L711'><i><font color='green'>/* Kill scripts in timeout, they'll be collected by the</font></i>
<a name='L712'><i><font color='green'> * sentinelCollectTerminatedScripts() function. */</font></i>
<a name='L713'><b>void</b> <a href='../S/82.html#L3055' title='Refered from 3055 in src/sentinel.c.'>sentinelKillTimedoutScripts</a>(<b>void</b>) <font color='red'>{</font>
<a name='L714'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L715'>    <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L716'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> now = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L717'>
<a name='L718'>    <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,&amp;li);
<a name='L719'>    <b>while</b> ((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li)) != NULL) <font color='red'>{</font>
<a name='L720'>        <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj = ln-&gt;value;
<a name='L721'>
<a name='L722'>        <b>if</b> (sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a> &amp;&amp;
<a name='L723'>            (now - sj-&gt;start_time) &gt; <a href='../S/82.html#L128' title='Defined at 128 in src/sentinel.c.'>SENTINEL_SCRIPT_MAX_RUNTIME</a>)
<a name='L724'>        <font color='red'>{</font>
<a name='L725'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-script-timeout",NULL,"%s %ld",
<a name='L726'>                sj-&gt;argv[0], (<b>long</b>)sj-&gt;pid);
<a name='L727'>            kill(sj-&gt;pid,SIGKILL);
<a name='L728'>        <font color='red'>}</font>
<a name='L729'>    <font color='red'>}</font>
<a name='L730'><font color='red'>}</font>
<a name='L731'>
<a name='L732'><i><font color='green'>/* Implements SENTINEL PENDING-SCRIPTS command. */</font></i>
<a name='L733'><b>void</b> <a href='../S/82.html#L2066' title='Refered from 2066 in src/sentinel.c.'>sentinelPendingScriptsCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L734'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L735'>    <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L736'>
<a name='L737'>    <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,<a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue));
<a name='L738'>    <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue,&amp;li);
<a name='L739'>    <b>while</b> ((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li)) != NULL) <font color='red'>{</font>
<a name='L740'>        <a href='../D/4089.html' title='Multiple defined in 2 places.'>sentinelScriptJob</a> *sj = ln-&gt;value;
<a name='L741'>        <b>int</b> j = 0;
<a name='L742'>
<a name='L743'>        <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,10);
<a name='L744'>
<a name='L745'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"argv");
<a name='L746'>        <b>while</b> (sj-&gt;argv[j]) j++;
<a name='L747'>        <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,j);
<a name='L748'>        j = 0;
<a name='L749'>        <b>while</b> (sj-&gt;argv[j]) <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,sj-&gt;argv[j++]);
<a name='L750'>
<a name='L751'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"flags");
<a name='L752'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,
<a name='L753'>            (sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>) ? "running" : "scheduled");
<a name='L754'>
<a name='L755'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"pid");
<a name='L756'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,sj-&gt;pid);
<a name='L757'>
<a name='L758'>        <b>if</b> (sj-&gt;flags &amp; <a href='../S/82.html#L125' title='Defined at 125 in src/sentinel.c.'>SENTINEL_SCRIPT_RUNNING</a>) <font color='red'>{</font>
<a name='L759'>            <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"run-time");
<a name='L760'>            <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - sj-&gt;start_time);
<a name='L761'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L762'>            <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> delay = sj-&gt;start_time ? (sj-&gt;start_time-<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>()) : 0;
<a name='L763'>            <b>if</b> (delay &lt; 0) delay = 0;
<a name='L764'>            <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"run-delay");
<a name='L765'>            <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,delay);
<a name='L766'>        <font color='red'>}</font>
<a name='L767'>
<a name='L768'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"retry-num");
<a name='L769'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,sj-&gt;retry_num);
<a name='L770'>    <font color='red'>}</font>
<a name='L771'><font color='red'>}</font>
<a name='L772'>
<a name='L773'><i><font color='green'>/* This function calls, if any, the client reconfiguration script with the</font></i>
<a name='L774'><i><font color='green'> * following parameters:</font></i>
<a name='L775'><i><font color='green'> *</font></i>
<a name='L776'><i><font color='green'> * &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</font></i>
<a name='L777'><i><font color='green'> *</font></i>
<a name='L778'><i><font color='green'> * It is called every time a failover starts, ends, or is aborted.</font></i>
<a name='L779'><i><font color='green'> *</font></i>
<a name='L780'><i><font color='green'> * &lt;state&gt; is "start", "end" or "abort".</font></i>
<a name='L781'><i><font color='green'> * &lt;role&gt; is either "leader" or "observer".</font></i>
<a name='L782'><i><font color='green'> *</font></i>
<a name='L783'><i><font color='green'> * from/to fields are respectively master -&gt; promoted slave addresses for</font></i>
<a name='L784'><i><font color='green'> * "start" and "end", or the reverse (promoted slave -&gt; master) in case of</font></i>
<a name='L785'><i><font color='green'> * "abort".</font></i>
<a name='L786'><i><font color='green'> */</font></i>
<a name='L787'><b>void</b> <a href='../R/3667.html' title='Multiple refered from 4 places.'>sentinelCallClientReconfScript</a>(sentinelRedisInstance *master, <b>int</b> role, <b>char</b> *state, sentinelAddr *from, sentinelAddr *to) <font color='red'>{</font>
<a name='L788'>    <b>char</b> fromport[32], toport[32];
<a name='L789'>
<a name='L790'>    <b>if</b> (master-&gt;client_reconfig_script == NULL) <b>return</b>;
<a name='L791'>    <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(fromport,<b>sizeof</b>(fromport),from-&gt;port);
<a name='L792'>    <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(toport,<b>sizeof</b>(toport),to-&gt;port);
<a name='L793'>    <a href='../S/82.html#L538' title='Defined at 538 in src/sentinel.c.'>sentinelScheduleScriptExecution</a>(master-&gt;client_reconfig_script,
<a name='L794'>        master-&gt;name,
<a name='L795'>        (role == <a href='../S/82.html#L120' title='Defined at 120 in src/sentinel.c.'>SENTINEL_LEADER</a>) ? "leader" : "observer",
<a name='L796'>        state, from-&gt;ip, fromport, to-&gt;ip, toport, NULL);
<a name='L797'><font color='red'>}</font>
<a name='L798'>
<a name='L799'><i><font color='green'>/* ========================== sentinelRedisInstance ========================= */</font></i>
<a name='L800'>
<a name='L801'><i><font color='green'>/* Create a redis instance, the following fields must be populated by the</font></i>
<a name='L802'><i><font color='green'> * caller if needed:</font></i>
<a name='L803'><i><font color='green'> * runid: set to NULL but will be populated once INFO output is received.</font></i>
<a name='L804'><i><font color='green'> * info_refresh: is set to 0 to mean that we never received INFO so far.</font></i>
<a name='L805'><i><font color='green'> *</font></i>
<a name='L806'><i><font color='green'> * If SRI_MASTER is set into initial flags the instance is added to</font></i>
<a name='L807'><i><font color='green'> * sentinel.masters table.</font></i>
<a name='L808'><i><font color='green'> *</font></i>
<a name='L809'><i><font color='green'> * if SRI_SLAVE or SRI_SENTINEL is set then 'master' must be not NULL and the</font></i>
<a name='L810'><i><font color='green'> * instance is added into master-&gt;slaves or master-&gt;sentinels table.</font></i>
<a name='L811'><i><font color='green'> *</font></i>
<a name='L812'><i><font color='green'> * If the instance is a slave or sentinel, the name parameter is ignored and</font></i>
<a name='L813'><i><font color='green'> * is created automatically as hostname:port.</font></i>
<a name='L814'><i><font color='green'> *</font></i>
<a name='L815'><i><font color='green'> * The function fails if hostname can't be resolved or port is out of range.</font></i>
<a name='L816'><i><font color='green'> * When this happens NULL is returned and errno is set accordingly to the</font></i>
<a name='L817'><i><font color='green'> * createSentinelAddr() function.</font></i>
<a name='L818'><i><font color='green'> *</font></i>
<a name='L819'><i><font color='green'> * The function may also fail and return NULL with errno set to EBUSY if</font></i>
<a name='L820'><i><font color='green'> * a master or slave with the same name already exists. */</font></i>
<a name='L821'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../R/1706.html' title='Multiple refered from 3 places.'>createSentinelRedisInstance</a>(<b>char</b> *name, <b>int</b> flags, <b>char</b> *hostname, <b>int</b> port, <b>int</b> quorum, sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L822'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L823'>    <a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *addr;
<a name='L824'>    <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *table = NULL;
<a name='L825'>    <b>char</b> slavename[128], *sdsname;
<a name='L826'>
<a name='L827'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(flags &amp; (<a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>|<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>|<a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>));
<a name='L828'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>((flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) || master != NULL);
<a name='L829'>
<a name='L830'>    <i><font color='green'>/* Check address validity. */</font></i>
<a name='L831'>    addr = <a href='../S/82.html#L419' title='Defined at 419 in src/sentinel.c.'>createSentinelAddr</a>(hostname,port);
<a name='L832'>    <b>if</b> (addr == NULL) <b>return</b> NULL;
<a name='L833'>
<a name='L834'>    <i><font color='green'>/* For slaves and sentinel we use ip:port as name. */</font></i>
<a name='L835'>    <b>if</b> (flags &amp; (<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>|<a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>)) <font color='red'>{</font>
<a name='L836'>        snprintf(slavename,<b>sizeof</b>(slavename),"%s:%d",hostname,port);
<a name='L837'>        name = slavename;
<a name='L838'>    <font color='red'>}</font>
<a name='L839'>
<a name='L840'>    <i><font color='green'>/* Make sure the entry is not duplicated. This may happen when the same</font></i>
<a name='L841'><i><font color='green'>     * name for a master is used multiple times inside the configuration or</font></i>
<a name='L842'><i><font color='green'>     * if we try to add multiple times a slave or sentinel with same ip/port</font></i>
<a name='L843'><i><font color='green'>     * to a master. */</font></i>
<a name='L844'>    <b>if</b> (flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) table = <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters;
<a name='L845'>    <b>else</b> <b>if</b> (flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) table = master-&gt;slaves;
<a name='L846'>    <b>else</b> <b>if</b> (flags &amp; <a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) table = master-&gt;sentinels;
<a name='L847'>    sdsname = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(name);
<a name='L848'>    <b>if</b> (<a href='../D/2076.html' title='Multiple defined in 2 places.'>dictFind</a>(table,sdsname)) <font color='red'>{</font>
<a name='L849'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sdsname);
<a name='L850'>        errno = EBUSY;
<a name='L851'>        <b>return</b> NULL;
<a name='L852'>    <font color='red'>}</font>
<a name='L853'>
<a name='L854'>    <i><font color='green'>/* Create the instance object. */</font></i>
<a name='L855'>    ri = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*ri));
<a name='L856'>    <i><font color='green'>/* Note that all the instances are started in the disconnected state,</font></i>
<a name='L857'><i><font color='green'>     * the event loop will take care of connecting them. */</font></i>
<a name='L858'>    ri-&gt;flags = flags | <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>;
<a name='L859'>    ri-&gt;name = sdsname;
<a name='L860'>    ri-&gt;runid = NULL;
<a name='L861'>    ri-&gt;addr = addr;
<a name='L862'>    ri-&gt;cc = NULL;
<a name='L863'>    ri-&gt;pc = NULL;
<a name='L864'>    ri-&gt;pending_commands = 0;
<a name='L865'>    ri-&gt;cc_conn_time = 0;
<a name='L866'>    ri-&gt;pc_conn_time = 0;
<a name='L867'>    ri-&gt;pc_last_activity = 0;
<a name='L868'>    ri-&gt;last_avail_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L869'>    ri-&gt;last_pong_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L870'>    ri-&gt;last_pub_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L871'>    ri-&gt;last_hello_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L872'>    ri-&gt;last_master_down_reply_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L873'>    ri-&gt;s_down_since_time = 0;
<a name='L874'>    ri-&gt;o_down_since_time = 0;
<a name='L875'>    ri-&gt;down_after_period = master ? master-&gt;down_after_period :
<a name='L876'>                            <a href='../S/82.html#L82' title='Defined at 82 in src/sentinel.c.'>SENTINEL_DOWN_AFTER_PERIOD</a>;
<a name='L877'>    ri-&gt;master_link_down_time = 0;
<a name='L878'>    ri-&gt;auth_pass = NULL;
<a name='L879'>    ri-&gt;slave_priority = <a href='../S/82.html#L86' title='Defined at 86 in src/sentinel.c.'>SENTINEL_DEFAULT_SLAVE_PRIORITY</a>;
<a name='L880'>    ri-&gt;slave_reconf_sent_time = 0;
<a name='L881'>    ri-&gt;slave_master_host = NULL;
<a name='L882'>    ri-&gt;slave_master_port = 0;
<a name='L883'>    ri-&gt;slave_master_link_status = <a href='../S/82.html#L115' title='Defined at 115 in src/sentinel.c.'>SENTINEL_MASTER_LINK_STATUS_DOWN</a>;
<a name='L884'>    ri-&gt;sentinels = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;instancesDictType,NULL);
<a name='L885'>    ri-&gt;quorum = quorum;
<a name='L886'>    ri-&gt;parallel_syncs = <a href='../S/82.html#L89' title='Defined at 89 in src/sentinel.c.'>SENTINEL_DEFAULT_PARALLEL_SYNCS</a>;
<a name='L887'>    ri-&gt;master = master;
<a name='L888'>    ri-&gt;slaves = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;instancesDictType,NULL);
<a name='L889'>    ri-&gt;info_refresh = 0;
<a name='L890'>
<a name='L891'>    <i><font color='green'>/* Failover state. */</font></i>
<a name='L892'>    ri-&gt;leader = NULL;
<a name='L893'>    ri-&gt;failover_state = <a href='../S/82.html#L102' title='Defined at 102 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_NONE</a>;
<a name='L894'>    ri-&gt;failover_state_change_time = 0;
<a name='L895'>    ri-&gt;failover_start_time = 0;
<a name='L896'>    ri-&gt;failover_timeout = <a href='../S/82.html#L91' title='Defined at 91 in src/sentinel.c.'>SENTINEL_DEFAULT_FAILOVER_TIMEOUT</a>;
<a name='L897'>    ri-&gt;promoted_slave = NULL;
<a name='L898'>    ri-&gt;notification_script = NULL;
<a name='L899'>    ri-&gt;client_reconfig_script = NULL;
<a name='L900'>
<a name='L901'>    <i><font color='green'>/* Add into the right table. */</font></i>
<a name='L902'>    <a href='../D/2061.html' title='Multiple defined in 2 places.'>dictAdd</a>(table, ri-&gt;name, ri);
<a name='L903'>    <b>return</b> ri;
<a name='L904'><font color='red'>}</font>
<a name='L905'>
<a name='L906'><i><font color='green'>/* Release this instance and all its slaves, sentinels, hiredis connections.</font></i>
<a name='L907'><i><font color='green'> * This function also takes care of unlinking the instance from the main</font></i>
<a name='L908'><i><font color='green'> * masters table (if it is a master) or from its master sentinels/slaves table</font></i>
<a name='L909'><i><font color='green'> * if it is a slave or sentinel. */</font></i>
<a name='L910'><b>void</b> <a href='../R/3516.html' title='Multiple refered from 2 places.'>releaseSentinelRedisInstance</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L911'>    <i><font color='green'>/* Release all its slaves or sentinels if any. */</font></i>
<a name='L912'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(ri-&gt;sentinels);
<a name='L913'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(ri-&gt;slaves);
<a name='L914'>
<a name='L915'>    <i><font color='green'>/* Release hiredis connections. */</font></i>
<a name='L916'>    <b>if</b> (ri-&gt;cc) <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;cc);
<a name='L917'>    <b>if</b> (ri-&gt;pc) <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;pc);
<a name='L918'>
<a name='L919'>    <i><font color='green'>/* Free other resources. */</font></i>
<a name='L920'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;name);
<a name='L921'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;runid);
<a name='L922'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;notification_script);
<a name='L923'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;client_reconfig_script);
<a name='L924'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;slave_master_host);
<a name='L925'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;leader);
<a name='L926'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;auth_pass);
<a name='L927'>    <a href='../S/82.html#L438' title='Defined at 438 in src/sentinel.c.'>releaseSentinelAddr</a>(ri-&gt;addr);
<a name='L928'>
<a name='L929'>    <i><font color='green'>/* Clear state into the master if needed. */</font></i>
<a name='L930'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) &amp;&amp; (ri-&gt;flags &amp; <a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>) &amp;&amp; ri-&gt;master)
<a name='L931'>        ri-&gt;master-&gt;promoted_slave = NULL;
<a name='L932'>
<a name='L933'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(ri);
<a name='L934'><font color='red'>}</font>
<a name='L935'>
<a name='L936'><i><font color='green'>/* Lookup a slave in a master Redis instance, by ip and port. */</font></i>
<a name='L937'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../S/82.html#L1402' title='Refered from 1402 in src/sentinel.c.'>sentinelRedisInstanceLookupSlave</a>(
<a name='L938'>                sentinelRedisInstance *ri, <b>char</b> *ip, <b>int</b> port)
<a name='L939'><font color='red'>{</font>
<a name='L940'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> key;
<a name='L941'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave;
<a name='L942'>  
<a name='L943'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>);
<a name='L944'>    key = <a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(<a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>(),"%s:%d",ip,port);
<a name='L945'>    slave = <a href='../S/29.html#L501' title='Defined at 501 in src/dict.c.'>dictFetchValue</a>(ri-&gt;slaves,key);
<a name='L946'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(key);
<a name='L947'>    <b>return</b> slave;
<a name='L948'><font color='red'>}</font>
<a name='L949'>
<a name='L950'><i><font color='green'>/* Return the name of the type of the instance as a string. */</font></i>
<a name='L951'><b>const</b> <b>char</b> *<a href='../R/3710.html' title='Multiple refered from 3 places.'>sentinelRedisInstanceTypeStr</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L952'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <b>return</b> "master";
<a name='L953'>    <b>else</b> <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) <b>return</b> "slave";
<a name='L954'>    <b>else</b> <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) <b>return</b> "sentinel";
<a name='L955'>    <b>else</b> <b>return</b> "unknown";
<a name='L956'><font color='red'>}</font>
<a name='L957'>
<a name='L958'><i><font color='green'>/* This function removes all the instances found in the dictionary of instances</font></i>
<a name='L959'><i><font color='green'> * 'd', having either:</font></i>
<a name='L960'><i><font color='green'> * </font></i>
<a name='L961'><i><font color='green'> * 1) The same ip/port as specified.</font></i>
<a name='L962'><i><font color='green'> * 2) The same runid.</font></i>
<a name='L963'><i><font color='green'> *</font></i>
<a name='L964'><i><font color='green'> * "1" and "2" don't need to verify at the same time, just one is enough.</font></i>
<a name='L965'><i><font color='green'> * If "runid" is NULL it is not checked.</font></i>
<a name='L966'><i><font color='green'> * Similarly if "ip" is NULL it is not checked.</font></i>
<a name='L967'><i><font color='green'> *</font></i>
<a name='L968'><i><font color='green'> * This function is useful because every time we add a new Sentinel into</font></i>
<a name='L969'><i><font color='green'> * a master's Sentinels dictionary, we want to be very sure about not</font></i>
<a name='L970'><i><font color='green'> * having duplicated instances for any reason. This is so important because</font></i>
<a name='L971'><i><font color='green'> * we use those other sentinels in order to run our quorum protocol to</font></i>
<a name='L972'><i><font color='green'> * understand if it's time to proceeed with the fail over.</font></i>
<a name='L973'><i><font color='green'> *</font></i>
<a name='L974'><i><font color='green'> * Making sure no duplication is possible we greately improve the robustness</font></i>
<a name='L975'><i><font color='green'> * of the quorum (otherwise we may end counting the same instance multiple</font></i>
<a name='L976'><i><font color='green'> * times for some reason).</font></i>
<a name='L977'><i><font color='green'> *</font></i>
<a name='L978'><i><font color='green'> * The function returns the number of Sentinels removed. */</font></i>
<a name='L979'><b>int</b> <a href='../S/82.html#L1683' title='Refered from 1683 in src/sentinel.c.'>removeMatchingSentinelsFromMaster</a>(sentinelRedisInstance *master, <b>char</b> *ip, <b>int</b> port, <b>char</b> *runid) <font color='red'>{</font>
<a name='L980'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L981'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L982'>    <b>int</b> removed = 0;
<a name='L983'>
<a name='L984'>    di = <a href='../S/29.html#L521' title='Defined at 521 in src/dict.c.'>dictGetSafeIterator</a>(master-&gt;sentinels);
<a name='L985'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L986'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L987'>
<a name='L988'>        <b>if</b> ((ri-&gt;runid &amp;&amp; runid &amp;&amp; strcmp(ri-&gt;runid,runid) == 0) ||
<a name='L989'>            (ip &amp;&amp; strcmp(ri-&gt;addr-&gt;ip,ip) == 0 &amp;&amp; port == ri-&gt;addr-&gt;port))
<a name='L990'>        <font color='red'>{</font>
<a name='L991'>            <a href='../D/2066.html' title='Multiple defined in 2 places.'>dictDelete</a>(master-&gt;sentinels,ri-&gt;name);
<a name='L992'>            removed++;
<a name='L993'>        <font color='red'>}</font>
<a name='L994'>    <font color='red'>}</font>
<a name='L995'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L996'>    <b>return</b> removed;
<a name='L997'><font color='red'>}</font>
<a name='L998'>
<a name='L999'><i><font color='green'>/* Search an instance with the same runid, ip and port into a dictionary</font></i>
<a name='L1000'><i><font color='green'> * of instances. Return NULL if not found, otherwise return the instance</font></i>
<a name='L1001'><i><font color='green'> * pointer.</font></i>
<a name='L1002'><i><font color='green'> *</font></i>
<a name='L1003'><i><font color='green'> * runid or ip can be NULL. In such a case the search is performed only</font></i>
<a name='L1004'><i><font color='green'> * by the non-NULL field. */</font></i>
<a name='L1005'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../R/2066.html' title='Multiple refered from 2 places.'>getSentinelRedisInstanceByAddrAndRunID</a>(dict *instances, <b>char</b> *ip, <b>int</b> port, <b>char</b> *runid) <font color='red'>{</font>
<a name='L1006'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L1007'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L1008'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *instance = NULL;
<a name='L1009'>
<a name='L1010'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(ip || runid);   <i><font color='green'>/* User must pass at least one search param. */</font></i>
<a name='L1011'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(instances);
<a name='L1012'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L1013'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L1014'>
<a name='L1015'>        <b>if</b> (runid &amp;&amp; !ri-&gt;runid) <b>continue</b>;
<a name='L1016'>        <b>if</b> ((runid == NULL || strcmp(ri-&gt;runid, runid) == 0) &amp;&amp;
<a name='L1017'>            (ip == NULL || (strcmp(ri-&gt;addr-&gt;ip, ip) == 0 &amp;&amp;
<a name='L1018'>                            ri-&gt;addr-&gt;port == port)))
<a name='L1019'>        <font color='red'>{</font>
<a name='L1020'>            instance = ri;
<a name='L1021'>            <b>break</b>;
<a name='L1022'>        <font color='red'>}</font>
<a name='L1023'>    <font color='red'>}</font>
<a name='L1024'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L1025'>    <b>return</b> instance;
<a name='L1026'><font color='red'>}</font>
<a name='L1027'>
<a name='L1028'><i><font color='green'>/* Simple master lookup by name */</font></i>
<a name='L1029'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../R/3687.html' title='Multiple refered from 9 places.'>sentinelGetMasterByName</a>(<b>char</b> *name) <font color='red'>{</font>
<a name='L1030'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1031'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> sdsname = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(name);
<a name='L1032'>
<a name='L1033'>    ri = <a href='../S/29.html#L501' title='Defined at 501 in src/dict.c.'>dictFetchValue</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters,sdsname);
<a name='L1034'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(sdsname);
<a name='L1035'>    <b>return</b> ri;
<a name='L1036'><font color='red'>}</font>
<a name='L1037'>
<a name='L1038'><i><font color='green'>/* Add the specified flags to all the instances in the specified dictionary. */</font></i>
<a name='L1039'><b>void</b> <a href='../S/82.html#L1532' title='Refered from 1532 in src/sentinel.c.'>sentinelAddFlagsToDictOfRedisInstances</a>(dict *instances, <b>int</b> flags) <font color='red'>{</font>
<a name='L1040'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L1041'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L1042'>
<a name='L1043'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(instances);
<a name='L1044'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L1045'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L1046'>        ri-&gt;flags |= flags;
<a name='L1047'>    <font color='red'>}</font>
<a name='L1048'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L1049'><font color='red'>}</font>
<a name='L1050'>
<a name='L1051'><i><font color='green'>/* Remove the specified flags to all the instances in the specified</font></i>
<a name='L1052'><i><font color='green'> * dictionary. */</font></i>
<a name='L1053'><b>void</b> <a href='../S/82.html#L2517' title='Refered from 2517 in src/sentinel.c.'>sentinelDelFlagsToDictOfRedisInstances</a>(dict *instances, <b>int</b> flags) <font color='red'>{</font>
<a name='L1054'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L1055'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L1056'>
<a name='L1057'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(instances);
<a name='L1058'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L1059'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L1060'>        ri-&gt;flags &amp;= ~flags;
<a name='L1061'>    <font color='red'>}</font>
<a name='L1062'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L1063'><font color='red'>}</font>
<a name='L1064'>
<a name='L1065'><i><font color='green'>/* Reset the state of a monitored master:</font></i>
<a name='L1066'><i><font color='green'> * 1) Remove all slaves.</font></i>
<a name='L1067'><i><font color='green'> * 2) Remove all sentinels.</font></i>
<a name='L1068'><i><font color='green'> * 3) Remove most of the flags resulting from runtime operations.</font></i>
<a name='L1069'><i><font color='green'> * 4) Reset timers to their default value.</font></i>
<a name='L1070'><i><font color='green'> * 5) In the process of doing this undo the failover if in progress.</font></i>
<a name='L1071'><i><font color='green'> * 6) Disconnect the connections with the master (will reconnect automatically).</font></i>
<a name='L1072'><i><font color='green'> */</font></i>
<a name='L1073'><b>void</b> <a href='../R/3713.html' title='Multiple refered from 2 places.'>sentinelResetMaster</a>(sentinelRedisInstance *ri, <b>int</b> flags) <font color='red'>{</font>
<a name='L1074'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>);
<a name='L1075'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(ri-&gt;slaves);
<a name='L1076'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(ri-&gt;sentinels);
<a name='L1077'>    ri-&gt;slaves = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;instancesDictType,NULL);
<a name='L1078'>    ri-&gt;sentinels = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;instancesDictType,NULL);
<a name='L1079'>    <b>if</b> (ri-&gt;cc) <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;cc);
<a name='L1080'>    <b>if</b> (ri-&gt;pc) <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;pc);
<a name='L1081'>    ri-&gt;flags &amp;= <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>|<a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>|<a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>;
<a name='L1082'>    <b>if</b> (ri-&gt;leader) <font color='red'>{</font>
<a name='L1083'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;leader);
<a name='L1084'>        ri-&gt;leader = NULL;
<a name='L1085'>    <font color='red'>}</font>
<a name='L1086'>    ri-&gt;failover_state = <a href='../S/82.html#L102' title='Defined at 102 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_NONE</a>;
<a name='L1087'>    ri-&gt;failover_state_change_time = 0;
<a name='L1088'>    ri-&gt;failover_start_time = 0;
<a name='L1089'>    ri-&gt;promoted_slave = NULL;
<a name='L1090'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;runid);
<a name='L1091'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;slave_master_host);
<a name='L1092'>    ri-&gt;runid = NULL;
<a name='L1093'>    ri-&gt;slave_master_host = NULL;
<a name='L1094'>    ri-&gt;last_avail_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1095'>    ri-&gt;last_pong_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1096'>    <b>if</b> (flags &amp; <a href='../S/82.html#L119' title='Defined at 119 in src/sentinel.c.'>SENTINEL_GENERATE_EVENT</a>)
<a name='L1097'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+reset-master",ri,"%@");
<a name='L1098'><font color='red'>}</font>
<a name='L1099'>
<a name='L1100'><i><font color='green'>/* Call sentinelResetMaster() on every master with a name matching the specified</font></i>
<a name='L1101'><i><font color='green'> * pattern. */</font></i>
<a name='L1102'><b>int</b> <a href='../S/82.html#L2024' title='Refered from 2024 in src/sentinel.c.'>sentinelResetMastersByPattern</a>(<b>char</b> *pattern, <b>int</b> flags) <font color='red'>{</font>
<a name='L1103'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L1104'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L1105'>    <b>int</b> reset = 0;
<a name='L1106'>
<a name='L1107'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters);
<a name='L1108'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L1109'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L1110'>
<a name='L1111'>        <b>if</b> (ri-&gt;name) <font color='red'>{</font>
<a name='L1112'>            <b>if</b> (<a href='../S/74.html#L166' title='Defined at 166 in src/util.c.'>stringmatch</a>(pattern,ri-&gt;name,0)) <font color='red'>{</font>
<a name='L1113'>                <a href='../S/82.html#L1073' title='Defined at 1073 in src/sentinel.c.'>sentinelResetMaster</a>(ri,flags);
<a name='L1114'>                reset++;
<a name='L1115'>            <font color='red'>}</font>
<a name='L1116'>        <font color='red'>}</font>
<a name='L1117'>    <font color='red'>}</font>
<a name='L1118'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L1119'>    <b>return</b> reset;
<a name='L1120'><font color='red'>}</font>
<a name='L1121'>
<a name='L1122'><i><font color='green'>/* Reset the specified master with sentinelResetMaster(), and also change</font></i>
<a name='L1123'><i><font color='green'> * the ip:port address, but take the name of the instance unmodified.</font></i>
<a name='L1124'><i><font color='green'> *</font></i>
<a name='L1125'><i><font color='green'> * This is used to handle the +switch-master and +redirect-to-master events.</font></i>
<a name='L1126'><i><font color='green'> *</font></i>
<a name='L1127'><i><font color='green'> * The function returns REDIS_ERR if the address can't be resolved for some</font></i>
<a name='L1128'><i><font color='green'> * reason. Otherwise REDIS_OK is returned.</font></i>
<a name='L1129'><i><font color='green'> *</font></i>
<a name='L1130'><i><font color='green'> * TODO: make this reset so that original sentinels are re-added with</font></i>
<a name='L1131'><i><font color='green'> * same ip / port / runid.</font></i>
<a name='L1132'><i><font color='green'> */</font></i>
<a name='L1133'>
<a name='L1134'><b>int</b> <a href='../R/3714.html' title='Multiple refered from 2 places.'>sentinelResetMasterAndChangeAddress</a>(sentinelRedisInstance *master, <b>char</b> *ip, <b>int</b> port) <font color='red'>{</font>
<a name='L1135'>    <a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *oldaddr, *newaddr;
<a name='L1136'>
<a name='L1137'>    newaddr = <a href='../S/82.html#L419' title='Defined at 419 in src/sentinel.c.'>createSentinelAddr</a>(ip,port);
<a name='L1138'>    <b>if</b> (newaddr == NULL) <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L1139'>    <a href='../S/82.html#L1073' title='Defined at 1073 in src/sentinel.c.'>sentinelResetMaster</a>(master,<a href='../S/82.html#L118' title='Defined at 118 in src/sentinel.c.'>SENTINEL_NO_FLAGS</a>);
<a name='L1140'>    oldaddr = master-&gt;addr;
<a name='L1141'>    master-&gt;addr = newaddr;
<a name='L1142'>    <i><font color='green'>/* Release the old address at the end so we are safe even if the function</font></i>
<a name='L1143'><i><font color='green'>     * gets the master-&gt;addr-&gt;ip and master-&gt;addr-&gt;port as arguments. */</font></i>
<a name='L1144'>    <a href='../S/82.html#L438' title='Defined at 438 in src/sentinel.c.'>releaseSentinelAddr</a>(oldaddr);
<a name='L1145'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L1146'><font color='red'>}</font>
<a name='L1147'>
<a name='L1148'><i><font color='green'>/* ============================ Config handling ============================= */</font></i>
<a name='L1149'><b>char</b> *<a href='../R/3692.html' title='Multiple refered from 2 places.'>sentinelHandleConfiguration</a>(<b>char</b> **argv, <b>int</b> argc) <font color='red'>{</font>
<a name='L1150'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1151'>
<a name='L1152'>    <b>if</b> (!strcasecmp(argv[0],"monitor") &amp;&amp; argc == 5) <font color='red'>{</font>
<a name='L1153'>        <i><font color='green'>/* monitor &lt;name&gt; &lt;host&gt; &lt;port&gt; &lt;quorum&gt; */</font></i>
<a name='L1154'>        <b>int</b> quorum = atoi(argv[4]);
<a name='L1155'>
<a name='L1156'>        <b>if</b> (quorum &lt;= 0) <b>return</b> "Quorum must be 1 or greater.";
<a name='L1157'>        <b>if</b> (<a href='../S/82.html#L821' title='Defined at 821 in src/sentinel.c.'>createSentinelRedisInstance</a>(argv[1],<a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>,argv[2],
<a name='L1158'>                                        atoi(argv[3]),quorum,NULL) == NULL)
<a name='L1159'>        <font color='red'>{</font>
<a name='L1160'>            <b>switch</b>(errno) <font color='red'>{</font>
<a name='L1161'>            <b>case</b> EBUSY: <b>return</b> "Duplicated master name.";
<a name='L1162'>            <b>case</b> ENOENT: <b>return</b> "Can't resolve master instance hostname.";
<a name='L1163'>            <b>case</b> EINVAL: <b>return</b> "Invalid port number";
<a name='L1164'>            <font color='red'>}</font>
<a name='L1165'>        <font color='red'>}</font>
<a name='L1166'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"down-after-milliseconds") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1167'>        <i><font color='green'>/* down-after-milliseconds &lt;name&gt; &lt;milliseconds&gt; */</font></i>
<a name='L1168'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1169'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1170'>        ri-&gt;down_after_period = atoi(argv[2]);
<a name='L1171'>        <b>if</b> (ri-&gt;down_after_period &lt;= 0)
<a name='L1172'>            <b>return</b> "negative or zero time parameter.";
<a name='L1173'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"failover-timeout") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1174'>        <i><font color='green'>/* failover-timeout &lt;name&gt; &lt;milliseconds&gt; */</font></i>
<a name='L1175'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1176'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1177'>        ri-&gt;failover_timeout = atoi(argv[2]);
<a name='L1178'>        <b>if</b> (ri-&gt;failover_timeout &lt;= 0)
<a name='L1179'>            <b>return</b> "negative or zero time parameter.";
<a name='L1180'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"can-failover") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1181'>        <i><font color='green'>/* can-failover &lt;name&gt; &lt;yes/no&gt; */</font></i>
<a name='L1182'>        <b>int</b> yesno = <a href='../S/96.html#L38' title='Defined at 38 in src/config.c.'>yesnotoi</a>(argv[2]);
<a name='L1183'>
<a name='L1184'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1185'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1186'>        <b>if</b> (yesno == -1) <b>return</b> "Argument must be either yes or no.";
<a name='L1187'>        <b>if</b> (yesno)
<a name='L1188'>            ri-&gt;flags |= <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>;
<a name='L1189'>        <b>else</b>
<a name='L1190'>            ri-&gt;flags &amp;= ~<a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>;
<a name='L1191'>   <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"parallel-syncs") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1192'>        <i><font color='green'>/* parallel-syncs &lt;name&gt; &lt;milliseconds&gt; */</font></i>
<a name='L1193'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1194'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1195'>        ri-&gt;parallel_syncs = atoi(argv[2]);
<a name='L1196'>   <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"notification-script") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1197'>        <i><font color='green'>/* notification-script &lt;name&gt; &lt;path&gt; */</font></i>
<a name='L1198'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1199'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1200'>        <b>if</b> (access(argv[2],X_OK) == -1)
<a name='L1201'>            <b>return</b> "Notification script seems non existing or non executable.";
<a name='L1202'>        ri-&gt;notification_script = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(argv[2]);
<a name='L1203'>   <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"client-reconfig-script") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1204'>        <i><font color='green'>/* client-reconfig-script &lt;name&gt; &lt;path&gt; */</font></i>
<a name='L1205'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1206'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1207'>        <b>if</b> (access(argv[2],X_OK) == -1)
<a name='L1208'>            <b>return</b> "Client reconfiguration script seems non existing or "
<a name='L1209'>                   "non executable.";
<a name='L1210'>        ri-&gt;client_reconfig_script = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(argv[2]);
<a name='L1211'>   <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(argv[0],"auth-pass") &amp;&amp; argc == 3) <font color='red'>{</font>
<a name='L1212'>        <i><font color='green'>/* auth-pass &lt;name&gt; &lt;password&gt; */</font></i>
<a name='L1213'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(argv[1]);
<a name='L1214'>        <b>if</b> (!ri) <b>return</b> "No such master with specified name.";
<a name='L1215'>        ri-&gt;auth_pass = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(argv[2]);
<a name='L1216'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1217'>        <b>return</b> "Unrecognized sentinel configuration statement.";
<a name='L1218'>    <font color='red'>}</font>
<a name='L1219'>    <b>return</b> NULL;
<a name='L1220'><font color='red'>}</font>
<a name='L1221'>
<a name='L1222'><i><font color='green'>/* ====================== hiredis connection handling ======================= */</font></i>
<a name='L1223'>
<a name='L1224'><i><font color='green'>/* Completely disconnect an hiredis link from an instance. */</font></i>
<a name='L1225'><b>void</b> <a href='../R/3697.html' title='Multiple refered from 10 places.'>sentinelKillLink</a>(sentinelRedisInstance *ri, redisAsyncContext *c) <font color='red'>{</font>
<a name='L1226'>    <b>if</b> (ri-&gt;cc == c) <font color='red'>{</font>
<a name='L1227'>        ri-&gt;cc = NULL;
<a name='L1228'>        ri-&gt;pending_commands = 0;
<a name='L1229'>    <font color='red'>}</font>
<a name='L1230'>    <b>if</b> (ri-&gt;pc == c) ri-&gt;pc = NULL;
<a name='L1231'>    c-&gt;data = NULL;
<a name='L1232'>    ri-&gt;flags |= <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>;
<a name='L1233'>    <a href='../S/104.html#L273' title='Defined at 273 in deps/hiredis/async.c.'>redisAsyncFree</a>(c);
<a name='L1234'><font color='red'>}</font>
<a name='L1235'>
<a name='L1236'><i><font color='green'>/* This function takes an hiredis context that is in an error condition</font></i>
<a name='L1237'><i><font color='green'> * and make sure to mark the instance as disconnected performing the</font></i>
<a name='L1238'><i><font color='green'> * cleanup needed.</font></i>
<a name='L1239'><i><font color='green'> *</font></i>
<a name='L1240'><i><font color='green'> * Note: we don't free the hiredis context as hiredis will do it for us</font></i>
<a name='L1241'><i><font color='green'> * for async conenctions. */</font></i>
<a name='L1242'><b>void</b> <a href='../R/3676.html' title='Multiple refered from 3 places.'>sentinelDisconnectInstanceFromContext</a>(<b>const</b> redisAsyncContext *c) <font color='red'>{</font>
<a name='L1243'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1244'>    <b>int</b> pubsub;
<a name='L1245'>
<a name='L1246'>    <b>if</b> (ri == NULL) <b>return</b>; <i><font color='green'>/* The instance no longer exists. */</font></i>
<a name='L1247'>
<a name='L1248'>    pubsub = (ri-&gt;pc == c);
<a name='L1249'>    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>, pubsub ? "-pubsub-link" : "-cmd-link", ri,
<a name='L1250'>        "%@ #%s", c-&gt;errstr);
<a name='L1251'>    <b>if</b> (pubsub)
<a name='L1252'>        ri-&gt;pc = NULL;
<a name='L1253'>    <b>else</b>
<a name='L1254'>        ri-&gt;cc = NULL;
<a name='L1255'>    ri-&gt;flags |= <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>;
<a name='L1256'><font color='red'>}</font>
<a name='L1257'>
<a name='L1258'><b>void</b> <a href='../R/3699.html' title='Multiple refered from 3 places.'>sentinelLinkEstablishedCallback</a>(<b>const</b> redisAsyncContext *c, <b>int</b> status) <font color='red'>{</font>
<a name='L1259'>    <b>if</b> (status != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L1260'>        <a href='../S/82.html#L1242' title='Defined at 1242 in src/sentinel.c.'>sentinelDisconnectInstanceFromContext</a>(c);
<a name='L1261'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1262'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1263'>        <b>int</b> pubsub = (ri-&gt;pc == c);
<a name='L1264'>
<a name='L1265'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>, pubsub ? "+pubsub-link" : "+cmd-link", ri,
<a name='L1266'>            "%@");
<a name='L1267'>    <font color='red'>}</font>
<a name='L1268'><font color='red'>}</font>
<a name='L1269'>
<a name='L1270'><b>void</b> <a href='../R/3675.html' title='Multiple refered from 3 places.'>sentinelDisconnectCallback</a>(<b>const</b> redisAsyncContext *c, <b>int</b> status) <font color='red'>{</font>
<a name='L1271'>    <a href='../S/82.html#L1242' title='Defined at 1242 in src/sentinel.c.'>sentinelDisconnectInstanceFromContext</a>(c);
<a name='L1272'><font color='red'>}</font>
<a name='L1273'>
<a name='L1274'><i><font color='green'>/* Send the AUTH command with the specified master password if needed.</font></i>
<a name='L1275'><i><font color='green'> * Note that for slaves the password set for the master is used.</font></i>
<a name='L1276'><i><font color='green'> *</font></i>
<a name='L1277'><i><font color='green'> * We don't check at all if the command was successfully transmitted</font></i>
<a name='L1278'><i><font color='green'> * to the instance as if it fails Sentinel will detect the instance down,</font></i>
<a name='L1279'><i><font color='green'> * will disconnect and reconnect the link and so forth. */</font></i>
<a name='L1280'><b>void</b> <a href='../R/3721.html' title='Multiple refered from 2 places.'>sentinelSendAuthIfNeeded</a>(sentinelRedisInstance *ri, redisAsyncContext *c) <font color='red'>{</font>
<a name='L1281'>    <b>char</b> *auth_pass = (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) ? ri-&gt;auth_pass :
<a name='L1282'>                                                 ri-&gt;master-&gt;auth_pass;
<a name='L1283'>
<a name='L1284'>    <b>if</b> (auth_pass)
<a name='L1285'>        <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(c, <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "AUTH %s",
<a name='L1286'>            auth_pass);
<a name='L1287'><font color='red'>}</font>
<a name='L1288'>
<a name='L1289'><i><font color='green'>/* Create the async connections for the specified instance if the instance</font></i>
<a name='L1290'><i><font color='green'> * is disconnected. Note that the SRI_DISCONNECTED flag is set even if just</font></i>
<a name='L1291'><i><font color='green'> * one of the two links (commands and pub/sub) is missing. */</font></i>
<a name='L1292'><b>void</b> <a href='../S/82.html#L2953' title='Refered from 2953 in src/sentinel.c.'>sentinelReconnectInstance</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L1293'>    <b>if</b> (!(ri-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>)) <b>return</b>;
<a name='L1294'>
<a name='L1295'>    <i><font color='green'>/* Commands connection. */</font></i>
<a name='L1296'>    <b>if</b> (ri-&gt;cc == NULL) <font color='red'>{</font>
<a name='L1297'>        ri-&gt;cc = <a href='../S/104.html#L144' title='Defined at 144 in deps/hiredis/async.c.'>redisAsyncConnect</a>(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port);
<a name='L1298'>        <b>if</b> (ri-&gt;cc-&gt;err) <font color='red'>{</font>
<a name='L1299'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>,"-cmd-link-reconnection",ri,"%@ #%s",
<a name='L1300'>                ri-&gt;cc-&gt;errstr);
<a name='L1301'>            <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;cc);
<a name='L1302'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1303'>            ri-&gt;cc_conn_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1304'>            ri-&gt;cc-&gt;data = ri;
<a name='L1305'>            <a href='../D/3752.html' title='Multiple defined in 2 places.'>redisAeAttach</a>(server.el,ri-&gt;cc);
<a name='L1306'>            <a href='../S/104.html#L158' title='Defined at 158 in deps/hiredis/async.c.'>redisAsyncSetConnectCallback</a>(ri-&gt;cc,
<a name='L1307'>                                            <a href='../S/82.html#L1258' title='Defined at 1258 in src/sentinel.c.'>sentinelLinkEstablishedCallback</a>);
<a name='L1308'>            <a href='../S/104.html#L171' title='Defined at 171 in deps/hiredis/async.c.'>redisAsyncSetDisconnectCallback</a>(ri-&gt;cc,
<a name='L1309'>                                            <a href='../S/82.html#L1270' title='Defined at 1270 in src/sentinel.c.'>sentinelDisconnectCallback</a>);
<a name='L1310'>            <a href='../S/82.html#L1280' title='Defined at 1280 in src/sentinel.c.'>sentinelSendAuthIfNeeded</a>(ri,ri-&gt;cc);
<a name='L1311'>        <font color='red'>}</font>
<a name='L1312'>    <font color='red'>}</font>
<a name='L1313'>    <i><font color='green'>/* Pub / Sub */</font></i>
<a name='L1314'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) &amp;&amp; ri-&gt;pc == NULL) <font color='red'>{</font>
<a name='L1315'>        ri-&gt;pc = <a href='../S/104.html#L144' title='Defined at 144 in deps/hiredis/async.c.'>redisAsyncConnect</a>(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port);
<a name='L1316'>        <b>if</b> (ri-&gt;pc-&gt;err) <font color='red'>{</font>
<a name='L1317'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L229' title='Defined at 229 in src/redis.h.'>REDIS_DEBUG</a>,"-pubsub-link-reconnection",ri,"%@ #%s",
<a name='L1318'>                ri-&gt;pc-&gt;errstr);
<a name='L1319'>            <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;pc);
<a name='L1320'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1321'>            <b>int</b> retval;
<a name='L1322'>
<a name='L1323'>            ri-&gt;pc_conn_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1324'>            ri-&gt;pc-&gt;data = ri;
<a name='L1325'>            <a href='../D/3752.html' title='Multiple defined in 2 places.'>redisAeAttach</a>(server.el,ri-&gt;pc);
<a name='L1326'>            <a href='../S/104.html#L158' title='Defined at 158 in deps/hiredis/async.c.'>redisAsyncSetConnectCallback</a>(ri-&gt;pc,
<a name='L1327'>                                            <a href='../S/82.html#L1258' title='Defined at 1258 in src/sentinel.c.'>sentinelLinkEstablishedCallback</a>);
<a name='L1328'>            <a href='../S/104.html#L171' title='Defined at 171 in deps/hiredis/async.c.'>redisAsyncSetDisconnectCallback</a>(ri-&gt;pc,
<a name='L1329'>                                            <a href='../S/82.html#L1270' title='Defined at 1270 in src/sentinel.c.'>sentinelDisconnectCallback</a>);
<a name='L1330'>            <a href='../S/82.html#L1280' title='Defined at 1280 in src/sentinel.c.'>sentinelSendAuthIfNeeded</a>(ri,ri-&gt;pc);
<a name='L1331'>            <i><font color='green'>/* Now we subscribe to the Sentinels "Hello" channel. */</font></i>
<a name='L1332'>            retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;pc,
<a name='L1333'>                <a href='../S/82.html#L1641' title='Defined at 1641 in src/sentinel.c.'>sentinelReceiveHelloMessages</a>, NULL, "SUBSCRIBE %s",
<a name='L1334'>                    <a href='../S/82.html#L83' title='Defined at 83 in src/sentinel.c.'>SENTINEL_HELLO_CHANNEL</a>);
<a name='L1335'>            <b>if</b> (retval != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L1336'>                <i><font color='green'>/* If we can't subscribe, the Pub/Sub connection is useless</font></i>
<a name='L1337'><i><font color='green'>                 * and we can simply disconnect it and try again. */</font></i>
<a name='L1338'>                <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;pc);
<a name='L1339'>                <b>return</b>;
<a name='L1340'>            <font color='red'>}</font>
<a name='L1341'>        <font color='red'>}</font>
<a name='L1342'>    <font color='red'>}</font>
<a name='L1343'>    <i><font color='green'>/* Clear the DISCONNECTED flags only if we have both the connections</font></i>
<a name='L1344'><i><font color='green'>     * (or just the commands connection if this is a slave or a</font></i>
<a name='L1345'><i><font color='green'>     * sentinel instance). */</font></i>
<a name='L1346'>    <b>if</b> (ri-&gt;cc &amp;&amp; (ri-&gt;flags &amp; (<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>|<a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) || ri-&gt;pc))
<a name='L1347'>        ri-&gt;flags &amp;= ~<a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>;
<a name='L1348'><font color='red'>}</font>
<a name='L1349'>
<a name='L1350'><i><font color='green'>/* ======================== Redis instances pinging  ======================== */</font></i>
<a name='L1351'>
<a name='L1352'><i><font color='green'>/* Process the INFO output from masters. */</font></i>
<a name='L1353'><b>void</b> <a href='../S/82.html#L1578' title='Refered from 1578 in src/sentinel.c.'>sentinelRefreshInstanceInfo</a>(sentinelRedisInstance *ri, <b>const</b> <b>char</b> *info) <font color='red'>{</font>
<a name='L1354'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> *lines;
<a name='L1355'>    <b>int</b> numlines, j;
<a name='L1356'>    <b>int</b> role = 0;
<a name='L1357'>    <b>int</b> runid_changed = 0;  <i><font color='green'>/* true if runid changed. */</font></i>
<a name='L1358'>    <b>int</b> first_runid = 0;    <i><font color='green'>/* true if this is the first runid we receive. */</font></i>
<a name='L1359'>
<a name='L1360'>    <i><font color='green'>/* The following fields must be reset to a given value in the case they</font></i>
<a name='L1361'><i><font color='green'>     * are not found at all in the INFO output. */</font></i>
<a name='L1362'>    ri-&gt;master_link_down_time = 0;
<a name='L1363'>
<a name='L1364'>    <i><font color='green'>/* Process line by line. */</font></i>
<a name='L1365'>    lines = <a href='../D/4018.html' title='Multiple defined in 2 places.'>sdssplitlen</a>(info,strlen(info),"\r\n",2,&amp;numlines);
<a name='L1366'>    <b>for</b> (j = 0; j &lt; numlines; j++) <font color='red'>{</font>
<a name='L1367'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave;
<a name='L1368'>        <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> l = lines[j];
<a name='L1369'>
<a name='L1370'>        <i><font color='green'>/* run_id:&lt;40 hex chars&gt;*/</font></i>
<a name='L1371'>        <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 47 &amp;&amp; !memcmp(l,"run_id:",7)) <font color='red'>{</font>
<a name='L1372'>            <b>if</b> (ri-&gt;runid == NULL) <font color='red'>{</font>
<a name='L1373'>                ri-&gt;runid = <a href='../D/4014.html' title='Multiple defined in 2 places.'>sdsnewlen</a>(l+7,40);
<a name='L1374'>                first_runid = 1;
<a name='L1375'>            <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1376'>                <b>if</b> (strncmp(ri-&gt;runid,l+7,40) != 0) <font color='red'>{</font>
<a name='L1377'>                    runid_changed = 1;
<a name='L1378'>                    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+reboot",ri,"%@");
<a name='L1379'>                    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;runid);
<a name='L1380'>                    ri-&gt;runid = <a href='../D/4014.html' title='Multiple defined in 2 places.'>sdsnewlen</a>(l+7,40);
<a name='L1381'>                <font color='red'>}</font>
<a name='L1382'>            <font color='red'>}</font>
<a name='L1383'>        <font color='red'>}</font>
<a name='L1384'>
<a name='L1385'>        <i><font color='green'>/* slave0:&lt;ip&gt;,&lt;port&gt;,&lt;state&gt; */</font></i>
<a name='L1386'>        <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) &amp;&amp;
<a name='L1387'>            <a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 7 &amp;&amp;
<a name='L1388'>            !memcmp(l,"slave",5) &amp;&amp; isdigit(l[5]))
<a name='L1389'>        <font color='red'>{</font>
<a name='L1390'>            <b>char</b> *ip, *port, *end;
<a name='L1391'>
<a name='L1392'>            ip = strchr(l,':'); <b>if</b> (!ip) <b>continue</b>;
<a name='L1393'>            ip++; <i><font color='green'>/* Now ip points to start of ip address. */</font></i>
<a name='L1394'>            port = strchr(ip,','); <b>if</b> (!port) <b>continue</b>;
<a name='L1395'>            *port = '\0'; <i><font color='green'>/* nul term for easy access. */</font></i>
<a name='L1396'>            port++; <i><font color='green'>/* Now port points to start of port number. */</font></i>
<a name='L1397'>            end = strchr(port,','); <b>if</b> (!end) <b>continue</b>;
<a name='L1398'>            *end = '\0'; <i><font color='green'>/* nul term for easy access. */</font></i>
<a name='L1399'>
<a name='L1400'>            <i><font color='green'>/* Check if we already have this slave into our table,</font></i>
<a name='L1401'><i><font color='green'>             * otherwise add it. */</font></i>
<a name='L1402'>            <b>if</b> (<a href='../S/82.html#L937' title='Defined at 937 in src/sentinel.c.'>sentinelRedisInstanceLookupSlave</a>(ri,ip,atoi(port)) == NULL) <font color='red'>{</font>
<a name='L1403'>                <b>if</b> ((slave = <a href='../S/82.html#L821' title='Defined at 821 in src/sentinel.c.'>createSentinelRedisInstance</a>(NULL,<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>,ip,
<a name='L1404'>                            atoi(port), ri-&gt;quorum,ri)) != NULL)
<a name='L1405'>                <font color='red'>{</font>
<a name='L1406'>                    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+slave",slave,"%@");
<a name='L1407'>                <font color='red'>}</font>
<a name='L1408'>            <font color='red'>}</font>
<a name='L1409'>        <font color='red'>}</font>
<a name='L1410'>
<a name='L1411'>        <i><font color='green'>/* master_link_down_since_seconds:&lt;seconds&gt; */</font></i>
<a name='L1412'>        <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 32 &amp;&amp;
<a name='L1413'>            !memcmp(l,"master_link_down_since_seconds",30))
<a name='L1414'>        <font color='red'>{</font>
<a name='L1415'>            ri-&gt;master_link_down_time = strtoll(l+31,NULL,10)*1000;
<a name='L1416'>        <font color='red'>}</font>
<a name='L1417'>
<a name='L1418'>        <i><font color='green'>/* role:&lt;role&gt; */</font></i>
<a name='L1419'>        <b>if</b> (!memcmp(l,"role:master",11)) role = <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>;
<a name='L1420'>        <b>else</b> <b>if</b> (!memcmp(l,"role:slave",10)) role = <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>;
<a name='L1421'>
<a name='L1422'>        <b>if</b> (role == <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) <font color='red'>{</font>
<a name='L1423'>            <i><font color='green'>/* master_host:&lt;host&gt; */</font></i>
<a name='L1424'>            <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 12 &amp;&amp; !memcmp(l,"master_host:",12)) <font color='red'>{</font>
<a name='L1425'>                <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;slave_master_host);
<a name='L1426'>                ri-&gt;slave_master_host = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(l+12);
<a name='L1427'>            <font color='red'>}</font>
<a name='L1428'>
<a name='L1429'>            <i><font color='green'>/* master_port:&lt;port&gt; */</font></i>
<a name='L1430'>            <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 12 &amp;&amp; !memcmp(l,"master_port:",12))
<a name='L1431'>                ri-&gt;slave_master_port = atoi(l+12);
<a name='L1432'>            
<a name='L1433'>            <i><font color='green'>/* master_link_status:&lt;status&gt; */</font></i>
<a name='L1434'>            <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 19 &amp;&amp; !memcmp(l,"master_link_status:",19)) <font color='red'>{</font>
<a name='L1435'>                ri-&gt;slave_master_link_status =
<a name='L1436'>                    (strcasecmp(l+19,"up") == 0) ?
<a name='L1437'>                    <a href='../S/82.html#L114' title='Defined at 114 in src/sentinel.c.'>SENTINEL_MASTER_LINK_STATUS_UP</a> :
<a name='L1438'>                    <a href='../S/82.html#L115' title='Defined at 115 in src/sentinel.c.'>SENTINEL_MASTER_LINK_STATUS_DOWN</a>;
<a name='L1439'>            <font color='red'>}</font>
<a name='L1440'>
<a name='L1441'>            <i><font color='green'>/* slave_priority:&lt;priority&gt; */</font></i>
<a name='L1442'>            <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(l) &gt;= 15 &amp;&amp; !memcmp(l,"slave_priority:",15))
<a name='L1443'>                ri-&gt;slave_priority = atoi(l+15);
<a name='L1444'>        <font color='red'>}</font>
<a name='L1445'>    <font color='red'>}</font>
<a name='L1446'>    ri-&gt;info_refresh = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1447'>    <a href='../D/4007.html' title='Multiple defined in 2 places.'>sdsfreesplitres</a>(lines,numlines);
<a name='L1448'>
<a name='L1449'>    <i><font color='green'>/* ---------------------------- Acting half ----------------------------- */</font></i>
<a name='L1450'>    <b>if</b> (<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt) <b>return</b>;
<a name='L1451'>
<a name='L1452'>    <i><font color='green'>/* Act if a master turned into a slave. */</font></i>
<a name='L1453'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) &amp;&amp; role == <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) <font color='red'>{</font>
<a name='L1454'>        <b>if</b> ((first_runid || runid_changed) &amp;&amp; ri-&gt;slave_master_host) <font color='red'>{</font>
<a name='L1455'>            <i><font color='green'>/* If it is the first time we receive INFO from it, but it's</font></i>
<a name='L1456'><i><font color='green'>             * a slave while it was configured as a master, we want to monitor</font></i>
<a name='L1457'><i><font color='green'>             * its master instead. */</font></i>
<a name='L1458'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+redirect-to-master",ri,
<a name='L1459'>                "%s %s %d %s %d",
<a name='L1460'>                ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,
<a name='L1461'>                ri-&gt;slave_master_host, ri-&gt;slave_master_port);
<a name='L1462'>            <a href='../S/82.html#L1134' title='Defined at 1134 in src/sentinel.c.'>sentinelResetMasterAndChangeAddress</a>(ri,ri-&gt;slave_master_host,
<a name='L1463'>                                                   ri-&gt;slave_master_port);
<a name='L1464'>            <b>return</b>;
<a name='L1465'>        <font color='red'>}</font>
<a name='L1466'>    <font color='red'>}</font>
<a name='L1467'>
<a name='L1468'>    <i><font color='green'>/* Act if a slave turned into a master. */</font></i>
<a name='L1469'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) &amp;&amp; role == <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <font color='red'>{</font>
<a name='L1470'>        <b>if</b> (!(ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) &amp;&amp;
<a name='L1471'>            (runid_changed || first_runid))
<a name='L1472'>        <font color='red'>{</font>
<a name='L1473'>            <i><font color='green'>/* If a slave turned into master but:</font></i>
<a name='L1474'><i><font color='green'>             *</font></i>
<a name='L1475'><i><font color='green'>             * 1) Failover not in progress.</font></i>
<a name='L1476'><i><font color='green'>             * 2) RunID hs changed, or its the first time we see an INFO output.</font></i>
<a name='L1477'><i><font color='green'>             * </font></i>
<a name='L1478'><i><font color='green'>             * We assume this is a reboot with a wrong configuration.</font></i>
<a name='L1479'><i><font color='green'>             * Log the event and remove the slave. */</font></i>
<a name='L1480'>            <b>int</b> retval;
<a name='L1481'>
<a name='L1482'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-slave-restart-as-master",ri,"%@ #removing it from the attached slaves");
<a name='L1483'>            retval = <a href='../D/2066.html' title='Multiple defined in 2 places.'>dictDelete</a>(ri-&gt;master-&gt;slaves,ri-&gt;name);
<a name='L1484'>            <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(retval == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>);
<a name='L1485'>            <b>return</b>;
<a name='L1486'>        <font color='red'>}</font> <b>else</b> <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>) <font color='red'>{</font>
<a name='L1487'>            <i><font color='green'>/* If this is a promoted slave we can change state to the</font></i>
<a name='L1488'><i><font color='green'>             * failover state machine. */</font></i>
<a name='L1489'>            <b>if</b> ((ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) &amp;&amp;
<a name='L1490'>                (ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) &amp;&amp;
<a name='L1491'>                (ri-&gt;master-&gt;failover_state ==
<a name='L1492'>                    <a href='../S/82.html#L106' title='Defined at 106 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</a>))
<a name='L1493'>            <font color='red'>{</font>
<a name='L1494'>                ri-&gt;master-&gt;failover_state = <a href='../S/82.html#L107' title='Defined at 107 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a>;
<a name='L1495'>                ri-&gt;master-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1496'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+promoted-slave",ri,"%@");
<a name='L1497'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-state-reconf-slaves",
<a name='L1498'>                    ri-&gt;master,"%@");
<a name='L1499'>                <a href='../S/82.html#L787' title='Defined at 787 in src/sentinel.c.'>sentinelCallClientReconfScript</a>(ri-&gt;master,<a href='../S/82.html#L120' title='Defined at 120 in src/sentinel.c.'>SENTINEL_LEADER</a>,
<a name='L1500'>                    "start",ri-&gt;master-&gt;addr,ri-&gt;addr);
<a name='L1501'>            <font color='red'>}</font>
<a name='L1502'>        <font color='red'>}</font> <b>else</b> <b>if</b> (!(ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) ||
<a name='L1503'>                    ((ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) &amp;&amp;
<a name='L1504'>                     (ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) &amp;&amp;
<a name='L1505'>                     ri-&gt;master-&gt;failover_state ==
<a name='L1506'>                     <a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>))
<a name='L1507'>        <font color='red'>{</font>
<a name='L1508'>            <i><font color='green'>/* No failover in progress? Then it is the start of a failover</font></i>
<a name='L1509'><i><font color='green'>             * and we are an observer.</font></i>
<a name='L1510'><i><font color='green'>             *</font></i>
<a name='L1511'><i><font color='green'>             * We also do that if we are a leader doing a failover, in wait</font></i>
<a name='L1512'><i><font color='green'>             * start, but well, somebody else started before us. */</font></i>
<a name='L1513'>
<a name='L1514'>            <b>if</b> (ri-&gt;master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) <font color='red'>{</font>
<a name='L1515'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-failover-abort-race",
<a name='L1516'>                                ri-&gt;master, "%@");
<a name='L1517'>                <a href='../S/82.html#L2877' title='Defined at 2877 in src/sentinel.c.'>sentinelAbortFailover</a>(ri-&gt;master);
<a name='L1518'>            <font color='red'>}</font>
<a name='L1519'>
<a name='L1520'>            ri-&gt;master-&gt;flags |= <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>;
<a name='L1521'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-detected",ri-&gt;master,"%@");
<a name='L1522'>            ri-&gt;master-&gt;failover_state = <a href='../S/82.html#L111' title='Defined at 111 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_DETECT_END</a>;
<a name='L1523'>            ri-&gt;master-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1524'>            ri-&gt;master-&gt;promoted_slave = ri;
<a name='L1525'>            ri-&gt;flags |= <a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>;
<a name='L1526'>            <a href='../S/82.html#L787' title='Defined at 787 in src/sentinel.c.'>sentinelCallClientReconfScript</a>(ri-&gt;master,<a href='../S/82.html#L121' title='Defined at 121 in src/sentinel.c.'>SENTINEL_OBSERVER</a>,
<a name='L1527'>                "start", ri-&gt;master-&gt;addr,ri-&gt;addr);
<a name='L1528'>            <i><font color='green'>/* We are an observer, so we can only assume that the leader</font></i>
<a name='L1529'><i><font color='green'>             * is reconfiguring the slave instances. For this reason we</font></i>
<a name='L1530'><i><font color='green'>             * set all the instances as RECONF_SENT waiting for progresses</font></i>
<a name='L1531'><i><font color='green'>             * on this side. */</font></i>
<a name='L1532'>            <a href='../S/82.html#L1039' title='Defined at 1039 in src/sentinel.c.'>sentinelAddFlagsToDictOfRedisInstances</a>(ri-&gt;master-&gt;slaves,
<a name='L1533'>                <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>);
<a name='L1534'>        <font color='red'>}</font>
<a name='L1535'>    <font color='red'>}</font>
<a name='L1536'>
<a name='L1537'>    <i><font color='green'>/* Detect if the slave that is in the process of being reconfigured</font></i>
<a name='L1538'><i><font color='green'>     * changed state. */</font></i>
<a name='L1539'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) &amp;&amp; role == <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a> &amp;&amp;
<a name='L1540'>        (ri-&gt;flags &amp; (<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>)))
<a name='L1541'>    <font color='red'>{</font>
<a name='L1542'>        <i><font color='green'>/* SRI_RECONF_SENT -&gt; SRI_RECONF_INPROG. */</font></i>
<a name='L1543'>        <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>) &amp;&amp;
<a name='L1544'>            ri-&gt;slave_master_host &amp;&amp;
<a name='L1545'>            strcmp(ri-&gt;slave_master_host,
<a name='L1546'>                    ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;ip) == 0 &amp;&amp;
<a name='L1547'>            ri-&gt;slave_master_port == ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;port)
<a name='L1548'>        <font color='red'>{</font>
<a name='L1549'>            ri-&gt;flags &amp;= ~<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>;
<a name='L1550'>            ri-&gt;flags |= <a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>;
<a name='L1551'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+slave-reconf-inprog",ri,"%@");
<a name='L1552'>        <font color='red'>}</font>
<a name='L1553'>
<a name='L1554'>        <i><font color='green'>/* SRI_RECONF_INPROG -&gt; SRI_RECONF_DONE */</font></i>
<a name='L1555'>        <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>) &amp;&amp;
<a name='L1556'>            ri-&gt;slave_master_link_status == <a href='../S/82.html#L114' title='Defined at 114 in src/sentinel.c.'>SENTINEL_MASTER_LINK_STATUS_UP</a>)
<a name='L1557'>        <font color='red'>{</font>
<a name='L1558'>            ri-&gt;flags &amp;= ~<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>;
<a name='L1559'>            ri-&gt;flags |= <a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>;
<a name='L1560'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+slave-reconf-done",ri,"%@");
<a name='L1561'>            <i><font color='green'>/* If we are moving forward (a new slave is now configured)</font></i>
<a name='L1562'><i><font color='green'>             * we update the change_time as we are conceptually passing</font></i>
<a name='L1563'><i><font color='green'>             * to the next slave. */</font></i>
<a name='L1564'>            ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1565'>        <font color='red'>}</font>
<a name='L1566'>    <font color='red'>}</font>
<a name='L1567'><font color='red'>}</font>
<a name='L1568'>
<a name='L1569'><b>void</b> <a href='../S/82.html#L1750' title='Refered from 1750 in src/sentinel.c.'>sentinelInfoReplyCallback</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L1570'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1571'>    <a href='../D/3855.html' title='Multiple defined in 2 places.'>redisReply</a> *r;
<a name='L1572'>
<a name='L1573'>    <b>if</b> (ri) ri-&gt;pending_commands--;
<a name='L1574'>    <b>if</b> (!reply || !ri) <b>return</b>;
<a name='L1575'>    r = reply;
<a name='L1576'>
<a name='L1577'>    <b>if</b> (r-&gt;type == <a href='../S/121.html#L82' title='Defined at 82 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STRING</a>) <font color='red'>{</font>
<a name='L1578'>        <a href='../S/82.html#L1353' title='Defined at 1353 in src/sentinel.c.'>sentinelRefreshInstanceInfo</a>(ri,r-&gt;str);
<a name='L1579'>    <font color='red'>}</font>
<a name='L1580'><font color='red'>}</font>
<a name='L1581'>
<a name='L1582'><i><font color='green'>/* Just discard the reply. We use this when we are not monitoring the return</font></i>
<a name='L1583'><i><font color='green'> * value of the command but its effects directly. */</font></i>
<a name='L1584'><b>void</b> <a href='../R/3674.html' title='Multiple refered from 7 places.'>sentinelDiscardReplyCallback</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L1585'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1586'>
<a name='L1587'>    <b>if</b> (ri) ri-&gt;pending_commands--;
<a name='L1588'><font color='red'>}</font>
<a name='L1589'>
<a name='L1590'><b>void</b> <a href='../S/82.html#L1756' title='Refered from 1756 in src/sentinel.c.'>sentinelPingReplyCallback</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L1591'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1592'>    <a href='../D/3855.html' title='Multiple defined in 2 places.'>redisReply</a> *r;
<a name='L1593'>
<a name='L1594'>    <b>if</b> (ri) ri-&gt;pending_commands--;
<a name='L1595'>    <b>if</b> (!reply || !ri) <b>return</b>;
<a name='L1596'>    r = reply;
<a name='L1597'>
<a name='L1598'>    <b>if</b> (r-&gt;type == <a href='../S/121.html#L86' title='Defined at 86 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STATUS</a> ||
<a name='L1599'>        r-&gt;type == <a href='../S/121.html#L87' title='Defined at 87 in deps/hiredis/hiredis.h.'>REDIS_REPLY_ERROR</a>) <font color='red'>{</font>
<a name='L1600'>        <i><font color='green'>/* Update the "instance available" field only if this is an</font></i>
<a name='L1601'><i><font color='green'>         * acceptable reply. */</font></i>
<a name='L1602'>        <b>if</b> (strncmp(r-&gt;str,"PONG",4) == 0 ||
<a name='L1603'>            strncmp(r-&gt;str,"LOADING",7) == 0 ||
<a name='L1604'>            strncmp(r-&gt;str,"MASTERDOWN",10) == 0)
<a name='L1605'>        <font color='red'>{</font>
<a name='L1606'>            ri-&gt;last_avail_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1607'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1608'>            <i><font color='green'>/* Send a SCRIPT KILL command if the instance appears to be</font></i>
<a name='L1609'><i><font color='green'>             * down because of a busy script. */</font></i>
<a name='L1610'>            <b>if</b> (strncmp(r-&gt;str,"BUSY",4) == 0 &amp;&amp;
<a name='L1611'>                (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) &amp;&amp;
<a name='L1612'>                !(ri-&gt;flags &amp; <a href='../S/82.html#L76' title='Defined at 76 in src/sentinel.c.'>SRI_SCRIPT_KILL_SENT</a>))
<a name='L1613'>            <font color='red'>{</font>
<a name='L1614'>                <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;cc,
<a name='L1615'>                    <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "SCRIPT KILL");
<a name='L1616'>                ri-&gt;flags |= <a href='../S/82.html#L76' title='Defined at 76 in src/sentinel.c.'>SRI_SCRIPT_KILL_SENT</a>;
<a name='L1617'>            <font color='red'>}</font>
<a name='L1618'>        <font color='red'>}</font>
<a name='L1619'>    <font color='red'>}</font>
<a name='L1620'>    ri-&gt;last_pong_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1621'><font color='red'>}</font>
<a name='L1622'>
<a name='L1623'><i><font color='green'>/* This is called when we get the reply about the PUBLISH command we send</font></i>
<a name='L1624'><i><font color='green'> * to the master to advertise this sentinel. */</font></i>
<a name='L1625'><b>void</b> <a href='../S/82.html#L1773' title='Refered from 1773 in src/sentinel.c.'>sentinelPublishReplyCallback</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L1626'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1627'>    <a href='../D/3855.html' title='Multiple defined in 2 places.'>redisReply</a> *r;
<a name='L1628'>
<a name='L1629'>    <b>if</b> (ri) ri-&gt;pending_commands--;
<a name='L1630'>    <b>if</b> (!reply || !ri) <b>return</b>;
<a name='L1631'>    r = reply;
<a name='L1632'>
<a name='L1633'>    <i><font color='green'>/* Only update pub_time if we actually published our message. Otherwise</font></i>
<a name='L1634'><i><font color='green'>     * we'll retry against in 100 milliseconds. */</font></i>
<a name='L1635'>    <b>if</b> (r-&gt;type != <a href='../S/121.html#L87' title='Defined at 87 in deps/hiredis/hiredis.h.'>REDIS_REPLY_ERROR</a>)
<a name='L1636'>        ri-&gt;last_pub_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1637'><font color='red'>}</font>
<a name='L1638'>
<a name='L1639'><i><font color='green'>/* This is our Pub/Sub callback for the Hello channel. It's useful in order</font></i>
<a name='L1640'><i><font color='green'> * to discover other sentinels attached at the same master. */</font></i>
<a name='L1641'><b>void</b> <a href='../R/3705.html' title='Multiple refered from 2 places.'>sentinelReceiveHelloMessages</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L1642'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L1643'>    <a href='../D/3855.html' title='Multiple defined in 2 places.'>redisReply</a> *r;
<a name='L1644'>
<a name='L1645'>    <b>if</b> (!reply || !ri) <b>return</b>;
<a name='L1646'>    r = reply;
<a name='L1647'>
<a name='L1648'>    <i><font color='green'>/* Update the last activity in the pubsub channel. Note that since we</font></i>
<a name='L1649'><i><font color='green'>     * receive our messages as well this timestamp can be used to detect</font></i>
<a name='L1650'><i><font color='green'>     * if the link is probably diconnected even if it seems otherwise. */</font></i>
<a name='L1651'>    ri-&gt;pc_last_activity = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1652'>   
<a name='L1653'>    <i><font color='green'>/* Sanity check in the reply we expect, so that the code that follows</font></i>
<a name='L1654'><i><font color='green'>     * can avoid to check for details. */</font></i>
<a name='L1655'>    <b>if</b> (r-&gt;type != <a href='../S/121.html#L83' title='Defined at 83 in deps/hiredis/hiredis.h.'>REDIS_REPLY_ARRAY</a> ||
<a name='L1656'>        r-&gt;elements != 3 ||
<a name='L1657'>        r-&gt;element[0]-&gt;type != <a href='../S/121.html#L82' title='Defined at 82 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STRING</a> ||
<a name='L1658'>        r-&gt;element[1]-&gt;type != <a href='../S/121.html#L82' title='Defined at 82 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STRING</a> ||
<a name='L1659'>        r-&gt;element[2]-&gt;type != <a href='../S/121.html#L82' title='Defined at 82 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STRING</a> ||
<a name='L1660'>        strcmp(r-&gt;element[0]-&gt;str,"message") != 0) <b>return</b>;
<a name='L1661'>
<a name='L1662'>    <i><font color='green'>/* We are not interested in meeting ourselves */</font></i>
<a name='L1663'>    <b>if</b> (strstr(r-&gt;element[2]-&gt;str,server.runid) != NULL) <b>return</b>;
<a name='L1664'>
<a name='L1665'>    <font color='red'>{</font>
<a name='L1666'>        <b>int</b> numtokens, port, removed, canfailover;
<a name='L1667'>        <b>char</b> **token = <a href='../D/4018.html' title='Multiple defined in 2 places.'>sdssplitlen</a>(r-&gt;element[2]-&gt;str,
<a name='L1668'>                                   r-&gt;element[2]-&gt;len,
<a name='L1669'>                                   ":",1,&amp;numtokens);
<a name='L1670'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>;
<a name='L1671'>
<a name='L1672'>        <b>if</b> (numtokens == 4) <font color='red'>{</font>
<a name='L1673'>            <i><font color='green'>/* First, try to see if we already have this sentinel. */</font></i>
<a name='L1674'>            port = atoi(token[1]);
<a name='L1675'>            canfailover = atoi(token[3]);
<a name='L1676'>            <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a> = <a href='../S/82.html#L1005' title='Defined at 1005 in src/sentinel.c.'>getSentinelRedisInstanceByAddrAndRunID</a>(
<a name='L1677'>                            ri-&gt;sentinels,token[0],port,token[2]);
<a name='L1678'>
<a name='L1679'>            <b>if</b> (!<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>) <font color='red'>{</font>
<a name='L1680'>                <i><font color='green'>/* If not, remove all the sentinels that have the same runid</font></i>
<a name='L1681'><i><font color='green'>                 * OR the same ip/port, because it's either a restart or a</font></i>
<a name='L1682'><i><font color='green'>                 * network topology change. */</font></i>
<a name='L1683'>                removed = <a href='../S/82.html#L979' title='Defined at 979 in src/sentinel.c.'>removeMatchingSentinelsFromMaster</a>(ri,token[0],port,
<a name='L1684'>                                token[2]);
<a name='L1685'>                <b>if</b> (removed) <font color='red'>{</font>
<a name='L1686'>                    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"-dup-sentinel",ri,
<a name='L1687'>                        "%@ #duplicate of %s:%d or %s",
<a name='L1688'>                        token[0],port,token[2]);
<a name='L1689'>                <font color='red'>}</font>
<a name='L1690'>
<a name='L1691'>                <i><font color='green'>/* Add the new sentinel. */</font></i>
<a name='L1692'>                <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a> = <a href='../S/82.html#L821' title='Defined at 821 in src/sentinel.c.'>createSentinelRedisInstance</a>(NULL,<a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>,
<a name='L1693'>                                token[0],port,ri-&gt;quorum,ri);
<a name='L1694'>                <b>if</b> (<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>) <font color='red'>{</font>
<a name='L1695'>                    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+sentinel",<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>,"%@");
<a name='L1696'>                    <i><font color='green'>/* The runid is NULL after a new instance creation and</font></i>
<a name='L1697'><i><font color='green'>                     * for Sentinels we don't have a later chance to fill it,</font></i>
<a name='L1698'><i><font color='green'>                     * so do it now. */</font></i>
<a name='L1699'>                    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>-&gt;runid = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(token[2]);
<a name='L1700'>                <font color='red'>}</font>
<a name='L1701'>            <font color='red'>}</font>
<a name='L1702'>
<a name='L1703'>            <i><font color='green'>/* Update the state of the Sentinel. */</font></i>
<a name='L1704'>            <b>if</b> (<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>) <font color='red'>{</font>
<a name='L1705'>                <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>-&gt;last_hello_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1706'>                <b>if</b> (canfailover)
<a name='L1707'>                    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>-&gt;flags |= <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>;
<a name='L1708'>                <b>else</b>
<a name='L1709'>                    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>-&gt;flags &amp;= ~<a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>;
<a name='L1710'>            <font color='red'>}</font>
<a name='L1711'>        <font color='red'>}</font>
<a name='L1712'>        <a href='../D/4007.html' title='Multiple defined in 2 places.'>sdsfreesplitres</a>(token,numtokens);
<a name='L1713'>    <font color='red'>}</font>
<a name='L1714'><font color='red'>}</font>
<a name='L1715'>
<a name='L1716'><b>void</b> <a href='../S/82.html#L2954' title='Refered from 2954 in src/sentinel.c.'>sentinelPingInstance</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L1717'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> now = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L1718'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> info_period;
<a name='L1719'>    <b>int</b> retval;
<a name='L1720'>
<a name='L1721'>    <i><font color='green'>/* Return ASAP if we have already a PING or INFO already pending, or</font></i>
<a name='L1722'><i><font color='green'>     * in the case the instance is not properly connected. */</font></i>
<a name='L1723'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) <b>return</b>;
<a name='L1724'>
<a name='L1725'>    <i><font color='green'>/* For INFO, PING, PUBLISH that are not critical commands to send we</font></i>
<a name='L1726'><i><font color='green'>     * also have a limit of SENTINEL_MAX_PENDING_COMMANDS. We don't</font></i>
<a name='L1727'><i><font color='green'>     * want to use a lot of memory just because a link is not working</font></i>
<a name='L1728'><i><font color='green'>     * properly (note that anyway there is a redundant protection about this,</font></i>
<a name='L1729'><i><font color='green'>     * that is, the link will be disconnected and reconnected if a long</font></i>
<a name='L1730'><i><font color='green'>     * timeout condition is detected. */</font></i>
<a name='L1731'>    <b>if</b> (ri-&gt;pending_commands &gt;= <a href='../S/82.html#L92' title='Defined at 92 in src/sentinel.c.'>SENTINEL_MAX_PENDING_COMMANDS</a>) <b>return</b>;
<a name='L1732'>
<a name='L1733'>    <i><font color='green'>/* If this is a slave of a master in O_DOWN condition we start sending</font></i>
<a name='L1734'><i><font color='green'>     * it INFO every second, instead of the usual SENTINEL_INFO_PERIOD</font></i>
<a name='L1735'><i><font color='green'>     * period. In this state we want to closely monitor slaves in case they</font></i>
<a name='L1736'><i><font color='green'>     * are turned into masters by another Sentinel, or by the sysadmin. */</font></i>
<a name='L1737'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) &amp;&amp;
<a name='L1738'>        (ri-&gt;master-&gt;flags &amp; (<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>|<a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>))) <font color='red'>{</font>
<a name='L1739'>        info_period = 1000;
<a name='L1740'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1741'>        info_period = <a href='../S/82.html#L78' title='Defined at 78 in src/sentinel.c.'>SENTINEL_INFO_PERIOD</a>;
<a name='L1742'>    <font color='red'>}</font>
<a name='L1743'>
<a name='L1744'>    <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) == 0 &amp;&amp;
<a name='L1745'>        (ri-&gt;info_refresh == 0 ||
<a name='L1746'>        (now - ri-&gt;info_refresh) &gt; info_period))
<a name='L1747'>    <font color='red'>{</font>
<a name='L1748'>        <i><font color='green'>/* Send INFO to masters and slaves, not sentinels. */</font></i>
<a name='L1749'>        retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;cc,
<a name='L1750'>            <a href='../S/82.html#L1569' title='Defined at 1569 in src/sentinel.c.'>sentinelInfoReplyCallback</a>, NULL, "INFO");
<a name='L1751'>        <b>if</b> (retval != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <b>return</b>;
<a name='L1752'>        ri-&gt;pending_commands++;
<a name='L1753'>    <font color='red'>}</font> <b>else</b> <b>if</b> ((now - ri-&gt;last_pong_time) &gt; <a href='../S/82.html#L79' title='Defined at 79 in src/sentinel.c.'>SENTINEL_PING_PERIOD</a>) <font color='red'>{</font>
<a name='L1754'>        <i><font color='green'>/* Send PING to all the three kinds of instances. */</font></i>
<a name='L1755'>        retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;cc,
<a name='L1756'>            <a href='../S/82.html#L1590' title='Defined at 1590 in src/sentinel.c.'>sentinelPingReplyCallback</a>, NULL, "PING");
<a name='L1757'>        <b>if</b> (retval != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <b>return</b>;
<a name='L1758'>        ri-&gt;pending_commands++;
<a name='L1759'>    <font color='red'>}</font> <b>else</b> <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) &amp;&amp;
<a name='L1760'>               (now - ri-&gt;last_pub_time) &gt; <a href='../S/82.html#L81' title='Defined at 81 in src/sentinel.c.'>SENTINEL_PUBLISH_PERIOD</a>)
<a name='L1761'>    <font color='red'>{</font>
<a name='L1762'>        <i><font color='green'>/* PUBLISH hello messages only to masters. */</font></i>
<a name='L1763'>        <b>struct</b> sockaddr_in sa;
<a name='L1764'>        socklen_t salen = <b>sizeof</b>(sa);
<a name='L1765'>
<a name='L1766'>        <b>if</b> (getsockname(ri-&gt;cc-&gt;c.fd,(<b>struct</b> sockaddr*)&amp;sa,&amp;salen) != -1) <font color='red'>{</font>
<a name='L1767'>            <b>char</b> myaddr[128];
<a name='L1768'>
<a name='L1769'>            snprintf(myaddr,<b>sizeof</b>(myaddr),"%s:%d:%s:%d",
<a name='L1770'>                inet_ntoa(sa.sin_addr), server.port, server.runid,
<a name='L1771'>                (ri-&gt;flags &amp; <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>) != 0);
<a name='L1772'>            retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;cc,
<a name='L1773'>                <a href='../S/82.html#L1625' title='Defined at 1625 in src/sentinel.c.'>sentinelPublishReplyCallback</a>, NULL, "PUBLISH %s %s",
<a name='L1774'>                    <a href='../S/82.html#L83' title='Defined at 83 in src/sentinel.c.'>SENTINEL_HELLO_CHANNEL</a>,myaddr);
<a name='L1775'>            <b>if</b> (retval != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <b>return</b>;
<a name='L1776'>            ri-&gt;pending_commands++;
<a name='L1777'>        <font color='red'>}</font>
<a name='L1778'>    <font color='red'>}</font>
<a name='L1779'><font color='red'>}</font>
<a name='L1780'>
<a name='L1781'><i><font color='green'>/* =========================== SENTINEL command ============================= */</font></i>
<a name='L1782'>
<a name='L1783'><b>const</b> <b>char</b> *<a href='../S/82.html#L1850' title='Refered from 1850 in src/sentinel.c.'>sentinelFailoverStateStr</a>(<b>int</b> state) <font color='red'>{</font>
<a name='L1784'>    <b>switch</b>(state) <font color='red'>{</font>
<a name='L1785'>    <b>case</b> <a href='../S/82.html#L102' title='Defined at 102 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_NONE</a>: <b>return</b> "none";
<a name='L1786'>    <b>case</b> <a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>: <b>return</b> "wait_start";
<a name='L1787'>    <b>case</b> <a href='../S/82.html#L104' title='Defined at 104 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SELECT_SLAVE</a>: <b>return</b> "select_slave";
<a name='L1788'>    <b>case</b> <a href='../S/82.html#L105' title='Defined at 105 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</a>: <b>return</b> "send_slaveof_noone";
<a name='L1789'>    <b>case</b> <a href='../S/82.html#L106' title='Defined at 106 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</a>: <b>return</b> "wait_promotion";
<a name='L1790'>    <b>case</b> <a href='../S/82.html#L107' title='Defined at 107 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a>: <b>return</b> "reconf_slaves";
<a name='L1791'>    <b>case</b> <a href='../S/82.html#L109' title='Defined at 109 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_ALERT_CLIENTS</a>: <b>return</b> "alert_clients";
<a name='L1792'>    <b>case</b> <a href='../S/82.html#L111' title='Defined at 111 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_DETECT_END</a>: <b>return</b> "detect_end";
<a name='L1793'>    <b>case</b> <a href='../S/82.html#L112' title='Defined at 112 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</a>: <b>return</b> "update_config";
<a name='L1794'>    <b>default</b>: <b>return</b> "unknown";
<a name='L1795'>    <font color='red'>}</font>
<a name='L1796'><font color='red'>}</font>
<a name='L1797'>
<a name='L1798'><i><font color='green'>/* Redis instance to Redis protocol representation. */</font></i>
<a name='L1799'><b>void</b> <a href='../S/82.html#L1953' title='Refered from 1953 in src/sentinel.c.'>addReplySentinelRedisInstance</a>(redisClient *c, sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L1800'>    <b>char</b> *flags = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L1801'>    <b>void</b> *mbl;
<a name='L1802'>    <b>int</b> fields = 0;
<a name='L1803'>
<a name='L1804'>    mbl = <a href='../S/86.html#L371' title='Defined at 371 in src/networking.c.'>addDeferredMultiBulkLength</a>(c);
<a name='L1805'>
<a name='L1806'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"name");
<a name='L1807'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,ri-&gt;name);
<a name='L1808'>    fields++;
<a name='L1809'>
<a name='L1810'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"ip");
<a name='L1811'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,ri-&gt;addr-&gt;ip);
<a name='L1812'>    fields++;
<a name='L1813'>
<a name='L1814'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"port");
<a name='L1815'>    <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;addr-&gt;port);
<a name='L1816'>    fields++;
<a name='L1817'>
<a name='L1818'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"runid");
<a name='L1819'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,ri-&gt;runid ? ri-&gt;runid : "");
<a name='L1820'>    fields++;
<a name='L1821'>
<a name='L1822'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"flags");
<a name='L1823'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"s_down,");
<a name='L1824'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"o_down,");
<a name='L1825'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"master,");
<a name='L1826'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"slave,");
<a name='L1827'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"sentinel,");
<a name='L1828'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"disconnected,");
<a name='L1829'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"master_down,");
<a name='L1830'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>)
<a name='L1831'>        flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"failover_in_progress,");
<a name='L1832'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>)
<a name='L1833'>        flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"i_am_the_leader,");
<a name='L1834'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"promoted,");
<a name='L1835'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"reconf_sent,");
<a name='L1836'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"reconf_inprog,");
<a name='L1837'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>) flags = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(flags,"reconf_done,");
<a name='L1838'>
<a name='L1839'>    <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(flags) != 0) flags = <a href='../D/4015.html' title='Multiple defined in 2 places.'>sdsrange</a>(flags,0,-2); <i><font color='green'>/* remove last "," */</font></i>
<a name='L1840'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,flags);
<a name='L1841'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(flags);
<a name='L1842'>    fields++;
<a name='L1843'>
<a name='L1844'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"pending-commands");
<a name='L1845'>    <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;pending_commands);
<a name='L1846'>    fields++;
<a name='L1847'>
<a name='L1848'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) <font color='red'>{</font>
<a name='L1849'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"failover-state");
<a name='L1850'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,(<b>char</b>*)<a href='../S/82.html#L1783' title='Defined at 1783 in src/sentinel.c.'>sentinelFailoverStateStr</a>(ri-&gt;failover_state));
<a name='L1851'>        fields++;
<a name='L1852'>    <font color='red'>}</font>
<a name='L1853'>
<a name='L1854'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"last-ok-ping-reply");
<a name='L1855'>    <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_avail_time);
<a name='L1856'>    fields++;
<a name='L1857'>
<a name='L1858'>    <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"last-ping-reply");
<a name='L1859'>    <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_pong_time);
<a name='L1860'>    fields++;
<a name='L1861'>
<a name='L1862'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) <font color='red'>{</font>
<a name='L1863'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"s-down-time");
<a name='L1864'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>()-ri-&gt;s_down_since_time);
<a name='L1865'>        fields++;
<a name='L1866'>    <font color='red'>}</font>
<a name='L1867'>
<a name='L1868'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>) <font color='red'>{</font>
<a name='L1869'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"o-down-time");
<a name='L1870'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>()-ri-&gt;o_down_since_time);
<a name='L1871'>        fields++;
<a name='L1872'>    <font color='red'>}</font>
<a name='L1873'>
<a name='L1874'>    <i><font color='green'>/* Masters and Slaves */</font></i>
<a name='L1875'>    <b>if</b> (ri-&gt;flags &amp; (<a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>|<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>)) <font color='red'>{</font>
<a name='L1876'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"info-refresh");
<a name='L1877'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;info_refresh);
<a name='L1878'>        fields++;
<a name='L1879'>    <font color='red'>}</font>
<a name='L1880'>
<a name='L1881'>    <i><font color='green'>/* Only masters */</font></i>
<a name='L1882'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <font color='red'>{</font>
<a name='L1883'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"num-slaves");
<a name='L1884'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(ri-&gt;slaves));
<a name='L1885'>        fields++;
<a name='L1886'>
<a name='L1887'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"num-other-sentinels");
<a name='L1888'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(ri-&gt;sentinels));
<a name='L1889'>        fields++;
<a name='L1890'>
<a name='L1891'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"quorum");
<a name='L1892'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;quorum);
<a name='L1893'>        fields++;
<a name='L1894'>    <font color='red'>}</font>
<a name='L1895'>
<a name='L1896'>    <i><font color='green'>/* Only slaves */</font></i>
<a name='L1897'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>) <font color='red'>{</font>
<a name='L1898'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"master-link-down-time");
<a name='L1899'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;master_link_down_time);
<a name='L1900'>        fields++;
<a name='L1901'>
<a name='L1902'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"master-link-status");
<a name='L1903'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,
<a name='L1904'>            (ri-&gt;slave_master_link_status == <a href='../S/82.html#L114' title='Defined at 114 in src/sentinel.c.'>SENTINEL_MASTER_LINK_STATUS_UP</a>) ?
<a name='L1905'>            "ok" : "err");
<a name='L1906'>        fields++;
<a name='L1907'>
<a name='L1908'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"master-host");
<a name='L1909'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,
<a name='L1910'>            ri-&gt;slave_master_host ? ri-&gt;slave_master_host : "?");
<a name='L1911'>        fields++;
<a name='L1912'>
<a name='L1913'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"master-port");
<a name='L1914'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;slave_master_port);
<a name='L1915'>        fields++;
<a name='L1916'>
<a name='L1917'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"slave-priority");
<a name='L1918'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,ri-&gt;slave_priority);
<a name='L1919'>        fields++;
<a name='L1920'>    <font color='red'>}</font>
<a name='L1921'>
<a name='L1922'>    <i><font color='green'>/* Only sentinels */</font></i>
<a name='L1923'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L57' title='Defined at 57 in src/sentinel.c.'>SRI_SENTINEL</a>) <font color='red'>{</font>
<a name='L1924'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"last-hello-message");
<a name='L1925'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_hello_time);
<a name='L1926'>        fields++;
<a name='L1927'>
<a name='L1928'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"can-failover-its-master");
<a name='L1929'>        <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,(ri-&gt;flags &amp; <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>) != 0);
<a name='L1930'>        fields++;
<a name='L1931'>
<a name='L1932'>        <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>) <font color='red'>{</font>
<a name='L1933'>            <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,"subjective-leader");
<a name='L1934'>            <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,ri-&gt;leader ? ri-&gt;leader : "?");
<a name='L1935'>            fields++;
<a name='L1936'>        <font color='red'>}</font>
<a name='L1937'>    <font color='red'>}</font>
<a name='L1938'>
<a name='L1939'>    <a href='../S/86.html#L381' title='Defined at 381 in src/networking.c.'>setDeferredMultiBulkLength</a>(c,mbl,fields*2);
<a name='L1940'><font color='red'>}</font>
<a name='L1941'>
<a name='L1942'><i><font color='green'>/* Output a number of instances contanined inside a dictionary as</font></i>
<a name='L1943'><i><font color='green'> * Redis protocol. */</font></i>
<a name='L1944'><b>void</b> <a href='../R/1203.html' title='Multiple refered from 3 places.'>addReplyDictOfRedisInstances</a>(redisClient *c, dict *instances) <font color='red'>{</font>
<a name='L1945'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L1946'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L1947'>
<a name='L1948'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(instances);
<a name='L1949'>    <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(instances));
<a name='L1950'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L1951'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L1952'>
<a name='L1953'>        <a href='../S/82.html#L1799' title='Defined at 1799 in src/sentinel.c.'>addReplySentinelRedisInstance</a>(c,ri);
<a name='L1954'>    <font color='red'>}</font>
<a name='L1955'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L1956'><font color='red'>}</font>
<a name='L1957'>
<a name='L1958'><i><font color='green'>/* Lookup the named master into sentinel.masters.</font></i>
<a name='L1959'><i><font color='green'> * If the master is not found reply to the client with an error and returns</font></i>
<a name='L1960'><i><font color='green'> * NULL. */</font></i>
<a name='L1961'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../R/3688.html' title='Multiple refered from 3 places.'>sentinelGetMasterByNameOrReplyError</a>(redisClient *c,
<a name='L1962'>                        robj *name)
<a name='L1963'><font color='red'>{</font>
<a name='L1964'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1965'>
<a name='L1966'>    ri = <a href='../S/29.html#L501' title='Defined at 501 in src/dict.c.'>dictFetchValue</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters,c-&gt;argv[2]-&gt;ptr);
<a name='L1967'>    <b>if</b> (!ri) <font color='red'>{</font>
<a name='L1968'>        <a href='../S/86.html#L330' title='Defined at 330 in src/networking.c.'>addReplyError</a>(c,"No such master with that name");
<a name='L1969'>        <b>return</b> NULL;
<a name='L1970'>    <font color='red'>}</font>
<a name='L1971'>    <b>return</b> ri;
<a name='L1972'><font color='red'>}</font>
<a name='L1973'>
<a name='L1974'><b>void</b> <a href='../R/3672.html' title='Multiple refered from 2 places.'>sentinelCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L1975'>    <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"masters")) <font color='red'>{</font>
<a name='L1976'>        <i><font color='green'>/* SENTINEL MASTERS */</font></i>
<a name='L1977'>        <b>if</b> (c-&gt;argc != 2) <b>goto</b> numargserr;
<a name='L1978'>
<a name='L1979'>        <a href='../S/82.html#L1944' title='Defined at 1944 in src/sentinel.c.'>addReplyDictOfRedisInstances</a>(c,<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters);
<a name='L1980'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"slaves")) <font color='red'>{</font>
<a name='L1981'>        <i><font color='green'>/* SENTINEL SLAVES &lt;master-name&gt; */</font></i>
<a name='L1982'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1983'>
<a name='L1984'>        <b>if</b> (c-&gt;argc != 3) <b>goto</b> numargserr;
<a name='L1985'>        <b>if</b> ((ri = <a href='../S/82.html#L1961' title='Defined at 1961 in src/sentinel.c.'>sentinelGetMasterByNameOrReplyError</a>(c,c-&gt;argv[2])) == NULL)
<a name='L1986'>            <b>return</b>;
<a name='L1987'>        <a href='../S/82.html#L1944' title='Defined at 1944 in src/sentinel.c.'>addReplyDictOfRedisInstances</a>(c,ri-&gt;slaves);
<a name='L1988'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"sentinels")) <font color='red'>{</font>
<a name='L1989'>        <i><font color='green'>/* SENTINEL SENTINELS &lt;master-name&gt; */</font></i>
<a name='L1990'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1991'>
<a name='L1992'>        <b>if</b> (c-&gt;argc != 3) <b>goto</b> numargserr;
<a name='L1993'>        <b>if</b> ((ri = <a href='../S/82.html#L1961' title='Defined at 1961 in src/sentinel.c.'>sentinelGetMasterByNameOrReplyError</a>(c,c-&gt;argv[2])) == NULL)
<a name='L1994'>            <b>return</b>;
<a name='L1995'>        <a href='../S/82.html#L1944' title='Defined at 1944 in src/sentinel.c.'>addReplyDictOfRedisInstances</a>(c,ri-&gt;sentinels);
<a name='L1996'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"is-master-down-by-addr")) <font color='red'>{</font>
<a name='L1997'>        <i><font color='green'>/* SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; */</font></i>
<a name='L1998'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L1999'>        <b>char</b> *leader = NULL;
<a name='L2000'>        <b>long</b> port;
<a name='L2001'>        <b>int</b> isdown = 0;
<a name='L2002'>
<a name='L2003'>        <b>if</b> (c-&gt;argc != 4) <b>goto</b> numargserr;
<a name='L2004'>        <b>if</b> (<a href='../S/71.html#L498' title='Defined at 498 in src/object.c.'>getLongFromObjectOrReply</a>(c,c-&gt;argv[3],&amp;port,NULL) != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>)
<a name='L2005'>            <b>return</b>;
<a name='L2006'>        ri = <a href='../S/82.html#L1005' title='Defined at 1005 in src/sentinel.c.'>getSentinelRedisInstanceByAddrAndRunID</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters,
<a name='L2007'>            c-&gt;argv[2]-&gt;ptr,port,NULL);
<a name='L2008'>
<a name='L2009'>        <i><font color='green'>/* It exists? Is actually a master? Is subjectively down? It's down.</font></i>
<a name='L2010'><i><font color='green'>         * Note: if we are in tilt mode we always reply with "0". */</font></i>
<a name='L2011'>        <b>if</b> (!<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt &amp;&amp; ri &amp;&amp; (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) &amp;&amp;
<a name='L2012'>                                    (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>))
<a name='L2013'>            isdown = 1;
<a name='L2014'>        <b>if</b> (ri) leader = <a href='../S/82.html#L2314' title='Defined at 2314 in src/sentinel.c.'>sentinelGetSubjectiveLeader</a>(ri);
<a name='L2015'>
<a name='L2016'>        <i><font color='green'>/* Reply with a two-elements multi-bulk reply: down state, leader. */</font></i>
<a name='L2017'>        <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,2);
<a name='L2018'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c, isdown ? shared.cone : shared.czero);
<a name='L2019'>        <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c, leader ? leader : "?");
<a name='L2020'>        <b>if</b> (leader) <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(leader);
<a name='L2021'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"reset")) <font color='red'>{</font>
<a name='L2022'>        <i><font color='green'>/* SENTINEL RESET &lt;pattern&gt; */</font></i>
<a name='L2023'>        <b>if</b> (c-&gt;argc != 3) <b>goto</b> numargserr;
<a name='L2024'>        <a href='../S/86.html#L439' title='Defined at 439 in src/networking.c.'>addReplyLongLong</a>(c,<a href='../S/82.html#L1102' title='Defined at 1102 in src/sentinel.c.'>sentinelResetMastersByPattern</a>(c-&gt;argv[2]-&gt;ptr,<a href='../S/82.html#L119' title='Defined at 119 in src/sentinel.c.'>SENTINEL_GENERATE_EVENT</a>));
<a name='L2025'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"get-master-addr-by-name")) <font color='red'>{</font>
<a name='L2026'>        <i><font color='green'>/* SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt; */</font></i>
<a name='L2027'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L2028'>
<a name='L2029'>        <b>if</b> (c-&gt;argc != 3) <b>goto</b> numargserr;
<a name='L2030'>        ri = <a href='../S/82.html#L1029' title='Defined at 1029 in src/sentinel.c.'>sentinelGetMasterByName</a>(c-&gt;argv[2]-&gt;ptr);
<a name='L2031'>        <b>if</b> (ri == NULL) <font color='red'>{</font>
<a name='L2032'>            <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.nullmultibulk);
<a name='L2033'>        <font color='red'>}</font> <b>else</b> <b>if</b> (ri-&gt;info_refresh == 0) <font color='red'>{</font>
<a name='L2034'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>("-IDONTKNOW I have not enough information to reply. Please ask another Sentinel.\r\n"));
<a name='L2035'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2036'>            <a href='../D/4035.html' title='Multiple defined in 2 places.'>sentinelAddr</a> *addr = ri-&gt;addr;
<a name='L2037'>
<a name='L2038'>            <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) &amp;&amp; ri-&gt;promoted_slave)
<a name='L2039'>                addr = ri-&gt;promoted_slave-&gt;addr;
<a name='L2040'>            <a href='../S/86.html#L448' title='Defined at 448 in src/networking.c.'>addReplyMultiBulkLen</a>(c,2);
<a name='L2041'>            <a href='../S/86.html#L489' title='Defined at 489 in src/networking.c.'>addReplyBulkCString</a>(c,addr-&gt;ip);
<a name='L2042'>            <a href='../S/86.html#L498' title='Defined at 498 in src/networking.c.'>addReplyBulkLongLong</a>(c,addr-&gt;port);
<a name='L2043'>        <font color='red'>}</font>
<a name='L2044'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"failover")) <font color='red'>{</font>
<a name='L2045'>        <i><font color='green'>/* SENTINEL FAILOVER &lt;master-name&gt; */</font></i>
<a name='L2046'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri;
<a name='L2047'>
<a name='L2048'>        <b>if</b> (c-&gt;argc != 3) <b>goto</b> numargserr;
<a name='L2049'>        <b>if</b> ((ri = <a href='../S/82.html#L1961' title='Defined at 1961 in src/sentinel.c.'>sentinelGetMasterByNameOrReplyError</a>(c,c-&gt;argv[2])) == NULL)
<a name='L2050'>            <b>return</b>;
<a name='L2051'>        <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) <font color='red'>{</font>
<a name='L2052'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>("-INPROG Failover already in progress\r\n"));
<a name='L2053'>            <b>return</b>;
<a name='L2054'>        <font color='red'>}</font>
<a name='L2055'>        <b>if</b> (<a href='../S/82.html#L2568' title='Defined at 2568 in src/sentinel.c.'>sentinelSelectSlave</a>(ri) == NULL) <font color='red'>{</font>
<a name='L2056'>            <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>("-NOGOODSLAVE No suitable slave to promote\r\n"));
<a name='L2057'>            <b>return</b>;
<a name='L2058'>        <font color='red'>}</font>
<a name='L2059'>        <a href='../S/82.html#L2441' title='Defined at 2441 in src/sentinel.c.'>sentinelStartFailover</a>(ri,<a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>);
<a name='L2060'>        ri-&gt;flags |= <a href='../S/82.html#L75' title='Defined at 75 in src/sentinel.c.'>SRI_FORCE_FAILOVER</a>;
<a name='L2061'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.<a href='../S/44.html#L300' title='Defined at 300 in src/intset.c.'>ok</a>);
<a name='L2062'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,"pending-scripts")) <font color='red'>{</font>
<a name='L2063'>        <i><font color='green'>/* SENTINEL PENDING-SCRIPTS */</font></i>
<a name='L2064'>
<a name='L2065'>        <b>if</b> (c-&gt;argc != 2) <b>goto</b> numargserr;
<a name='L2066'>        <a href='../S/82.html#L733' title='Defined at 733 in src/sentinel.c.'>sentinelPendingScriptsCommand</a>(c);
<a name='L2067'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2068'>        <a href='../S/86.html#L334' title='Defined at 334 in src/networking.c.'>addReplyErrorFormat</a>(c,"Unknown sentinel subcommand '%s'",
<a name='L2069'>                               (<b>char</b>*)c-&gt;argv[1]-&gt;ptr);
<a name='L2070'>    <font color='red'>}</font>
<a name='L2071'>    <b>return</b>;
<a name='L2072'>
<a name='L2073'>numargserr:
<a name='L2074'>    <a href='../S/86.html#L334' title='Defined at 334 in src/networking.c.'>addReplyErrorFormat</a>(c,"Wrong number of commands for 'sentinel %s'",
<a name='L2075'>                          (<b>char</b>*)c-&gt;argv[1]-&gt;ptr);
<a name='L2076'><font color='red'>}</font>
<a name='L2077'>
<a name='L2078'><b>void</b> <a href='../R/3695.html' title='Multiple refered from 2 places.'>sentinelInfoCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L2079'>    <b>char</b> *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : "default";
<a name='L2080'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> info = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L2081'>    <b>int</b> defsections = !strcasecmp(section,"default");
<a name='L2082'>    <b>int</b> sections = 0;
<a name='L2083'>
<a name='L2084'>    <b>if</b> (c-&gt;argc &gt; 2) <font color='red'>{</font>
<a name='L2085'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.syntaxerr);
<a name='L2086'>        <b>return</b>;
<a name='L2087'>    <font color='red'>}</font>
<a name='L2088'>
<a name='L2089'>    <b>if</b> (!strcasecmp(section,"server") || defsections) <font color='red'>{</font>
<a name='L2090'>        <b>if</b> (sections++) info = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(info,"\r\n");
<a name='L2091'>        <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> serversection = <a href='../S/35.html#L1838' title='Defined at 1838 in src/redis.c.'>genRedisInfoString</a>("server");
<a name='L2092'>        info = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(info,serversection,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(serversection));
<a name='L2093'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(serversection);
<a name='L2094'>    <font color='red'>}</font>
<a name='L2095'>
<a name='L2096'>    <b>if</b> (!strcasecmp(section,"sentinel") || defsections) <font color='red'>{</font>
<a name='L2097'>        <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2098'>        <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2099'>        <b>int</b> master_id = 0;
<a name='L2100'>
<a name='L2101'>        <b>if</b> (sections++) info = <a href='../D/3994.html' title='Multiple defined in 2 places.'>sdscat</a>(info,"\r\n");
<a name='L2102'>        info = <a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(info,
<a name='L2103'>            "# Sentinel\r\n"
<a name='L2104'>            "sentinel_masters:%lu\r\n"
<a name='L2105'>            "sentinel_tilt:%d\r\n"
<a name='L2106'>            "sentinel_running_scripts:%d\r\n"
<a name='L2107'>            "sentinel_scripts_queue_length:%ld\r\n",
<a name='L2108'>            <a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters),
<a name='L2109'>            <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt,
<a name='L2110'>            <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.running_scripts,
<a name='L2111'>            <a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.scripts_queue));
<a name='L2112'>
<a name='L2113'>        di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters);
<a name='L2114'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2115'>            <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2116'>            <b>char</b> *status = "ok";
<a name='L2117'>
<a name='L2118'>            <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>) status = "odown";
<a name='L2119'>            <b>else</b> <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) status = "sdown";
<a name='L2120'>            info = <a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(info,
<a name='L2121'>                "master%d:name=%s,status=%s,address=%s:%d,"
<a name='L2122'>                "slaves=%lu,sentinels=%lu\r\n",
<a name='L2123'>                master_id++, ri-&gt;name, status,
<a name='L2124'>                ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,
<a name='L2125'>                <a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(ri-&gt;slaves),
<a name='L2126'>                <a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(ri-&gt;sentinels)+1);
<a name='L2127'>        <font color='red'>}</font>
<a name='L2128'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2129'>    <font color='red'>}</font>
<a name='L2130'>
<a name='L2131'>    <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,<a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(<a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>(),"$%lu\r\n",
<a name='L2132'>        (<b>unsigned</b> <b>long</b>)<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(info)));
<a name='L2133'>    <a href='../S/86.html#L304' title='Defined at 304 in src/networking.c.'>addReplySds</a>(c,info);
<a name='L2134'>    <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.crlf);
<a name='L2135'><font color='red'>}</font>
<a name='L2136'>
<a name='L2137'><i><font color='green'>/* ===================== SENTINEL availability checks ======================= */</font></i>
<a name='L2138'>
<a name='L2139'><i><font color='green'>/* Is this instance down from our point of view? */</font></i>
<a name='L2140'><b>void</b> <a href='../S/82.html#L2977' title='Refered from 2977 in src/sentinel.c.'>sentinelCheckSubjectivelyDown</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2141'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> elapsed = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_avail_time;
<a name='L2142'>
<a name='L2143'>    <i><font color='green'>/* Check if we are in need for a reconnection of one of the </font></i>
<a name='L2144'><i><font color='green'>     * links, because we are detecting low activity.</font></i>
<a name='L2145'><i><font color='green'>     *</font></i>
<a name='L2146'><i><font color='green'>     * 1) Check if the command link seems connected, was connected not less</font></i>
<a name='L2147'><i><font color='green'>     *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have an</font></i>
<a name='L2148'><i><font color='green'>     *    idle time that is greater than down_after_period / 2 seconds. */</font></i>
<a name='L2149'>    <b>if</b> (ri-&gt;cc &amp;&amp;
<a name='L2150'>        (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;cc_conn_time) &gt; <a href='../S/82.html#L90' title='Defined at 90 in src/sentinel.c.'>SENTINEL_MIN_LINK_RECONNECT_PERIOD</a> &amp;&amp;
<a name='L2151'>        (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_pong_time) &gt; (ri-&gt;down_after_period/2))
<a name='L2152'>    <font color='red'>{</font>
<a name='L2153'>        <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;cc);
<a name='L2154'>    <font color='red'>}</font>
<a name='L2155'>
<a name='L2156'>    <i><font color='green'>/* 2) Check if the pubsub link seems connected, was connected not less</font></i>
<a name='L2157'><i><font color='green'>     *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have no</font></i>
<a name='L2158'><i><font color='green'>     *    activity in the Pub/Sub channel for more than</font></i>
<a name='L2159'><i><font color='green'>     *    SENTINEL_PUBLISH_PERIOD * 3.</font></i>
<a name='L2160'><i><font color='green'>     */</font></i>
<a name='L2161'>    <b>if</b> (ri-&gt;pc &amp;&amp;
<a name='L2162'>        (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;pc_conn_time) &gt; <a href='../S/82.html#L90' title='Defined at 90 in src/sentinel.c.'>SENTINEL_MIN_LINK_RECONNECT_PERIOD</a> &amp;&amp;
<a name='L2163'>        (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;pc_last_activity) &gt; (<a href='../S/82.html#L81' title='Defined at 81 in src/sentinel.c.'>SENTINEL_PUBLISH_PERIOD</a>*3))
<a name='L2164'>    <font color='red'>{</font>
<a name='L2165'>        <a href='../S/82.html#L1225' title='Defined at 1225 in src/sentinel.c.'>sentinelKillLink</a>(ri,ri-&gt;pc);
<a name='L2166'>    <font color='red'>}</font>
<a name='L2167'>
<a name='L2168'>    <i><font color='green'>/* Update the subjectively down flag. */</font></i>
<a name='L2169'>    <b>if</b> (elapsed &gt; ri-&gt;down_after_period) <font color='red'>{</font>
<a name='L2170'>        <i><font color='green'>/* Is subjectively down */</font></i>
<a name='L2171'>        <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) == 0) <font color='red'>{</font>
<a name='L2172'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+sdown",ri,"%@");
<a name='L2173'>            ri-&gt;s_down_since_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2174'>            ri-&gt;flags |= <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>;
<a name='L2175'>        <font color='red'>}</font>
<a name='L2176'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2177'>        <i><font color='green'>/* Is subjectively up */</font></i>
<a name='L2178'>        <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) <font color='red'>{</font>
<a name='L2179'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-sdown",ri,"%@");
<a name='L2180'>            ri-&gt;flags &amp;= ~(<a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>|<a href='../S/82.html#L76' title='Defined at 76 in src/sentinel.c.'>SRI_SCRIPT_KILL_SENT</a>);
<a name='L2181'>        <font color='red'>}</font>
<a name='L2182'>    <font color='red'>}</font>
<a name='L2183'><font color='red'>}</font>
<a name='L2184'>
<a name='L2185'><i><font color='green'>/* Is this instance down accordingly to the configured quorum? */</font></i>
<a name='L2186'><b>void</b> <a href='../S/82.html#L2986' title='Refered from 2986 in src/sentinel.c.'>sentinelCheckObjectivelyDown</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2187'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2188'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2189'>    <b>int</b> quorum = 0, odown = 0;
<a name='L2190'>
<a name='L2191'>    <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) <font color='red'>{</font>
<a name='L2192'>        <i><font color='green'>/* Is down for enough sentinels? */</font></i>
<a name='L2193'>        quorum = 1; <i><font color='green'>/* the current sentinel. */</font></i>
<a name='L2194'>        <i><font color='green'>/* Count all the other sentinels. */</font></i>
<a name='L2195'>        di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;sentinels);
<a name='L2196'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2197'>            <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2198'>
<a name='L2199'>            <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>) quorum++;
<a name='L2200'>        <font color='red'>}</font>
<a name='L2201'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2202'>        <b>if</b> (quorum &gt;= master-&gt;quorum) odown = 1;
<a name='L2203'>    <font color='red'>}</font>
<a name='L2204'>
<a name='L2205'>    <i><font color='green'>/* Set the flag accordingly to the outcome. */</font></i>
<a name='L2206'>    <b>if</b> (odown) <font color='red'>{</font>
<a name='L2207'>        <b>if</b> ((master-&gt;flags &amp; <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>) == 0) <font color='red'>{</font>
<a name='L2208'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+odown",master,"%@ #quorum %d/%d",
<a name='L2209'>                quorum, master-&gt;quorum);
<a name='L2210'>            master-&gt;flags |= <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>;
<a name='L2211'>            master-&gt;o_down_since_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2212'>        <font color='red'>}</font>
<a name='L2213'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2214'>        <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>) <font color='red'>{</font>
<a name='L2215'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-odown",master,"%@");
<a name='L2216'>            master-&gt;flags &amp;= ~<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>;
<a name='L2217'>        <font color='red'>}</font>
<a name='L2218'>    <font color='red'>}</font>
<a name='L2219'><font color='red'>}</font>
<a name='L2220'>
<a name='L2221'><i><font color='green'>/* Receive the SENTINEL is-master-down-by-addr reply, see the</font></i>
<a name='L2222'><i><font color='green'> * sentinelAskMasterStateToOtherSentinels() function for more information. */</font></i>
<a name='L2223'><b>void</b> <a href='../S/82.html#L2285' title='Refered from 2285 in src/sentinel.c.'>sentinelReceiveIsMasterDownReply</a>(redisAsyncContext *c, <b>void</b> *reply, <b>void</b> *privdata) <font color='red'>{</font>
<a name='L2224'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = c-&gt;data;
<a name='L2225'>    <a href='../D/3855.html' title='Multiple defined in 2 places.'>redisReply</a> *r;
<a name='L2226'>
<a name='L2227'>    <b>if</b> (ri) ri-&gt;pending_commands--;
<a name='L2228'>    <b>if</b> (!reply || !ri) <b>return</b>;
<a name='L2229'>    r = reply;
<a name='L2230'>
<a name='L2231'>    <i><font color='green'>/* Ignore every error or unexpected reply.</font></i>
<a name='L2232'><i><font color='green'>     * Note that if the command returns an error for any reason we'll</font></i>
<a name='L2233'><i><font color='green'>     * end clearing the SRI_MASTER_DOWN flag for timeout anyway. */</font></i>
<a name='L2234'>    <b>if</b> (r-&gt;type == <a href='../S/121.html#L83' title='Defined at 83 in deps/hiredis/hiredis.h.'>REDIS_REPLY_ARRAY</a> &amp;&amp; r-&gt;elements == 2 &amp;&amp;
<a name='L2235'>        r-&gt;element[0]-&gt;type == <a href='../S/121.html#L84' title='Defined at 84 in deps/hiredis/hiredis.h.'>REDIS_REPLY_INTEGER</a> &amp;&amp;
<a name='L2236'>        r-&gt;element[1]-&gt;type == <a href='../S/121.html#L82' title='Defined at 82 in deps/hiredis/hiredis.h.'>REDIS_REPLY_STRING</a>)
<a name='L2237'>    <font color='red'>{</font>
<a name='L2238'>        ri-&gt;last_master_down_reply_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2239'>        <b>if</b> (r-&gt;element[0]-&gt;integer == 1) <font color='red'>{</font>
<a name='L2240'>            ri-&gt;flags |= <a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>;
<a name='L2241'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2242'>            ri-&gt;flags &amp;= ~<a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>;
<a name='L2243'>        <font color='red'>}</font>
<a name='L2244'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;leader);
<a name='L2245'>        ri-&gt;leader = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(r-&gt;element[1]-&gt;str);
<a name='L2246'>    <font color='red'>}</font>
<a name='L2247'><font color='red'>}</font>
<a name='L2248'>
<a name='L2249'><i><font color='green'>/* If we think (subjectively) the master is down, we start sending</font></i>
<a name='L2250'><i><font color='green'> * SENTINEL IS-MASTER-DOWN-BY-ADDR requests to other sentinels</font></i>
<a name='L2251'><i><font color='green'> * in order to get the replies that allow to reach the quorum and</font></i>
<a name='L2252'><i><font color='green'> * possibly also mark the master as objectively down. */</font></i>
<a name='L2253'><b>void</b> <a href='../S/82.html#L2963' title='Refered from 2963 in src/sentinel.c.'>sentinelAskMasterStateToOtherSentinels</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2254'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2255'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2256'>
<a name='L2257'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;sentinels);
<a name='L2258'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2259'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2260'>        <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> elapsed = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_master_down_reply_time;
<a name='L2261'>        <b>char</b> port[32];
<a name='L2262'>        <b>int</b> retval;
<a name='L2263'>
<a name='L2264'>        <i><font color='green'>/* If the master state from other sentinel is too old, we clear it. */</font></i>
<a name='L2265'>        <b>if</b> (elapsed &gt; <a href='../S/82.html#L97' title='Defined at 97 in src/sentinel.c.'>SENTINEL_INFO_VALIDITY_TIME</a>) <font color='red'>{</font>
<a name='L2266'>            ri-&gt;flags &amp;= ~<a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>;
<a name='L2267'>            <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(ri-&gt;leader);
<a name='L2268'>            ri-&gt;leader = NULL;
<a name='L2269'>        <font color='red'>}</font>
<a name='L2270'>
<a name='L2271'>        <i><font color='green'>/* Only ask if master is down to other sentinels if:</font></i>
<a name='L2272'><i><font color='green'>         *</font></i>
<a name='L2273'><i><font color='green'>         * 1) We believe it is down, or there is a failover in progress.</font></i>
<a name='L2274'><i><font color='green'>         * 2) Sentinel is connected.</font></i>
<a name='L2275'><i><font color='green'>         * 3) We did not received the info within SENTINEL_ASK_PERIOD ms. */</font></i>
<a name='L2276'>        <b>if</b> ((master-&gt;flags &amp; (<a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>|<a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>)) == 0)
<a name='L2277'>            <b>continue</b>;
<a name='L2278'>        <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) <b>continue</b>;
<a name='L2279'>        <b>if</b> (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_master_down_reply_time &lt; <a href='../S/82.html#L80' title='Defined at 80 in src/sentinel.c.'>SENTINEL_ASK_PERIOD</a>)
<a name='L2280'>            <b>continue</b>;
<a name='L2281'>
<a name='L2282'>        <i><font color='green'>/* Ask */</font></i>
<a name='L2283'>        <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(port,<b>sizeof</b>(port),master-&gt;addr-&gt;port);
<a name='L2284'>        retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;cc,
<a name='L2285'>                    <a href='../S/82.html#L2223' title='Defined at 2223 in src/sentinel.c.'>sentinelReceiveIsMasterDownReply</a>, NULL,
<a name='L2286'>                    "SENTINEL is-master-down-by-addr %s %s",
<a name='L2287'>                    master-&gt;addr-&gt;ip, port);
<a name='L2288'>        <b>if</b> (retval == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) ri-&gt;pending_commands++;
<a name='L2289'>    <font color='red'>}</font>
<a name='L2290'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2291'><font color='red'>}</font>
<a name='L2292'>
<a name='L2293'><i><font color='green'>/* =============================== FAILOVER ================================= */</font></i>
<a name='L2294'>
<a name='L2295'><i><font color='green'>/* Given a master get the "subjective leader", that is, among all the sentinels</font></i>
<a name='L2296'><i><font color='green'> * with given characteristics, the one with the lexicographically smaller</font></i>
<a name='L2297'><i><font color='green'> * runid. The characteristics required are:</font></i>
<a name='L2298'><i><font color='green'> *</font></i>
<a name='L2299'><i><font color='green'> * 1) Has SRI_CAN_FAILOVER flag.</font></i>
<a name='L2300'><i><font color='green'> * 2) Is not disconnected.</font></i>
<a name='L2301'><i><font color='green'> * 3) Recently answered to our ping (no longer than</font></i>
<a name='L2302'><i><font color='green'> *    SENTINEL_INFO_VALIDITY_TIME milliseconds ago).</font></i>
<a name='L2303'><i><font color='green'> *</font></i>
<a name='L2304'><i><font color='green'> * The function returns a pointer to an sds string representing the runid of the</font></i>
<a name='L2305'><i><font color='green'> * leader sentinel instance (from our point of view). Otherwise NULL is</font></i>
<a name='L2306'><i><font color='green'> * returned if there are no suitable sentinels.</font></i>
<a name='L2307'><i><font color='green'> */</font></i>
<a name='L2308'>
<a name='L2309'><b>int</b> <a href='../S/82.html#L2344' title='Refered from 2344 in src/sentinel.c.'>compareRunID</a>(<b>const</b> <b>void</b> *a, <b>const</b> <b>void</b> *b) <font color='red'>{</font>
<a name='L2310'>    <b>char</b> **aptrptr = (<b>char</b>**)a, **bptrptr = (<b>char</b>**)b;
<a name='L2311'>    <b>return</b> strcasecmp(*aptrptr, *bptrptr);
<a name='L2312'><font color='red'>}</font>
<a name='L2313'>
<a name='L2314'><b>char</b> *<a href='../R/3691.html' title='Multiple refered from 3 places.'>sentinelGetSubjectiveLeader</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2315'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2316'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2317'>    <b>char</b> **instance =
<a name='L2318'>        <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(<b>char</b>*)*(<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(master-&gt;sentinels)+1));
<a name='L2319'>    <b>int</b> instances = 0;
<a name='L2320'>    <b>char</b> *leader = NULL;
<a name='L2321'>
<a name='L2322'>    <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>) <font color='red'>{</font>
<a name='L2323'>        <i><font color='green'>/* Add myself if I'm a Sentinel that can failover this master. */</font></i>
<a name='L2324'>        instance[instances++] = server.runid;
<a name='L2325'>    <font color='red'>}</font>
<a name='L2326'>
<a name='L2327'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;sentinels);
<a name='L2328'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2329'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2330'>        <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> lag = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;last_avail_time;
<a name='L2331'>
<a name='L2332'>        <b>if</b> (lag &gt; <a href='../S/82.html#L97' title='Defined at 97 in src/sentinel.c.'>SENTINEL_INFO_VALIDITY_TIME</a> ||
<a name='L2333'>            !(ri-&gt;flags &amp; <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>) ||
<a name='L2334'>            (ri-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) ||
<a name='L2335'>            ri-&gt;runid == NULL)
<a name='L2336'>            <b>continue</b>;
<a name='L2337'>        instance[instances++] = ri-&gt;runid;
<a name='L2338'>    <font color='red'>}</font>
<a name='L2339'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2340'>
<a name='L2341'>    <i><font color='green'>/* If we have at least one instance passing our checks, order the array</font></i>
<a name='L2342'><i><font color='green'>     * by runid. */</font></i>
<a name='L2343'>    <b>if</b> (instances) <font color='red'>{</font>
<a name='L2344'>        qsort(instance,instances,<b>sizeof</b>(<b>char</b>*),<a href='../S/82.html#L2309' title='Defined at 2309 in src/sentinel.c.'>compareRunID</a>);
<a name='L2345'>        leader = <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(instance[0]);
<a name='L2346'>    <font color='red'>}</font>
<a name='L2347'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(instance);
<a name='L2348'>    <b>return</b> leader;
<a name='L2349'><font color='red'>}</font>
<a name='L2350'>
<a name='L2351'><b>struct</b> sentinelLeader <font color='red'>{</font>
<a name='L2352'>    <b>char</b> *runid;
<a name='L2353'>    <b>unsigned</b> <b>long</b> votes;
<a name='L2354'><font color='red'>}</font>;
<a name='L2355'>
<a name='L2356'><i><font color='green'>/* Helper function for sentinelGetObjectiveLeader, increment the counter</font></i>
<a name='L2357'><i><font color='green'> * relative to the specified runid. */</font></i>
<a name='L2358'><b>void</b> <a href='../R/3700.html' title='Multiple refered from 2 places.'>sentinelObjectiveLeaderIncr</a>(dict *counters, <b>char</b> *runid) <font color='red'>{</font>
<a name='L2359'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de = <a href='../D/2076.html' title='Multiple defined in 2 places.'>dictFind</a>(counters,runid);
<a name='L2360'>    <a href='../S/160.html#L90' title='Defined at 90 in deps/jemalloc/include/msvc_compat/stdint.h.'>uint64_t</a> oldval;
<a name='L2361'>
<a name='L2362'>    <b>if</b> (de) <font color='red'>{</font>
<a name='L2363'>        oldval = <a href='../S/88.html#L134' title='Defined at 134 in src/dict.h.'>dictGetUnsignedIntegerVal</a>(de);
<a name='L2364'>        <a href='../S/88.html#L111' title='Defined at 111 in src/dict.h.'>dictSetUnsignedIntegerVal</a>(de,oldval+1);
<a name='L2365'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2366'>        de = <a href='../S/29.html#L338' title='Defined at 338 in src/dict.c.'>dictAddRaw</a>(counters,runid);
<a name='L2367'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(de != NULL);
<a name='L2368'>        <a href='../S/88.html#L111' title='Defined at 111 in src/dict.h.'>dictSetUnsignedIntegerVal</a>(de,1);
<a name='L2369'>    <font color='red'>}</font>
<a name='L2370'><font color='red'>}</font>
<a name='L2371'>
<a name='L2372'><i><font color='green'>/* Scan all the Sentinels attached to this master to check what is the</font></i>
<a name='L2373'><i><font color='green'> * most voted leader among Sentinels. */</font></i>
<a name='L2374'><b>char</b> *<a href='../R/3689.html' title='Multiple refered from 2 places.'>sentinelGetObjectiveLeader</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2375'>    <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *counters;
<a name='L2376'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2377'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2378'>    <b>unsigned</b> <b>int</b> voters = 0, voters_quorum;
<a name='L2379'>    <b>char</b> *myvote;
<a name='L2380'>    <b>char</b> *winner = NULL;
<a name='L2381'>
<a name='L2382'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(master-&gt;flags &amp; (<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>|<a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>));
<a name='L2383'>    counters = <a href='../D/2065.html' title='Multiple defined in 2 places.'>dictCreate</a>(&amp;leaderVotesDictType,NULL);
<a name='L2384'>
<a name='L2385'>    <i><font color='green'>/* Count my vote. */</font></i>
<a name='L2386'>    myvote = <a href='../S/82.html#L2314' title='Defined at 2314 in src/sentinel.c.'>sentinelGetSubjectiveLeader</a>(master);
<a name='L2387'>    <b>if</b> (myvote) <font color='red'>{</font>
<a name='L2388'>        <a href='../S/82.html#L2358' title='Defined at 2358 in src/sentinel.c.'>sentinelObjectiveLeaderIncr</a>(counters,myvote);
<a name='L2389'>        voters++;
<a name='L2390'>    <font color='red'>}</font>
<a name='L2391'>
<a name='L2392'>    <i><font color='green'>/* Count other sentinels votes */</font></i>
<a name='L2393'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;sentinels);
<a name='L2394'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2395'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2396'>        <b>if</b> (ri-&gt;leader == NULL) <b>continue</b>;
<a name='L2397'>        <i><font color='green'>/* If the failover is not already in progress we are only interested</font></i>
<a name='L2398'><i><font color='green'>         * in Sentinels that believe the master is down. Otherwise the leader</font></i>
<a name='L2399'><i><font color='green'>         * selection is useful for the "failover-takedown" when the original</font></i>
<a name='L2400'><i><font color='green'>         * leader fails. In that case we consider all the voters. */</font></i>
<a name='L2401'>        <b>if</b> (!(master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) &amp;&amp;
<a name='L2402'>            !(ri-&gt;flags &amp; <a href='../S/82.html#L61' title='Defined at 61 in src/sentinel.c.'>SRI_MASTER_DOWN</a>)) <b>continue</b>;
<a name='L2403'>        <a href='../S/82.html#L2358' title='Defined at 2358 in src/sentinel.c.'>sentinelObjectiveLeaderIncr</a>(counters,ri-&gt;leader);
<a name='L2404'>        voters++;
<a name='L2405'>    <font color='red'>}</font>
<a name='L2406'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2407'>    voters_quorum = voters/2+1;
<a name='L2408'>
<a name='L2409'>    <i><font color='green'>/* Check what's the winner. For the winner to win, it needs two conditions:</font></i>
<a name='L2410'><i><font color='green'>     * 1) Absolute majority between voters (50% + 1).</font></i>
<a name='L2411'><i><font color='green'>     * 2) And anyway at least master-&gt;quorum votes. */</font></i>
<a name='L2412'>    <font color='red'>{</font>
<a name='L2413'>        <a href='../S/160.html#L90' title='Defined at 90 in deps/jemalloc/include/msvc_compat/stdint.h.'>uint64_t</a> max_votes = 0; <i><font color='green'>/* Max votes so far. */</font></i>
<a name='L2414'>
<a name='L2415'>        di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(counters);
<a name='L2416'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2417'>            <a href='../S/160.html#L90' title='Defined at 90 in deps/jemalloc/include/msvc_compat/stdint.h.'>uint64_t</a> votes = <a href='../S/88.html#L134' title='Defined at 134 in src/dict.h.'>dictGetUnsignedIntegerVal</a>(de);
<a name='L2418'>
<a name='L2419'>            <b>if</b> (max_votes &lt; votes) <font color='red'>{</font>
<a name='L2420'>                max_votes = votes;
<a name='L2421'>                winner = <a href='../S/88.html#L131' title='Defined at 131 in src/dict.h.'>dictGetKey</a>(de);
<a name='L2422'>            <font color='red'>}</font>
<a name='L2423'>        <font color='red'>}</font>
<a name='L2424'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2425'>        <b>if</b> (winner &amp;&amp; (max_votes &lt; voters_quorum || max_votes &lt; master-&gt;quorum))
<a name='L2426'>            winner = NULL;
<a name='L2427'>    <font color='red'>}</font>
<a name='L2428'>    winner = winner ? <a href='../D/4013.html' title='Multiple defined in 2 places.'>sdsnew</a>(winner) : NULL;
<a name='L2429'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(myvote);
<a name='L2430'>    <a href='../D/2108.html' title='Multiple defined in 2 places.'>dictRelease</a>(counters);
<a name='L2431'>    <b>return</b> winner;
<a name='L2432'><font color='red'>}</font>
<a name='L2433'>
<a name='L2434'><i><font color='green'>/* Setup the master state to start a failover as a leader.</font></i>
<a name='L2435'><i><font color='green'> *</font></i>
<a name='L2436'><i><font color='green'> * State can be either:</font></i>
<a name='L2437'><i><font color='green'> *</font></i>
<a name='L2438'><i><font color='green'> * SENTINEL_FAILOVER_STATE_WAIT_START: starts a failover from scratch.</font></i>
<a name='L2439'><i><font color='green'> * SENTINEL_FAILOVER_STATE_RECONF_SLAVES: takedown a failed failover.</font></i>
<a name='L2440'><i><font color='green'> */</font></i>
<a name='L2441'><b>void</b> <a href='../R/3722.html' title='Multiple refered from 4 places.'>sentinelStartFailover</a>(sentinelRedisInstance *master, <b>int</b> state) <font color='red'>{</font>
<a name='L2442'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(master-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>);
<a name='L2443'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(state == <a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a> ||
<a name='L2444'>                state == <a href='../S/82.html#L107' title='Defined at 107 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a>);
<a name='L2445'>
<a name='L2446'>    master-&gt;failover_state = state;
<a name='L2447'>    master-&gt;flags |= <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>|<a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>;
<a name='L2448'>    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-triggered",master,"%@");
<a name='L2449'>
<a name='L2450'>    <i><font color='green'>/* Pick a random delay if it's a fresh failover (WAIT_START), and not</font></i>
<a name='L2451'><i><font color='green'>     * a recovery of a failover started by another sentinel. */</font></i>
<a name='L2452'>    <b>if</b> (master-&gt;failover_state == <a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>) <font color='red'>{</font>
<a name='L2453'>        master-&gt;failover_start_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() +
<a name='L2454'>            <a href='../S/82.html#L98' title='Defined at 98 in src/sentinel.c.'>SENTINEL_FAILOVER_FIXED_DELAY</a> +
<a name='L2455'>            (rand() % <a href='../S/82.html#L99' title='Defined at 99 in src/sentinel.c.'>SENTINEL_FAILOVER_MAX_RANDOM_DELAY</a>);
<a name='L2456'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-state-wait-start",master,
<a name='L2457'>            "%@ #starting in %lld milliseconds",
<a name='L2458'>            master-&gt;failover_start_time-<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>());
<a name='L2459'>    <font color='red'>}</font>
<a name='L2460'>    master-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2461'><font color='red'>}</font>
<a name='L2462'>
<a name='L2463'><i><font color='green'>/* This function checks if there are the conditions to start the failover,</font></i>
<a name='L2464'><i><font color='green'> * that is:</font></i>
<a name='L2465'><i><font color='green'> *</font></i>
<a name='L2466'><i><font color='green'> * 1) Enough time has passed since O_DOWN.</font></i>
<a name='L2467'><i><font color='green'> * 2) The master is marked as SRI_CAN_FAILOVER, so we can failover it.</font></i>
<a name='L2468'><i><font color='green'> * 3) We are the objectively leader for this master.</font></i>
<a name='L2469'><i><font color='green'> *</font></i>
<a name='L2470'><i><font color='green'> * If the conditions are met we flag the master as SRI_FAILOVER_IN_PROGRESS</font></i>
<a name='L2471'><i><font color='green'> * and SRI_I_AM_THE_LEADER.</font></i>
<a name='L2472'><i><font color='green'> */</font></i>
<a name='L2473'><b>void</b> <a href='../S/82.html#L2987' title='Refered from 2987 in src/sentinel.c.'>sentinelStartFailoverIfNeeded</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2474'>    <b>char</b> *leader;
<a name='L2475'>    <b>int</b> isleader;
<a name='L2476'>
<a name='L2477'>    <i><font color='green'>/* We can't failover if the master is not in O_DOWN state or if</font></i>
<a name='L2478'><i><font color='green'>     * there is not already a failover in progress (to perform the</font></i>
<a name='L2479'><i><font color='green'>     * takedown if the leader died) or if this Sentinel is not allowed</font></i>
<a name='L2480'><i><font color='green'>     * to start a failover. */</font></i>
<a name='L2481'>    <b>if</b> (!(master-&gt;flags &amp; <a href='../S/82.html#L67' title='Defined at 67 in src/sentinel.c.'>SRI_CAN_FAILOVER</a>) ||
<a name='L2482'>        !(master-&gt;flags &amp; (<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>|<a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>))) <b>return</b>;
<a name='L2483'>
<a name='L2484'>    leader = <a href='../S/82.html#L2374' title='Defined at 2374 in src/sentinel.c.'>sentinelGetObjectiveLeader</a>(master);
<a name='L2485'>    isleader = leader &amp;&amp; strcasecmp(leader,server.runid) == 0;
<a name='L2486'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(leader);
<a name='L2487'>
<a name='L2488'>    <i><font color='green'>/* If I'm not the leader, I can't failover for sure. */</font></i>
<a name='L2489'>    <b>if</b> (!isleader) <b>return</b>;
<a name='L2490'>
<a name='L2491'>    <i><font color='green'>/* If the failover is already in progress there are two options... */</font></i>
<a name='L2492'>    <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) <font color='red'>{</font>
<a name='L2493'>        <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) <font color='red'>{</font>
<a name='L2494'>            <i><font color='green'>/* 1) I'm flagged as leader so I already started the failover.</font></i>
<a name='L2495'><i><font color='green'>             *    Just return. */</font></i>
<a name='L2496'>            <b>return</b>;
<a name='L2497'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2498'>            <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> elapsed = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - master-&gt;failover_state_change_time;
<a name='L2499'>
<a name='L2500'>            <i><font color='green'>/* 2) I'm the new leader, but I'm not flagged as leader in the</font></i>
<a name='L2501'><i><font color='green'>             *    master: I did not started the failover, but the original</font></i>
<a name='L2502'><i><font color='green'>             *    leader has no longer the leadership.</font></i>
<a name='L2503'><i><font color='green'>             *</font></i>
<a name='L2504'><i><font color='green'>             *    In this case if the failover appears to be lagging</font></i>
<a name='L2505'><i><font color='green'>             *    for at least 25% of the configured failover timeout,</font></i>
<a name='L2506'><i><font color='green'>             *    I can assume I can take control. Otherwise</font></i>
<a name='L2507'><i><font color='green'>             *    it's better to return and wait more. */</font></i>
<a name='L2508'>            <b>if</b> (elapsed &lt; (master-&gt;failover_timeout/4)) <b>return</b>;
<a name='L2509'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-takedown",master,"%@");
<a name='L2510'>            <i><font color='green'>/* We have already an elected slave if we are in</font></i>
<a name='L2511'><i><font color='green'>             * FAILOVER_IN_PROGRESS state, that is, the slave that we</font></i>
<a name='L2512'><i><font color='green'>             * observed turning into a master. */</font></i>
<a name='L2513'>            <a href='../S/82.html#L2441' title='Defined at 2441 in src/sentinel.c.'>sentinelStartFailover</a>(master,<a href='../S/82.html#L107' title='Defined at 107 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a>);
<a name='L2514'>            <i><font color='green'>/* As an observer we flagged all the slaves as RECONF_SENT but</font></i>
<a name='L2515'><i><font color='green'>             * now we are in charge of actually sending the reconfiguration</font></i>
<a name='L2516'><i><font color='green'>             * command so let's clear this flag for all the instances. */</font></i>
<a name='L2517'>            <a href='../S/82.html#L1053' title='Defined at 1053 in src/sentinel.c.'>sentinelDelFlagsToDictOfRedisInstances</a>(master-&gt;slaves,
<a name='L2518'>                <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>);
<a name='L2519'>        <font color='red'>}</font>
<a name='L2520'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2521'>        <i><font color='green'>/* Brand new failover as SRI_FAILOVER_IN_PROGRESS was not set.</font></i>
<a name='L2522'><i><font color='green'>         *</font></i>
<a name='L2523'><i><font color='green'>         * Do we have a slave to promote? Otherwise don't start a failover</font></i>
<a name='L2524'><i><font color='green'>         * at all. */</font></i>
<a name='L2525'>        <b>if</b> (<a href='../S/82.html#L2568' title='Defined at 2568 in src/sentinel.c.'>sentinelSelectSlave</a>(master) == NULL) <b>return</b>;
<a name='L2526'>        <a href='../S/82.html#L2441' title='Defined at 2441 in src/sentinel.c.'>sentinelStartFailover</a>(master,<a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>);
<a name='L2527'>    <font color='red'>}</font>
<a name='L2528'><font color='red'>}</font>
<a name='L2529'>
<a name='L2530'><i><font color='green'>/* Select a suitable slave to promote. The current algorithm only uses</font></i>
<a name='L2531'><i><font color='green'> * the following parameters:</font></i>
<a name='L2532'><i><font color='green'> *</font></i>
<a name='L2533'><i><font color='green'> * 1) None of the following conditions: S_DOWN, O_DOWN, DISCONNECTED.</font></i>
<a name='L2534'><i><font color='green'> * 2) last_avail_time more recent than SENTINEL_INFO_VALIDITY_TIME.</font></i>
<a name='L2535'><i><font color='green'> * 3) info_refresh more recent than SENTINEL_INFO_VALIDITY_TIME.</font></i>
<a name='L2536'><i><font color='green'> * 4) master_link_down_time no more than:</font></i>
<a name='L2537'><i><font color='green'> *     (now - master-&gt;s_down_since_time) + (master-&gt;down_after_period * 10).</font></i>
<a name='L2538'><i><font color='green'> * 5) Slave priority can't be zero, otherwise the slave is discareded.</font></i>
<a name='L2539'><i><font color='green'> *</font></i>
<a name='L2540'><i><font color='green'> * Among all the slaves matching the above conditions we select the slave</font></i>
<a name='L2541'><i><font color='green'> * with lower slave_priority. If priority is the same we select the slave</font></i>
<a name='L2542'><i><font color='green'> * with lexicographically smaller runid.</font></i>
<a name='L2543'><i><font color='green'> *</font></i>
<a name='L2544'><i><font color='green'> * The function returns the pointer to the selected slave, otherwise</font></i>
<a name='L2545'><i><font color='green'> * NULL if no suitable slave was found.</font></i>
<a name='L2546'><i><font color='green'> */</font></i>
<a name='L2547'>
<a name='L2548'><b>int</b> <a href='../S/82.html#L2602' title='Refered from 2602 in src/sentinel.c.'>compareSlavesForPromotion</a>(<b>const</b> <b>void</b> *a, <b>const</b> <b>void</b> *b) <font color='red'>{</font>
<a name='L2549'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> **sa = (<a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> **)a,
<a name='L2550'>                          **sb = (<a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> **)b;
<a name='L2551'>    <b>char</b> *sa_runid, *sb_runid;
<a name='L2552'>
<a name='L2553'>    <b>if</b> ((*sa)-&gt;slave_priority != (*sb)-&gt;slave_priority)
<a name='L2554'>        <b>return</b> (*sa)-&gt;slave_priority - (*sb)-&gt;slave_priority;
<a name='L2555'>
<a name='L2556'>    <i><font color='green'>/* If priority is the same, select the slave with that has the</font></i>
<a name='L2557'><i><font color='green'>     * lexicographically smaller runid. Note that we try to handle runid</font></i>
<a name='L2558'><i><font color='green'>     * == NULL as there are old Redis versions that don't publish runid in</font></i>
<a name='L2559'><i><font color='green'>     * INFO. A NULL runid is considered bigger than any other runid. */</font></i>
<a name='L2560'>    sa_runid = (*sa)-&gt;runid;
<a name='L2561'>    sb_runid = (*sb)-&gt;runid;
<a name='L2562'>    <b>if</b> (sa_runid == NULL &amp;&amp; sb_runid == NULL) <b>return</b> 0;
<a name='L2563'>    <b>else</b> <b>if</b> (sa_runid == NULL) <b>return</b> 1;  <i><font color='green'>/* a &gt; b */</font></i>
<a name='L2564'>    <b>else</b> <b>if</b> (sb_runid == NULL) <b>return</b> -1; <i><font color='green'>/* a &lt; b */</font></i>
<a name='L2565'>    <b>return</b> strcasecmp(sa_runid, sb_runid);
<a name='L2566'><font color='red'>}</font>
<a name='L2567'>
<a name='L2568'><a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *<a href='../R/3720.html' title='Multiple refered from 4 places.'>sentinelSelectSlave</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2569'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> **instance =
<a name='L2570'>        <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(instance[0])*<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(master-&gt;slaves));
<a name='L2571'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *selected = NULL;
<a name='L2572'>    <b>int</b> instances = 0;
<a name='L2573'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2574'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2575'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> max_master_down_time = 0;
<a name='L2576'>
<a name='L2577'>    <b>if</b> (master-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>)
<a name='L2578'>        max_master_down_time += <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - master-&gt;s_down_since_time;
<a name='L2579'>    max_master_down_time += master-&gt;down_after_period * 10;
<a name='L2580'>
<a name='L2581'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;slaves);
<a name='L2582'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2583'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2584'>        <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> info_validity_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>()-<a href='../S/82.html#L97' title='Defined at 97 in src/sentinel.c.'>SENTINEL_INFO_VALIDITY_TIME</a>;
<a name='L2585'>
<a name='L2586'>        <b>if</b> (slave-&gt;flags &amp; (<a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>|<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>|<a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>)) <b>continue</b>;
<a name='L2587'>        <b>if</b> (slave-&gt;last_avail_time &lt; info_validity_time) <b>continue</b>;
<a name='L2588'>        <b>if</b> (slave-&gt;slave_priority == 0) <b>continue</b>;
<a name='L2589'>
<a name='L2590'>        <i><font color='green'>/* If the master is in SDOWN state we get INFO for slaves every second.</font></i>
<a name='L2591'><i><font color='green'>         * Otherwise we get it with the usual period so we need to account for</font></i>
<a name='L2592'><i><font color='green'>         * a larger delay. */</font></i>
<a name='L2593'>        <b>if</b> ((master-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) == 0)
<a name='L2594'>            info_validity_time -= <a href='../S/82.html#L78' title='Defined at 78 in src/sentinel.c.'>SENTINEL_INFO_PERIOD</a>;
<a name='L2595'>        <b>if</b> (slave-&gt;info_refresh &lt; info_validity_time) <b>continue</b>;
<a name='L2596'>        <b>if</b> (slave-&gt;master_link_down_time &gt; max_master_down_time) <b>continue</b>;
<a name='L2597'>        instance[instances++] = slave;
<a name='L2598'>    <font color='red'>}</font>
<a name='L2599'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2600'>    <b>if</b> (instances) <font color='red'>{</font>
<a name='L2601'>        qsort(instance,instances,<b>sizeof</b>(<a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a>*),
<a name='L2602'>            <a href='../S/82.html#L2548' title='Defined at 2548 in src/sentinel.c.'>compareSlavesForPromotion</a>);
<a name='L2603'>        selected = instance[0];
<a name='L2604'>    <font color='red'>}</font>
<a name='L2605'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(instance);
<a name='L2606'>    <b>return</b> selected;
<a name='L2607'><font color='red'>}</font>
<a name='L2608'>
<a name='L2609'><i><font color='green'>/* ---------------- Failover state machine implementation ------------------- */</font></i>
<a name='L2610'><b>void</b> <a href='../S/82.html#L2847' title='Refered from 2847 in src/sentinel.c.'>sentinelFailoverWaitStart</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2611'>    <i><font color='green'>/* If we in "wait start" but the master is no longer in ODOWN nor in</font></i>
<a name='L2612'><i><font color='green'>     * SDOWN condition we abort the failover. This is important as it</font></i>
<a name='L2613'><i><font color='green'>     * prevents a useless failover in a a notable case of netsplit, where</font></i>
<a name='L2614'><i><font color='green'>     * the senitnels are split from the redis instances. In this case</font></i>
<a name='L2615'><i><font color='green'>     * the failover will not start while there is the split because no</font></i>
<a name='L2616'><i><font color='green'>     * good slave can be reached. However when the split is resolved, we</font></i>
<a name='L2617'><i><font color='green'>     * can go to waitstart if the slave is back rechable a few milliseconds</font></i>
<a name='L2618'><i><font color='green'>     * before the master is. In that case when the master is back online</font></i>
<a name='L2619'><i><font color='green'>     * we cancel the failover. */</font></i>
<a name='L2620'>    <b>if</b> ((ri-&gt;flags &amp; (<a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>|<a href='../S/82.html#L60' title='Defined at 60 in src/sentinel.c.'>SRI_O_DOWN</a>|<a href='../S/82.html#L75' title='Defined at 75 in src/sentinel.c.'>SRI_FORCE_FAILOVER</a>)) == 0) <font color='red'>{</font>
<a name='L2621'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-failover-abort-master-is-back",
<a name='L2622'>            ri,"%@");
<a name='L2623'>        <a href='../S/82.html#L2877' title='Defined at 2877 in src/sentinel.c.'>sentinelAbortFailover</a>(ri);
<a name='L2624'>        <b>return</b>;
<a name='L2625'>    <font color='red'>}</font>
<a name='L2626'>
<a name='L2627'>    <i><font color='green'>/* Start the failover going to the next state if enough time has</font></i>
<a name='L2628'><i><font color='green'>     * elapsed. */</font></i>
<a name='L2629'>    <b>if</b> (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() &gt;= ri-&gt;failover_start_time) <font color='red'>{</font>
<a name='L2630'>        ri-&gt;failover_state = <a href='../S/82.html#L104' title='Defined at 104 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SELECT_SLAVE</a>;
<a name='L2631'>        ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2632'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-state-select-slave",ri,"%@");
<a name='L2633'>    <font color='red'>}</font>
<a name='L2634'><font color='red'>}</font>
<a name='L2635'>
<a name='L2636'><b>void</b> <a href='../S/82.html#L2850' title='Refered from 2850 in src/sentinel.c.'>sentinelFailoverSelectSlave</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2637'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/82.html#L2568' title='Defined at 2568 in src/sentinel.c.'>sentinelSelectSlave</a>(ri);
<a name='L2638'>
<a name='L2639'>    <b>if</b> (slave == NULL) <font color='red'>{</font>
<a name='L2640'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-failover-abort-no-good-slave",ri,"%@");
<a name='L2641'>        <a href='../S/82.html#L2877' title='Defined at 2877 in src/sentinel.c.'>sentinelAbortFailover</a>(ri);
<a name='L2642'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L2643'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+selected-slave",slave,"%@");
<a name='L2644'>        slave-&gt;flags |= <a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>;
<a name='L2645'>        ri-&gt;promoted_slave = slave;
<a name='L2646'>        ri-&gt;failover_state = <a href='../S/82.html#L105' title='Defined at 105 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</a>;
<a name='L2647'>        ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2648'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+failover-state-send-slaveof-noone",
<a name='L2649'>            slave, "%@");
<a name='L2650'>    <font color='red'>}</font>
<a name='L2651'><font color='red'>}</font>
<a name='L2652'>
<a name='L2653'><b>void</b> <a href='../S/82.html#L2853' title='Refered from 2853 in src/sentinel.c.'>sentinelFailoverSendSlaveOfNoOne</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2654'>    <b>int</b> retval;
<a name='L2655'>
<a name='L2656'>    <b>if</b> (ri-&gt;promoted_slave-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) <b>return</b>;
<a name='L2657'>
<a name='L2658'>    <i><font color='green'>/* Send SLAVEOF NO ONE command to turn the slave into a master.</font></i>
<a name='L2659'><i><font color='green'>     * We actually register a generic callback for this command as we don't</font></i>
<a name='L2660'><i><font color='green'>     * really care about the reply. We check if it worked indirectly observing</font></i>
<a name='L2661'><i><font color='green'>     * if INFO returns a different role (master instead of slave). */</font></i>
<a name='L2662'>    retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(ri-&gt;promoted_slave-&gt;cc,
<a name='L2663'>        <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "SLAVEOF NO ONE");
<a name='L2664'>    <b>if</b> (retval != <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <b>return</b>;
<a name='L2665'>    ri-&gt;promoted_slave-&gt;pending_commands++;
<a name='L2666'>    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>, "+failover-state-wait-promotion",
<a name='L2667'>        ri-&gt;promoted_slave,"%@");
<a name='L2668'>    ri-&gt;failover_state = <a href='../S/82.html#L106' title='Defined at 106 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</a>;
<a name='L2669'>    ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2670'><font color='red'>}</font>
<a name='L2671'>
<a name='L2672'><i><font color='green'>/* We actually wait for promotion indirectly checking with INFO when the</font></i>
<a name='L2673'><i><font color='green'> * slave turns into a master. */</font></i>
<a name='L2674'><b>void</b> <a href='../S/82.html#L2856' title='Refered from 2856 in src/sentinel.c.'>sentinelFailoverWaitPromotion</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2675'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> elapsed = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;failover_state_change_time;
<a name='L2676'>
<a name='L2677'>    <b>if</b> (elapsed &gt;= <a href='../S/82.html#L87' title='Defined at 87 in src/sentinel.c.'>SENTINEL_PROMOTION_RETRY_PERIOD</a>) <font color='red'>{</font>
<a name='L2678'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-promotion-timeout",ri-&gt;promoted_slave,
<a name='L2679'>            "%@");
<a name='L2680'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-state-select-slave",ri,"%@");
<a name='L2681'>        ri-&gt;failover_state = <a href='../S/82.html#L104' title='Defined at 104 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SELECT_SLAVE</a>;
<a name='L2682'>        ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2683'>        ri-&gt;promoted_slave-&gt;flags &amp;= ~<a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>;
<a name='L2684'>        ri-&gt;promoted_slave = NULL;
<a name='L2685'>    <font color='red'>}</font>
<a name='L2686'><font color='red'>}</font>
<a name='L2687'>
<a name='L2688'><b>void</b> <a href='../R/3678.html' title='Multiple refered from 2 places.'>sentinelFailoverDetectEnd</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2689'>    <b>int</b> not_reconfigured = 0, timeout = 0;
<a name='L2690'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2691'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2692'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> elapsed = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - master-&gt;failover_state_change_time;
<a name='L2693'>
<a name='L2694'>    <i><font color='green'>/* We can't consider failover finished if the promoted slave is</font></i>
<a name='L2695'><i><font color='green'>     * not reachable. */</font></i>
<a name='L2696'>    <b>if</b> (master-&gt;promoted_slave == NULL ||
<a name='L2697'>        master-&gt;promoted_slave-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) <b>return</b>;
<a name='L2698'>
<a name='L2699'>    <i><font color='green'>/* The failover terminates once all the reachable slaves are properly</font></i>
<a name='L2700'><i><font color='green'>     * configured. */</font></i>
<a name='L2701'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;slaves);
<a name='L2702'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2703'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2704'>
<a name='L2705'>        <b>if</b> (slave-&gt;flags &amp; (<a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>|<a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>)) <b>continue</b>;
<a name='L2706'>        <b>if</b> (slave-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) <b>continue</b>;
<a name='L2707'>        not_reconfigured++;
<a name='L2708'>    <font color='red'>}</font>
<a name='L2709'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2710'>
<a name='L2711'>    <i><font color='green'>/* Force end of failover on timeout. */</font></i>
<a name='L2712'>    <b>if</b> (elapsed &gt; master-&gt;failover_timeout) <font color='red'>{</font>
<a name='L2713'>        not_reconfigured = 0;
<a name='L2714'>        timeout = 1;
<a name='L2715'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-end-for-timeout",master,"%@");
<a name='L2716'>    <font color='red'>}</font>
<a name='L2717'>
<a name='L2718'>    <b>if</b> (not_reconfigured == 0) <font color='red'>{</font>
<a name='L2719'>        <b>int</b> role = (master-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) ? <a href='../S/82.html#L120' title='Defined at 120 in src/sentinel.c.'>SENTINEL_LEADER</a> :
<a name='L2720'>                                                           <a href='../S/82.html#L121' title='Defined at 121 in src/sentinel.c.'>SENTINEL_OBSERVER</a>;
<a name='L2721'>
<a name='L2722'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+failover-end",master,"%@");
<a name='L2723'>        master-&gt;failover_state = <a href='../S/82.html#L112' title='Defined at 112 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</a>;
<a name='L2724'>        master-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2725'>        <a href='../S/82.html#L787' title='Defined at 787 in src/sentinel.c.'>sentinelCallClientReconfScript</a>(master,role,"end",master-&gt;addr,
<a name='L2726'>            master-&gt;promoted_slave-&gt;addr);
<a name='L2727'>    <font color='red'>}</font>
<a name='L2728'>
<a name='L2729'>    <i><font color='green'>/* If I'm the leader it is a good idea to send a best effort SLAVEOF</font></i>
<a name='L2730'><i><font color='green'>     * command to all the slaves still not reconfigured to replicate with</font></i>
<a name='L2731'><i><font color='green'>     * the new master. */</font></i>
<a name='L2732'>    <b>if</b> (timeout &amp;&amp; (master-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>)) <font color='red'>{</font>
<a name='L2733'>        <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2734'>        <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2735'>        <b>char</b> master_port[32];
<a name='L2736'>
<a name='L2737'>        <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(master_port,<b>sizeof</b>(master_port),
<a name='L2738'>            master-&gt;promoted_slave-&gt;addr-&gt;port);
<a name='L2739'>
<a name='L2740'>        di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;slaves);
<a name='L2741'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2742'>            <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2743'>            <b>int</b> retval;
<a name='L2744'>
<a name='L2745'>            <b>if</b> (slave-&gt;flags &amp;
<a name='L2746'>                (<a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>|<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>)) <b>continue</b>;
<a name='L2747'>
<a name='L2748'>            retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(slave-&gt;cc,
<a name='L2749'>                <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "SLAVEOF %s %s",
<a name='L2750'>                    master-&gt;promoted_slave-&gt;addr-&gt;ip,
<a name='L2751'>                    master_port);
<a name='L2752'>            <b>if</b> (retval == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L2753'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+slave-reconf-sent-be",slave,"%@");
<a name='L2754'>                slave-&gt;flags |= <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>;
<a name='L2755'>            <font color='red'>}</font>
<a name='L2756'>        <font color='red'>}</font>
<a name='L2757'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2758'>    <font color='red'>}</font>
<a name='L2759'><font color='red'>}</font>
<a name='L2760'>
<a name='L2761'><i><font color='green'>/* Send SLAVE OF &lt;new master address&gt; to all the remaining slaves that</font></i>
<a name='L2762'><i><font color='green'> * still don't appear to have the configuration updated. */</font></i>
<a name='L2763'><b>void</b> <a href='../S/82.html#L2859' title='Refered from 2859 in src/sentinel.c.'>sentinelFailoverReconfNextSlave</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2764'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2765'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2766'>    <b>int</b> in_progress = 0;
<a name='L2767'>
<a name='L2768'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;slaves);
<a name='L2769'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2770'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2771'>
<a name='L2772'>        <b>if</b> (slave-&gt;flags &amp; (<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>))
<a name='L2773'>            in_progress++;
<a name='L2774'>    <font color='red'>}</font>
<a name='L2775'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2776'>
<a name='L2777'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(master-&gt;slaves);
<a name='L2778'>    <b>while</b>(in_progress &lt; master-&gt;parallel_syncs &amp;&amp;
<a name='L2779'>          (de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL)
<a name='L2780'>    <font color='red'>{</font>
<a name='L2781'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2782'>        <b>int</b> retval;
<a name='L2783'>        <b>char</b> master_port[32];
<a name='L2784'>
<a name='L2785'>        <i><font color='green'>/* Skip the promoted slave, and already configured slaves. */</font></i>
<a name='L2786'>        <b>if</b> (slave-&gt;flags &amp; (<a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>|<a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>)) <b>continue</b>;
<a name='L2787'>
<a name='L2788'>        <i><font color='green'>/* Clear the SRI_RECONF_SENT flag if too much time elapsed without</font></i>
<a name='L2789'><i><font color='green'>         * the slave moving forward to the next state. */</font></i>
<a name='L2790'>        <b>if</b> ((slave-&gt;flags &amp; <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>) &amp;&amp;
<a name='L2791'>            (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - slave-&gt;slave_reconf_sent_time) &gt;
<a name='L2792'>            <a href='../S/82.html#L88' title='Defined at 88 in src/sentinel.c.'>SENTINEL_SLAVE_RECONF_RETRY_PERIOD</a>)
<a name='L2793'>        <font color='red'>{</font>
<a name='L2794'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"-slave-reconf-sent-timeout",slave,"%@");
<a name='L2795'>            slave-&gt;flags &amp;= ~<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>;
<a name='L2796'>        <font color='red'>}</font>
<a name='L2797'>
<a name='L2798'>        <i><font color='green'>/* Nothing to do for instances that are disconnected or already</font></i>
<a name='L2799'><i><font color='green'>         * in RECONF_SENT state. */</font></i>
<a name='L2800'>        <b>if</b> (slave-&gt;flags &amp; (<a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>|<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>))
<a name='L2801'>            <b>continue</b>;
<a name='L2802'>
<a name='L2803'>        <i><font color='green'>/* Send SLAVEOF &lt;new master&gt;. */</font></i>
<a name='L2804'>        <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(master_port,<b>sizeof</b>(master_port),
<a name='L2805'>            master-&gt;promoted_slave-&gt;addr-&gt;port);
<a name='L2806'>        retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(slave-&gt;cc,
<a name='L2807'>            <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "SLAVEOF %s %s",
<a name='L2808'>                master-&gt;promoted_slave-&gt;addr-&gt;ip,
<a name='L2809'>                master_port);
<a name='L2810'>        <b>if</b> (retval == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L2811'>            slave-&gt;flags |= <a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>;
<a name='L2812'>            slave-&gt;pending_commands++;
<a name='L2813'>            slave-&gt;slave_reconf_sent_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2814'>            <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"+slave-reconf-sent",slave,"%@");
<a name='L2815'>            in_progress++;
<a name='L2816'>        <font color='red'>}</font>
<a name='L2817'>    <font color='red'>}</font>
<a name='L2818'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2819'>    <a href='../S/82.html#L2688' title='Defined at 2688 in src/sentinel.c.'>sentinelFailoverDetectEnd</a>(master);
<a name='L2820'><font color='red'>}</font>
<a name='L2821'>
<a name='L2822'><i><font color='green'>/* This function is called when the slave is in</font></i>
<a name='L2823'><i><font color='green'> * SENTINEL_FAILOVER_STATE_UPDATE_CONFIG state. In this state we need</font></i>
<a name='L2824'><i><font color='green'> * to remove it from the master table and add the promoted slave instead.</font></i>
<a name='L2825'><i><font color='green'> *</font></i>
<a name='L2826'><i><font color='green'> * If there are no promoted slaves as this instance is unique, we remove</font></i>
<a name='L2827'><i><font color='green'> * and re-add it with the same address to trigger a complete state</font></i>
<a name='L2828'><i><font color='green'> * refresh. */</font></i>
<a name='L2829'><b>void</b> <a href='../S/82.html#L3015' title='Refered from 3015 in src/sentinel.c.'>sentinelFailoverSwitchToPromotedSlave</a>(sentinelRedisInstance *master) <font color='red'>{</font>
<a name='L2830'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ref = master-&gt;promoted_slave ?
<a name='L2831'>                                 master-&gt;promoted_slave : master;
<a name='L2832'>
<a name='L2833'>    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+switch-master",master,"%s %s %d %s %d",
<a name='L2834'>        master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,
<a name='L2835'>        ref-&gt;addr-&gt;ip, ref-&gt;addr-&gt;port);
<a name='L2836'>
<a name='L2837'>    <a href='../S/82.html#L1134' title='Defined at 1134 in src/sentinel.c.'>sentinelResetMasterAndChangeAddress</a>(master,ref-&gt;addr-&gt;ip,ref-&gt;addr-&gt;port);
<a name='L2838'><font color='red'>}</font>
<a name='L2839'>
<a name='L2840'><b>void</b> <a href='../S/82.html#L2988' title='Refered from 2988 in src/sentinel.c.'>sentinelFailoverStateMachine</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2841'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>);
<a name='L2842'>
<a name='L2843'>    <b>if</b> (!(ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>)) <b>return</b>;
<a name='L2844'>
<a name='L2845'>    <b>switch</b>(ri-&gt;failover_state) <font color='red'>{</font>
<a name='L2846'>        <b>case</b> <a href='../S/82.html#L103' title='Defined at 103 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_START</a>:
<a name='L2847'>            <a href='../S/82.html#L2610' title='Defined at 2610 in src/sentinel.c.'>sentinelFailoverWaitStart</a>(ri);
<a name='L2848'>            <b>break</b>;
<a name='L2849'>        <b>case</b> <a href='../S/82.html#L104' title='Defined at 104 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SELECT_SLAVE</a>:
<a name='L2850'>            <a href='../S/82.html#L2636' title='Defined at 2636 in src/sentinel.c.'>sentinelFailoverSelectSlave</a>(ri);
<a name='L2851'>            <b>break</b>;
<a name='L2852'>        <b>case</b> <a href='../S/82.html#L105' title='Defined at 105 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE</a>:
<a name='L2853'>            <a href='../S/82.html#L2653' title='Defined at 2653 in src/sentinel.c.'>sentinelFailoverSendSlaveOfNoOne</a>(ri);
<a name='L2854'>            <b>break</b>;
<a name='L2855'>        <b>case</b> <a href='../S/82.html#L106' title='Defined at 106 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_WAIT_PROMOTION</a>:
<a name='L2856'>            <a href='../S/82.html#L2674' title='Defined at 2674 in src/sentinel.c.'>sentinelFailoverWaitPromotion</a>(ri);
<a name='L2857'>            <b>break</b>;
<a name='L2858'>        <b>case</b> <a href='../S/82.html#L107' title='Defined at 107 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_RECONF_SLAVES</a>:
<a name='L2859'>            <a href='../S/82.html#L2763' title='Defined at 2763 in src/sentinel.c.'>sentinelFailoverReconfNextSlave</a>(ri);
<a name='L2860'>            <b>break</b>;
<a name='L2861'>        <b>case</b> <a href='../S/82.html#L111' title='Defined at 111 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_DETECT_END</a>:
<a name='L2862'>            <a href='../S/82.html#L2688' title='Defined at 2688 in src/sentinel.c.'>sentinelFailoverDetectEnd</a>(ri);
<a name='L2863'>            <b>break</b>;
<a name='L2864'>    <font color='red'>}</font>
<a name='L2865'><font color='red'>}</font>
<a name='L2866'>
<a name='L2867'><i><font color='green'>/* Abort a failover in progress with the following steps:</font></i>
<a name='L2868'><i><font color='green'> * 1) If this instance is the leaer send a SLAVEOF command to all the already</font></i>
<a name='L2869'><i><font color='green'> *    reconfigured slaves if any to configure them to replicate with the</font></i>
<a name='L2870'><i><font color='green'> *    original master.</font></i>
<a name='L2871'><i><font color='green'> * 2) For both leaders and observers: clear the failover flags and state in</font></i>
<a name='L2872'><i><font color='green'> *    the master instance.</font></i>
<a name='L2873'><i><font color='green'> * 3) If there is already a promoted slave and we are the leader, and this</font></i>
<a name='L2874'><i><font color='green'> *    slave is not DISCONNECTED, try to reconfigure it to replicate</font></i>
<a name='L2875'><i><font color='green'> *    back to the master as well, sending a best effort SLAVEOF command.</font></i>
<a name='L2876'><i><font color='green'> */</font></i>
<a name='L2877'><b>void</b> <a href='../R/3662.html' title='Multiple refered from 5 places.'>sentinelAbortFailover</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2878'>    <b>char</b> master_port[32];
<a name='L2879'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2880'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2881'>    <b>int</b> sentinel_role;
<a name='L2882'>
<a name='L2883'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>);
<a name='L2884'>    <a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(master_port,<b>sizeof</b>(master_port),ri-&gt;addr-&gt;port);
<a name='L2885'>
<a name='L2886'>    <i><font color='green'>/* Clear failover related flags from slaves.</font></i>
<a name='L2887'><i><font color='green'>     * Also if we are the leader make sure to send SLAVEOF commands to all the</font></i>
<a name='L2888'><i><font color='green'>     * already reconfigured slaves in order to turn them back into slaves of</font></i>
<a name='L2889'><i><font color='green'>     * the original master. */</font></i>
<a name='L2890'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(ri-&gt;slaves);
<a name='L2891'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L2892'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *slave = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L2893'>        <b>if</b> ((ri-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) &amp;&amp;
<a name='L2894'>            !(slave-&gt;flags &amp; <a href='../S/82.html#L58' title='Defined at 58 in src/sentinel.c.'>SRI_DISCONNECTED</a>) &amp;&amp;
<a name='L2895'>             (slave-&gt;flags &amp; (<a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>|<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>|
<a name='L2896'>                              <a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>)))
<a name='L2897'>        <font color='red'>{</font>
<a name='L2898'>            <b>int</b> retval;
<a name='L2899'>
<a name='L2900'>            retval = <a href='../S/104.html#L605' title='Defined at 605 in deps/hiredis/async.c.'>redisAsyncCommand</a>(slave-&gt;cc,
<a name='L2901'>                <a href='../S/82.html#L1584' title='Defined at 1584 in src/sentinel.c.'>sentinelDiscardReplyCallback</a>, NULL, "SLAVEOF %s %s",
<a name='L2902'>                    ri-&gt;addr-&gt;ip,
<a name='L2903'>                    master_port);
<a name='L2904'>            <b>if</b> (retval == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>)
<a name='L2905'>                <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"-slave-reconf-undo",slave,"%@");
<a name='L2906'>        <font color='red'>}</font>
<a name='L2907'>        slave-&gt;flags &amp;= ~(<a href='../S/82.html#L72' title='Defined at 72 in src/sentinel.c.'>SRI_RECONF_SENT</a>|<a href='../S/82.html#L73' title='Defined at 73 in src/sentinel.c.'>SRI_RECONF_INPROG</a>|<a href='../S/82.html#L74' title='Defined at 74 in src/sentinel.c.'>SRI_RECONF_DONE</a>);
<a name='L2908'>    <font color='red'>}</font>
<a name='L2909'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L2910'>
<a name='L2911'>    sentinel_role = (ri-&gt;flags &amp; <a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>) ? <a href='../S/82.html#L120' title='Defined at 120 in src/sentinel.c.'>SENTINEL_LEADER</a> :
<a name='L2912'>                                                        <a href='../S/82.html#L121' title='Defined at 121 in src/sentinel.c.'>SENTINEL_OBSERVER</a>;
<a name='L2913'>    ri-&gt;flags &amp;= ~(<a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>|<a href='../S/82.html#L70' title='Defined at 70 in src/sentinel.c.'>SRI_I_AM_THE_LEADER</a>|<a href='../S/82.html#L75' title='Defined at 75 in src/sentinel.c.'>SRI_FORCE_FAILOVER</a>);
<a name='L2914'>    ri-&gt;failover_state = <a href='../S/82.html#L102' title='Defined at 102 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_NONE</a>;
<a name='L2915'>    ri-&gt;failover_state_change_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L2916'>    <b>if</b> (ri-&gt;promoted_slave) <font color='red'>{</font>
<a name='L2917'>        <a href='../S/82.html#L787' title='Defined at 787 in src/sentinel.c.'>sentinelCallClientReconfScript</a>(ri,sentinel_role,"abort",
<a name='L2918'>            ri-&gt;promoted_slave-&gt;addr,ri-&gt;addr);
<a name='L2919'>        ri-&gt;promoted_slave-&gt;flags &amp;= ~<a href='../S/82.html#L71' title='Defined at 71 in src/sentinel.c.'>SRI_PROMOTED</a>;
<a name='L2920'>        ri-&gt;promoted_slave = NULL;
<a name='L2921'>    <font color='red'>}</font>
<a name='L2922'><font color='red'>}</font>
<a name='L2923'>
<a name='L2924'><i><font color='green'>/* The following is called only for master instances and will abort the</font></i>
<a name='L2925'><i><font color='green'> * failover process if:</font></i>
<a name='L2926'><i><font color='green'> *</font></i>
<a name='L2927'><i><font color='green'> * 1) The failover is in progress.</font></i>
<a name='L2928'><i><font color='green'> * 2) We already promoted a slave.</font></i>
<a name='L2929'><i><font color='green'> * 3) The promoted slave is in extended SDOWN condition.</font></i>
<a name='L2930'><i><font color='green'> */</font></i>
<a name='L2931'><b>void</b> <a href='../S/82.html#L2989' title='Refered from 2989 in src/sentinel.c.'>sentinelAbortFailoverIfNeeded</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2932'>    <i><font color='green'>/* Failover is in progress? Do we have a promoted slave? */</font></i>
<a name='L2933'>    <b>if</b> (!(ri-&gt;flags &amp; <a href='../S/82.html#L68' title='Defined at 68 in src/sentinel.c.'>SRI_FAILOVER_IN_PROGRESS</a>) || !ri-&gt;promoted_slave) <b>return</b>;
<a name='L2934'>
<a name='L2935'>    <i><font color='green'>/* Is the promoted slave into an extended SDOWN state? */</font></i>
<a name='L2936'>    <b>if</b> (!(ri-&gt;promoted_slave-&gt;flags &amp; <a href='../S/82.html#L59' title='Defined at 59 in src/sentinel.c.'>SRI_S_DOWN</a>) ||
<a name='L2937'>        (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>() - ri-&gt;promoted_slave-&gt;s_down_since_time) &lt;
<a name='L2938'>        (ri-&gt;down_after_period * <a href='../S/82.html#L93' title='Defined at 93 in src/sentinel.c.'>SENTINEL_EXTENDED_SDOWN_MULTIPLIER</a>)) <b>return</b>;
<a name='L2939'>
<a name='L2940'>    <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-failover-abort-x-sdown",ri-&gt;promoted_slave,"%@");
<a name='L2941'>    <a href='../S/82.html#L2877' title='Defined at 2877 in src/sentinel.c.'>sentinelAbortFailover</a>(ri);
<a name='L2942'><font color='red'>}</font>
<a name='L2943'>
<a name='L2944'><i><font color='green'>/* ======================== SENTINEL timer handler ==========================</font></i>
<a name='L2945'><i><font color='green'> * This is the "main" our Sentinel, being sentinel completely non blocking</font></i>
<a name='L2946'><i><font color='green'> * in design. The function is called every second.</font></i>
<a name='L2947'><i><font color='green'> * -------------------------------------------------------------------------- */</font></i>
<a name='L2948'>
<a name='L2949'><i><font color='green'>/* Perform scheduled operations for the specified Redis instance. */</font></i>
<a name='L2950'><b>void</b> <a href='../S/82.html#L3005' title='Refered from 3005 in src/sentinel.c.'>sentinelHandleRedisInstance</a>(sentinelRedisInstance *ri) <font color='red'>{</font>
<a name='L2951'>    <i><font color='green'>/* ========== MONITORING HALF ============ */</font></i>
<a name='L2952'>    <i><font color='green'>/* Every kind of instance */</font></i>
<a name='L2953'>    <a href='../S/82.html#L1292' title='Defined at 1292 in src/sentinel.c.'>sentinelReconnectInstance</a>(ri);
<a name='L2954'>    <a href='../S/82.html#L1716' title='Defined at 1716 in src/sentinel.c.'>sentinelPingInstance</a>(ri);
<a name='L2955'>
<a name='L2956'>    <i><font color='green'>/* Masters and slaves */</font></i>
<a name='L2957'>    <b>if</b> (ri-&gt;flags &amp; (<a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>|<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>)) <font color='red'>{</font>
<a name='L2958'>        <i><font color='green'>/* Nothing so far. */</font></i>
<a name='L2959'>    <font color='red'>}</font>
<a name='L2960'>
<a name='L2961'>    <i><font color='green'>/* Only masters */</font></i>
<a name='L2962'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <font color='red'>{</font>
<a name='L2963'>        <a href='../S/82.html#L2253' title='Defined at 2253 in src/sentinel.c.'>sentinelAskMasterStateToOtherSentinels</a>(ri);
<a name='L2964'>    <font color='red'>}</font>
<a name='L2965'>
<a name='L2966'>    <i><font color='green'>/* ============== ACTING HALF ============= */</font></i>
<a name='L2967'>    <i><font color='green'>/* We don't proceed with the acting half if we are in TILT mode.</font></i>
<a name='L2968'><i><font color='green'>     * TILT happens when we find something odd with the time, like a</font></i>
<a name='L2969'><i><font color='green'>     * sudden change in the clock. */</font></i>
<a name='L2970'>    <b>if</b> (<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt) <font color='red'>{</font>
<a name='L2971'>        <b>if</b> (<a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>()-<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt_start_time &lt; <a href='../S/82.html#L85' title='Defined at 85 in src/sentinel.c.'>SENTINEL_TILT_PERIOD</a>) <b>return</b>;
<a name='L2972'>        <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt = 0;
<a name='L2973'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"-tilt",NULL,"#tilt mode exited");
<a name='L2974'>    <font color='red'>}</font>
<a name='L2975'>
<a name='L2976'>    <i><font color='green'>/* Every kind of instance */</font></i>
<a name='L2977'>    <a href='../S/82.html#L2140' title='Defined at 2140 in src/sentinel.c.'>sentinelCheckSubjectivelyDown</a>(ri);
<a name='L2978'>
<a name='L2979'>    <i><font color='green'>/* Masters and slaves */</font></i>
<a name='L2980'>    <b>if</b> (ri-&gt;flags &amp; (<a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>|<a href='../S/82.html#L56' title='Defined at 56 in src/sentinel.c.'>SRI_SLAVE</a>)) <font color='red'>{</font>
<a name='L2981'>        <i><font color='green'>/* Nothing so far. */</font></i>
<a name='L2982'>    <font color='red'>}</font>
<a name='L2983'>
<a name='L2984'>    <i><font color='green'>/* Only masters */</font></i>
<a name='L2985'>    <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <font color='red'>{</font>
<a name='L2986'>        <a href='../S/82.html#L2186' title='Defined at 2186 in src/sentinel.c.'>sentinelCheckObjectivelyDown</a>(ri);
<a name='L2987'>        <a href='../S/82.html#L2473' title='Defined at 2473 in src/sentinel.c.'>sentinelStartFailoverIfNeeded</a>(ri);
<a name='L2988'>        <a href='../S/82.html#L2840' title='Defined at 2840 in src/sentinel.c.'>sentinelFailoverStateMachine</a>(ri);
<a name='L2989'>        <a href='../S/82.html#L2931' title='Defined at 2931 in src/sentinel.c.'>sentinelAbortFailoverIfNeeded</a>(ri);
<a name='L2990'>    <font color='red'>}</font>
<a name='L2991'><font color='red'>}</font>
<a name='L2992'>
<a name='L2993'><i><font color='green'>/* Perform scheduled operations for all the instances in the dictionary.</font></i>
<a name='L2994'><i><font color='green'> * Recursively call the function against dictionaries of slaves. */</font></i>
<a name='L2995'><b>void</b> <a href='../R/3693.html' title='Multiple refered from 3 places.'>sentinelHandleDictOfRedisInstances</a>(dict *instances) <font color='red'>{</font>
<a name='L2996'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di;
<a name='L2997'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L2998'>    <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *switch_to_promoted = NULL;
<a name='L2999'>
<a name='L3000'>    <i><font color='green'>/* There are a number of things we need to perform against every master. */</font></i>
<a name='L3001'>    di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(instances);
<a name='L3002'>    <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L3003'>        <a href='../D/4079.html' title='Multiple defined in 2 places.'>sentinelRedisInstance</a> *ri = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L3004'>
<a name='L3005'>        <a href='../S/82.html#L2950' title='Defined at 2950 in src/sentinel.c.'>sentinelHandleRedisInstance</a>(ri);
<a name='L3006'>        <b>if</b> (ri-&gt;flags &amp; <a href='../S/82.html#L55' title='Defined at 55 in src/sentinel.c.'>SRI_MASTER</a>) <font color='red'>{</font>
<a name='L3007'>            <a href='../S/82.html#L2995' title='Defined at 2995 in src/sentinel.c.'>sentinelHandleDictOfRedisInstances</a>(ri-&gt;slaves);
<a name='L3008'>            <a href='../S/82.html#L2995' title='Defined at 2995 in src/sentinel.c.'>sentinelHandleDictOfRedisInstances</a>(ri-&gt;sentinels);
<a name='L3009'>            <b>if</b> (ri-&gt;failover_state == <a href='../S/82.html#L112' title='Defined at 112 in src/sentinel.c.'>SENTINEL_FAILOVER_STATE_UPDATE_CONFIG</a>) <font color='red'>{</font>
<a name='L3010'>                switch_to_promoted = ri;
<a name='L3011'>            <font color='red'>}</font>
<a name='L3012'>        <font color='red'>}</font>
<a name='L3013'>    <font color='red'>}</font>
<a name='L3014'>    <b>if</b> (switch_to_promoted)
<a name='L3015'>        <a href='../S/82.html#L2829' title='Defined at 2829 in src/sentinel.c.'>sentinelFailoverSwitchToPromotedSlave</a>(switch_to_promoted);
<a name='L3016'>    <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L3017'><font color='red'>}</font>
<a name='L3018'>
<a name='L3019'><i><font color='green'>/* This function checks if we need to enter the TITL mode.</font></i>
<a name='L3020'><i><font color='green'> *</font></i>
<a name='L3021'><i><font color='green'> * The TILT mode is entered if we detect that between two invocations of the</font></i>
<a name='L3022'><i><font color='green'> * timer interrupt, a negative amount of time, or too much time has passed.</font></i>
<a name='L3023'><i><font color='green'> * Note that we expect that more or less just 100 milliseconds will pass</font></i>
<a name='L3024'><i><font color='green'> * if everything is fine. However we'll see a negative number or a</font></i>
<a name='L3025'><i><font color='green'> * difference bigger than SENTINEL_TILT_TRIGGER milliseconds if one of the</font></i>
<a name='L3026'><i><font color='green'> * following conditions happen:</font></i>
<a name='L3027'><i><font color='green'> *</font></i>
<a name='L3028'><i><font color='green'> * 1) The Sentiel process for some time is blocked, for every kind of</font></i>
<a name='L3029'><i><font color='green'> * random reason: the load is huge, the computer was freezed for some time</font></i>
<a name='L3030'><i><font color='green'> * in I/O or alike, the process was stopped by a signal. Everything.</font></i>
<a name='L3031'><i><font color='green'> * 2) The system clock was altered significantly.</font></i>
<a name='L3032'><i><font color='green'> *</font></i>
<a name='L3033'><i><font color='green'> * Under both this conditions we'll see everything as timed out and failing</font></i>
<a name='L3034'><i><font color='green'> * without good reasons. Instead we enter the TILT mode and wait</font></i>
<a name='L3035'><i><font color='green'> * for SENTIENL_TILT_PERIOD to elapse before starting to act again.</font></i>
<a name='L3036'><i><font color='green'> *</font></i>
<a name='L3037'><i><font color='green'> * During TILT time we still collect information, we just do not act. */</font></i>
<a name='L3038'><b>void</b> <a href='../S/82.html#L3051' title='Refered from 3051 in src/sentinel.c.'>sentinelCheckTiltCondition</a>(<b>void</b>) <font color='red'>{</font>
<a name='L3039'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> now = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L3040'>    <a href='../S/82.html#L46' title='Defined at 46 in src/sentinel.c.'>mstime_t</a> delta = now - <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.previous_time;
<a name='L3041'>
<a name='L3042'>    <b>if</b> (delta &lt; 0 || delta &gt; <a href='../S/82.html#L84' title='Defined at 84 in src/sentinel.c.'>SENTINEL_TILT_TRIGGER</a>) <font color='red'>{</font>
<a name='L3043'>        <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt = 1;
<a name='L3044'>        <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.tilt_start_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L3045'>        <a href='../S/82.html#L469' title='Defined at 469 in src/sentinel.c.'>sentinelEvent</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"+tilt",NULL,"#tilt mode entered");
<a name='L3046'>    <font color='red'>}</font>
<a name='L3047'>    <a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.previous_time = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L3048'><font color='red'>}</font>
<a name='L3049'>
<a name='L3050'><b>void</b> <a href='../R/3724.html' title='Multiple refered from 2 places.'>sentinelTimer</a>(<b>void</b>) <font color='red'>{</font>
<a name='L3051'>    <a href='../S/82.html#L3038' title='Defined at 3038 in src/sentinel.c.'>sentinelCheckTiltCondition</a>();
<a name='L3052'>    <a href='../S/82.html#L2995' title='Defined at 2995 in src/sentinel.c.'>sentinelHandleDictOfRedisInstances</a>(<a href='../S/279.html#L448' title='Defined at 448 in deps/lua/src/loadlib.c.'>sentinel</a>.masters);
<a name='L3053'>    <a href='../S/82.html#L602' title='Defined at 602 in src/sentinel.c.'>sentinelRunPendingScripts</a>();
<a name='L3054'>    <a href='../S/82.html#L666' title='Defined at 666 in src/sentinel.c.'>sentinelCollectTerminatedScripts</a>();
<a name='L3055'>    <a href='../S/82.html#L713' title='Defined at 713 in src/sentinel.c.'>sentinelKillTimedoutScripts</a>();
<a name='L3056'><font color='red'>}</font>
<a name='L3057'>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L229'>[^]</a><a href='#L3050'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
