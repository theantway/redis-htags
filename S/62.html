<html>
<head>
<title>src/aof.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/401.html'>src</a>/aof.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L1038'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L68' title='Defined at 68.'>aofRewriteBufferReset</a>
<li><a href='#L77' title='Defined at 77.'>aofRewriteBufferSize</a>
<li><a href='#L89' title='Defined at 89.'>aofRewriteBufferAppend</a>
<li><a href='#L131' title='Defined at 131.'>aofRewriteBufferWrite</a>
<li><a href='#L159' title='Defined at 159.'>aof_background_fsync</a>
<li><a href='#L165' title='Defined at 165.'>stopAppendOnly</a>
<li><a href='#L192' title='Defined at 192.'>startAppendOnly</a>
<li><a href='#L229' title='Defined at 229.'>flushAppendOnlyFile</a>
<li><a href='#L322' title='Defined at 322.'>catAppendOnlyGenericCommand</a>
<li><a href='#L354' title='Defined at 354.'>catAppendOnlyExpireAtCommand</a>
<li><a href='#L384' title='Defined at 384.'>feedAppendOnlyFile</a>
<li><a href='#L440' title='Defined at 440.'>createFakeClient</a>
<li><a href='#L464' title='Defined at 464.'>freeFakeClient</a>
<li><a href='#L475' title='Defined at 475.'>loadAppendOnlyFile</a>
<li><a href='#L588' title='Defined at 588.'>rioWriteBulkObject</a>
<li><a href='#L602' title='Defined at 602.'>rewriteListObject</a>
<li><a href='#L659' title='Defined at 659.'>rewriteSetObject</a>
<li><a href='#L706' title='Defined at 706.'>rewriteSortedSetObject</a>
<li><a href='#L779' title='Defined at 779.'>rioWriteHashIteratorCursor</a>
<li><a href='#L805' title='Defined at 805.'>rewriteHashObject</a>
<li><a href='#L838' title='Defined at 838.'>rewriteAppendOnlyFile</a>
<li><a href='#L951' title='Defined at 951.'>rewriteAppendOnlyFileBackground</a>
<li><a href='#L1001' title='Defined at 1001.'>bgrewriteaofCommand</a>
<li><a href='#L1014' title='Defined at 1014.'>aofRemoveTempFile</a>
<li><a href='#L1025' title='Defined at 1025.'>aofUpdateCurrentSize</a>
<li><a href='#L1038' title='Defined at 1038.'>backgroundRewriteDoneHandler</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/*</font></i>
<a name='L2'><i><font color='green'> * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</font></i>
<a name='L3'><i><font color='green'> * All rights reserved.</font></i>
<a name='L4'><i><font color='green'> *</font></i>
<a name='L5'><i><font color='green'> * Redistribution and use in source and binary forms, with or without</font></i>
<a name='L6'><i><font color='green'> * modification, are permitted provided that the following conditions are met:</font></i>
<a name='L7'><i><font color='green'> *</font></i>
<a name='L8'><i><font color='green'> *   * Redistributions of source code must retain the above copyright notice,</font></i>
<a name='L9'><i><font color='green'> *     this list of conditions and the following disclaimer.</font></i>
<a name='L10'><i><font color='green'> *   * Redistributions in binary form must reproduce the above copyright</font></i>
<a name='L11'><i><font color='green'> *     notice, this list of conditions and the following disclaimer in the</font></i>
<a name='L12'><i><font color='green'> *     documentation and/or other materials provided with the distribution.</font></i>
<a name='L13'><i><font color='green'> *   * Neither the name of Redis nor the names of its contributors may be used</font></i>
<a name='L14'><i><font color='green'> *     to endorse or promote products derived from this software without</font></i>
<a name='L15'><i><font color='green'> *     specific prior written permission.</font></i>
<a name='L16'><i><font color='green'> *</font></i>
<a name='L17'><i><font color='green'> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</font></i>
<a name='L18'><i><font color='green'> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</font></i>
<a name='L19'><i><font color='green'> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</font></i>
<a name='L20'><i><font color='green'> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</font></i>
<a name='L21'><i><font color='green'> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</font></i>
<a name='L22'><i><font color='green'> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</font></i>
<a name='L23'><i><font color='green'> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</font></i>
<a name='L24'><i><font color='green'> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</font></i>
<a name='L25'><i><font color='green'> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</font></i>
<a name='L26'><i><font color='green'> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</font></i>
<a name='L27'><i><font color='green'> * POSSIBILITY OF SUCH DAMAGE.</font></i>
<a name='L28'><i><font color='green'> */</font></i>
<a name='L29'>
<a name='L30'><font color='darkred'>#include</font> "<a href='32.html'>redis.h</a>"
<a name='L31'><font color='darkred'>#include</font> "<a href='68.html'>bio.h</a>"
<a name='L32'><font color='darkred'>#include</font> "<a href='65.html'>rio.h</a>"
<a name='L33'>
<a name='L34'><font color='darkred'>#include</font> &lt;signal.h&gt;
<a name='L35'><font color='darkred'>#include</font> &lt;fcntl.h&gt;
<a name='L36'><font color='darkred'>#include</font> &lt;sys/stat.h&gt;
<a name='L37'><font color='darkred'>#include</font> &lt;sys/types.h&gt;
<a name='L38'><font color='darkred'>#include</font> &lt;sys/time.h&gt;
<a name='L39'><font color='darkred'>#include</font> &lt;sys/resource.h&gt;
<a name='L40'><font color='darkred'>#include</font> &lt;sys/wait.h&gt;
<a name='L41'>
<a name='L42'><b>void</b> <a href='../S/62.html#L1025' title='Defined at 1025 in src/aof.c.'>aofUpdateCurrentSize</a>(<b>void</b>);
<a name='L43'>
<a name='L44'><i><font color='green'>/* ----------------------------------------------------------------------------</font></i>
<a name='L45'><i><font color='green'> * AOF rewrite buffer implementation.</font></i>
<a name='L46'><i><font color='green'> *</font></i>
<a name='L47'><i><font color='green'> * The following code implement a simple buffer used in order to accumulate</font></i>
<a name='L48'><i><font color='green'> * changes while the background process is rewriting the AOF file.</font></i>
<a name='L49'><i><font color='green'> *</font></i>
<a name='L50'><i><font color='green'> * We only need to append, but can't just use realloc with a large block</font></i>
<a name='L51'><i><font color='green'> * because 'huge' reallocs are not always handled as one could expect</font></i>
<a name='L52'><i><font color='green'> * (via remapping of pages at OS level) but may involve copying data.</font></i>
<a name='L53'><i><font color='green'> *</font></i>
<a name='L54'><i><font color='green'> * For this reason we use a list of blocks, every block is</font></i>
<a name='L55'><i><font color='green'> * AOF_RW_BUF_BLOCK_SIZE bytes.</font></i>
<a name='L56'><i><font color='green'> * ------------------------------------------------------------------------- */</font></i>
<a name='L57'>
<a name='L58'><font color='darkred'>#define</font> <a href='../R/27.html' title='Multiple refered from 3 places.'>AOF_RW_BUF_BLOCK_SIZE</a> (1024*1024*10)    <i><font color='green'>/* 10 MB per block */</font></i>
<a name='L59'>
<a name='L60'><b>typedef</b> <b>struct</b> <a href='../R/1294.html' title='Multiple refered from 3 places.'>aofrwblock</a> <font color='red'>{</font>
<a name='L61'>    <b>unsigned</b> <b>long</b> used, <a href='../D/2271.html' title='Multiple defined in 2 places.'>free</a>;
<a name='L62'>    <b>char</b> buf[<a href='../S/62.html#L58' title='Defined at 58 in src/aof.c.'>AOF_RW_BUF_BLOCK_SIZE</a>];
<a name='L63'><font color='red'>}</font> <a href='../R/1294.html' title='Multiple refered from 3 places.'>aofrwblock</a>;
<a name='L64'>
<a name='L65'><i><font color='green'>/* This function free the old AOF rewrite buffer if needed, and initialize</font></i>
<a name='L66'><i><font color='green'> * a fresh new one. It tests for server.aof_rewrite_buf_blocks equal to NULL</font></i>
<a name='L67'><i><font color='green'> * so can be used for the first initialization as well. */</font></i>
<a name='L68'><b>void</b> <a href='../R/1288.html' title='Multiple refered from 4 places.'>aofRewriteBufferReset</a>(<b>void</b>) <font color='red'>{</font>
<a name='L69'>    <b>if</b> (server.aof_rewrite_buf_blocks)
<a name='L70'>        <a href='../S/54.html#L58' title='Defined at 58 in src/adlist.c.'>listRelease</a>(server.aof_rewrite_buf_blocks);
<a name='L71'>
<a name='L72'>    server.aof_rewrite_buf_blocks = <a href='../S/54.html#L41' title='Defined at 41 in src/adlist.c.'>listCreate</a>();
<a name='L73'>    <a href='../S/58.html#L65' title='Defined at 65 in src/adlist.h.'>listSetFreeMethod</a>(server.aof_rewrite_buf_blocks,<a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>);
<a name='L74'><font color='red'>}</font>
<a name='L75'>
<a name='L76'><i><font color='green'>/* Return the current size of the AOF rerwite buffer. */</font></i>
<a name='L77'><b>unsigned</b> <b>long</b> <a href='../R/1289.html' title='Multiple refered from 5 places.'>aofRewriteBufferSize</a>(<b>void</b>) <font color='red'>{</font>
<a name='L78'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln = <a href='../S/58.html#L59' title='Defined at 59 in src/adlist.h.'>listLast</a>(server.aof_rewrite_buf_blocks);
<a name='L79'>    <a href='../D/1558.html' title='Multiple defined in 2 places.'>aofrwblock</a> *<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a> = ln ? ln-&gt;value : NULL;
<a name='L80'>
<a name='L81'>    <b>if</b> (<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a> == NULL) <b>return</b> 0;
<a name='L82'>    <b>unsigned</b> <b>long</b> size =
<a name='L83'>        (<a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(server.aof_rewrite_buf_blocks)-1) * <a href='../S/62.html#L58' title='Defined at 58 in src/aof.c.'>AOF_RW_BUF_BLOCK_SIZE</a>;
<a name='L84'>    size += <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used;
<a name='L85'>    <b>return</b> size;
<a name='L86'><font color='red'>}</font>
<a name='L87'>
<a name='L88'><i><font color='green'>/* Append data to the AOF rewrite buffer, allocating new blocks if needed. */</font></i>
<a name='L89'><b>void</b> <a href='../S/62.html#L429' title='Refered from 429 in src/aof.c.'>aofRewriteBufferAppend</a>(<b>unsigned</b> <b>char</b> *s, <b>unsigned</b> <b>long</b> len) <font color='red'>{</font>
<a name='L90'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln = <a href='../S/58.html#L59' title='Defined at 59 in src/adlist.h.'>listLast</a>(server.aof_rewrite_buf_blocks);
<a name='L91'>    <a href='../D/1558.html' title='Multiple defined in 2 places.'>aofrwblock</a> *<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a> = ln ? ln-&gt;value : NULL;
<a name='L92'>
<a name='L93'>    <b>while</b>(len) <font color='red'>{</font>
<a name='L94'>        <i><font color='green'>/* If we already got at least an allocated block, try appending</font></i>
<a name='L95'><i><font color='green'>         * at least some piece into it. */</font></i>
<a name='L96'>        <b>if</b> (<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>) <font color='red'>{</font>
<a name='L97'>            <b>unsigned</b> <b>long</b> thislen = (<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;<a href='../D/2271.html' title='Multiple defined in 2 places.'>free</a> &lt; len) ? <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;<a href='../D/2271.html' title='Multiple defined in 2 places.'>free</a> : len;
<a name='L98'>            <b>if</b> (thislen) <font color='red'>{</font>  <i><font color='green'>/* The current block is not already full. */</font></i>
<a name='L99'>                memcpy(<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;buf+<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used, s, thislen);
<a name='L100'>                <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used += thislen;
<a name='L101'>                <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;<a href='../D/2271.html' title='Multiple defined in 2 places.'>free</a> -= thislen;
<a name='L102'>                s += thislen;
<a name='L103'>                len -= thislen;
<a name='L104'>            <font color='red'>}</font>
<a name='L105'>        <font color='red'>}</font>
<a name='L106'>
<a name='L107'>        <b>if</b> (len) <font color='red'>{</font> <i><font color='green'>/* First block to allocate, or need another block. */</font></i>
<a name='L108'>            <b>int</b> numblocks;
<a name='L109'>
<a name='L110'>            <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a> = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>));
<a name='L111'>            <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;<a href='../D/2271.html' title='Multiple defined in 2 places.'>free</a> = <a href='../S/62.html#L58' title='Defined at 58 in src/aof.c.'>AOF_RW_BUF_BLOCK_SIZE</a>;
<a name='L112'>            <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used = 0;
<a name='L113'>            <a href='../S/54.html#L106' title='Defined at 106 in src/adlist.c.'>listAddNodeTail</a>(server.aof_rewrite_buf_blocks,<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>);
<a name='L114'>
<a name='L115'>            <i><font color='green'>/* Log every time we cross more 10 or 100 blocks, respectively</font></i>
<a name='L116'><i><font color='green'>             * as a notice or warning. */</font></i>
<a name='L117'>            numblocks = <a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(server.aof_rewrite_buf_blocks);
<a name='L118'>            <b>if</b> (((numblocks+1) % 10) == 0) <font color='red'>{</font>
<a name='L119'>                <b>int</b> level = ((numblocks+1) % 100) == 0 ? <a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a> :
<a name='L120'>                                                         <a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>;
<a name='L121'>                <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(level,"Background AOF buffer size: %lu MB",
<a name='L122'>                    <a href='../S/62.html#L77' title='Defined at 77 in src/aof.c.'>aofRewriteBufferSize</a>()/(1024*1024));
<a name='L123'>            <font color='red'>}</font>
<a name='L124'>        <font color='red'>}</font>
<a name='L125'>    <font color='red'>}</font>
<a name='L126'><font color='red'>}</font>
<a name='L127'>
<a name='L128'><i><font color='green'>/* Write the buffer (possibly composed of multiple blocks) into the specified</font></i>
<a name='L129'><i><font color='green'> * fd. If no short write or any other error happens -1 is returned,</font></i>
<a name='L130'><i><font color='green'> * otherwise the number of bytes written is returned. */</font></i>
<a name='L131'>ssize_t <a href='../S/62.html#L1058' title='Refered from 1058 in src/aof.c.'>aofRewriteBufferWrite</a>(<b>int</b> fd) <font color='red'>{</font>
<a name='L132'>    <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L133'>    <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L134'>    ssize_t count = 0;
<a name='L135'>
<a name='L136'>    <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(server.aof_rewrite_buf_blocks,&amp;li);
<a name='L137'>    <b>while</b>((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li))) <font color='red'>{</font>
<a name='L138'>        <a href='../D/1558.html' title='Multiple defined in 2 places.'>aofrwblock</a> *<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a> = <a href='../S/58.html#L62' title='Defined at 62 in src/adlist.h.'>listNodeValue</a>(ln);
<a name='L139'>        ssize_t nwritten;
<a name='L140'>
<a name='L141'>        <b>if</b> (<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used) <font color='red'>{</font>
<a name='L142'>            nwritten = write(fd,<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;buf,<a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used);
<a name='L143'>            <b>if</b> (nwritten != <a href='../S/304.html#L881' title='Defined at 881 in deps/lua/src/lparser.c.'>block</a>-&gt;used) <font color='red'>{</font>
<a name='L144'>                <b>if</b> (nwritten == 0) errno = EIO;
<a name='L145'>                <b>return</b> -1;
<a name='L146'>            <font color='red'>}</font>
<a name='L147'>            count += nwritten;
<a name='L148'>        <font color='red'>}</font>
<a name='L149'>    <font color='red'>}</font>
<a name='L150'>    <b>return</b> count;
<a name='L151'><font color='red'>}</font>
<a name='L152'>
<a name='L153'><i><font color='green'>/* ----------------------------------------------------------------------------</font></i>
<a name='L154'><i><font color='green'> * AOF file implementation</font></i>
<a name='L155'><i><font color='green'> * ------------------------------------------------------------------------- */</font></i>
<a name='L156'>
<a name='L157'><i><font color='green'>/* Starts a background task that performs fsync() against the specified</font></i>
<a name='L158'><i><font color='green'> * file descriptor (the one of the AOF file) in another thread. */</font></i>
<a name='L159'><b>void</b> <a href='../R/1292.html' title='Multiple refered from 2 places.'>aof_background_fsync</a>(<b>int</b> fd) <font color='red'>{</font>
<a name='L160'>    <a href='../S/25.html#L124' title='Defined at 124 in src/bio.c.'>bioCreateBackgroundJob</a>(<a href='../S/68.html#L39' title='Defined at 39 in src/bio.h.'>REDIS_BIO_AOF_FSYNC</a>,(<b>void</b>*)(<b>long</b>)fd,NULL,NULL);
<a name='L161'><font color='red'>}</font>
<a name='L162'>
<a name='L163'><i><font color='green'>/* Called when the user switches from "appendonly yes" to "appendonly no"</font></i>
<a name='L164'><i><font color='green'> * at runtime using the CONFIG command. */</font></i>
<a name='L165'><b>void</b> <a href='../R/3846.html' title='Multiple refered from 3 places.'>stopAppendOnly</a>(<b>void</b>) <font color='red'>{</font>
<a name='L166'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(server.aof_state != <a href='../S/32.html#L167' title='Defined at 167 in src/redis.h.'>REDIS_AOF_OFF</a>);
<a name='L167'>    <a href='../S/62.html#L229' title='Defined at 229 in src/aof.c.'>flushAppendOnlyFile</a>(1);
<a name='L168'>    <a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a>(server.aof_fd);
<a name='L169'>    close(server.aof_fd);
<a name='L170'>
<a name='L171'>    server.aof_fd = -1;
<a name='L172'>    server.aof_selected_db = -1;
<a name='L173'>    server.aof_state = <a href='../S/32.html#L167' title='Defined at 167 in src/redis.h.'>REDIS_AOF_OFF</a>;
<a name='L174'>    <i><font color='green'>/* rewrite operation in progress? kill it, wait child exit */</font></i>
<a name='L175'>    <b>if</b> (server.aof_child_pid != -1) <font color='red'>{</font>
<a name='L176'>        <b>int</b> statloc;
<a name='L177'>
<a name='L178'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"Killing running AOF rewrite child: %ld",
<a name='L179'>            (<b>long</b>) server.aof_child_pid);
<a name='L180'>        <b>if</b> (kill(server.aof_child_pid,SIGKILL) != -1)
<a name='L181'>            wait3(&amp;statloc,0,NULL);
<a name='L182'>        <i><font color='green'>/* reset the buffer accumulating changes while the child saves */</font></i>
<a name='L183'>        <a href='../S/62.html#L68' title='Defined at 68 in src/aof.c.'>aofRewriteBufferReset</a>();
<a name='L184'>        <a href='../S/62.html#L1014' title='Defined at 1014 in src/aof.c.'>aofRemoveTempFile</a>(server.aof_child_pid);
<a name='L185'>        server.aof_child_pid = -1;
<a name='L186'>        server.aof_rewrite_time_start = -1;
<a name='L187'>    <font color='red'>}</font>
<a name='L188'><font color='red'>}</font>
<a name='L189'>
<a name='L190'><i><font color='green'>/* Called when the user switches from "appendonly no" to "appendonly yes"</font></i>
<a name='L191'><i><font color='green'> * at runtime using the CONFIG command. */</font></i>
<a name='L192'><b>int</b> <a href='../R/3830.html' title='Multiple refered from 3 places.'>startAppendOnly</a>(<b>void</b>) <font color='red'>{</font>
<a name='L193'>    server.aof_last_fsync = server.unixtime;
<a name='L194'>    server.aof_fd = open(server.aof_filename,O_WRONLY|O_APPEND|O_CREAT,0644);
<a name='L195'>    <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(server.aof_state == <a href='../S/32.html#L167' title='Defined at 167 in src/redis.h.'>REDIS_AOF_OFF</a>);
<a name='L196'>    <b>if</b> (server.aof_fd == -1) <font color='red'>{</font>
<a name='L197'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Redis needs to enable the AOF but can't open the append only file: %s",strerror(errno));
<a name='L198'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L199'>    <font color='red'>}</font>
<a name='L200'>    <b>if</b> (<a href='../S/62.html#L951' title='Defined at 951 in src/aof.c.'>rewriteAppendOnlyFileBackground</a>() == <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>) <font color='red'>{</font>
<a name='L201'>        close(server.aof_fd);
<a name='L202'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Redis needs to enable the AOF but can't trigger a background AOF rewrite operation. Check the above logs for more info about the error.");
<a name='L203'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L204'>    <font color='red'>}</font>
<a name='L205'>    <i><font color='green'>/* We correctly switched on AOF, now wait for the rerwite to be complete</font></i>
<a name='L206'><i><font color='green'>     * in order to append data on disk. */</font></i>
<a name='L207'>    server.aof_state = <a href='../S/32.html#L169' title='Defined at 169 in src/redis.h.'>REDIS_AOF_WAIT_REWRITE</a>;
<a name='L208'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L209'><font color='red'>}</font>
<a name='L210'>
<a name='L211'><i><font color='green'>/* Write the append only file buffer on disk.</font></i>
<a name='L212'><i><font color='green'> *</font></i>
<a name='L213'><i><font color='green'> * Since we are required to write the AOF before replying to the client,</font></i>
<a name='L214'><i><font color='green'> * and the only way the client socket can get a write is entering when the</font></i>
<a name='L215'><i><font color='green'> * the event loop, we accumulate all the AOF writes in a memory</font></i>
<a name='L216'><i><font color='green'> * buffer and write it on disk using this function just before entering</font></i>
<a name='L217'><i><font color='green'> * the event loop again.</font></i>
<a name='L218'><i><font color='green'> *</font></i>
<a name='L219'><i><font color='green'> * About the 'force' argument:</font></i>
<a name='L220'><i><font color='green'> *</font></i>
<a name='L221'><i><font color='green'> * When the fsync policy is set to 'everysec' we may delay the flush if there</font></i>
<a name='L222'><i><font color='green'> * is still an fsync() going on in the background thread, since for instance</font></i>
<a name='L223'><i><font color='green'> * on Linux write(2) will be blocked by the background fsync anyway.</font></i>
<a name='L224'><i><font color='green'> * When this happens we remember that there is some aof buffer to be</font></i>
<a name='L225'><i><font color='green'> * flushed ASAP, and will try to do that in the serverCron() function.</font></i>
<a name='L226'><i><font color='green'> *</font></i>
<a name='L227'><i><font color='green'> * However if force is set to 1 we'll write regardless of the background</font></i>
<a name='L228'><i><font color='green'> * fsync. */</font></i>
<a name='L229'><b>void</b> <a href='../R/1981.html' title='Multiple refered from 4 places.'>flushAppendOnlyFile</a>(<b>int</b> force) <font color='red'>{</font>
<a name='L230'>    ssize_t nwritten;
<a name='L231'>    <b>int</b> sync_in_progress = 0;
<a name='L232'>
<a name='L233'>    <b>if</b> (<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(server.aof_buf) == 0) <b>return</b>;
<a name='L234'>
<a name='L235'>    <b>if</b> (server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L244' title='Defined at 244 in src/redis.h.'>AOF_FSYNC_EVERYSEC</a>)
<a name='L236'>        sync_in_progress = <a href='../S/25.html#L187' title='Defined at 187 in src/bio.c.'>bioPendingJobsOfType</a>(<a href='../S/68.html#L39' title='Defined at 39 in src/bio.h.'>REDIS_BIO_AOF_FSYNC</a>) != 0;
<a name='L237'>
<a name='L238'>    <b>if</b> (server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L244' title='Defined at 244 in src/redis.h.'>AOF_FSYNC_EVERYSEC</a> &amp;&amp; !force) <font color='red'>{</font>
<a name='L239'>        <i><font color='green'>/* With this append fsync policy we do background fsyncing.</font></i>
<a name='L240'><i><font color='green'>         * If the fsync is still in progress we can try to delay</font></i>
<a name='L241'><i><font color='green'>         * the write for a couple of seconds. */</font></i>
<a name='L242'>        <b>if</b> (sync_in_progress) <font color='red'>{</font>
<a name='L243'>            <b>if</b> (server.aof_flush_postponed_start == 0) <font color='red'>{</font>
<a name='L244'>                <i><font color='green'>/* No previous write postponinig, remember that we are</font></i>
<a name='L245'><i><font color='green'>                 * postponing the flush and return. */</font></i>
<a name='L246'>                server.aof_flush_postponed_start = server.unixtime;
<a name='L247'>                <b>return</b>;
<a name='L248'>            <font color='red'>}</font> <b>else</b> <b>if</b> (server.unixtime - server.aof_flush_postponed_start &lt; 2) <font color='red'>{</font>
<a name='L249'>                <i><font color='green'>/* We were already waiting for fsync to finish, but for less</font></i>
<a name='L250'><i><font color='green'>                 * than two seconds this is still ok. Postpone again. */</font></i>
<a name='L251'>                <b>return</b>;
<a name='L252'>            <font color='red'>}</font>
<a name='L253'>            <i><font color='green'>/* Otherwise fall trough, and go write since we can't wait</font></i>
<a name='L254'><i><font color='green'>             * over two seconds. */</font></i>
<a name='L255'>            server.aof_delayed_fsync++;
<a name='L256'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.");
<a name='L257'>        <font color='red'>}</font>
<a name='L258'>    <font color='red'>}</font>
<a name='L259'>    <i><font color='green'>/* If you are following this code path, then we are going to write so</font></i>
<a name='L260'><i><font color='green'>     * set reset the postponed flush sentinel to zero. */</font></i>
<a name='L261'>    server.aof_flush_postponed_start = 0;
<a name='L262'>
<a name='L263'>    <i><font color='green'>/* We want to perform a single write. This should be guaranteed atomic</font></i>
<a name='L264'><i><font color='green'>     * at least if the filesystem we are writing is a real physical one.</font></i>
<a name='L265'><i><font color='green'>     * While this will save us against the server being killed I don't think</font></i>
<a name='L266'><i><font color='green'>     * there is much to do about the whole server stopping for power problems</font></i>
<a name='L267'><i><font color='green'>     * or alike */</font></i>
<a name='L268'>    nwritten = write(server.aof_fd,server.aof_buf,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(server.aof_buf));
<a name='L269'>    <b>if</b> (nwritten != (<b>signed</b>)<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(server.aof_buf)) <font color='red'>{</font>
<a name='L270'>        <i><font color='green'>/* Ooops, we are in troubles. The best thing to do for now is</font></i>
<a name='L271'><i><font color='green'>         * aborting instead of giving the illusion that everything is</font></i>
<a name='L272'><i><font color='green'>         * working as expected. */</font></i>
<a name='L273'>        <b>if</b> (nwritten == -1) <font color='red'>{</font>
<a name='L274'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Exiting on error writing to the append-only file: %s",strerror(errno));
<a name='L275'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L276'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Exiting on short write while writing to "
<a name='L277'>                                   "the append-only file: %s (nwritten=%ld, "
<a name='L278'>                                   "expected=%ld)",
<a name='L279'>                                   strerror(errno),
<a name='L280'>                                   (<b>long</b>)nwritten,
<a name='L281'>                                   (<b>long</b>)<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(server.aof_buf));
<a name='L282'>
<a name='L283'>            <b>if</b> (ftruncate(server.aof_fd, server.aof_current_size) == -1) <font color='red'>{</font>
<a name='L284'>                <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>, "Could not remove short write "
<a name='L285'>                         "from the append-only file.  Redis may refuse "
<a name='L286'>                         "to load the AOF the next time it starts.  "
<a name='L287'>                         "ftruncate: %s", strerror(errno));
<a name='L288'>            <font color='red'>}</font>
<a name='L289'>        <font color='red'>}</font>
<a name='L290'>        exit(1);
<a name='L291'>    <font color='red'>}</font>
<a name='L292'>    server.aof_current_size += nwritten;
<a name='L293'>
<a name='L294'>    <i><font color='green'>/* Re-use AOF buffer when it is small enough. The maximum comes from the</font></i>
<a name='L295'><i><font color='green'>     * arena size of 4k minus some overhead (but is otherwise arbitrary). */</font></i>
<a name='L296'>    <b>if</b> ((<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(server.aof_buf)+<a href='../D/3993.html' title='Multiple defined in 2 places.'>sdsavail</a>(server.aof_buf)) &lt; 4000) <font color='red'>{</font>
<a name='L297'>        <a href='../S/63.html#L81' title='Defined at 81 in src/sds.c.'>sdsclear</a>(server.aof_buf);
<a name='L298'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L299'>        <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(server.aof_buf);
<a name='L300'>        server.aof_buf = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L301'>    <font color='red'>}</font>
<a name='L302'>
<a name='L303'>    <i><font color='green'>/* Don't fsync if no-appendfsync-on-rewrite is set to yes and there are</font></i>
<a name='L304'><i><font color='green'>     * children doing I/O in the background. */</font></i>
<a name='L305'>    <b>if</b> (server.aof_no_fsync_on_rewrite &amp;&amp;
<a name='L306'>        (server.aof_child_pid != -1 || server.rdb_child_pid != -1))
<a name='L307'>            <b>return</b>;
<a name='L308'>
<a name='L309'>    <i><font color='green'>/* Perform the fsync if needed. */</font></i>
<a name='L310'>    <b>if</b> (server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L243' title='Defined at 243 in src/redis.h.'>AOF_FSYNC_ALWAYS</a>) <font color='red'>{</font>
<a name='L311'>        <i><font color='green'>/* aof_fsync is defined as fdatasync() for Linux in order to avoid</font></i>
<a name='L312'><i><font color='green'>         * flushing metadata. */</font></i>
<a name='L313'>        <a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a>(server.aof_fd); <i><font color='green'>/* Let's try to get this data on the disk */</font></i>
<a name='L314'>        server.aof_last_fsync = server.unixtime;
<a name='L315'>    <font color='red'>}</font> <b>else</b> <b>if</b> ((server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L244' title='Defined at 244 in src/redis.h.'>AOF_FSYNC_EVERYSEC</a> &amp;&amp;
<a name='L316'>                server.unixtime &gt; server.aof_last_fsync)) <font color='red'>{</font>
<a name='L317'>        <b>if</b> (!sync_in_progress) <a href='../S/62.html#L159' title='Defined at 159 in src/aof.c.'>aof_background_fsync</a>(server.aof_fd);
<a name='L318'>        server.aof_last_fsync = server.unixtime;
<a name='L319'>    <font color='red'>}</font>
<a name='L320'><font color='red'>}</font>
<a name='L321'>
<a name='L322'><a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> <a href='../R/1533.html' title='Multiple refered from 3 places.'>catAppendOnlyGenericCommand</a>(sds dst, <b>int</b> argc, robj **argv) <font color='red'>{</font>
<a name='L323'>    <b>char</b> buf[32];
<a name='L324'>    <b>int</b> len, j;
<a name='L325'>    <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *o;
<a name='L326'>
<a name='L327'>    buf[0] = '*';
<a name='L328'>    len = 1+<a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(buf+1,<b>sizeof</b>(buf)-1,argc);
<a name='L329'>    buf[len++] = '\r';
<a name='L330'>    buf[len++] = '\n';
<a name='L331'>    dst = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(dst,buf,len);
<a name='L332'>
<a name='L333'>    <b>for</b> (j = 0; j &lt; argc; j++) <font color='red'>{</font>
<a name='L334'>        o = <a href='../S/71.html#L312' title='Defined at 312 in src/object.c.'>getDecodedObject</a>(argv[j]);
<a name='L335'>        buf[0] = '$';
<a name='L336'>        len = 1+<a href='../S/74.html#L220' title='Defined at 220 in src/util.c.'>ll2string</a>(buf+1,<b>sizeof</b>(buf)-1,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(o-&gt;ptr));
<a name='L337'>        buf[len++] = '\r';
<a name='L338'>        buf[len++] = '\n';
<a name='L339'>        dst = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(dst,buf,len);
<a name='L340'>        dst = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(dst,o-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(o-&gt;ptr));
<a name='L341'>        dst = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(dst,"\r\n",2);
<a name='L342'>        <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(o);
<a name='L343'>    <font color='red'>}</font>
<a name='L344'>    <b>return</b> dst;
<a name='L345'><font color='red'>}</font>
<a name='L346'>
<a name='L347'><i><font color='green'>/* Create the sds representation of an PEXPIREAT command, using</font></i>
<a name='L348'><i><font color='green'> * 'seconds' as time to live and 'cmd' to understand what command</font></i>
<a name='L349'><i><font color='green'> * we are translating into a PEXPIREAT.</font></i>
<a name='L350'><i><font color='green'> *</font></i>
<a name='L351'><i><font color='green'> * This command is used in order to translate EXPIRE and PEXPIRE commands</font></i>
<a name='L352'><i><font color='green'> * into PEXPIREAT command so that we retain precision in the append only</font></i>
<a name='L353'><i><font color='green'> * file, and the time is always absolute and not relative. */</font></i>
<a name='L354'><a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> <a href='../R/1532.html' title='Multiple refered from 2 places.'>catAppendOnlyExpireAtCommand</a>(sds buf, <b>struct</b> redisCommand *cmd, robj *key, robj *seconds) <font color='red'>{</font>
<a name='L355'>    <b>long</b> <b>long</b> when;
<a name='L356'>    <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *argv[3];
<a name='L357'>
<a name='L358'>    <i><font color='green'>/* Make sure we can use strtol */</font></i>
<a name='L359'>    seconds = <a href='../S/71.html#L312' title='Defined at 312 in src/object.c.'>getDecodedObject</a>(seconds);
<a name='L360'>    when = strtoll(seconds-&gt;ptr,NULL,10);
<a name='L361'>    <i><font color='green'>/* Convert argument into milliseconds for EXPIRE, SETEX, EXPIREAT */</font></i>
<a name='L362'>    <b>if</b> (cmd-&gt;proc == <a href='../S/31.html#L586' title='Defined at 586 in src/db.c.'>expireCommand</a> || cmd-&gt;proc == <a href='../S/79.html#L78' title='Defined at 78 in src/t_string.c.'>setexCommand</a> ||
<a name='L363'>        cmd-&gt;proc == <a href='../S/31.html#L590' title='Defined at 590 in src/db.c.'>expireatCommand</a>)
<a name='L364'>    <font color='red'>{</font>
<a name='L365'>        when *= 1000;
<a name='L366'>    <font color='red'>}</font>
<a name='L367'>    <i><font color='green'>/* Convert into absolute time for EXPIRE, PEXPIRE, SETEX, PSETEX */</font></i>
<a name='L368'>    <b>if</b> (cmd-&gt;proc == <a href='../S/31.html#L586' title='Defined at 586 in src/db.c.'>expireCommand</a> || cmd-&gt;proc == <a href='../S/31.html#L594' title='Defined at 594 in src/db.c.'>pexpireCommand</a> ||
<a name='L369'>        cmd-&gt;proc == <a href='../S/79.html#L78' title='Defined at 78 in src/t_string.c.'>setexCommand</a> || cmd-&gt;proc == <a href='../S/79.html#L83' title='Defined at 83 in src/t_string.c.'>psetexCommand</a>)
<a name='L370'>    <font color='red'>{</font>
<a name='L371'>        when += <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L372'>    <font color='red'>}</font>
<a name='L373'>    <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(seconds);
<a name='L374'>
<a name='L375'>    argv[0] = <a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>("PEXPIREAT",9);
<a name='L376'>    argv[1] = key;
<a name='L377'>    argv[2] = <a href='../S/71.html#L51' title='Defined at 51 in src/object.c.'>createStringObjectFromLongLong</a>(when);
<a name='L378'>    buf = <a href='../S/62.html#L322' title='Defined at 322 in src/aof.c.'>catAppendOnlyGenericCommand</a>(buf, 3, argv);
<a name='L379'>    <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(argv[0]);
<a name='L380'>    <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(argv[2]);
<a name='L381'>    <b>return</b> buf;
<a name='L382'><font color='red'>}</font>
<a name='L383'>
<a name='L384'><b>void</b> <a href='../R/1970.html' title='Multiple refered from 4 places.'>feedAppendOnlyFile</a>(<b>struct</b> redisCommand *cmd, <b>int</b> dictid, robj **argv, <b>int</b> argc) <font color='red'>{</font>
<a name='L385'>    <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> buf = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L386'>    <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *tmpargv[3];
<a name='L387'>
<a name='L388'>    <i><font color='green'>/* The DB this command was targetting is not the same as the last command</font></i>
<a name='L389'><i><font color='green'>     * we appendend. To issue a SELECT command is needed. */</font></i>
<a name='L390'>    <b>if</b> (dictid != server.aof_selected_db) <font color='red'>{</font>
<a name='L391'>        <b>char</b> seldb[64];
<a name='L392'>
<a name='L393'>        snprintf(seldb,<b>sizeof</b>(seldb),"%d",dictid);
<a name='L394'>        buf = <a href='../D/3996.html' title='Multiple defined in 2 places.'>sdscatprintf</a>(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",
<a name='L395'>            (<b>unsigned</b> <b>long</b>)strlen(seldb),seldb);
<a name='L396'>        server.aof_selected_db = dictid;
<a name='L397'>    <font color='red'>}</font>
<a name='L398'>
<a name='L399'>    <b>if</b> (cmd-&gt;proc == <a href='../S/31.html#L586' title='Defined at 586 in src/db.c.'>expireCommand</a> || cmd-&gt;proc == <a href='../S/31.html#L594' title='Defined at 594 in src/db.c.'>pexpireCommand</a> ||
<a name='L400'>        cmd-&gt;proc == <a href='../S/31.html#L590' title='Defined at 590 in src/db.c.'>expireatCommand</a>) <font color='red'>{</font>
<a name='L401'>        <i><font color='green'>/* Translate EXPIRE/PEXPIRE/EXPIREAT into PEXPIREAT */</font></i>
<a name='L402'>        buf = <a href='../S/62.html#L354' title='Defined at 354 in src/aof.c.'>catAppendOnlyExpireAtCommand</a>(buf,cmd,argv[1],argv[2]);
<a name='L403'>    <font color='red'>}</font> <b>else</b> <b>if</b> (cmd-&gt;proc == <a href='../S/79.html#L78' title='Defined at 78 in src/t_string.c.'>setexCommand</a> || cmd-&gt;proc == <a href='../S/79.html#L83' title='Defined at 83 in src/t_string.c.'>psetexCommand</a>) <font color='red'>{</font>
<a name='L404'>        <i><font color='green'>/* Translate SETEX/PSETEX to SET and PEXPIREAT */</font></i>
<a name='L405'>        tmpargv[0] = <a href='../D/1986.html' title='Multiple defined in 2 places.'>createStringObject</a>("SET",3);
<a name='L406'>        tmpargv[1] = argv[1];
<a name='L407'>        tmpargv[2] = argv[3];
<a name='L408'>        buf = <a href='../S/62.html#L322' title='Defined at 322 in src/aof.c.'>catAppendOnlyGenericCommand</a>(buf,3,tmpargv);
<a name='L409'>        <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(tmpargv[0]);
<a name='L410'>        buf = <a href='../S/62.html#L354' title='Defined at 354 in src/aof.c.'>catAppendOnlyExpireAtCommand</a>(buf,cmd,argv[1],argv[2]);
<a name='L411'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L412'>        <i><font color='green'>/* All the other commands don't need translation or need the</font></i>
<a name='L413'><i><font color='green'>         * same translation already operated in the command vector</font></i>
<a name='L414'><i><font color='green'>         * for the replication itself. */</font></i>
<a name='L415'>        buf = <a href='../S/62.html#L322' title='Defined at 322 in src/aof.c.'>catAppendOnlyGenericCommand</a>(buf,argc,argv);
<a name='L416'>    <font color='red'>}</font>
<a name='L417'>
<a name='L418'>    <i><font color='green'>/* Append to the AOF buffer. This will be flushed on disk just before</font></i>
<a name='L419'><i><font color='green'>     * of re-entering the event loop, so before the client will get a</font></i>
<a name='L420'><i><font color='green'>     * positive reply about the operation performed. */</font></i>
<a name='L421'>    <b>if</b> (server.aof_state == <a href='../S/32.html#L168' title='Defined at 168 in src/redis.h.'>REDIS_AOF_ON</a>)
<a name='L422'>        server.aof_buf = <a href='../D/3995.html' title='Multiple defined in 2 places.'>sdscatlen</a>(server.aof_buf,buf,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(buf));
<a name='L423'>
<a name='L424'>    <i><font color='green'>/* If a background append only file rewriting is in progress we want to</font></i>
<a name='L425'><i><font color='green'>     * accumulate the differences between the child DB and the current one</font></i>
<a name='L426'><i><font color='green'>     * in a buffer, so that when the child process will do its work we</font></i>
<a name='L427'><i><font color='green'>     * can append the differences to the new append only file. */</font></i>
<a name='L428'>    <b>if</b> (server.aof_child_pid != -1)
<a name='L429'>        <a href='../S/62.html#L89' title='Defined at 89 in src/aof.c.'>aofRewriteBufferAppend</a>((<b>unsigned</b> <b>char</b>*)buf,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(buf));
<a name='L430'>
<a name='L431'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(buf);
<a name='L432'><font color='red'>}</font>
<a name='L433'>
<a name='L434'><i><font color='green'>/* ----------------------------------------------------------------------------</font></i>
<a name='L435'><i><font color='green'> * AOF loading</font></i>
<a name='L436'><i><font color='green'> * ------------------------------------------------------------------------- */</font></i>
<a name='L437'>
<a name='L438'><i><font color='green'>/* In Redis commands are always executed in the context of a client, so in</font></i>
<a name='L439'><i><font color='green'> * order to load the append only file we need to create a fake client. */</font></i>
<a name='L440'><b>struct</b> <a href='../D/3781.html' title='Multiple defined in 2 places.'>redisClient</a> *<a href='../S/62.html#L497' title='Refered from 497 in src/aof.c.'>createFakeClient</a>(<b>void</b>) <font color='red'>{</font>
<a name='L441'>    <b>struct</b> <a href='../D/3781.html' title='Multiple defined in 2 places.'>redisClient</a> *c = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(*c));
<a name='L442'>
<a name='L443'>    <a href='../S/31.html#L181' title='Defined at 181 in src/db.c.'>selectDb</a>(c,0);
<a name='L444'>    c-&gt;fd = -1;
<a name='L445'>    c-&gt;querybuf = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L446'>    c-&gt;querybuf_peak = 0;
<a name='L447'>    c-&gt;argc = 0;
<a name='L448'>    c-&gt;argv = NULL;
<a name='L449'>    c-&gt;bufpos = 0;
<a name='L450'>    c-&gt;flags = 0;
<a name='L451'>    <i><font color='green'>/* We set the fake client as a slave waiting for the synchronization</font></i>
<a name='L452'><i><font color='green'>     * so that Redis will not try to send replies to this client. */</font></i>
<a name='L453'>    c-&gt;replstate = <a href='../S/32.html#L213' title='Defined at 213 in src/redis.h.'>REDIS_REPL_WAIT_BGSAVE_START</a>;
<a name='L454'>    c-&gt;reply = <a href='../S/54.html#L41' title='Defined at 41 in src/adlist.c.'>listCreate</a>();
<a name='L455'>    c-&gt;reply_bytes = 0;
<a name='L456'>    c-&gt;obuf_soft_limit_reached_time = 0;
<a name='L457'>    c-&gt;watched_keys = <a href='../S/54.html#L41' title='Defined at 41 in src/adlist.c.'>listCreate</a>();
<a name='L458'>    <a href='../S/58.html#L65' title='Defined at 65 in src/adlist.h.'>listSetFreeMethod</a>(c-&gt;reply,<a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>);
<a name='L459'>    <a href='../S/58.html#L64' title='Defined at 64 in src/adlist.h.'>listSetDupMethod</a>(c-&gt;reply,<a href='../S/86.html#L43' title='Defined at 43 in src/networking.c.'>dupClientReplyValue</a>);
<a name='L460'>    <a href='../S/81.html#L35' title='Defined at 35 in src/multi.c.'>initClientMultiState</a>(c);
<a name='L461'>    <b>return</b> c;
<a name='L462'><font color='red'>}</font>
<a name='L463'>
<a name='L464'><b>void</b> <a href='../S/62.html#L563' title='Refered from 563 in src/aof.c.'>freeFakeClient</a>(<b>struct</b> redisClient *c) <font color='red'>{</font>
<a name='L465'>    <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(c-&gt;querybuf);
<a name='L466'>    <a href='../S/54.html#L58' title='Defined at 58 in src/adlist.c.'>listRelease</a>(c-&gt;reply);
<a name='L467'>    <a href='../S/54.html#L58' title='Defined at 58 in src/adlist.c.'>listRelease</a>(c-&gt;watched_keys);
<a name='L468'>    <a href='../S/81.html#L41' title='Defined at 41 in src/multi.c.'>freeClientMultiState</a>(c);
<a name='L469'>    <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(c);
<a name='L470'><font color='red'>}</font>
<a name='L471'>
<a name='L472'><i><font color='green'>/* Replay the append log file. On error REDIS_OK is returned. On non fatal</font></i>
<a name='L473'><i><font color='green'> * error (the append only file is zero-length) REDIS_ERR is returned. On</font></i>
<a name='L474'><i><font color='green'> * fatal error an error message is logged and the program exists. */</font></i>
<a name='L475'><b>int</b> <a href='../R/2438.html' title='Multiple refered from 3 places.'>loadAppendOnlyFile</a>(<b>char</b> *filename) <font color='red'>{</font>
<a name='L476'>    <b>struct</b> <a href='../D/3781.html' title='Multiple defined in 2 places.'>redisClient</a> *fakeClient;
<a name='L477'>    FILE *fp = fopen(filename,"r");
<a name='L478'>    <b>struct</b> <a href='../D/3875.html' title='Multiple defined in 2 places.'>redis_stat</a> sb;
<a name='L479'>    <b>int</b> old_aof_state = server.aof_state;
<a name='L480'>    <b>long</b> loops = 0;
<a name='L481'>
<a name='L482'>    <b>if</b> (fp &amp;&amp; <a href='../D/3872.html' title='Multiple defined in 2 places.'>redis_fstat</a>(fileno(fp),&amp;sb) != -1 &amp;&amp; sb.st_size == 0) <font color='red'>{</font>
<a name='L483'>        server.aof_current_size = 0;
<a name='L484'>        fclose(fp);
<a name='L485'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L486'>    <font color='red'>}</font>
<a name='L487'>
<a name='L488'>    <b>if</b> (fp == NULL) <font color='red'>{</font>
<a name='L489'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Fatal error: can't open the append log file for reading: %s",strerror(errno));
<a name='L490'>        exit(1);
<a name='L491'>    <font color='red'>}</font>
<a name='L492'>
<a name='L493'>    <i><font color='green'>/* Temporarily disable AOF, to prevent EXEC from feeding a MULTI</font></i>
<a name='L494'><i><font color='green'>     * to the same file we're about to read. */</font></i>
<a name='L495'>    server.aof_state = <a href='../S/32.html#L167' title='Defined at 167 in src/redis.h.'>REDIS_AOF_OFF</a>;
<a name='L496'>
<a name='L497'>    fakeClient = <a href='../S/62.html#L440' title='Defined at 440 in src/aof.c.'>createFakeClient</a>();
<a name='L498'>    <a href='../S/87.html#L1035' title='Defined at 1035 in src/rdb.c.'>startLoading</a>(fp);
<a name='L499'>
<a name='L500'>    <b>while</b>(1) <font color='red'>{</font>
<a name='L501'>        <b>int</b> argc, j;
<a name='L502'>        <b>unsigned</b> <b>long</b> len;
<a name='L503'>        <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> **argv;
<a name='L504'>        <b>char</b> buf[128];
<a name='L505'>        <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> argsds;
<a name='L506'>        <b>struct</b> <a href='../D/3782.html' title='Multiple defined in 2 places.'>redisCommand</a> *cmd;
<a name='L507'>
<a name='L508'>        <i><font color='green'>/* Serve the clients from time to time */</font></i>
<a name='L509'>        <b>if</b> (!(loops++ % 1000)) <font color='red'>{</font>
<a name='L510'>            <a href='../S/87.html#L1049' title='Defined at 1049 in src/rdb.c.'>loadingProgress</a>(ftello(fp));
<a name='L511'>            <a href='../S/36.html#L318' title='Defined at 318 in src/ae.c.'>aeProcessEvents</a>(server.el, <a href='../S/38.html#L43' title='Defined at 43 in src/ae.h.'>AE_FILE_EVENTS</a>|<a href='../S/38.html#L46' title='Defined at 46 in src/ae.h.'>AE_DONT_WAIT</a>);
<a name='L512'>        <font color='red'>}</font>
<a name='L513'>
<a name='L514'>        <b>if</b> (fgets(buf,<b>sizeof</b>(buf),fp) == NULL) <font color='red'>{</font>
<a name='L515'>            <b>if</b> (feof(fp))
<a name='L516'>                <b>break</b>;
<a name='L517'>            <b>else</b>
<a name='L518'>                <b>goto</b> readerr;
<a name='L519'>        <font color='red'>}</font>
<a name='L520'>        <b>if</b> (buf[0] != '*') <b>goto</b> fmterr;
<a name='L521'>        argc = atoi(buf+1);
<a name='L522'>        <b>if</b> (argc &lt; 1) <b>goto</b> fmterr;
<a name='L523'>
<a name='L524'>        argv = <a href='../S/39.html#L121' title='Defined at 121 in src/zmalloc.c.'>zmalloc</a>(<b>sizeof</b>(<a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a>*)*argc);
<a name='L525'>        <b>for</b> (j = 0; j &lt; argc; j++) <font color='red'>{</font>
<a name='L526'>            <b>if</b> (fgets(buf,<b>sizeof</b>(buf),fp) == NULL) <b>goto</b> readerr;
<a name='L527'>            <b>if</b> (buf[0] != '$') <b>goto</b> fmterr;
<a name='L528'>            len = strtol(buf+1,NULL,10);
<a name='L529'>            argsds = <a href='../D/4014.html' title='Multiple defined in 2 places.'>sdsnewlen</a>(NULL,len);
<a name='L530'>            <b>if</b> (len &amp;&amp; fread(argsds,len,1,fp) == 0) <b>goto</b> fmterr;
<a name='L531'>            argv[j] = <a href='../S/71.html#L35' title='Defined at 35 in src/object.c.'>createObject</a>(<a href='../D/923.html' title='Multiple defined in 2 places.'>REDIS_STRING</a>,argsds);
<a name='L532'>            <b>if</b> (fread(buf,2,1,fp) == 0) <b>goto</b> fmterr; <i><font color='green'>/* discard CRLF */</font></i>
<a name='L533'>        <font color='red'>}</font>
<a name='L534'>
<a name='L535'>        <i><font color='green'>/* Command lookup */</font></i>
<a name='L536'>        cmd = <a href='../S/35.html#L1448' title='Defined at 1448 in src/redis.c.'>lookupCommand</a>(argv[0]-&gt;ptr);
<a name='L537'>        <b>if</b> (!cmd) <font color='red'>{</font>
<a name='L538'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Unknown command '%s' reading the append only file", argv[0]-&gt;ptr);
<a name='L539'>            exit(1);
<a name='L540'>        <font color='red'>}</font>
<a name='L541'>        <i><font color='green'>/* Run the command in the context of a fake client */</font></i>
<a name='L542'>        fakeClient-&gt;argc = argc;
<a name='L543'>        fakeClient-&gt;argv = argv;
<a name='L544'>        cmd-&gt;proc(fakeClient);
<a name='L545'>
<a name='L546'>        <i><font color='green'>/* The fake client should not have a reply */</font></i>
<a name='L547'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(fakeClient-&gt;bufpos == 0 &amp;&amp; <a href='../S/58.html#L57' title='Defined at 57 in src/adlist.h.'>listLength</a>(fakeClient-&gt;reply) == 0);
<a name='L548'>        <i><font color='green'>/* The fake client should never get blocked */</font></i>
<a name='L549'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>((fakeClient-&gt;flags &amp; <a href='../S/32.html#L176' title='Defined at 176 in src/redis.h.'>REDIS_BLOCKED</a>) == 0);
<a name='L550'>
<a name='L551'>        <i><font color='green'>/* Clean up. Command code may have changed argv/argc so we use the</font></i>
<a name='L552'><i><font color='green'>         * argv/argc of the client instead of the local variables. */</font></i>
<a name='L553'>        <b>for</b> (j = 0; j &lt; fakeClient-&gt;argc; j++)
<a name='L554'>            <a href='../S/71.html#L218' title='Defined at 218 in src/object.c.'>decrRefCount</a>(fakeClient-&gt;argv[j]);
<a name='L555'>        <a href='../S/39.html#L192' title='Defined at 192 in src/zmalloc.c.'>zfree</a>(fakeClient-&gt;argv);
<a name='L556'>    <font color='red'>}</font>
<a name='L557'>
<a name='L558'>    <i><font color='green'>/* This point can only be reached when EOF is reached without errors.</font></i>
<a name='L559'><i><font color='green'>     * If the client is in the middle of a MULTI/EXEC, log error and quit. */</font></i>
<a name='L560'>    <b>if</b> (fakeClient-&gt;flags &amp; <a href='../S/32.html#L175' title='Defined at 175 in src/redis.h.'>REDIS_MULTI</a>) <b>goto</b> readerr;
<a name='L561'>
<a name='L562'>    fclose(fp);
<a name='L563'>    <a href='../S/62.html#L464' title='Defined at 464 in src/aof.c.'>freeFakeClient</a>(fakeClient);
<a name='L564'>    server.aof_state = old_aof_state;
<a name='L565'>    <a href='../S/87.html#L1056' title='Defined at 1056 in src/rdb.c.'>stopLoading</a>();
<a name='L566'>    <a href='../S/62.html#L1025' title='Defined at 1025 in src/aof.c.'>aofUpdateCurrentSize</a>();
<a name='L567'>    server.aof_rewrite_base_size = server.aof_current_size;
<a name='L568'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L569'>
<a name='L570'>readerr:
<a name='L571'>    <b>if</b> (feof(fp)) <font color='red'>{</font>
<a name='L572'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Unexpected end of file reading the append only file");
<a name='L573'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L574'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Unrecoverable error reading the append only file: %s", strerror(errno));
<a name='L575'>    <font color='red'>}</font>
<a name='L576'>    exit(1);
<a name='L577'>fmterr:
<a name='L578'>    <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;");
<a name='L579'>    exit(1);
<a name='L580'><font color='red'>}</font>
<a name='L581'>
<a name='L582'><i><font color='green'>/* ----------------------------------------------------------------------------</font></i>
<a name='L583'><i><font color='green'> * AOF rewrite</font></i>
<a name='L584'><i><font color='green'> * ------------------------------------------------------------------------- */</font></i>
<a name='L585'>
<a name='L586'><i><font color='green'>/* Delegate writing an object to writing a bulk string or bulk long long.</font></i>
<a name='L587'><i><font color='green'> * This is not placed in rio.c since that adds the redis.h dependency. */</font></i>
<a name='L588'><b>int</b> <a href='../R/3576.html' title='Multiple refered from 14 places.'>rioWriteBulkObject</a>(rio *r, robj *obj) <font color='red'>{</font>
<a name='L589'>    <i><font color='green'>/* Avoid using getDecodedObject to help copy-on-write (we are often</font></i>
<a name='L590'><i><font color='green'>     * in a child process when this function is called). */</font></i>
<a name='L591'>    <b>if</b> (obj-&gt;encoding == <a href='../D/786.html' title='Multiple defined in 2 places.'>REDIS_ENCODING_INT</a>) <font color='red'>{</font>
<a name='L592'>        <b>return</b> <a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(r,(<b>long</b>)obj-&gt;ptr);
<a name='L593'>    <font color='red'>}</font> <b>else</b> <b>if</b> (obj-&gt;encoding == <a href='../D/789.html' title='Multiple defined in 2 places.'>REDIS_ENCODING_RAW</a>) <font color='red'>{</font>
<a name='L594'>        <b>return</b> <a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,obj-&gt;ptr,<a href='../D/4011.html' title='Multiple defined in 2 places.'>sdslen</a>(obj-&gt;ptr));
<a name='L595'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L596'>        <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown string encoding");
<a name='L597'>    <font color='red'>}</font>
<a name='L598'><font color='red'>}</font>
<a name='L599'>
<a name='L600'><i><font color='green'>/* Emit the commands needed to rebuild a list object.</font></i>
<a name='L601'><i><font color='green'> * The function returns 0 on error, 1 on success. */</font></i>
<a name='L602'><b>int</b> <a href='../S/62.html#L893' title='Refered from 893 in src/aof.c.'>rewriteListObject</a>(rio *r, robj *key, robj *o) <font color='red'>{</font>
<a name='L603'>    <b>long</b> <b>long</b> count = 0, items = <a href='../S/60.html#L114' title='Defined at 114 in src/t_list.c.'>listTypeLength</a>(o);
<a name='L604'>
<a name='L605'>    <b>if</b> (o-&gt;encoding == <a href='../S/32.html#L135' title='Defined at 135 in src/redis.h.'>REDIS_ENCODING_ZIPLIST</a>) <font color='red'>{</font>
<a name='L606'>        <b>unsigned</b> <b>char</b> *zl = o-&gt;ptr;
<a name='L607'>        <b>unsigned</b> <b>char</b> *p = <a href='../S/89.html#L677' title='Defined at 677 in src/ziplist.c.'>ziplistIndex</a>(zl,0);
<a name='L608'>        <b>unsigned</b> <b>char</b> *vstr;
<a name='L609'>        <b>unsigned</b> <b>int</b> vlen;
<a name='L610'>        <b>long</b> <b>long</b> vlong;
<a name='L611'>
<a name='L612'>        <b>while</b>(<a href='../S/89.html#L746' title='Defined at 746 in src/ziplist.c.'>ziplistGet</a>(p,&amp;vstr,&amp;vlen,&amp;vlong)) <font color='red'>{</font>
<a name='L613'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L614'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L615'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L616'>
<a name='L617'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items) == 0) <b>return</b> 0;
<a name='L618'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"RPUSH",5) == 0) <b>return</b> 0;
<a name='L619'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L620'>            <font color='red'>}</font>
<a name='L621'>            <b>if</b> (vstr) <font color='red'>{</font>
<a name='L622'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,(<b>char</b>*)vstr,vlen) == 0) <b>return</b> 0;
<a name='L623'>            <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L624'>                <b>if</b> (<a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(r,vlong) == 0) <b>return</b> 0;
<a name='L625'>            <font color='red'>}</font>
<a name='L626'>            p = <a href='../S/89.html#L705' title='Defined at 705 in src/ziplist.c.'>ziplistNext</a>(zl,p);
<a name='L627'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L628'>            items--;
<a name='L629'>        <font color='red'>}</font>
<a name='L630'>    <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;encoding == <a href='../S/32.html#L134' title='Defined at 134 in src/redis.h.'>REDIS_ENCODING_LINKEDLIST</a>) <font color='red'>{</font>
<a name='L631'>        <a href='../D/2690.html' title='Multiple defined in 2 places.'>list</a> *<a href='../D/2690.html' title='Multiple defined in 2 places.'>list</a> = o-&gt;ptr;
<a name='L632'>        <a href='../D/2710.html' title='Multiple defined in 2 places.'>listNode</a> *ln;
<a name='L633'>        <a href='../D/2703.html' title='Multiple defined in 2 places.'>listIter</a> li;
<a name='L634'>
<a name='L635'>        <a href='../S/54.html#L197' title='Defined at 197 in src/adlist.c.'>listRewind</a>(<a href='../D/2690.html' title='Multiple defined in 2 places.'>list</a>,&amp;li);
<a name='L636'>        <b>while</b>((ln = <a href='../S/54.html#L221' title='Defined at 221 in src/adlist.c.'>listNext</a>(&amp;li))) <font color='red'>{</font>
<a name='L637'>            <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *eleobj = <a href='../S/58.html#L62' title='Defined at 62 in src/adlist.h.'>listNodeValue</a>(ln);
<a name='L638'>
<a name='L639'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L640'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L641'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L642'>
<a name='L643'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items) == 0) <b>return</b> 0;
<a name='L644'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"RPUSH",5) == 0) <b>return</b> 0;
<a name='L645'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L646'>            <font color='red'>}</font>
<a name='L647'>            <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,eleobj) == 0) <b>return</b> 0;
<a name='L648'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L649'>            items--;
<a name='L650'>        <font color='red'>}</font>
<a name='L651'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L652'>        <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown list encoding");
<a name='L653'>    <font color='red'>}</font>
<a name='L654'>    <b>return</b> 1;
<a name='L655'><font color='red'>}</font>
<a name='L656'>
<a name='L657'><i><font color='green'>/* Emit the commands needed to rebuild a set object.</font></i>
<a name='L658'><i><font color='green'> * The function returns 0 on error, 1 on success. */</font></i>
<a name='L659'><b>int</b> <a href='../S/62.html#L895' title='Refered from 895 in src/aof.c.'>rewriteSetObject</a>(rio *r, robj *key, robj *o) <font color='red'>{</font>
<a name='L660'>    <b>long</b> <b>long</b> count = 0, items = <a href='../S/92.html#L208' title='Defined at 208 in src/t_set.c.'>setTypeSize</a>(o);
<a name='L661'>
<a name='L662'>    <b>if</b> (o-&gt;encoding == <a href='../S/32.html#L136' title='Defined at 136 in src/redis.h.'>REDIS_ENCODING_INTSET</a>) <font color='red'>{</font>
<a name='L663'>        <b>int</b> ii = 0;
<a name='L664'>        <a href='../S/160.html#L89' title='Defined at 89 in deps/jemalloc/include/msvc_compat/stdint.h.'>int64_t</a> llval;
<a name='L665'>
<a name='L666'>        <b>while</b>(<a href='../S/44.html#L266' title='Defined at 266 in src/intset.c.'>intsetGet</a>(o-&gt;ptr,ii++,&amp;llval)) <font color='red'>{</font>
<a name='L667'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L668'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L669'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L670'>
<a name='L671'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items) == 0) <b>return</b> 0;
<a name='L672'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"SADD",4) == 0) <b>return</b> 0;
<a name='L673'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L674'>            <font color='red'>}</font>
<a name='L675'>            <b>if</b> (<a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(r,llval) == 0) <b>return</b> 0;
<a name='L676'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L677'>            items--;
<a name='L678'>        <font color='red'>}</font>
<a name='L679'>    <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;encoding == <a href='../D/785.html' title='Multiple defined in 2 places.'>REDIS_ENCODING_HT</a>) <font color='red'>{</font>
<a name='L680'>        <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(o-&gt;ptr);
<a name='L681'>        <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L682'>
<a name='L683'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L684'>            <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *eleobj = <a href='../S/88.html#L131' title='Defined at 131 in src/dict.h.'>dictGetKey</a>(de);
<a name='L685'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L686'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L687'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L688'>
<a name='L689'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items) == 0) <b>return</b> 0;
<a name='L690'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"SADD",4) == 0) <b>return</b> 0;
<a name='L691'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L692'>            <font color='red'>}</font>
<a name='L693'>            <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,eleobj) == 0) <b>return</b> 0;
<a name='L694'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L695'>            items--;
<a name='L696'>        <font color='red'>}</font>
<a name='L697'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L698'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L699'>        <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown set encoding");
<a name='L700'>    <font color='red'>}</font>
<a name='L701'>    <b>return</b> 1;
<a name='L702'><font color='red'>}</font>
<a name='L703'>
<a name='L704'><i><font color='green'>/* Emit the commands needed to rebuild a sorted set object.</font></i>
<a name='L705'><i><font color='green'> * The function returns 0 on error, 1 on success. */</font></i>
<a name='L706'><b>int</b> <a href='../S/62.html#L897' title='Refered from 897 in src/aof.c.'>rewriteSortedSetObject</a>(rio *r, robj *key, robj *o) <font color='red'>{</font>
<a name='L707'>    <b>long</b> <b>long</b> count = 0, items = <a href='../S/59.html#L748' title='Defined at 748 in src/t_zset.c.'>zsetLength</a>(o);
<a name='L708'>
<a name='L709'>    <b>if</b> (o-&gt;encoding == <a href='../S/32.html#L135' title='Defined at 135 in src/redis.h.'>REDIS_ENCODING_ZIPLIST</a>) <font color='red'>{</font>
<a name='L710'>        <b>unsigned</b> <b>char</b> *zl = o-&gt;ptr;
<a name='L711'>        <b>unsigned</b> <b>char</b> *eptr, *sptr;
<a name='L712'>        <b>unsigned</b> <b>char</b> *vstr;
<a name='L713'>        <b>unsigned</b> <b>int</b> vlen;
<a name='L714'>        <b>long</b> <b>long</b> vll;
<a name='L715'>        <b>double</b> score;
<a name='L716'>
<a name='L717'>        eptr = <a href='../S/89.html#L677' title='Defined at 677 in src/ziplist.c.'>ziplistIndex</a>(zl,0);
<a name='L718'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(eptr != NULL);
<a name='L719'>        sptr = <a href='../S/89.html#L705' title='Defined at 705 in src/ziplist.c.'>ziplistNext</a>(zl,eptr);
<a name='L720'>        <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(sptr != NULL);
<a name='L721'>
<a name='L722'>        <b>while</b> (eptr != NULL) <font color='red'>{</font>
<a name='L723'>            <a href='../S/32.html#L299' title='Defined at 299 in src/redis.h.'>redisAssert</a>(<a href='../S/89.html#L746' title='Defined at 746 in src/ziplist.c.'>ziplistGet</a>(eptr,&amp;vstr,&amp;vlen,&amp;vll));
<a name='L724'>            score = <a href='../S/59.html#L438' title='Defined at 438 in src/t_zset.c.'>zzlGetScore</a>(sptr);
<a name='L725'>
<a name='L726'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L727'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L728'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L729'>
<a name='L730'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items*2) == 0) <b>return</b> 0;
<a name='L731'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"ZADD",4) == 0) <b>return</b> 0;
<a name='L732'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L733'>            <font color='red'>}</font>
<a name='L734'>            <b>if</b> (<a href='../S/76.html#L164' title='Defined at 164 in src/rio.c.'>rioWriteBulkDouble</a>(r,score) == 0) <b>return</b> 0;
<a name='L735'>            <b>if</b> (vstr != NULL) <font color='red'>{</font>
<a name='L736'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,(<b>char</b>*)vstr,vlen) == 0) <b>return</b> 0;
<a name='L737'>            <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L738'>                <b>if</b> (<a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(r,vll) == 0) <b>return</b> 0;
<a name='L739'>            <font color='red'>}</font>
<a name='L740'>            <a href='../S/59.html#L486' title='Defined at 486 in src/t_zset.c.'>zzlNext</a>(zl,&amp;eptr,&amp;sptr);
<a name='L741'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L742'>            items--;
<a name='L743'>        <font color='red'>}</font>
<a name='L744'>    <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;encoding == <a href='../S/32.html#L137' title='Defined at 137 in src/redis.h.'>REDIS_ENCODING_SKIPLIST</a>) <font color='red'>{</font>
<a name='L745'>        <a href='../D/4576.html' title='Multiple defined in 2 places.'>zset</a> *zs = o-&gt;ptr;
<a name='L746'>        <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di = <a href='../D/2087.html' title='Multiple defined in 2 places.'>dictGetIterator</a>(zs-&gt;<a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a>);
<a name='L747'>        <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L748'>
<a name='L749'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L750'>            <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *eleobj = <a href='../S/88.html#L131' title='Defined at 131 in src/dict.h.'>dictGetKey</a>(de);
<a name='L751'>            <b>double</b> *score = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L752'>
<a name='L753'>            <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L754'>                <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L755'>                    <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L756'>
<a name='L757'>                <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items*2) == 0) <b>return</b> 0;
<a name='L758'>                <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"ZADD",4) == 0) <b>return</b> 0;
<a name='L759'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L760'>            <font color='red'>}</font>
<a name='L761'>            <b>if</b> (<a href='../S/76.html#L164' title='Defined at 164 in src/rio.c.'>rioWriteBulkDouble</a>(r,*score) == 0) <b>return</b> 0;
<a name='L762'>            <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,eleobj) == 0) <b>return</b> 0;
<a name='L763'>            <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L764'>            items--;
<a name='L765'>        <font color='red'>}</font>
<a name='L766'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L767'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L768'>        <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown sorted zset encoding");
<a name='L769'>    <font color='red'>}</font>
<a name='L770'>    <b>return</b> 1;
<a name='L771'><font color='red'>}</font>
<a name='L772'>
<a name='L773'><i><font color='green'>/* Write either the key or the value of the currently selected item of an hash.</font></i>
<a name='L774'><i><font color='green'> * The 'hi' argument passes a valid Redis hash iterator.</font></i>
<a name='L775'><i><font color='green'> * The 'what' filed specifies if to write a key or a value and can be</font></i>
<a name='L776'><i><font color='green'> * either REDIS_HASH_KEY or REDIS_HASH_VALUE.</font></i>
<a name='L777'><i><font color='green'> *</font></i>
<a name='L778'><i><font color='green'> * The function returns 0 on error, non-zero on success. */</font></i>
<a name='L779'><b>static</b> <b>int</b> <a href='../R/3578.html' title='Multiple refered from 2 places.'>rioWriteHashIteratorCursor</a>(rio *r, hashTypeIterator *hi, <b>int</b> what) <font color='red'>{</font>
<a name='L780'>    <b>if</b> (hi-&gt;encoding == <a href='../S/32.html#L135' title='Defined at 135 in src/redis.h.'>REDIS_ENCODING_ZIPLIST</a>) <font color='red'>{</font>
<a name='L781'>        <b>unsigned</b> <b>char</b> *vstr = NULL;
<a name='L782'>        <b>unsigned</b> <b>int</b> vlen = UINT_MAX;
<a name='L783'>        <b>long</b> <b>long</b> vll = LLONG_MAX;
<a name='L784'>
<a name='L785'>        <a href='../S/97.html#L340' title='Defined at 340 in src/t_hash.c.'>hashTypeCurrentFromZiplist</a>(hi, what, &amp;vstr, &amp;vlen, &amp;vll);
<a name='L786'>        <b>if</b> (vstr) <font color='red'>{</font>
<a name='L787'>            <b>return</b> <a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r, (<b>char</b>*)vstr, vlen);
<a name='L788'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L789'>            <b>return</b> <a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(r, vll);
<a name='L790'>        <font color='red'>}</font>
<a name='L791'>
<a name='L792'>    <font color='red'>}</font> <b>else</b> <b>if</b> (hi-&gt;encoding == <a href='../D/785.html' title='Multiple defined in 2 places.'>REDIS_ENCODING_HT</a>) <font color='red'>{</font>
<a name='L793'>        <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> *value;
<a name='L794'>
<a name='L795'>        <a href='../S/97.html#L360' title='Defined at 360 in src/t_hash.c.'>hashTypeCurrentFromHashTable</a>(hi, what, &amp;value);
<a name='L796'>        <b>return</b> <a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r, value);
<a name='L797'>    <font color='red'>}</font>
<a name='L798'>
<a name='L799'>    <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown hash encoding");
<a name='L800'>    <b>return</b> 0;
<a name='L801'><font color='red'>}</font>
<a name='L802'>
<a name='L803'><i><font color='green'>/* Emit the commands needed to rebuild a hash object.</font></i>
<a name='L804'><i><font color='green'> * The function returns 0 on error, 1 on success. */</font></i>
<a name='L805'><b>int</b> <a href='../S/62.html#L899' title='Refered from 899 in src/aof.c.'>rewriteHashObject</a>(rio *r, robj *key, robj *o) <font color='red'>{</font>
<a name='L806'>    <a href='../S/32.html#L743' title='Defined at 743 in src/redis.h.'>hashTypeIterator</a> *hi;
<a name='L807'>    <b>long</b> <b>long</b> count = 0, items = <a href='../S/97.html#L262' title='Defined at 262 in src/t_hash.c.'>hashTypeLength</a>(o);
<a name='L808'>
<a name='L809'>    hi = <a href='../S/97.html#L276' title='Defined at 276 in src/t_hash.c.'>hashTypeInitIterator</a>(o);
<a name='L810'>    <b>while</b> (<a href='../S/97.html#L303' title='Defined at 303 in src/t_hash.c.'>hashTypeNext</a>(hi) != <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>) <font color='red'>{</font>
<a name='L811'>        <b>if</b> (count == 0) <font color='red'>{</font>
<a name='L812'>            <b>int</b> cmd_items = (items &gt; <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) ?
<a name='L813'>                <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a> : items;
<a name='L814'>
<a name='L815'>            <b>if</b> (<a href='../S/76.html#L132' title='Defined at 132 in src/rio.c.'>rioWriteBulkCount</a>(r,'*',2+cmd_items*2) == 0) <b>return</b> 0;
<a name='L816'>            <b>if</b> (<a href='../S/76.html#L145' title='Defined at 145 in src/rio.c.'>rioWriteBulkString</a>(r,"HMSET",5) == 0) <b>return</b> 0;
<a name='L817'>            <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(r,key) == 0) <b>return</b> 0;
<a name='L818'>        <font color='red'>}</font>
<a name='L819'>
<a name='L820'>        <b>if</b> (<a href='../S/62.html#L779' title='Defined at 779 in src/aof.c.'>rioWriteHashIteratorCursor</a>(r, hi, <a href='../S/32.html#L745' title='Defined at 745 in src/redis.h.'>REDIS_HASH_KEY</a>) == 0) <b>return</b> 0;
<a name='L821'>        <b>if</b> (<a href='../S/62.html#L779' title='Defined at 779 in src/aof.c.'>rioWriteHashIteratorCursor</a>(r, hi, <a href='../S/32.html#L746' title='Defined at 746 in src/redis.h.'>REDIS_HASH_VALUE</a>) == 0) <b>return</b> 0;
<a name='L822'>        <b>if</b> (++count == <a href='../S/32.html#L84' title='Defined at 84 in src/redis.h.'>REDIS_AOF_REWRITE_ITEMS_PER_CMD</a>) count = 0;
<a name='L823'>        items--;
<a name='L824'>    <font color='red'>}</font>
<a name='L825'>
<a name='L826'>    <a href='../S/97.html#L293' title='Defined at 293 in src/t_hash.c.'>hashTypeReleaseIterator</a>(hi);
<a name='L827'>
<a name='L828'>    <b>return</b> 1;
<a name='L829'><font color='red'>}</font>
<a name='L830'>
<a name='L831'><i><font color='green'>/* Write a sequence of commands able to fully rebuild the dataset into</font></i>
<a name='L832'><i><font color='green'> * "filename". Used both by REWRITEAOF and BGREWRITEAOF.</font></i>
<a name='L833'><i><font color='green'> *</font></i>
<a name='L834'><i><font color='green'> * In order to minimize the number of commands needed in the rewritten</font></i>
<a name='L835'><i><font color='green'> * log Redis uses variadic commands when possible, such as RPUSH, SADD</font></i>
<a name='L836'><i><font color='green'> * and ZADD. However at max REDIS_AOF_REWRITE_ITEMS_PER_CMD items per time</font></i>
<a name='L837'><i><font color='green'> * are inserted using a single command. */</font></i>
<a name='L838'><b>int</b> <a href='../S/62.html#L964' title='Refered from 964 in src/aof.c.'>rewriteAppendOnlyFile</a>(<b>char</b> *filename) <font color='red'>{</font>
<a name='L839'>    <a href='../D/2099.html' title='Multiple defined in 4 places.'>dictIterator</a> *di = NULL;
<a name='L840'>    <a href='../D/2073.html' title='Multiple defined in 4 places.'>dictEntry</a> *de;
<a name='L841'>    <a href='../S/65.html#L67' title='Defined at 67 in src/rio.h.'>rio</a> aof;
<a name='L842'>    FILE *fp;
<a name='L843'>    <b>char</b> tmpfile[256];
<a name='L844'>    <b>int</b> j;
<a name='L845'>    <b>long</b> <b>long</b> now = <a href='../D/3402.html' title='Multiple defined in 3 places.'>mstime</a>();
<a name='L846'>
<a name='L847'>    <i><font color='green'>/* Note that we have to use a different temp name here compared to the</font></i>
<a name='L848'><i><font color='green'>     * one used by rewriteAppendOnlyFileBackground() function. */</font></i>
<a name='L849'>    snprintf(tmpfile,256,"temp-rewriteaof-%d.aof", (<b>int</b>) getpid());
<a name='L850'>    fp = fopen(tmpfile,"w");
<a name='L851'>    <b>if</b> (!fp) <font color='red'>{</font>
<a name='L852'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>, "Opening the temp file for AOF rewrite in rewriteAppendOnlyFile(): %s", strerror(errno));
<a name='L853'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L854'>    <font color='red'>}</font>
<a name='L855'>
<a name='L856'>    <a href='../S/76.html#L110' title='Defined at 110 in src/rio.c.'>rioInitWithFile</a>(&amp;aof,fp);
<a name='L857'>    <b>for</b> (j = 0; j &lt; server.dbnum; j++) <font color='red'>{</font>
<a name='L858'>        <b>char</b> selectcmd[] = "*2\r\n$6\r\nSELECT\r\n";
<a name='L859'>        <a href='../D/3798.html' title='Multiple defined in 2 places.'>redisDb</a> *db = server.db+j;
<a name='L860'>        <a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a> *d = db-&gt;<a href='../D/2060.html' title='Multiple defined in 4 places.'>dict</a>;
<a name='L861'>        <b>if</b> (<a href='../D/2125.html' title='Multiple defined in 2 places.'>dictSize</a>(d) == 0) <b>continue</b>;
<a name='L862'>        di = <a href='../S/29.html#L521' title='Defined at 521 in src/dict.c.'>dictGetSafeIterator</a>(d);
<a name='L863'>        <b>if</b> (!di) <font color='red'>{</font>
<a name='L864'>            fclose(fp);
<a name='L865'>            <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L866'>        <font color='red'>}</font>
<a name='L867'>
<a name='L868'>        <i><font color='green'>/* SELECT the new DB */</font></i>
<a name='L869'>        <b>if</b> (<a href='../S/65.html#L73' title='Defined at 73 in src/rio.h.'>rioWrite</a>(&amp;aof,selectcmd,<b>sizeof</b>(selectcmd)-1) == 0) <b>goto</b> werr;
<a name='L870'>        <b>if</b> (<a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(&amp;aof,j) == 0) <b>goto</b> werr;
<a name='L871'>
<a name='L872'>        <i><font color='green'>/* Iterate this DB writing every entry */</font></i>
<a name='L873'>        <b>while</b>((de = <a href='../D/2101.html' title='Multiple defined in 2 places.'>dictNext</a>(di)) != NULL) <font color='red'>{</font>
<a name='L874'>            <a href='../D/3987.html' title='Multiple defined in 2 places.'>sds</a> keystr;
<a name='L875'>            <a href='../S/32.html#L318' title='Defined at 318 in src/redis.h.'>robj</a> key, *o;
<a name='L876'>            <b>long</b> <b>long</b> expiretime;
<a name='L877'>
<a name='L878'>            keystr = <a href='../S/88.html#L131' title='Defined at 131 in src/dict.h.'>dictGetKey</a>(de);
<a name='L879'>            o = <a href='../S/88.html#L132' title='Defined at 132 in src/dict.h.'>dictGetVal</a>(de);
<a name='L880'>            <a href='../S/32.html#L324' title='Defined at 324 in src/redis.h.'>initStaticStringObject</a>(key,keystr);
<a name='L881'>
<a name='L882'>            expiretime = <a href='../S/31.html#L465' title='Defined at 465 in src/db.c.'>getExpire</a>(db,&amp;key);
<a name='L883'>
<a name='L884'>            <i><font color='green'>/* Save the key and associated value */</font></i>
<a name='L885'>            <b>if</b> (o-&gt;type == <a href='../D/923.html' title='Multiple defined in 2 places.'>REDIS_STRING</a>) <font color='red'>{</font>
<a name='L886'>                <i><font color='green'>/* Emit a SET command */</font></i>
<a name='L887'>                <b>char</b> cmd[]="*3\r\n$3\r\nSET\r\n";
<a name='L888'>                <b>if</b> (<a href='../S/65.html#L73' title='Defined at 73 in src/rio.h.'>rioWrite</a>(&amp;aof,cmd,<b>sizeof</b>(cmd)-1) == 0) <b>goto</b> werr;
<a name='L889'>                <i><font color='green'>/* Key and value */</font></i>
<a name='L890'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(&amp;aof,&amp;key) == 0) <b>goto</b> werr;
<a name='L891'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(&amp;aof,o) == 0) <b>goto</b> werr;
<a name='L892'>            <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;type == <a href='../D/820.html' title='Multiple defined in 2 places.'>REDIS_LIST</a>) <font color='red'>{</font>
<a name='L893'>                <b>if</b> (<a href='../S/62.html#L602' title='Defined at 602 in src/aof.c.'>rewriteListObject</a>(&amp;aof,&amp;key,o) == 0) <b>goto</b> werr;
<a name='L894'>            <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;type == <a href='../D/908.html' title='Multiple defined in 2 places.'>REDIS_SET</a>) <font color='red'>{</font>
<a name='L895'>                <b>if</b> (<a href='../S/62.html#L659' title='Defined at 659 in src/aof.c.'>rewriteSetObject</a>(&amp;aof,&amp;key,o) == 0) <b>goto</b> werr;
<a name='L896'>            <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;type == <a href='../D/933.html' title='Multiple defined in 2 places.'>REDIS_ZSET</a>) <font color='red'>{</font>
<a name='L897'>                <b>if</b> (<a href='../S/62.html#L706' title='Defined at 706 in src/aof.c.'>rewriteSortedSetObject</a>(&amp;aof,&amp;key,o) == 0) <b>goto</b> werr;
<a name='L898'>            <font color='red'>}</font> <b>else</b> <b>if</b> (o-&gt;type == <a href='../D/807.html' title='Multiple defined in 2 places.'>REDIS_HASH</a>) <font color='red'>{</font>
<a name='L899'>                <b>if</b> (<a href='../S/62.html#L805' title='Defined at 805 in src/aof.c.'>rewriteHashObject</a>(&amp;aof,&amp;key,o) == 0) <b>goto</b> werr;
<a name='L900'>            <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L901'>                <a href='../S/32.html#L300' title='Defined at 300 in src/redis.h.'>redisPanic</a>("Unknown object type");
<a name='L902'>            <font color='red'>}</font>
<a name='L903'>            <i><font color='green'>/* Save the expire time */</font></i>
<a name='L904'>            <b>if</b> (expiretime != -1) <font color='red'>{</font>
<a name='L905'>                <b>char</b> cmd[]="*3\r\n$9\r\nPEXPIREAT\r\n";
<a name='L906'>                <i><font color='green'>/* If this key is already expired skip it */</font></i>
<a name='L907'>                <b>if</b> (expiretime &lt; now) <b>continue</b>;
<a name='L908'>                <b>if</b> (<a href='../S/65.html#L73' title='Defined at 73 in src/rio.h.'>rioWrite</a>(&amp;aof,cmd,<b>sizeof</b>(cmd)-1) == 0) <b>goto</b> werr;
<a name='L909'>                <b>if</b> (<a href='../S/62.html#L588' title='Defined at 588 in src/aof.c.'>rioWriteBulkObject</a>(&amp;aof,&amp;key) == 0) <b>goto</b> werr;
<a name='L910'>                <b>if</b> (<a href='../S/76.html#L155' title='Defined at 155 in src/rio.c.'>rioWriteBulkLongLong</a>(&amp;aof,expiretime) == 0) <b>goto</b> werr;
<a name='L911'>            <font color='red'>}</font>
<a name='L912'>        <font color='red'>}</font>
<a name='L913'>        <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L914'>    <font color='red'>}</font>
<a name='L915'>
<a name='L916'>    <i><font color='green'>/* Make sure data will not remain on the OS's output buffers */</font></i>
<a name='L917'>    fflush(fp);
<a name='L918'>    <a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a>(fileno(fp));
<a name='L919'>    fclose(fp);
<a name='L920'>
<a name='L921'>    <i><font color='green'>/* Use RENAME to make sure the DB file is changed atomically only</font></i>
<a name='L922'><i><font color='green'>     * if the generate DB file is ok. */</font></i>
<a name='L923'>    <b>if</b> (rename(tmpfile,filename) == -1) <font color='red'>{</font>
<a name='L924'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Error moving temp append only file on the final destination: %s", strerror(errno));
<a name='L925'>        unlink(tmpfile);
<a name='L926'>        <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L927'>    <font color='red'>}</font>
<a name='L928'>    <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,"SYNC append only file rewrite performed");
<a name='L929'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L930'>
<a name='L931'>werr:
<a name='L932'>    fclose(fp);
<a name='L933'>    unlink(tmpfile);
<a name='L934'>    <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Write error writing append only file on disk: %s", strerror(errno));
<a name='L935'>    <b>if</b> (di) <a href='../D/2109.html' title='Multiple defined in 2 places.'>dictReleaseIterator</a>(di);
<a name='L936'>    <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L937'><font color='red'>}</font>
<a name='L938'>
<a name='L939'><i><font color='green'>/* This is how rewriting of the append only file in background works:</font></i>
<a name='L940'><i><font color='green'> *</font></i>
<a name='L941'><i><font color='green'> * 1) The user calls BGREWRITEAOF</font></i>
<a name='L942'><i><font color='green'> * 2) Redis calls this function, that forks():</font></i>
<a name='L943'><i><font color='green'> *    2a) the child rewrite the append only file in a temp file.</font></i>
<a name='L944'><i><font color='green'> *    2b) the parent accumulates differences in server.aof_rewrite_buf.</font></i>
<a name='L945'><i><font color='green'> * 3) When the child finished '2a' exists.</font></i>
<a name='L946'><i><font color='green'> * 4) The parent will trap the exit code, if it's OK, will append the</font></i>
<a name='L947'><i><font color='green'> *    data accumulated into server.aof_rewrite_buf into the temp file, and</font></i>
<a name='L948'><i><font color='green'> *    finally will rename(2) the temp file in the actual file name.</font></i>
<a name='L949'><i><font color='green'> *    The the new file is reopened as the new append only file. Profit!</font></i>
<a name='L950'><i><font color='green'> */</font></i>
<a name='L951'><b>int</b> <a href='../R/3553.html' title='Multiple refered from 5 places.'>rewriteAppendOnlyFileBackground</a>(<b>void</b>) <font color='red'>{</font>
<a name='L952'>    pid_t childpid;
<a name='L953'>    <b>long</b> <b>long</b> start;
<a name='L954'>
<a name='L955'>    <b>if</b> (server.aof_child_pid != -1) <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L956'>    start = <a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>();
<a name='L957'>    <b>if</b> ((childpid = fork()) == 0) <font color='red'>{</font>
<a name='L958'>        <b>char</b> tmpfile[256];
<a name='L959'>
<a name='L960'>        <i><font color='green'>/* Child */</font></i>
<a name='L961'>        <b>if</b> (server.ipfd &gt; 0) close(server.ipfd);
<a name='L962'>        <b>if</b> (server.sofd &gt; 0) close(server.sofd);
<a name='L963'>        snprintf(tmpfile,256,"temp-rewriteaof-bg-%d.aof", (<b>int</b>) getpid());
<a name='L964'>        <b>if</b> (<a href='../S/62.html#L838' title='Defined at 838 in src/aof.c.'>rewriteAppendOnlyFile</a>(tmpfile) == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L965'>            size_t private_dirty = <a href='../D/4545.html' title='Multiple defined in 2 places.'>zmalloc_get_private_dirty</a>();
<a name='L966'>
<a name='L967'>            <b>if</b> (private_dirty) <font color='red'>{</font>
<a name='L968'>                <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,
<a name='L969'>                    "AOF rewrite: %lu MB of memory used by copy-on-write",
<a name='L970'>                    private_dirty/(1024*1024));
<a name='L971'>            <font color='red'>}</font>
<a name='L972'>            <a href='../S/35.html#L356' title='Defined at 356 in src/redis.c.'>exitFromChild</a>(0);
<a name='L973'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L974'>            <a href='../S/35.html#L356' title='Defined at 356 in src/redis.c.'>exitFromChild</a>(1);
<a name='L975'>        <font color='red'>}</font>
<a name='L976'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L977'>        <i><font color='green'>/* Parent */</font></i>
<a name='L978'>        server.stat_fork_time = <a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>()-start;
<a name='L979'>        <b>if</b> (childpid == -1) <font color='red'>{</font>
<a name='L980'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L981'>                "Can't rewrite append only file in background: fork: %s",
<a name='L982'>                strerror(errno));
<a name='L983'>            <b>return</b> <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L984'>        <font color='red'>}</font>
<a name='L985'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,
<a name='L986'>            "Background append only file rewriting started by pid %d",childpid);
<a name='L987'>        server.aof_rewrite_scheduled = 0;
<a name='L988'>        server.aof_rewrite_time_start = time(NULL);
<a name='L989'>        server.aof_child_pid = childpid;
<a name='L990'>        <a href='../S/35.html#L611' title='Defined at 611 in src/redis.c.'>updateDictResizePolicy</a>();
<a name='L991'>        <i><font color='green'>/* We set appendseldb to -1 in order to force the next call to the</font></i>
<a name='L992'><i><font color='green'>         * feedAppendOnlyFile() to issue a SELECT command, so the differences</font></i>
<a name='L993'><i><font color='green'>         * accumulated by the parent into server.aof_rewrite_buf will start</font></i>
<a name='L994'><i><font color='green'>         * with a SELECT statement and it will be safe to merge. */</font></i>
<a name='L995'>        server.aof_selected_db = -1;
<a name='L996'>        <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L997'>    <font color='red'>}</font>
<a name='L998'>    <b>return</b> <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>; <i><font color='green'>/* unreached */</font></i>
<a name='L999'><font color='red'>}</font>
<a name='L1000'>
<a name='L1001'><b>void</b> <a href='../R/1454.html' title='Multiple refered from 2 places.'>bgrewriteaofCommand</a>(redisClient *c) <font color='red'>{</font>
<a name='L1002'>    <b>if</b> (server.aof_child_pid != -1) <font color='red'>{</font>
<a name='L1003'>        <a href='../S/86.html#L330' title='Defined at 330 in src/networking.c.'>addReplyError</a>(c,"Background append only file rewriting already in progress");
<a name='L1004'>    <font color='red'>}</font> <b>else</b> <b>if</b> (server.rdb_child_pid != -1) <font color='red'>{</font>
<a name='L1005'>        server.aof_rewrite_scheduled = 1;
<a name='L1006'>        <a href='../S/86.html#L356' title='Defined at 356 in src/networking.c.'>addReplyStatus</a>(c,"Background append only file rewriting scheduled");
<a name='L1007'>    <font color='red'>}</font> <b>else</b> <b>if</b> (<a href='../S/62.html#L951' title='Defined at 951 in src/aof.c.'>rewriteAppendOnlyFileBackground</a>() == <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>) <font color='red'>{</font>
<a name='L1008'>        <a href='../S/86.html#L356' title='Defined at 356 in src/networking.c.'>addReplyStatus</a>(c,"Background append only file rewriting started");
<a name='L1009'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1010'>        <a href='../S/86.html#L268' title='Defined at 268 in src/networking.c.'>addReply</a>(c,shared.err);
<a name='L1011'>    <font color='red'>}</font>
<a name='L1012'><font color='red'>}</font>
<a name='L1013'>
<a name='L1014'><b>void</b> <a href='../R/1286.html' title='Multiple refered from 3 places.'>aofRemoveTempFile</a>(pid_t childpid) <font color='red'>{</font>
<a name='L1015'>    <b>char</b> tmpfile[256];
<a name='L1016'>
<a name='L1017'>    snprintf(tmpfile,256,"temp-rewriteaof-bg-%d.aof", (<b>int</b>) childpid);
<a name='L1018'>    unlink(tmpfile);
<a name='L1019'><font color='red'>}</font>
<a name='L1020'>
<a name='L1021'><i><font color='green'>/* Update the server.aof_current_size filed explicitly using stat(2)</font></i>
<a name='L1022'><i><font color='green'> * to check the size of the file. This is useful after a rewrite or after</font></i>
<a name='L1023'><i><font color='green'> * a restart, normally the size is updated just adding the write length</font></i>
<a name='L1024'><i><font color='green'> * to the current length, that is much faster. */</font></i>
<a name='L1025'><b>void</b> <a href='../R/1291.html' title='Multiple refered from 3 places.'>aofUpdateCurrentSize</a>(<b>void</b>) <font color='red'>{</font>
<a name='L1026'>    <b>struct</b> <a href='../D/3875.html' title='Multiple defined in 2 places.'>redis_stat</a> sb;
<a name='L1027'>
<a name='L1028'>    <b>if</b> (<a href='../D/3872.html' title='Multiple defined in 2 places.'>redis_fstat</a>(server.aof_fd,&amp;sb) == -1) <font color='red'>{</font>
<a name='L1029'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,"Unable to obtain the AOF file length. stat: %s",
<a name='L1030'>            strerror(errno));
<a name='L1031'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1032'>        server.aof_current_size = sb.st_size;
<a name='L1033'>    <font color='red'>}</font>
<a name='L1034'><font color='red'>}</font>
<a name='L1035'>
<a name='L1036'><i><font color='green'>/* A background append only file rewriting (BGREWRITEAOF) terminated its work.</font></i>
<a name='L1037'><i><font color='green'> * Handle this. */</font></i>
<a name='L1038'><b>void</b> <a href='../R/1439.html' title='Multiple refered from 2 places.'>backgroundRewriteDoneHandler</a>(<b>int</b> exitcode, <b>int</b> bysignal) <font color='red'>{</font>
<a name='L1039'>    <b>if</b> (!bysignal &amp;&amp; exitcode == 0) <font color='red'>{</font>
<a name='L1040'>        <b>int</b> newfd, oldfd;
<a name='L1041'>        <b>char</b> tmpfile[256];
<a name='L1042'>        <b>long</b> <b>long</b> now = <a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>();
<a name='L1043'>
<a name='L1044'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,
<a name='L1045'>            "Background AOF rewrite terminated with success");
<a name='L1046'>
<a name='L1047'>        <i><font color='green'>/* Flush the differences accumulated by the parent to the</font></i>
<a name='L1048'><i><font color='green'>         * rewritten AOF. */</font></i>
<a name='L1049'>        snprintf(tmpfile,256,"temp-rewriteaof-bg-%d.aof",
<a name='L1050'>            (<b>int</b>)server.aof_child_pid);
<a name='L1051'>        newfd = open(tmpfile,O_WRONLY|O_APPEND);
<a name='L1052'>        <b>if</b> (newfd == -1) <font color='red'>{</font>
<a name='L1053'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L1054'>                "Unable to open the temporary AOF produced by the child: %s", strerror(errno));
<a name='L1055'>            <b>goto</b> cleanup;
<a name='L1056'>        <font color='red'>}</font>
<a name='L1057'>
<a name='L1058'>        <b>if</b> (<a href='../S/62.html#L131' title='Defined at 131 in src/aof.c.'>aofRewriteBufferWrite</a>(newfd) == -1) <font color='red'>{</font>
<a name='L1059'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L1060'>                "Error trying to flush the parent diff to the rewritten AOF: %s", strerror(errno));
<a name='L1061'>            close(newfd);
<a name='L1062'>            <b>goto</b> cleanup;
<a name='L1063'>        <font color='red'>}</font>
<a name='L1064'>
<a name='L1065'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>,
<a name='L1066'>            "Parent diff successfully flushed to the rewritten AOF (%lu bytes)", <a href='../S/62.html#L77' title='Defined at 77 in src/aof.c.'>aofRewriteBufferSize</a>());
<a name='L1067'>
<a name='L1068'>        <i><font color='green'>/* The only remaining thing to do is to rename the temporary file to</font></i>
<a name='L1069'><i><font color='green'>         * the configured file and switch the file descriptor used to do AOF</font></i>
<a name='L1070'><i><font color='green'>         * writes. We don't want close(2) or rename(2) calls to block the</font></i>
<a name='L1071'><i><font color='green'>         * server on old file deletion.</font></i>
<a name='L1072'><i><font color='green'>         *</font></i>
<a name='L1073'><i><font color='green'>         * There are two possible scenarios:</font></i>
<a name='L1074'><i><font color='green'>         *</font></i>
<a name='L1075'><i><font color='green'>         * 1) AOF is DISABLED and this was a one time rewrite. The temporary</font></i>
<a name='L1076'><i><font color='green'>         * file will be renamed to the configured file. When this file already</font></i>
<a name='L1077'><i><font color='green'>         * exists, it will be unlinked, which may block the server.</font></i>
<a name='L1078'><i><font color='green'>         *</font></i>
<a name='L1079'><i><font color='green'>         * 2) AOF is ENABLED and the rewritten AOF will immediately start</font></i>
<a name='L1080'><i><font color='green'>         * receiving writes. After the temporary file is renamed to the</font></i>
<a name='L1081'><i><font color='green'>         * configured file, the original AOF file descriptor will be closed.</font></i>
<a name='L1082'><i><font color='green'>         * Since this will be the last reference to that file, closing it</font></i>
<a name='L1083'><i><font color='green'>         * causes the underlying file to be unlinked, which may block the</font></i>
<a name='L1084'><i><font color='green'>         * server.</font></i>
<a name='L1085'><i><font color='green'>         *</font></i>
<a name='L1086'><i><font color='green'>         * To mitigate the blocking effect of the unlink operation (either</font></i>
<a name='L1087'><i><font color='green'>         * caused by rename(2) in scenario 1, or by close(2) in scenario 2), we</font></i>
<a name='L1088'><i><font color='green'>         * use a background thread to take care of this. First, we</font></i>
<a name='L1089'><i><font color='green'>         * make scenario 1 identical to scenario 2 by opening the target file</font></i>
<a name='L1090'><i><font color='green'>         * when it exists. The unlink operation after the rename(2) will then</font></i>
<a name='L1091'><i><font color='green'>         * be executed upon calling close(2) for its descriptor. Everything to</font></i>
<a name='L1092'><i><font color='green'>         * guarantee atomicity for this switch has already happened by then, so</font></i>
<a name='L1093'><i><font color='green'>         * we don't care what the outcome or duration of that close operation</font></i>
<a name='L1094'><i><font color='green'>         * is, as long as the file descriptor is released again. */</font></i>
<a name='L1095'>        <b>if</b> (server.aof_fd == -1) <font color='red'>{</font>
<a name='L1096'>            <i><font color='green'>/* AOF disabled */</font></i>
<a name='L1097'>
<a name='L1098'>             <i><font color='green'>/* Don't care if this fails: oldfd will be -1 and we handle that.</font></i>
<a name='L1099'><i><font color='green'>              * One notable case of -1 return is if the old file does</font></i>
<a name='L1100'><i><font color='green'>              * not exist. */</font></i>
<a name='L1101'>             oldfd = open(server.aof_filename,O_RDONLY|O_NONBLOCK);
<a name='L1102'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1103'>            <i><font color='green'>/* AOF enabled */</font></i>
<a name='L1104'>            oldfd = -1; <i><font color='green'>/* We'll set this to the current AOF filedes later. */</font></i>
<a name='L1105'>        <font color='red'>}</font>
<a name='L1106'>
<a name='L1107'>        <i><font color='green'>/* Rename the temporary file. This will not unlink the target file if</font></i>
<a name='L1108'><i><font color='green'>         * it exists, because we reference it with "oldfd". */</font></i>
<a name='L1109'>        <b>if</b> (rename(tmpfile,server.aof_filename) == -1) <font color='red'>{</font>
<a name='L1110'>            <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L1111'>                "Error trying to rename the temporary AOF file: %s", strerror(errno));
<a name='L1112'>            close(newfd);
<a name='L1113'>            <b>if</b> (oldfd != -1) close(oldfd);
<a name='L1114'>            <b>goto</b> cleanup;
<a name='L1115'>        <font color='red'>}</font>
<a name='L1116'>
<a name='L1117'>        <b>if</b> (server.aof_fd == -1) <font color='red'>{</font>
<a name='L1118'>            <i><font color='green'>/* AOF disabled, we don't need to set the AOF file descriptor</font></i>
<a name='L1119'><i><font color='green'>             * to this new file, so we can close it. */</font></i>
<a name='L1120'>            close(newfd);
<a name='L1121'>        <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1122'>            <i><font color='green'>/* AOF enabled, replace the old fd with the new one. */</font></i>
<a name='L1123'>            oldfd = server.aof_fd;
<a name='L1124'>            server.aof_fd = newfd;
<a name='L1125'>            <b>if</b> (server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L243' title='Defined at 243 in src/redis.h.'>AOF_FSYNC_ALWAYS</a>)
<a name='L1126'>                <a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a>(newfd);
<a name='L1127'>            <b>else</b> <b>if</b> (server.<a href='../D/1557.html' title='Multiple defined in 2 places.'>aof_fsync</a> == <a href='../S/32.html#L244' title='Defined at 244 in src/redis.h.'>AOF_FSYNC_EVERYSEC</a>)
<a name='L1128'>                <a href='../S/62.html#L159' title='Defined at 159 in src/aof.c.'>aof_background_fsync</a>(newfd);
<a name='L1129'>            server.aof_selected_db = -1; <i><font color='green'>/* Make sure SELECT is re-issued */</font></i>
<a name='L1130'>            <a href='../S/62.html#L1025' title='Defined at 1025 in src/aof.c.'>aofUpdateCurrentSize</a>();
<a name='L1131'>            server.aof_rewrite_base_size = server.aof_current_size;
<a name='L1132'>
<a name='L1133'>            <i><font color='green'>/* Clear regular AOF buffer since its contents was just written to</font></i>
<a name='L1134'><i><font color='green'>             * the new AOF from the background rewrite buffer. */</font></i>
<a name='L1135'>            <a href='../D/4006.html' title='Multiple defined in 2 places.'>sdsfree</a>(server.aof_buf);
<a name='L1136'>            server.aof_buf = <a href='../D/4005.html' title='Multiple defined in 2 places.'>sdsempty</a>();
<a name='L1137'>        <font color='red'>}</font>
<a name='L1138'>
<a name='L1139'>        server.aof_lastbgrewrite_status = <a href='../D/848.html' title='Multiple defined in 2 places.'>REDIS_OK</a>;
<a name='L1140'>
<a name='L1141'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L231' title='Defined at 231 in src/redis.h.'>REDIS_NOTICE</a>, "Background AOF rewrite finished successfully");
<a name='L1142'>        <i><font color='green'>/* Change state from WAIT_REWRITE to ON if needed */</font></i>
<a name='L1143'>        <b>if</b> (server.aof_state == <a href='../S/32.html#L169' title='Defined at 169 in src/redis.h.'>REDIS_AOF_WAIT_REWRITE</a>)
<a name='L1144'>            server.aof_state = <a href='../S/32.html#L168' title='Defined at 168 in src/redis.h.'>REDIS_AOF_ON</a>;
<a name='L1145'>
<a name='L1146'>        <i><font color='green'>/* Asynchronously close the overwritten AOF. */</font></i>
<a name='L1147'>        <b>if</b> (oldfd != -1) <a href='../S/25.html#L124' title='Defined at 124 in src/bio.c.'>bioCreateBackgroundJob</a>(<a href='../S/68.html#L38' title='Defined at 38 in src/bio.h.'>REDIS_BIO_CLOSE_FILE</a>,(<b>void</b>*)(<b>long</b>)oldfd,NULL,NULL);
<a name='L1148'>
<a name='L1149'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L230' title='Defined at 230 in src/redis.h.'>REDIS_VERBOSE</a>,
<a name='L1150'>            "Background AOF rewrite signal handler took %lldus", <a href='../D/4460.html' title='Multiple defined in 2 places.'>ustime</a>()-now);
<a name='L1151'>    <font color='red'>}</font> <b>else</b> <b>if</b> (!bysignal &amp;&amp; exitcode != 0) <font color='red'>{</font>
<a name='L1152'>        server.aof_lastbgrewrite_status = <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L1153'>
<a name='L1154'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L1155'>            "Background AOF rewrite terminated with error");
<a name='L1156'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L1157'>        server.aof_lastbgrewrite_status = <a href='../D/794.html' title='Multiple defined in 2 places.'>REDIS_ERR</a>;
<a name='L1158'>
<a name='L1159'>        <a href='../S/35.html#L294' title='Defined at 294 in src/redis.c.'>redisLog</a>(<a href='../S/32.html#L232' title='Defined at 232 in src/redis.h.'>REDIS_WARNING</a>,
<a name='L1160'>            "Background AOF rewrite terminated by signal %d", bysignal);
<a name='L1161'>    <font color='red'>}</font>
<a name='L1162'>
<a name='L1163'>cleanup:
<a name='L1164'>    <a href='../S/62.html#L68' title='Defined at 68 in src/aof.c.'>aofRewriteBufferReset</a>();
<a name='L1165'>    <a href='../S/62.html#L1014' title='Defined at 1014 in src/aof.c.'>aofRemoveTempFile</a>(server.aof_child_pid);
<a name='L1166'>    server.aof_child_pid = -1;
<a name='L1167'>    server.aof_rewrite_time_last = time(NULL)-server.aof_rewrite_time_start;
<a name='L1168'>    server.aof_rewrite_time_start = -1;
<a name='L1169'>    <i><font color='green'>/* Schedule a new rewrite if we are waiting for it to switch the AOF ON. */</font></i>
<a name='L1170'>    <b>if</b> (server.aof_state == <a href='../S/32.html#L169' title='Defined at 169 in src/redis.h.'>REDIS_AOF_WAIT_REWRITE</a>)
<a name='L1171'>        server.aof_rewrite_scheduled = 1;
<a name='L1172'><font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L1038'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
